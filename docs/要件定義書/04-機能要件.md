## 4. 機能要件

### 4.1 機能要件一覧

#### FR-100: 音声処理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-101 | リアルタイム音声取得 | 必須 | 1 |
| FR-102 | オンデバイス文字起こし | 必須 | 1 |
| FR-103 | 話者分離処理 | 必須 | 1 |
| FR-104 | 音声チャンク送信 | 必須 | 1 |
| FR-105 | 文字起こし結果保存 | 必須 | 1 |

#### FR-200: AI分析機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-201 | トーク比率分析 | 必須 | 1 |
| FR-202 | 質問分析 | 必須 | 1 |
| FR-203 | 感情分析 | 必須 | 1 |
| FR-204 | 悩みキーワード検出 | 必須 | 1 |
| FR-205 | 提案タイミング分析 | 必須 | 2 |
| FR-206 | 提案品質分析 | 必須 | 2 |
| FR-207 | 成約判定 | 必須 | 2 |
| FR-208 | 総合スコアリング | 必須 | 2 |

#### FR-300: リアルタイムアシスト機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-301 | リアルタイムスコア表示 | 必須 | 1 |
| FR-302 | 提案タイミング通知 | 必須 | 2 |
| FR-303 | 成功トーク提案 | 必須 | 2 |
| FR-304 | アラート表示 | 任意 | 3 |

#### FR-400: 成功事例マッチング機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-401 | 成功事例登録 | 必須 | 2 |
| FR-402 | ベクトル埋め込み生成 | 必須 | 2 |
| FR-403 | 類似事例検索 | 必須 | 2 |
| FR-404 | 成功事例表示 | 必須 | 2 |

#### FR-500: レポート機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-501 | セッションレポート生成 | 必須 | 1 |
| FR-502 | 改善ポイント提示 | 必須 | 1 |
| FR-503 | アクションアイテム生成 | 必須 | 2 |
| FR-504 | レポート履歴管理 | 必須 | 2 |
| FR-505 | レポートエクスポート | 任意 | 3 |

#### FR-600: 教育・トレーニング機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-601 | AIロールプレイ | 必須 | 3 |
| FR-602 | シナリオ選択 | 必須 | 3 |
| FR-603 | ロールプレイ評価 | 必須 | 3 |
| FR-604 | ベストプラクティスDB | 必須 | 3 |
| FR-605 | ゲーミフィケーション | 任意 | 3 |

#### FR-700: 管理ダッシュボード機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-701 | スタッフ一覧・管理 | 必須 | 1 |
| FR-702 | スタッフ別分析 | 必須 | 2 |
| FR-703 | 店舗全体分析 | 必須 | 2 |
| FR-704 | 期間比較分析 | 必須 | 2 |
| FR-705 | 複数店舗統合分析 | 任意 | 3 |

#### FR-800: 認証・アカウント管理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-801 | ユーザー認証 | 必須 | 1 |
| FR-802 | ロールベースアクセス制御 | 必須 | 1 |
| FR-803 | 店舗アカウント管理 | 必須 | 1 |
| FR-804 | スタッフ招待・管理 | 必須 | 1 |
| FR-805 | パスワードリセット | 必須 | 1 |

#### FR-1100: デバイス（iPad）管理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-1101 | iPadデバイス登録 | 必須 | 1 |
| FR-1102 | iPadアクティベーション | 必須 | 1 |
| FR-1103 | デバイス一覧・管理 | 必須 | 1 |
| FR-1104 | デバイス無効化 | 必須 | 1 |
| FR-1105 | セット面割り当て | 必須 | 1 |

#### FR-1200: スタッフ声紋識別機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-1201 | スタッフ声紋登録（オンボーディング） | 必須 | 1 |
| FR-1202 | スタッフ声紋更新 | 必須 | 1 |
| FR-1203 | スタッフ声紋照合 | 必須 | 1 |
| FR-1204 | スタッフ自動識別 | 必須 | 1 |
| FR-1205 | 声紋登録ガイダンス | 必須 | 1 |

---

### 4.2 機能要件詳細

#### FR-101: リアルタイム音声取得

**概要**: iPadのマイクから施術中の会話音声を継続的に取得する

**入力**:
- iPadのマイクからの音声ストリーム
- サンプリングレート: 16kHz
- チャンネル: モノラル

**処理**:
1. マイクアクセス権限の確認・要求
2. AVAudioEngineによる音声キャプチャ開始
3. 1分間隔での音声チャンク分割
4. WAV形式での一時保存

**出力**:
- 1分間の音声チャンク（WAVファイル）

**受け入れ基準**:
- [ ] マイク権限取得のUIが表示される
- [ ] 施術開始ボタンタップで録音が開始される
- [ ] バックグラウンドでも録音が継続する
- [ ] 1分ごとに音声チャンクが生成される
- [ ] 音声品質: SNR 20dB以上

**例外処理**:
- マイク権限拒否時: 権限要求ダイアログ再表示
- ストレージ不足時: ユーザーへの警告表示

---

#### FR-102: オンデバイス文字起こし

**概要**: Apple SpeechAnalyzerを使用してiPad上で音声を文字起こしする

**入力**:
- 音声チャンク（WAVファイル）
- 言語設定（日本語）

**処理**:
1. SpeechAnalyzerの初期化
2. 日本語言語モデルのダウンロード確認（初回のみ）
3. 音声ファイルの読み込み
4. 文字起こし実行
5. タイムスタンプ付きセグメント生成

**出力**:
```typescript
interface TranscriptionResult {
  text: string;
  segments: {
    text: string;
    startTime: number;
    endTime: number;
    confidence: number;
  }[];
  durationInSeconds: number;
}
```

**受け入れ基準**:
- [ ] 文字起こし精度: 95%以上（標準的な会話環境）
- [ ] 処理時間: 1分音声に対して10秒以内
- [ ] オフライン動作が可能
- [ ] セグメントごとにタイムスタンプが付与される

**依存関係**:
- iOS 26以上
- @react-native-ai/appleパッケージ

---

#### FR-103: 話者分離処理

**概要**: pyannote.audioを使用して美容師とお客様の発話を分離する

**入力**:
- 音声チャンク（WAVファイル）
- セッションID
- 想定話者数: 2名

**処理**:
1. 音声ファイルをpyannoteサーバーにアップロード
2. 話者分離処理実行
3. 発話時間に基づく役割推定（発話量が多い方を美容師と推定）
4. 結果をデータベースに保存

**出力**:
```typescript
interface DiarizationResult {
  sessionId: string;
  segments: {
    role: 'stylist' | 'customer';
    startTime: number;
    endTime: number;
    speakerLabel: string;
  }[];
}
```

**受け入れ基準**:
- [ ] 話者分離精度: 90%以上（DER 10%未満）
- [ ] 処理時間: 1時間音声に対して5分以内
- [ ] 2話者の識別が正確に行われる

**設定パラメータ**:
| パラメータ | 値 | 説明 |
|-----------|-----|------|
| num_speakers | 2 | 想定話者数 |
| min_duration | 0.5 | 最小発話長（秒） |

---

#### FR-201: トーク比率分析

**概要**: 美容師とお客様の発話時間比率を計算・評価する

**入力**:
- 話者分離結果（DiarizationResult）

**処理**:
1. 美容師の総発話時間を計算
2. お客様の総発話時間を計算
3. 比率を計算
4. 理想値（40:60）との比較による評価

**出力**:
```typescript
interface TalkRatioAnalysis {
  stylistPercent: number;      // 美容師の発話比率（%）
  customerPercent: number;     // お客様の発話比率（%）
  judgment: 'excellent' | 'good' | 'needs_improvement';
  comment: string;
}
```

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 美容師35-45% かつ お客様55-65% |
| good | 美容師30-50% かつ お客様50-70% |
| needs_improvement | 上記以外 |

**受け入れ基準**:
- [ ] 比率が正確に計算される（誤差1%以内）
- [ ] 評価判定が正しく行われる
- [ ] 日本語でのコメントが生成される

---

#### FR-202: 質問分析

**概要**: 美容師の質問を検出し、オープン質問とクローズド質問の比率を分析する

**入力**:
- 美容師の発話テキスト一覧

**処理**:
1. 質問文の検出（「？」「か」で終わる文）
2. オープン質問の分類（「どう」「何」「どんな」等で始まる）
3. クローズド質問の分類（「〜ですか？」「〜しますか？」等）
4. 比率計算と評価

**出力**:
```typescript
interface QuestionAnalysis {
  totalCount: number;          // 質問総数
  openCount: number;           // オープン質問数
  closedCount: number;         // クローズド質問数
  openRatio: number;           // オープン質問比率（%）
  judgment: 'excellent' | 'good' | 'needs_improvement';
  examples: {
    open: string[];            // オープン質問例
    closed: string[];          // クローズド質問例
  };
}
```

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 質問8-12回 かつ オープン比率60%以上 |
| good | 質問6-15回 かつ オープン比率40%以上 |
| needs_improvement | 上記以外 |

**オープン質問の判定キーワード**:
- 「どう」「どのように」「どんな」
- 「何」「なに」
- 「いつ」「どこ」「誰」「なぜ」

---

#### FR-203: 感情分析

**概要**: お客様の発話から感情の傾向を分析する

**入力**:
- お客様の発話テキスト一覧

**処理**:
1. 肯定的キーワードの検出
2. 否定的キーワードの検出
3. 比率計算
4. 感情傾向の評価

**出力**:
```typescript
interface EmotionAnalysis {
  positiveRatio: number;       // 肯定的比率（%）
  detectedKeywords: {
    positive: string[];        // 検出した肯定的キーワード
    negative: string[];        // 検出した否定的キーワード
  };
  judgment: 'excellent' | 'good' | 'needs_improvement';
  overallSentiment: 'positive' | 'neutral' | 'negative';
}
```

**キーワード辞書**:

肯定的キーワード:
- 「いいですね」「素敵」「嬉しい」「楽しみ」「気に入った」
- 「ありがとう」「助かる」「さすが」「きれい」「かわいい」

否定的キーワード:
- 「困る」「嫌」「ちょっと」「微妙」「心配」
- 「痛い」「不安」「高い」「面倒」「難しい」

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 肯定比率70%以上 |
| good | 肯定比率50%以上 |
| needs_improvement | 肯定比率50%未満 |

---

#### FR-204: 悩みキーワード検出

**概要**: お客様が発した髪の悩みに関するキーワードを検出する

**入力**:
- お客様の発話テキスト一覧

**処理**:
1. 悩みキーワード辞書との照合
2. キーワードの出現位置（タイムスタンプ）の記録
3. カテゴリ分類

**出力**:
```typescript
interface ConcernKeywordResult {
  keywords: {
    keyword: string;           // 検出キーワード
    category: string;          // カテゴリ
    timestamp: number;         // 検出時刻（秒）
    context: string;           // 前後の文脈
  }[];
  categories: string[];        // 検出されたカテゴリ一覧
}
```

**悩みキーワード辞書**:

| カテゴリ | キーワード |
|---------|-----------|
| 乾燥・パサつき | 乾燥、パサパサ、パサつき、ツヤがない |
| 広がり・まとまり | 広がる、まとまらない、ボサボサ、うねり |
| ダメージ | 傷み、切れ毛、枝毛、ダメージ |
| 白髪 | 白髪、グレイヘア、染まりにくい |
| 薄毛・抜け毛 | 薄い、抜け毛、ボリュームがない |
| スタイリング | 朝大変、セットが持たない、崩れる |
| 頭皮 | 頭皮、かゆい、フケ、べたつき |

---

#### FR-301: リアルタイムスコア表示

**概要**: 施術中にiPad上でリアルタイムにスコアを表示する

**入力**:
- 現在までの分析結果

**処理**:
1. 1分ごとのスコア再計算
2. UI更新
3. トレンド表示

**出力（UI表示項目）**:

| 表示項目 | 表示形式 | 更新頻度 |
|---------|---------|---------|
| 傾聴スコア（総合スコア） | 0-100点 + ゲージ | 1分 |
| 質問数 | 数値 | リアルタイム |
| 感情インジケータ | 😊 😐 😞 | 1分 |
| 経過時間 | mm:ss | リアルタイム |
| 悩みキーワード | タグ表示 | リアルタイム |

**受け入れ基準**:
- [ ] スコアがリアルタイムで更新される
- [ ] UIがスムーズに動作する（60fps維持）
- [ ] 施術の邪魔にならない控えめな表示

---

#### FR-302: 提案タイミング通知

**概要**: 悩みキーワード検出後、適切なタイミングで提案を促す通知を表示する

**入力**:
- 悩みキーワード検出結果
- 現在の会話状態

**処理**:
1. 悩みキーワード検出をトリガーとする
2. 検出後2-5分のタイミングを計測
3. 適切なタイミングで通知を生成
4. 関連する成功トーク例を取得

**出力**:
```typescript
interface ProposalNotification {
  type: 'proposal_timing';
  concernKeyword: string;      // 検出した悩み
  suggestedProduct: string;    // 提案推奨商品
  successTalkExample: string;  // 成功トーク例
  timing: 'now' | 'soon';      // タイミング
}
```

**通知UI**:
```
┌────────────────────────────────────────────┐
│ 🎯 提案チャンス！                           │
│                                            │
│ お客様が「乾燥」と発言しました              │
│                                            │
│ ▶ 保湿シャンプーを提案しましょう            │
│                                            │
│ 💡 成功トーク例：                           │
│ 「同じお悩みだった○○様は...」              │
└────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] 悩みキーワード検出後3分以内に通知が表示される
- [ ] 通知は施術の邪魔にならない形式である
- [ ] 通知を閉じることができる
- [ ] 成功トーク例が含まれる

---

#### FR-401: 成功事例登録

**概要**: 成約に成功したセッションを成功事例として登録する

**入力**:
- セッションID
- 成約情報（商品、金額）
- 成功要因（手動入力または自動抽出）

**処理**:
1. セッションデータの取得
2. 成功要因の抽出（Claude APIによる分析）
3. ベクトル埋め込みの生成
4. データベースへの登録

**出力**:
```typescript
interface SuccessCase {
  id: string;
  sessionId: string;
  salonId: string;
  stylistId: string;
  concernKeywords: string[];
  customerProfile: {
    ageGroup: string;
    visitFrequency: string;
  };
  successfulTalk: string;
  keyTactics: string[];
  soldProduct: string;
  conversionRate: number;
  embedding: number[];         // ベクトル埋め込み
  createdAt: Date;
}
```

**受け入れ基準**:
- [ ] 成約セッションが正しく登録される
- [ ] ベクトル埋め込みが生成される
- [ ] 成功要因が自動抽出される

---

#### FR-501: セッションレポート生成

**概要**: 施術終了後に詳細な分析レポートを生成する

**入力**:
- セッションID
- 全分析結果

**処理**:
1. 全分析データの集約
2. Claude APIによるレポート生成
3. 改善ポイントの抽出
4. アクションアイテムの生成
5. レポートの保存

**出力**:
```typescript
interface SessionReport {
  sessionId: string;
  generatedAt: Date;
  summary: {
    date: Date;
    duration: number;
    stylistName: string;
    overallScore: number;
  };
  analysis: {
    talkRatio: TalkRatioAnalysis;
    questions: QuestionAnalysis;
    emotion: EmotionAnalysis;
    concerns: ConcernKeywordResult;
    proposalTiming: ProposalTimingAnalysis;
    proposalQuality: ProposalQualityAnalysis;
    conversion: ConversionResult;
  };
  goodPoints: string[];
  improvementPoints: string[];
  actionItems: string[];
  similarSuccessCases: SuccessCase[];
}
```

**レポート形式**:
- 総合スコア（0-100点）
- 7つの指標の詳細分析
- 良かった点（3-5項目）
- 改善点（2-3項目）
- 次回へのアクションアイテム（3項目）
- 類似成功事例（1-3件）

**受け入れ基準**:
- [ ] セッション終了後5分以内にレポートが生成される
- [ ] 全7指標の分析が含まれる
- [ ] 具体的な改善アドバイスが含まれる
- [ ] 日本語で自然な文章である

---

#### FR-601: AIロールプレイ

**概要**: Claude Sonnet 4.5がお客様役となり、トレーニングを実施する

**入力**:
- シナリオ選択
- ユーザーの発話

**処理**:
1. シナリオに基づくお客様キャラクター設定
2. ユーザー発話への応答生成
3. 会話の評価
4. フィードバック生成

**出力**:
```typescript
interface RoleplaySession {
  scenarioId: string;
  difficulty: 'beginner' | 'intermediate' | 'advanced';
  customerProfile: {
    age: number;
    concern: string;
    personality: string;
  };
  conversation: {
    role: 'user' | 'ai';
    text: string;
    timestamp: Date;
  }[];
  evaluation: {
    score: number;
    goodPoints: string[];
    improvementPoints: string[];
    modelAnswer: string;
  };
}
```

**シナリオ例**:

| 難易度 | シナリオ | 目標 |
|--------|---------|------|
| 初級 | 髪のパサつきを気にする25歳女性 | 基本的な提案練習 |
| 中級 | 「今使ってるシャンプーがある」と言う35歳女性 | 異議処理 |
| 上級 | 「価格が高い」と言う45歳女性 | 異議処理 + クロージング |

**受け入れ基準**:
- [ ] シナリオ選択が可能
- [ ] AIが自然な会話を行う
- [ ] 終了後に評価とフィードバックが提供される
- [ ] モデル回答が提示される

---

#### FR-701: スタッフ一覧・管理

**概要**: 店舗内のスタッフを一覧表示し、管理する

**入力**:
- 店舗ID

**処理**:
1. 店舗に紐づくスタッフの取得
2. 各スタッフの基本情報・統計の集計
3. 一覧表示

**出力**:
```typescript
interface StaffListItem {
  id: string;
  name: string;
  role: 'stylist' | 'assistant' | 'receptionist';
  joinDate: Date;
  profileImage?: string;
  stats: {
    totalSessions: number;
    averageScore: number;
    conversionRate: number;
    lastSessionDate: Date;
  };
}
```

**画面項目**:
| 項目 | 説明 |
|------|------|
| プロフィール画像 | スタッフの顔写真 |
| 氏名 | スタッフ名 |
| 役職 | スタイリスト/アシスタント等 |
| 入社日 | 入社日 |
| 総セッション数 | これまでの分析セッション数 |
| 平均スコア | 総合スコアの平均 |
| 成約率 | 店販成約率 |

**受け入れ基準**:
- [ ] 全スタッフが一覧表示される
- [ ] スタッフの検索・フィルタが可能
- [ ] スタッフ詳細画面への遷移が可能
- [ ] 新規スタッフの追加が可能

---

#### FR-900: 初回セットアップウィザード機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-901 | 店舗初回セットアップ（Web） | 必須 | 1 |
| FR-902 | スタッフ初回セットアップ（iPad） | 必須 | 1 |
| FR-903 | セットアップ進捗管理 | 必須 | 1 |
| FR-904 | セットアップスキップ・後で設定 | 任意 | 1 |

#### FR-1000: 声紋識別（顧客識別）機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-1001 | 声紋（話者埋め込み）抽出 | 必須 | 2 |
| FR-1002 | 顧客声紋登録 | 必須 | 2 |
| FR-1003 | 顧客声紋マッチング | 必須 | 2 |
| FR-1004 | 顧客名抽出・設定 | 必須 | 2 |
| FR-1005 | 顧客識別結果表示 | 必須 | 2 |
| FR-1006 | 顧客情報管理 | 任意 | 3 |

---

### 4.3 初回セットアップウィザード詳細

#### FR-901: 店舗初回セットアップ（Web）

**概要**: オーナー/マネージャーが初回ログイン時に店舗の基本設定を行うウィザード

**トリガー条件**:
- 新規登録後の初回ログイン
- `salons.setup_completed = false` の場合

**ステップ構成**:

| ステップ | 画面名 | 必須 | 入力項目 |
|---------|--------|------|---------|
| 1 | ようこそ | - | （説明のみ） |
| 2 | 店舗情報 | 必須 | 店舗名、住所、電話番号、営業時間 |
| 3 | プラン選択 | 必須 | 料金プラン（Free/Standard/Premium） |
| 4 | スタッフ招待 | 任意 | メールアドレスによる招待（複数可） |
| 5 | プライバシー設定 | 必須 | 録音同意フロー設定、データ保持期間 |
| 6 | 完了 | - | セットアップ完了確認 |

**入力項目詳細**:

```typescript
interface SalonSetupData {
  // Step 2: 店舗情報
  salon_info: {
    name: string;              // 店舗名（必須）
    address?: string;          // 住所（任意）
    phone?: string;            // 電話番号（任意）
    business_hours?: {
      open: string;            // 開店時間 "09:00"
      close: string;           // 閉店時間 "21:00"
    };
  };

  // Step 3: プラン選択
  plan: 'free' | 'standard' | 'premium';

  // Step 4: スタッフ招待
  staff_invitations: {
    email: string;
    role: 'stylist' | 'manager';
  }[];

  // Step 5: プライバシー設定
  privacy_settings: {
    require_customer_consent: boolean;   // お客様同意必須
    consent_message?: string;            // 同意文言カスタマイズ
    data_retention_days: number;         // データ保持期間（日）
    auto_delete_audio: boolean;          // 音声自動削除
  };
}
```

**受け入れ基準**:
- [ ] 初回ログイン時に自動的にウィザードが開始される
- [ ] 各ステップで「戻る」「次へ」ナビゲーションが機能する
- [ ] 必須項目未入力時はエラー表示される
- [ ] プログレスバーで進捗が表示される
- [ ] 途中離脱しても進捗が保存される
- [ ] 完了後は `salons.setup_completed = true` に更新される
- [ ] 完了後はダッシュボードへ遷移する

---

#### FR-902: スタッフ初回セットアップ（iPad）

**概要**: スタイリストが初回ログイン時に個人設定を行うウィザード

**トリガー条件**:
- 招待リンクからの初回ログイン
- `staffs.setup_completed = false` の場合

**ステップ構成**:

| ステップ | 画面名 | 必須 | 入力項目 |
|---------|--------|------|---------|
| 1 | ようこそ | - | アプリ概要説明 |
| 2 | プロフィール設定 | 必須 | 表示名、プロフィール画像 |
| 3 | 権限許可 | 必須 | マイク権限、通知権限 |
| 4 | **声紋登録** | **必須** | **30秒以上の音声録音（FR-1201参照）** |
| 5 | 機能チュートリアル | 任意 | セッション機能の説明（スキップ可） |
| 6 | 完了 | - | セットアップ完了、最初のセッション開始促し |

**入力項目詳細**:

```typescript
interface StaffSetupData {
  // Step 2: プロフィール設定
  profile: {
    display_name: string;      // 表示名（必須）
    avatar_url?: string;       // プロフィール画像URL（任意）
  };

  // Step 3: 権限許可（デバイス側で処理）
  permissions: {
    microphone: boolean;       // マイク権限
    notifications: boolean;    // 通知権限
  };

  // Step 4: 声紋登録
  voice_registration: {
    completed: boolean;        // 登録完了フラグ
    quality: 'high' | 'medium' | 'low';  // 品質評価
    duration_ms: number;       // 録音時間（ミリ秒）
  };

  // Step 5: チュートリアル完了フラグ
  tutorial_completed: boolean;
}
```

**機能チュートリアル内容**:

1. **セッション開始方法**: 「施術開始」ボタンの説明
2. **リアルタイムスコア**: 傾聴スコア、質問数、感情の見方
3. **提案通知**: 悩み検出時の通知の使い方
4. **セッション終了**: レポート確認方法

**受け入れ基準**:
- [ ] 初回ログイン時に自動的にウィザードが開始される
- [ ] マイク権限許可のシステムダイアログが表示される
- [ ] 権限拒否時は再度許可を促すメッセージが表示される
- [ ] チュートリアルはスキップ可能
- [ ] 完了後は `staffs.setup_completed = true` に更新される
- [ ] 完了後はホーム画面へ遷移する

---

#### FR-903: セットアップ進捗管理

**概要**: セットアップの進捗状態を管理し、中断からの再開を可能にする

**データ構造**:

```typescript
interface SetupProgress {
  user_id: string;
  user_type: 'salon' | 'staff';
  current_step: number;
  completed_steps: number[];
  step_data: Record<string, unknown>;  // 各ステップの入力データ
  started_at: string;
  updated_at: string;
}
```

**処理**:
1. 各ステップ完了時にデータを自動保存
2. 中断時は最後に完了したステップまでの進捗を保持
3. 再ログイン時は中断したステップから再開

**受け入れ基準**:
- [ ] ブラウザ/アプリを閉じても進捗が保持される
- [ ] 再開時は最後のステップから継続できる
- [ ] 入力済みデータが復元される

---

#### FR-904: セットアップスキップ・後で設定

**概要**: 任意項目のスキップおよび後からの設定変更を可能にする

**スキップ可能項目**:

| 項目 | スキップ時のデフォルト値 |
|------|------------------------|
| 住所・電話番号 | 未設定 |
| 営業時間 | 未設定 |
| スタッフ招待 | 0名（後から設定画面で追加可能） |
| プロフィール画像 | デフォルトアバター |
| チュートリアル | 未完了（後からヘルプで確認可能） |

**後から設定可能な場所**:
- Web: 設定画面（Web-008）
- iPad: 設定画面（iPad-008）

**受け入れ基準**:
- [ ] 「スキップ」または「後で設定」ボタンが表示される
- [ ] スキップ時は次のステップへ進む
- [ ] スキップした項目は設定画面から後で入力可能
- [ ] 未設定項目がある場合は設定画面でリマインダー表示

---

### 4.4 声紋識別（顧客識別）機能詳細

#### FR-1001: 声紋（話者埋め込み）抽出

**概要**: pyannote.audioを使用して音声から話者の声紋（話者埋め込みベクトル）を抽出する

**入力**:
- 音声チャンク（WAVファイル）
- セッションID
- 話者ラベル（stylist / customer）

**処理**:
1. 話者分離結果から顧客の発話セグメントを特定
2. 顧客発話セグメントを結合（最低10秒以上推奨）
3. pyannote.audio の SpeakerEmbedding モデルで埋め込みベクトルを生成
4. 512次元のベクトルとして返却

**出力**:
```typescript
interface VoiceEmbeddingResult {
  session_id: string;
  speaker: 'stylist' | 'customer';
  embedding: number[];          // 512次元ベクトル
  duration_seconds: number;     // 抽出に使用した音声の長さ
  confidence: number;           // 信頼度スコア（0-1）
  extracted_at: string;
}
```

**技術仕様**:
| パラメータ | 値 | 説明 |
|-----------|-----|------|
| モデル | pyannote/embedding | 話者埋め込みモデル |
| 次元数 | 512 | 埋め込みベクトルの次元 |
| 最小音声長 | 10秒 | 信頼性のある埋め込みに必要な最小音声長 |
| 推奨音声長 | 30秒以上 | より高精度な埋め込みのための推奨音声長 |

**受け入れ基準**:
- [ ] 10秒以上の音声から埋め込みベクトルが生成される
- [ ] 埋め込みベクトルは512次元である
- [ ] 同一話者の異なる発話から生成された埋め込みの類似度が0.8以上
- [ ] 異なる話者の埋め込みの類似度が0.6未満

---

#### FR-1002: 顧客声紋登録

**概要**: 新規顧客の声紋をデータベースに登録する

**入力**:
- 声紋埋め込みベクトル（VoiceEmbeddingResult）
- 店舗ID
- 顧客情報（任意）

**処理**:
1. 既存顧客との声紋マッチングを実行（FR-1003）
2. マッチする顧客がいない場合、新規顧客として登録
3. 顧客IDを生成し、声紋埋め込みを保存
4. 関連セッションと紐付け

**出力**:
```typescript
interface CustomerRegistrationResult {
  customer_id: string;
  is_new_customer: boolean;
  matched_customer_id?: string;  // 既存顧客にマッチした場合
  match_confidence?: number;     // マッチング信頼度
  created_at: string;
}
```

**データ構造（customers テーブル）**:
```sql
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id),
  name TEXT,                              -- 顧客名（後から設定可能）
  voice_embedding VECTOR(512),            -- 声紋埋め込みベクトル
  embedding_updated_at TIMESTAMPTZ,       -- 埋め込み最終更新日時
  total_visits INTEGER DEFAULT 1,         -- 来店回数
  first_visit_at TIMESTAMPTZ DEFAULT NOW(),
  last_visit_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'::jsonb,     -- 追加情報（年齢層、性別等）
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**受け入れ基準**:
- [ ] 新規顧客の声紋が正しく保存される
- [ ] 既存顧客とのマッチング判定が行われる
- [ ] 顧客IDが一意に生成される
- [ ] 店舗ごとに顧客が分離される（マルチテナント対応）

---

#### FR-1003: 顧客声紋マッチング

**概要**: セッション開始時に顧客の声紋を既存データと照合し、リピーターを識別する

**入力**:
- 声紋埋め込みベクトル
- 店舗ID

**処理**:
1. 店舗内の全顧客の声紋埋め込みを取得
2. コサイン類似度で類似検索（pgvector）
3. 閾値以上の類似度を持つ顧客を候補として返却
4. 最も類似度の高い顧客を推定顧客として特定

**出力**:
```typescript
interface VoiceMatchResult {
  matched: boolean;
  customer_id?: string;
  customer_name?: string;
  similarity_score: number;      // 0-1のコサイン類似度
  confidence: 'high' | 'medium' | 'low';
  previous_visits: number;
  last_visit_at?: string;
  alternative_candidates: {
    customer_id: string;
    customer_name?: string;
    similarity_score: number;
  }[];
}
```

**マッチング閾値**:
| 信頼度 | 類似度範囲 | 動作 |
|--------|-----------|------|
| high | 0.85以上 | 自動的に顧客を特定 |
| medium | 0.75-0.85 | 候補として表示、確認を促す |
| low | 0.65-0.75 | 複数候補を表示、手動選択を促す |
| 不一致 | 0.65未満 | 新規顧客として扱う |

**pgvector 検索関数**:
```sql
CREATE OR REPLACE FUNCTION match_customer_by_voice(
  query_embedding VECTOR(512),
  salon_id_param UUID,
  match_threshold FLOAT DEFAULT 0.65,
  match_count INT DEFAULT 5
)
RETURNS TABLE (
  customer_id UUID,
  customer_name TEXT,
  similarity FLOAT,
  total_visits INTEGER,
  last_visit_at TIMESTAMPTZ
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    c.id,
    c.name,
    1 - (c.voice_embedding <=> query_embedding) AS similarity,
    c.total_visits,
    c.last_visit_at
  FROM customers c
  WHERE c.salon_id = salon_id_param
    AND c.voice_embedding IS NOT NULL
    AND 1 - (c.voice_embedding <=> query_embedding) > match_threshold
  ORDER BY c.voice_embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```

**受け入れ基準**:
- [ ] リピーターの識別精度が90%以上
- [ ] 検索応答時間が500ms以内
- [ ] 類似度スコアが正確に計算される
- [ ] 候補が複数ある場合は全て返却される

---

#### FR-1004: 顧客名抽出・設定

**概要**: 会話内容から顧客名を自動抽出、または手動で設定する

**入力**:
- セッションの会話トランスクリプト
- 顧客ID

**処理**:
1. Claude APIで会話から顧客名を抽出
2. 名前の候補を信頼度順にリスト化
3. 美容師の発話から呼びかけパターンを検出
4. 顧客の自己紹介を検出

**出力**:
```typescript
interface CustomerNameExtractionResult {
  extracted_names: {
    name: string;
    confidence: number;
    source: 'stylist_address' | 'customer_intro' | 'context';
    context: string;             // 抽出元の文脈
  }[];
  recommended_name?: string;     // 最も信頼度の高い名前
}
```

**名前抽出プロンプト**:
```
以下の美容室での会話トランスクリプトから、お客様の名前を抽出してください。

抽出ルール:
1. 美容師がお客様を呼ぶ際の名前（「○○さん」「○○様」）
2. お客様の自己紹介（「○○です」「○○といいます」）
3. 予約確認の際の名前

出力形式:
{
  "names": [
    {"name": "田中", "confidence": 0.95, "source": "stylist_address", "context": "田中さん、いつもありがとうございます"},
    ...
  ]
}

会話:
{transcript}
```

**手動設定UI**:
- セッション終了後のレポート画面から顧客名を設定可能
- リアルタイム表示パネルからも設定可能
- 過去のセッションから顧客情報を編集可能

**受け入れ基準**:
- [ ] 会話から顧客名が自動抽出される
- [ ] 複数候補がある場合はリスト表示される
- [ ] 手動での名前設定が可能
- [ ] 名前が設定されると以降のセッションで表示される

---

#### FR-1005: 顧客識別結果表示

**概要**: セッション中にリアルタイムで顧客識別結果を表示する

**入力**:
- 声紋マッチング結果（VoiceMatchResult）
- 顧客情報

**処理**:
1. セッション開始から60秒後に初回識別を実行
2. 識別結果をリアルタイムパネルに表示
3. リピーターの場合は過去の来店情報を表示
4. 新規顧客の場合はその旨を表示

**出力（UI表示項目）**:

| 表示項目 | リピーター | 新規顧客 |
|---------|-----------|---------|
| 顧客アイコン | 写真またはアバター | デフォルトアバター |
| 顧客名 | 設定済み名前 | 「新規のお客様」 |
| 来店回数 | 「X回目のご来店」 | 「初めてのご来店」 |
| 前回来店日 | 「前回: YYYY/MM/DD」 | - |
| 信頼度インジケータ | ●●●（高）/ ●●○（中）/ ●○○（低） | - |
| 確認ボタン | 「この方で合っていますか？」 | 「お名前を設定」 |

**UI モックアップ**:
```
┌─────────────────────────────────────────────┐
│ 👤 顧客識別                                 │
├─────────────────────────────────────────────┤
│ リピーターの場合:                           │
│ ┌─────┐                                     │
│ │ 👩  │ 田中様（3回目のご来店）             │
│ └─────┘ 前回: 2025/11/15                    │
│         信頼度: ●●● 高                      │
│                                             │
│ [✓ この方で合っています] [✗ 別の方です]     │
├─────────────────────────────────────────────┤
│ 新規顧客の場合:                             │
│ ┌─────┐                                     │
│ │ 👤  │ 新規のお客様                        │
│ └─────┘ 初めてのご来店                      │
│                                             │
│ [📝 お名前を設定する]                        │
└─────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] セッション開始後1分以内に識別結果が表示される
- [ ] リピーターの場合は過去の来店情報が表示される
- [ ] 識別結果の確認・修正が可能
- [ ] UIが施術の邪魔にならない

---

#### FR-1006: 顧客情報管理

**概要**: 登録済み顧客の情報を管理画面から閲覧・編集する

**入力**:
- 店舗ID

**処理**:
1. 店舗に紐づく全顧客を取得
2. 顧客情報の一覧表示
3. 顧客詳細の閲覧・編集

**出力（顧客一覧）**:
```typescript
interface CustomerListItem {
  customer_id: string;
  name?: string;
  total_visits: number;
  first_visit_at: string;
  last_visit_at: string;
  assigned_stylist?: string;     // 主な担当スタイリスト
  total_sessions: number;
  average_score?: number;        // 平均セッションスコア
}
```

**画面項目（顧客詳細）**:
| 項目 | 説明 |
|------|------|
| 顧客名 | 編集可能 |
| 来店履歴 | 日付、担当者、スコアの一覧 |
| 過去のセッション | セッションレポートへのリンク |
| 声紋情報 | 最終更新日時、再登録ボタン |
| メモ | 自由入力メモ欄 |
| 顧客メタデータ | 年齢層、性別、好み等 |

**受け入れ基準**:
- [ ] 顧客一覧が表示される
- [ ] 顧客名での検索が可能
- [ ] 来店回数、最終来店日でソート可能
- [ ] 顧客詳細画面で情報編集が可能
- [ ] 過去のセッションへ遷移可能

---

#### FR-1100: デバイス（iPad）管理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-1101 | iPadデバイス登録 | 必須 | 1 |
| FR-1102 | iPadアクティベーション | 必須 | 1 |
| FR-1103 | デバイス一覧・管理 | 必須 | 1 |
| FR-1104 | デバイス無効化 | 必須 | 1 |
| FR-1105 | セット面割り当て | 必須 | 1 |

---

### 4.6 デバイス管理機能詳細

#### FR-1101: iPadデバイス登録

**概要**: オーナー/マネージャーがWebダッシュボードからiPadデバイスを登録し、アクティベーションコードを発行する

**入力**:
- 店舗ID
- デバイス名（例: "セット面1"）
- セット面番号（任意）

**処理**:
1. 店舗の`seats_count`を確認（制限チェック）
2. ユニークなアクティベーションコード（6桁数字）を生成
3. `devices`テーブルにレコード作成（status: 'pending'）
4. `device_activations`テーブルにコード情報保存
5. アクティベーションコードを表示

**出力**:
```typescript
interface DeviceRegistration {
  device_id: string;
  activation_code: string;      // 例: "123456"（6桁数字）
  name: string;
  seat_number?: number;
  expires_at: string;           // コード有効期限（24時間）
}
```

**受け入れ基準**:
- [ ] オーナー/マネージャーのみがデバイス登録可能
- [ ] アクティベーションコードが生成される
- [ ] コードは24時間有効
- [ ] QRコード形式でも表示可能

---

#### FR-1102: iPadアクティベーション

**概要**: iPadアプリでアクティベーションコードを入力し、サロンに紐付ける

**入力**:
- アクティベーションコード（6桁数字）
- デバイス識別子（iOS UDID）

**処理**:
1. アクティベーションコードの検証
2. 有効期限チェック
3. デバイス識別子の保存
4. `devices.status = 'active'` に更新
5. `device_activations.used_at` を記録
6. サロン情報を取得してローカル保存

**出力**:
```typescript
interface ActivationResult {
  success: boolean;
  device: {
    id: string;
    name: string;
    seat_number?: number;
  };
  salon: {
    id: string;
    name: string;
  };
}
```

**受け入れ基準**:
- [ ] 正しいコードでアクティベーション成功
- [ ] 無効/期限切れコードでエラー表示
- [ ] アクティベーション後はホーム画面へ遷移
- [ ] デバイス識別子が保存され再アクティベーション不要

---

#### FR-1103: デバイス一覧・管理

**概要**: 登録済みiPadデバイスを一覧表示し、状態を管理する

**入力**:
- 店舗ID

**処理**:
1. 店舗に紐づくデバイス一覧取得
2. 各デバイスの状態（オンライン/オフライン）確認
3. 現在のセッション状況確認

**出力**:
```typescript
interface DeviceListItem {
  device_id: string;
  name: string;
  seat_number?: number;
  status: 'pending' | 'active' | 'inactive' | 'revoked';  // device_status ENUM
  is_online: boolean;              // last_active_at から5分以内
  last_active_at?: string;
  current_session_id?: string;     // 進行中セッション
  current_stylist?: {
    id: string;
    name: string;
  };
}
```

**画面項目**:
| 項目 | 説明 |
|------|------|
| デバイス名 | セット面名 |
| 状態 | オンライン/オフライン/未アクティベーション/無効 |
| 最終接続 | 最後に接続した日時 |
| 現在のセッション | 進行中の施術者名 |
| アクション | 無効化、コード再発行 |

**受け入れ基準**:
- [ ] 全デバイスが一覧表示される
- [ ] オンライン/オフライン状態がリアルタイム更新
- [ ] 進行中セッションが表示される
- [ ] デバイスごとのアクション操作が可能

---

#### FR-1104: デバイス無効化

**概要**: 紛失・故障等の場合にデバイスを無効化する

**入力**:
- デバイスID
- 無効化理由（任意）

**処理**:
1. デバイスの進行中セッションがないことを確認
2. `devices.status = 'inactive'` または `'revoked'` に更新
   - `inactive`: 一時無効化（再有効化可能）
   - `revoked`: 完全無効化（紛失・盗難時）
3. デバイス側のローカル認証情報を無効化

**受け入れ基準**:
- [ ] 無効化されたデバイスはセッション開始不可
- [ ] 無効化後も履歴データは保持
- [ ] `inactive` 状態のデバイスは再有効化が可能
- [ ] `revoked` 状態のデバイスは新規アクティベーションが必要

---

#### FR-1105: セット面割り当て

**概要**: iPadデバイスを物理的なセット面に割り当てる

**入力**:
- デバイスID
- セット面番号

**処理**:
1. セット面番号の重複チェック
2. `devices.seat_number` を更新

**受け入れ基準**:
- [ ] セット面番号は店舗内で一意
- [ ] 番号変更履歴が記録される

---

#### FR-1200: スタッフ声紋識別機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-1201 | スタッフ声紋登録（オンボーディング） | 必須 | 1 |
| FR-1202 | スタッフ声紋更新 | 必須 | 1 |
| FR-1203 | スタッフ声紋照合 | 必須 | 1 |
| FR-1204 | スタッフ自動識別 | 必須 | 1 |
| FR-1205 | 声紋登録ガイダンス | 必須 | 1 |

---

### 4.7 スタッフ声紋識別機能詳細

#### FR-1201: スタッフ声紋登録（オンボーディング）

**概要**: スタッフが初回セットアップ時に声紋（話者埋め込み）を登録する

**入力**:
- スタッフID
- 音声サンプル（30秒以上）

**処理**:
1. 音声録音開始
2. 読み上げ用テキストを表示
3. 30秒以上の音声を取得
4. pyannote/embedding で512次元ベクトルを生成
5. `staffs.voice_embedding` に保存
6. `staffs.voice_embedding_updated_at` を更新

**読み上げテキスト例**:
```
「本日はご来店いただきありがとうございます。
今日はカットとカラーでよろしいでしょうか。
最近、髪のお悩みはありますか？
こちらのトリートメントがおすすめです。
仕上がりいかがでしょうか。」
```

**出力**:
```typescript
interface VoiceRegistrationResult {
  success: boolean;
  embedding_quality: 'high' | 'medium' | 'low';
  duration_ms: number;
  error?: string;
}
```

**品質判定基準**:
| 品質 | 条件 |
|------|------|
| high | 30秒以上、SNR > 20dB、単一話者 |
| medium | 20-30秒、SNR > 15dB |
| low | 20秒未満または雑音多い |

**受け入れ基準**:
- [ ] 読み上げテキストが画面に表示される
- [ ] 録音時間がリアルタイム表示される
- [ ] 30秒以上で登録完了可能
- [ ] 品質が低い場合は再録音を促す
- [ ] 登録完了後は次のステップへ進む

---

#### FR-1202: スタッフ声紋更新

**概要**: 登録済みの声紋を後から更新する

**入力**:
- スタッフID
- 新しい音声サンプル

**処理**:
1. FR-1201 と同様の録音・埋め込み生成
2. 既存の埋め込みを上書き更新
3. 更新日時を記録

**トリガー条件**:
- スタッフ本人が設定画面から実行
- 識別精度が低下した場合に通知

**受け入れ基準**:
- [ ] 設定画面から声紋更新にアクセス可能
- [ ] 更新前に確認ダイアログ表示
- [ ] 更新履歴が記録される

---

#### FR-1203: スタッフ声紋照合

**概要**: セッション中の音声からスタッフを特定する

**入力**:
- セッション音声の話者埋め込み（512次元）
- 店舗ID

**処理**:
1. 話者分離で検出された話者の埋め込みを取得
2. 店舗に所属する全スタッフの声紋と照合
3. コサイン類似度で最も近いスタッフを特定
4. 信頼度スコアを計算

**出力**:
```typescript
interface StaffMatchResult {
  matched_staff_id?: string;
  matched_staff_name?: string;
  similarity: number;            // 0.0 - 1.0
  confidence: 'high' | 'medium' | 'low' | 'none';
}
```

**マッチング閾値**:
| 類似度 | 信頼度 | アクション |
|--------|--------|-----------|
| 0.85以上 | high | 自動確定 |
| 0.75-0.85 | medium | 自動確定（ログ記録） |
| 0.65-0.75 | low | 確認を促す |
| 0.65未満 | none | 手動選択を要求 |

**受け入れ基準**:
- [ ] 正しいスタッフが特定される
- [ ] 類似度スコアが返される
- [ ] 閾値未満の場合は候補リスト表示

---

#### FR-1204: スタッフ自動識別

**概要**: セッション開始時に担当スタッフを自動識別し、セッションに紐付ける

**入力**:
- セッションID
- デバイスID
- 音声チャンク（最初の60秒）

**処理**:
1. 話者分離で2話者を検出
2. 各話者の埋め込みを生成
3. FR-1203 でスタッフ照合
4. 一方がスタッフ → もう一方は顧客と判定
5. セッションの `stylist_id` を設定
6. UIに識別結果を通知

**フローチャート**:
```
セッション開始
    ↓
最初の60秒を収集
    ↓
話者分離（2話者）
    ↓
┌─────────────────────┐
│ 話者A ←→ スタッフDB照合 │
│ 話者B ←→ スタッフDB照合 │
└─────────────────────┘
    ↓
┌───────────────────────────┐
│ 一方がマッチ              │
│  → スタッフ確定           │
│  → もう一方 = 顧客        │
├───────────────────────────┤
│ 両方マッチなし            │
│  → 手動選択を促す         │
├───────────────────────────┤
│ 両方マッチ（複数スタッフ） │
│  → どちらか選択を促す     │
└───────────────────────────┘
    ↓
顧客 → FR-1003 で顧客照合
    ↓
UI に識別結果表示
```

**受け入れ基準**:
- [ ] セッション開始後60秒以内に識別
- [ ] スタッフが自動識別される
- [ ] 識別失敗時は手動選択UI表示
- [ ] 識別結果はセッションに保存

---

#### FR-1205: 声紋登録ガイダンス

**概要**: 声紋登録時にユーザーを適切にガイドする

**入力**:
- 録音状態（開始前/録音中/完了）

**処理**:
1. 録音環境チェック（周囲騒音レベル）
2. 読み上げテキストの段階的表示
3. 録音時間のリアルタイム表示
4. 音量レベルインジケータ表示
5. 品質フィードバック提供

**ガイダンスUI**:
```
┌─────────────────────────────────────────────┐
│ 🎤 声紋を登録                               │
├─────────────────────────────────────────────┤
│                                             │
│ 以下のテキストを自然な声で読み上げて       │
│ ください。普段お客様と話すような声で       │
│ お願いします。                             │
│                                             │
│ ┌─────────────────────────────────────────┐ │
│ │「本日はご来店いただきありがとうござい │ │
│ │ます。今日はカットとカラーでよろしい   │ │
│ │でしょうか。」                          │ │
│ └─────────────────────────────────────────┘ │
│                                             │
│ 録音時間: ████████░░░░ 24秒 / 30秒         │
│ 音量: ▁▃▅▇▅▃▁ 良好                          │
│                                             │
│ [🔴 録音中...]                              │
│                                             │
│ 💡 静かな場所で、マイクに向かって          │
│    はっきりと読み上げてください            │
└─────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] 読み上げテキストが見やすく表示される
- [ ] 録音時間がプログレスバーで表示される
- [ ] 音量レベルがリアルタイム表示される
- [ ] 雑音検出時に警告表示
- [ ] 完了時に成功フィードバック表示

---

### FR-1300: 運営管理機能（オペレータ管理）

> **概要**: SalonTalk AIのシステム運営者向け管理機能。サロンの契約管理、座席枠設定、プラン変更、
> サロン停止/再開などの運営業務を行う。一般ユーザー（サロン管理者）とは別の認証・権限体系を持つ。

#### FR-1301: 運営ユーザー認証・認可

**概要**: 運営者（オペレータ）専用の認証とロールベース認可

**運営ロール定義**:

| ロール | 説明 | 権限 |
|--------|------|------|
| `operator_admin` | 運営管理者 | 全機能へのフルアクセス |
| `operator_support` | サポートスタッフ | 閲覧 + 一部変更（座席枠変更など） |

**権限マトリクス**:

| 機能 | operator_admin | operator_support |
|------|----------------|------------------|
| サロン一覧/検索 | ✅ | ✅ |
| サロン詳細閲覧 | ✅ | ✅ |
| 座席枠変更 | ✅ | ✅ |
| プラン変更 | ✅ | ❌ |
| サロン停止/再開 | ✅ | ❌ |
| 監査ログ閲覧 | ✅ | ✅（自分の操作のみ） |
| 運営ユーザー管理 | ✅ | ❌ |

**セキュリティ要件**:
- MFA（多要素認証）必須
- セッションタイムアウト: 30分
- IP制限オプション（将来対応）
- 全操作の監査ログ記録

**処理フロー**:
```
運営ログイン画面（/admin/login）
    ↓
メール/パスワード認証
    ↓
MFA検証（TOTP）
    ↓
operator_admins テーブルでロール確認
    ↓
JWTにoperator_roleクレーム付与
    ↓
運営ダッシュボードへ遷移
```

**受け入れ基準**:
- [ ] 運営専用ログインページ（/admin/login）が存在する
- [ ] MFA（TOTP）が必須化されている
- [ ] ロールに応じた機能制限が適用される
- [ ] 30分無操作でセッションタイムアウトする
- [ ] 一般ユーザー認証と完全に分離されている

---

#### FR-1302: サロン一覧・検索

**概要**: 登録されている全サロンの一覧表示と検索機能

**入力**:
- 検索条件（任意）:
  - `keyword`: サロン名/メールでの部分一致検索
  - `plan`: プランでのフィルタ（free/standard/premium/enterprise）
  - `status`: ステータスでのフィルタ（active/suspended）
  - `sort_by`: ソート項目（created_at/name/seats_count）
  - `sort_order`: 昇順/降順
  - `page`: ページ番号
  - `per_page`: 1ページあたりの件数（デフォルト: 50）

**出力**:
```typescript
interface SalonListResponse {
  salons: SalonSummary[];
  total_count: number;
  page: number;
  per_page: number;
  total_pages: number;
}

interface SalonSummary {
  id: string;
  name: string;
  plan: 'free' | 'standard' | 'premium' | 'enterprise';
  status: 'active' | 'suspended';
  seats_count: number;
  active_device_count: number;
  staff_count: number;
  owner_email: string;
  created_at: string;
  last_session_at: string | null;
}
```

**一覧画面UI**:
```
┌─────────────────────────────────────────────────────────────────────────┐
│ 🏢 サロン管理                                          [+ 新規作成]    │
├─────────────────────────────────────────────────────────────────────────┤
│ 🔍 [サロン名/メールで検索_______] [プラン▼] [ステータス▼] [検索]      │
├─────────────────────────────────────────────────────────────────────────┤
│ ☐ │ サロン名        │ プラン    │ 状態    │ 座席 │ スタッフ │ 操作   │
├───┼─────────────────┼───────────┼─────────┼──────┼──────────┼────────┤
│ ☐ │ Presto 恵比寿店 │ premium   │ 🟢 稼働 │ 8/10 │ 12名     │ [詳細] │
│ ☐ │ Hair Studio A   │ standard  │ 🟢 稼働 │ 4/5  │ 6名      │ [詳細] │
│ ☐ │ Beauty Salon B  │ free      │ 🔴 停止 │ 0/2  │ 3名      │ [詳細] │
│ ☐ │ Hair Lab C      │ enterprise│ 🟢 稼働 │ 15/20│ 25名     │ [詳細] │
├─────────────────────────────────────────────────────────────────────────┤
│ 全120件中 1-50件表示                    [<] [1] [2] [3] [>]            │
└─────────────────────────────────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] 全サロンが一覧表示される
- [ ] キーワード検索が機能する
- [ ] プラン/ステータスでフィルタできる
- [ ] ページネーションが正しく動作する
- [ ] 座席使用状況（登録済み/上限）が表示される

---

#### FR-1303: サロン詳細表示

**概要**: 特定サロンの詳細情報と関連データの表示

**入力**:
- `salon_id`: サロンID

**出力**:
```typescript
interface SalonDetailResponse {
  salon: {
    id: string;
    name: string;
    plan: string;
    status: 'active' | 'suspended';
    suspended_at: string | null;
    suspended_reason: string | null;
    seats_count: number;
    settings: SalonSettings;
    created_at: string;
    updated_at: string;
  };
  owner: {
    id: string;
    name: string;
    email: string;
  };
  stats: {
    staff_count: number;
    active_device_count: number;
    total_sessions: number;
    sessions_this_month: number;
    last_session_at: string | null;
  };
  recent_audit_logs: AuditLogEntry[];
}
```

**詳細画面UI**:
```
┌─────────────────────────────────────────────────────────────────────────┐
│ ← サロン一覧                                                            │
├─────────────────────────────────────────────────────────────────────────┤
│ 🏢 Presto 恵比寿店                                      🟢 稼働中      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ ┌─ 基本情報 ─────────────────────┐ ┌─ 利用状況 ─────────────────────┐ │
│ │ サロンID: salon_abc123          │ │ スタッフ数: 12名               │ │
│ │ オーナー: 山田太郎              │ │ デバイス: 8台 / 10台           │ │
│ │ メール: owner@presto.jp        │ │ 今月セッション: 156回          │ │
│ │ 登録日: 2025-01-15             │ │ 総セッション: 1,234回          │ │
│ │ 最終更新: 2025-12-08           │ │ 最終利用: 2025-12-09 14:32     │ │
│ └────────────────────────────────┘ └────────────────────────────────┘ │
│                                                                         │
│ ┌─ 契約情報 ─────────────────────────────────────────────────────────┐ │
│ │ プラン: Premium                                      [変更]        │ │
│ │ 座席枠: 10席                                         [変更]        │ │
│ │ ステータス: 稼働中                                   [停止する]    │ │
│ └────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│ ┌─ 最近の操作履歴 ───────────────────────────────────────────────────┐ │
│ │ 2025-12-08 10:23  座席枠変更 8→10  by admin@salontalk.jp          │ │
│ │ 2025-11-01 09:15  プラン変更 standard→premium  by admin@...       │ │
│ │ 2025-01-15 14:00  サロン作成  by system                            │ │
│ │                                                [すべての履歴を見る] │ │
│ └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] サロンの基本情報が表示される
- [ ] 利用統計（スタッフ数、セッション数など）が表示される
- [ ] 契約情報（プラン、座席枠）が表示される
- [ ] 直近の監査ログが表示される
- [ ] 各種変更ボタンが適切な権限で表示される

---

#### FR-1304: 座席枠（seats_count）変更

**概要**: サロンのデバイス登録上限数を変更する

**入力**:
```typescript
interface UpdateSeatsRequest {
  salon_id: string;
  new_seats_count: number;  // 1-100
  reason: string;           // 変更理由（必須）
}
```

**処理**:
1. 入力バリデーション
   - `new_seats_count`: 1〜100の整数
   - `reason`: 必須、最低10文字
2. 現在のアクティブデバイス数チェック
   - 新しい座席数 < 現在のアクティブデバイス数 → エラー
3. salons.seats_count を更新
4. 監査ログ記録
5. 変更通知（サロンオーナーへメール）

**出力**:
```typescript
interface UpdateSeatsResponse {
  success: boolean;
  salon_id: string;
  previous_seats_count: number;
  new_seats_count: number;
  changed_by: string;
  changed_at: string;
}
```

**確認ダイアログ**:
```
┌────────────────────────────────────────────────┐
│ 座席枠の変更                                   │
├────────────────────────────────────────────────┤
│                                                │
│ サロン: Presto 恵比寿店                        │
│                                                │
│ 現在の座席枠: 8席                              │
│ アクティブデバイス: 8台                        │
│                                                │
│ 新しい座席枠: [10____] 席                      │
│                                                │
│ 変更理由（必須）:                              │
│ ┌──────────────────────────────────────────┐  │
│ │プレミアムプランへのアップグレードに伴い  │  │
│ │座席数を増加                              │  │
│ └──────────────────────────────────────────┘  │
│                                                │
│ ⚠️ この操作は監査ログに記録されます            │
│                                                │
│            [キャンセル]  [変更を確定]          │
└────────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] 1〜100の範囲で座席数を設定できる
- [ ] 現在のアクティブデバイス数より少なくできない
- [ ] 変更理由が必須である
- [ ] 変更が監査ログに記録される
- [ ] サロンオーナーに通知メールが送信される

---

#### FR-1305: プラン変更

**概要**: サロンの契約プランを変更する（operator_adminのみ）

**プラン定義**:

| プラン | 座席上限 | 機能 | 月額目安 |
|--------|----------|------|----------|
| free | 2席 | 基本機能のみ | ¥0 |
| standard | 5席 | + 詳細分析 | ¥19,800 |
| premium | 15席 | + 成功事例検索、API | ¥49,800 |
| enterprise | 100席 | + 専用サポート、SLA | 個別見積 |

**入力**:
```typescript
interface ChangePlanRequest {
  salon_id: string;
  new_plan: 'free' | 'standard' | 'premium' | 'enterprise';
  effective_date?: string;  // 即時の場合は省略
  reason: string;
}
```

**処理**:
1. 入力バリデーション
2. プラン変更の影響チェック
   - ダウングレード時: 座席数が新プラン上限を超えていないか
3. salons.plan を更新
4. 座席数の自動調整（ダウングレード時、現在値がプラン上限を超える場合は上限に設定）
5. 監査ログ記録
6. 通知（サロンオーナー + 経理担当）

**出力**:
```typescript
interface ChangePlanResponse {
  success: boolean;
  salon_id: string;
  previous_plan: string;
  new_plan: string;
  seats_adjusted: boolean;      // 座席数が調整されたか
  previous_seats_count: number;
  new_seats_count: number;
  effective_at: string;
}
```

**受け入れ基準**:
- [ ] operator_adminのみ実行可能
- [ ] ダウングレード時は座席数の影響が警告される
- [ ] プラン変更が即時または指定日で適用される
- [ ] 監査ログに詳細が記録される
- [ ] 関係者に通知が送信される

---

#### FR-1306: サロン停止/再開

**概要**: 支払い滞納等の理由でサロンのサービス利用を停止/再開する（operator_adminのみ）

**停止時の挙動**:
- 新規セッション開始不可
- 既存データの閲覧は可能
- デバイスアクティベーション不可
- サロンユーザーへログイン時に停止理由を表示

**入力（停止）**:
```typescript
interface SuspendSalonRequest {
  salon_id: string;
  reason: string;           // 停止理由（ユーザーに表示）
  internal_note?: string;   // 内部メモ
}
```

**入力（再開）**:
```typescript
interface UnsuspendSalonRequest {
  salon_id: string;
  note?: string;
}
```

**処理（停止）**:
1. salons.status = 'suspended' に更新
2. salons.suspended_at = NOW() を記録
3. salons.suspended_reason = reason を記録
4. 監査ログ記録
5. サロン全スタッフへ停止通知メール送信

**処理（再開）**:
1. salons.status = 'active' に更新
2. salons.suspended_at = NULL
3. salons.suspended_reason = NULL
4. 監査ログ記録
5. サロン全スタッフへ再開通知メール送信

**確認ダイアログ（停止時）**:
```
┌────────────────────────────────────────────────┐
│ ⚠️ サロンの停止                                │
├────────────────────────────────────────────────┤
│                                                │
│ サロン: Presto 恵比寿店                        │
│ スタッフ数: 12名                               │
│ アクティブデバイス: 8台                        │
│                                                │
│ 停止理由（ユーザーに表示されます）:            │
│ ┌──────────────────────────────────────────┐  │
│ │お支払いの確認が取れないため、サービスを  │  │
│ │一時停止いたしました。                    │  │
│ └──────────────────────────────────────────┘  │
│                                                │
│ 内部メモ（任意）:                              │
│ ┌──────────────────────────────────────────┐  │
│ │2ヶ月分未払い。営業担当: 鈴木             │  │
│ └──────────────────────────────────────────┘  │
│                                                │
│ ⚠️ 停止すると:                                 │
│   • 新規セッションが開始できなくなります       │
│   • デバイスの追加登録ができなくなります       │
│   • 12名のスタッフに通知メールが送信されます   │
│                                                │
│            [キャンセル]  [🔴 停止を実行]       │
└────────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] operator_adminのみ実行可能
- [ ] 停止時に理由の入力が必須
- [ ] 停止中はセッション開始・デバイス登録が不可になる
- [ ] 停止/再開時に全スタッフへメール通知される
- [ ] 監査ログに詳細が記録される

---

#### FR-1307: 監査ログ

**概要**: 運営操作の監査ログを記録・閲覧する

**記録対象操作**:
- 座席枠変更
- プラン変更
- サロン停止/再開
- 運営ユーザー作成/変更/削除
- サロン新規作成
- その他設定変更

**ログエントリ構造**:
```typescript
interface AuditLogEntry {
  id: string;
  timestamp: string;
  operator_id: string;
  operator_email: string;
  operator_role: 'operator_admin' | 'operator_support';
  action: string;           // 'seats_change' | 'plan_change' | 'suspend' | ...
  target_type: string;      // 'salon' | 'operator' | ...
  target_id: string;
  target_name: string;      // サロン名など
  details: {
    before: Record<string, any>;
    after: Record<string, any>;
    reason?: string;
    note?: string;
  };
  ip_address: string;
  user_agent: string;
}
```

**検索条件**:
```typescript
interface AuditLogSearchParams {
  start_date?: string;
  end_date?: string;
  operator_id?: string;
  action?: string;
  target_type?: string;
  target_id?: string;
  keyword?: string;
  page?: number;
  per_page?: number;  // デフォルト: 100
}
```

**監査ログ画面UI**:
```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📋 監査ログ                                                            │
├─────────────────────────────────────────────────────────────────────────┤
│ 期間: [2025-12-01] 〜 [2025-12-09]                                      │
│ 操作者: [全員▼]  操作種別: [全て▼]  対象: [サロン▼]  [検索]          │
├─────────────────────────────────────────────────────────────────────────┤
│ 日時                │ 操作者          │ 操作        │ 対象          │ │
├─────────────────────┼─────────────────┼─────────────┼───────────────┼─┤
│ 2025-12-09 10:23:45 │ admin@salon...  │ 座席枠変更  │ Presto恵比寿  │▶│
│ 2025-12-08 15:30:12 │ support@sal...  │ 座席枠変更  │ Hair Studio   │▶│
│ 2025-12-07 09:00:00 │ admin@salon...  │ プラン変更  │ Beauty Salon  │▶│
│ 2025-12-06 14:22:33 │ admin@salon...  │ サロン停止  │ Hair Lab      │▶│
├─────────────────────────────────────────────────────────────────────────┤
│ 全1,234件中 1-100件表示                   [<] [1] [2] [3] ... [13] [>] │
└─────────────────────────────────────────────────────────────────────────┘

[▶ をクリックで詳細展開]
┌─────────────────────────────────────────────────────────────────────────┐
│ 詳細: 座席枠変更                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│ 変更前: seats_count = 8                                                 │
│ 変更後: seats_count = 10                                                │
│ 理由: プレミアムプランへのアップグレードに伴い座席数を増加             │
│ IP: 203.0.113.50                                                        │
│ UA: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)...                 │
└─────────────────────────────────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] 全ての運営操作がログに記録される
- [ ] 日時、操作者、操作種別でフィルタできる
- [ ] operator_supportは自分の操作のみ閲覧可能
- [ ] 変更前後の値が記録されている
- [ ] IPアドレス、UserAgentが記録されている
- [ ] ログは最低1年間保持される

---

#### FR-1308: 運営ダッシュボード

**概要**: 運営者向けのシステム全体状況ダッシュボード

**表示項目**:
```typescript
interface OperatorDashboard {
  summary: {
    total_salons: number;
    active_salons: number;
    suspended_salons: number;
    total_staff: number;
    total_devices: number;
    active_devices: number;
  };
  today_stats: {
    new_salons: number;
    new_sessions: number;
    active_sessions_now: number;
  };
  plan_distribution: {
    free: number;
    standard: number;
    premium: number;
    enterprise: number;
  };
  recent_activities: AuditLogEntry[];  // 直近10件
  alerts: {
    type: 'warning' | 'error';
    message: string;
    target_id?: string;
  }[];
}
```

**ダッシュボード画面UI**:
```
┌─────────────────────────────────────────────────────────────────────────┐
│ 🏠 運営ダッシュボード                           2025-12-09 14:32 現在  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ ┌─ 全体サマリー ────────────────────────────────────────────────────┐ │
│ │  🏢 サロン数        👤 スタッフ数      📱 デバイス数              │ │
│ │     120社              1,456名            892台                   │ │
│ │  (稼働:118/停止:2)                     (オンライン:234)          │ │
│ └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│ ┌─ 本日の状況 ─────────────┐ ┌─ プラン分布 ─────────────────────────┐ │
│ │ 新規サロン: 2社          │ │ Enterprise ████░░░░░░ 12社 (10%)    │ │
│ │ 新規セッション: 156回    │ │ Premium    ████████░░ 36社 (30%)    │ │
│ │ 現在アクティブ: 23回     │ │ Standard   ██████████ 48社 (40%)    │ │
│ └──────────────────────────┘ │ Free       ████████░░ 24社 (20%)    │ │
│                               └──────────────────────────────────────┘ │
│                                                                         │
│ ┌─ アラート ────────────────────────────────────────────────────────┐ │
│ │ ⚠️ Hair Lab C: 支払い期限超過（7日）                              │ │
│ │ ⚠️ Beauty Salon D: デバイス稼働なし（14日間）                     │ │
│ └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│ ┌─ 最近の操作 ──────────────────────────────────────────────────────┐ │
│ │ 10:23 admin@... 座席枠変更 Presto恵比寿 8→10                      │ │
│ │ 09:15 support@... プロフィール更新                                │ │
│ │ 昨日 admin@... プラン変更 Hair Studio standard→premium           │ │
│ │                                               [すべての履歴を見る] │ │
│ └──────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] システム全体の統計が表示される
- [ ] 本日の新規登録・セッション数が表示される
- [ ] プラン分布がグラフで表示される
- [ ] 要注意アラート（支払い遅延、長期未使用）が表示される
- [ ] 直近の操作履歴が表示される

---
