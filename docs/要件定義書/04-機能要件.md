## 4. 機能要件

### 4.1 機能要件一覧

#### FR-100: 音声処理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-101 | リアルタイム音声取得 | 必須 | 1 |
| FR-102 | オンデバイス文字起こし | 必須 | 1 |
| FR-103 | 話者分離処理 | 必須 | 1 |
| FR-104 | 音声チャンク送信 | 必須 | 1 |
| FR-105 | 文字起こし結果保存 | 必須 | 1 |

#### FR-200: AI分析機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-201 | トーク比率分析 | 必須 | 1 |
| FR-202 | 質問分析 | 必須 | 1 |
| FR-203 | 感情分析 | 必須 | 1 |
| FR-204 | 悩みキーワード検出 | 必須 | 1 |
| FR-205 | 提案タイミング分析 | 必須 | 2 |
| FR-206 | 提案品質分析 | 必須 | 2 |
| FR-207 | 成約判定 | 必須 | 2 |
| FR-208 | 総合スコアリング | 必須 | 2 |

#### FR-300: リアルタイムアシスト機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-301 | リアルタイムスコア表示 | 必須 | 1 |
| FR-302 | 提案タイミング通知 | 必須 | 2 |
| FR-303 | 成功トーク提案 | 必須 | 2 |
| FR-304 | アラート表示 | 任意 | 3 |

#### FR-400: 成功事例マッチング機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-401 | 成功事例登録 | 必須 | 2 |
| FR-402 | ベクトル埋め込み生成 | 必須 | 2 |
| FR-403 | 類似事例検索 | 必須 | 2 |
| FR-404 | 成功事例表示 | 必須 | 2 |

#### FR-500: レポート機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-501 | セッションレポート生成 | 必須 | 1 |
| FR-502 | 改善ポイント提示 | 必須 | 1 |
| FR-503 | アクションアイテム生成 | 必須 | 2 |
| FR-504 | レポート履歴管理 | 必須 | 2 |
| FR-505 | レポートエクスポート | 任意 | 3 |

#### FR-600: 教育・トレーニング機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-601 | AIロールプレイ | 必須 | 3 |
| FR-602 | シナリオ選択 | 必須 | 3 |
| FR-603 | ロールプレイ評価 | 必須 | 3 |
| FR-604 | ベストプラクティスDB | 必須 | 3 |
| FR-605 | ゲーミフィケーション | 任意 | 3 |

#### FR-700: 管理ダッシュボード機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-701 | スタッフ一覧・管理 | 必須 | 1 |
| FR-702 | スタッフ別分析 | 必須 | 2 |
| FR-703 | 店舗全体分析 | 必須 | 2 |
| FR-704 | 期間比較分析 | 必須 | 2 |
| FR-705 | 複数店舗統合分析 | 任意 | 3 |

#### FR-800: 認証・アカウント管理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-801 | ユーザー認証 | 必須 | 1 |
| FR-802 | ロールベースアクセス制御 | 必須 | 1 |
| FR-803 | 店舗アカウント管理 | 必須 | 1 |
| FR-804 | スタッフ招待・管理 | 必須 | 1 |
| FR-805 | パスワードリセット | 必須 | 1 |

---

### 4.2 機能要件詳細

#### FR-101: リアルタイム音声取得

**概要**: iPadのマイクから施術中の会話音声を継続的に取得する

**入力**:
- iPadのマイクからの音声ストリーム
- サンプリングレート: 16kHz
- チャンネル: モノラル

**処理**:
1. マイクアクセス権限の確認・要求
2. AVAudioEngineによる音声キャプチャ開始
3. 1分間隔での音声チャンク分割
4. WAV形式での一時保存

**出力**:
- 1分間の音声チャンク（WAVファイル）

**受け入れ基準**:
- [ ] マイク権限取得のUIが表示される
- [ ] 施術開始ボタンタップで録音が開始される
- [ ] バックグラウンドでも録音が継続する
- [ ] 1分ごとに音声チャンクが生成される
- [ ] 音声品質: SNR 20dB以上

**例外処理**:
- マイク権限拒否時: 権限要求ダイアログ再表示
- ストレージ不足時: ユーザーへの警告表示

---

#### FR-102: オンデバイス文字起こし

**概要**: Apple SpeechAnalyzerを使用してiPad上で音声を文字起こしする

**入力**:
- 音声チャンク（WAVファイル）
- 言語設定（日本語）

**処理**:
1. SpeechAnalyzerの初期化
2. 日本語言語モデルのダウンロード確認（初回のみ）
3. 音声ファイルの読み込み
4. 文字起こし実行
5. タイムスタンプ付きセグメント生成

**出力**:
```typescript
interface TranscriptionResult {
  text: string;
  segments: {
    text: string;
    startTime: number;
    endTime: number;
    confidence: number;
  }[];
  durationInSeconds: number;
}
```

**受け入れ基準**:
- [ ] 文字起こし精度: 95%以上（標準的な会話環境）
- [ ] 処理時間: 1分音声に対して10秒以内
- [ ] オフライン動作が可能
- [ ] セグメントごとにタイムスタンプが付与される

**依存関係**:
- iOS 26以上
- @react-native-ai/appleパッケージ

---

#### FR-103: 話者分離処理

**概要**: pyannote.audioを使用して美容師とお客様の発話を分離する

**入力**:
- 音声チャンク（WAVファイル）
- セッションID
- 想定話者数: 2名

**処理**:
1. 音声ファイルをpyannoteサーバーにアップロード
2. 話者分離処理実行
3. 発話時間に基づく役割推定（発話量が多い方を美容師と推定）
4. 結果をデータベースに保存

**出力**:
```typescript
interface DiarizationResult {
  sessionId: string;
  segments: {
    role: 'stylist' | 'customer';
    startTime: number;
    endTime: number;
    speakerLabel: string;
  }[];
}
```

**受け入れ基準**:
- [ ] 話者分離精度: 90%以上（DER 10%未満）
- [ ] 処理時間: 1時間音声に対して5分以内
- [ ] 2話者の識別が正確に行われる

**設定パラメータ**:
| パラメータ | 値 | 説明 |
|-----------|-----|------|
| num_speakers | 2 | 想定話者数 |
| min_duration | 0.5 | 最小発話長（秒） |

---

#### FR-201: トーク比率分析

**概要**: 美容師とお客様の発話時間比率を計算・評価する

**入力**:
- 話者分離結果（DiarizationResult）

**処理**:
1. 美容師の総発話時間を計算
2. お客様の総発話時間を計算
3. 比率を計算
4. 理想値（40:60）との比較による評価

**出力**:
```typescript
interface TalkRatioAnalysis {
  stylistPercent: number;      // 美容師の発話比率（%）
  customerPercent: number;     // お客様の発話比率（%）
  judgment: 'excellent' | 'good' | 'needs_improvement';
  comment: string;
}
```

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 美容師35-45% かつ お客様55-65% |
| good | 美容師30-50% かつ お客様50-70% |
| needs_improvement | 上記以外 |

**受け入れ基準**:
- [ ] 比率が正確に計算される（誤差1%以内）
- [ ] 評価判定が正しく行われる
- [ ] 日本語でのコメントが生成される

---

#### FR-202: 質問分析

**概要**: 美容師の質問を検出し、オープン質問とクローズド質問の比率を分析する

**入力**:
- 美容師の発話テキスト一覧

**処理**:
1. 質問文の検出（「？」「か」で終わる文）
2. オープン質問の分類（「どう」「何」「どんな」等で始まる）
3. クローズド質問の分類（「〜ですか？」「〜しますか？」等）
4. 比率計算と評価

**出力**:
```typescript
interface QuestionAnalysis {
  totalCount: number;          // 質問総数
  openCount: number;           // オープン質問数
  closedCount: number;         // クローズド質問数
  openRatio: number;           // オープン質問比率（%）
  judgment: 'excellent' | 'good' | 'needs_improvement';
  examples: {
    open: string[];            // オープン質問例
    closed: string[];          // クローズド質問例
  };
}
```

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 質問8-12回 かつ オープン比率60%以上 |
| good | 質問6-15回 かつ オープン比率40%以上 |
| needs_improvement | 上記以外 |

**オープン質問の判定キーワード**:
- 「どう」「どのように」「どんな」
- 「何」「なに」
- 「いつ」「どこ」「誰」「なぜ」

---

#### FR-203: 感情分析

**概要**: お客様の発話から感情の傾向を分析する

**入力**:
- お客様の発話テキスト一覧

**処理**:
1. 肯定的キーワードの検出
2. 否定的キーワードの検出
3. 比率計算
4. 感情傾向の評価

**出力**:
```typescript
interface EmotionAnalysis {
  positiveRatio: number;       // 肯定的比率（%）
  detectedKeywords: {
    positive: string[];        // 検出した肯定的キーワード
    negative: string[];        // 検出した否定的キーワード
  };
  judgment: 'excellent' | 'good' | 'needs_improvement';
  overallSentiment: 'positive' | 'neutral' | 'negative';
}
```

**キーワード辞書**:

肯定的キーワード:
- 「いいですね」「素敵」「嬉しい」「楽しみ」「気に入った」
- 「ありがとう」「助かる」「さすが」「きれい」「かわいい」

否定的キーワード:
- 「困る」「嫌」「ちょっと」「微妙」「心配」
- 「痛い」「不安」「高い」「面倒」「難しい」

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 肯定比率70%以上 |
| good | 肯定比率50%以上 |
| needs_improvement | 肯定比率50%未満 |

---

#### FR-204: 悩みキーワード検出

**概要**: お客様が発した髪の悩みに関するキーワードを検出する

**入力**:
- お客様の発話テキスト一覧

**処理**:
1. 悩みキーワード辞書との照合
2. キーワードの出現位置（タイムスタンプ）の記録
3. カテゴリ分類

**出力**:
```typescript
interface ConcernKeywordResult {
  keywords: {
    keyword: string;           // 検出キーワード
    category: string;          // カテゴリ
    timestamp: number;         // 検出時刻（秒）
    context: string;           // 前後の文脈
  }[];
  categories: string[];        // 検出されたカテゴリ一覧
}
```

**悩みキーワード辞書**:

| カテゴリ | キーワード |
|---------|-----------|
| 乾燥・パサつき | 乾燥、パサパサ、パサつき、ツヤがない |
| 広がり・まとまり | 広がる、まとまらない、ボサボサ、うねり |
| ダメージ | 傷み、切れ毛、枝毛、ダメージ |
| 白髪 | 白髪、グレイヘア、染まりにくい |
| 薄毛・抜け毛 | 薄い、抜け毛、ボリュームがない |
| スタイリング | 朝大変、セットが持たない、崩れる |
| 頭皮 | 頭皮、かゆい、フケ、べたつき |

---

#### FR-301: リアルタイムスコア表示

**概要**: 施術中にiPad上でリアルタイムにスコアを表示する

**入力**:
- 現在までの分析結果

**処理**:
1. 1分ごとのスコア再計算
2. UI更新
3. トレンド表示

**出力（UI表示項目）**:

| 表示項目 | 表示形式 | 更新頻度 |
|---------|---------|---------|
| 傾聴スコア（総合スコア） | 0-100点 + ゲージ | 1分 |
| 質問数 | 数値 | リアルタイム |
| 感情インジケータ | 😊 😐 😞 | 1分 |
| 経過時間 | mm:ss | リアルタイム |
| 悩みキーワード | タグ表示 | リアルタイム |

**受け入れ基準**:
- [ ] スコアがリアルタイムで更新される
- [ ] UIがスムーズに動作する（60fps維持）
- [ ] 施術の邪魔にならない控えめな表示

---

#### FR-302: 提案タイミング通知

**概要**: 悩みキーワード検出後、適切なタイミングで提案を促す通知を表示する

**入力**:
- 悩みキーワード検出結果
- 現在の会話状態

**処理**:
1. 悩みキーワード検出をトリガーとする
2. 検出後2-5分のタイミングを計測
3. 適切なタイミングで通知を生成
4. 関連する成功トーク例を取得

**出力**:
```typescript
interface ProposalNotification {
  type: 'proposal_timing';
  concernKeyword: string;      // 検出した悩み
  suggestedProduct: string;    // 提案推奨商品
  successTalkExample: string;  // 成功トーク例
  timing: 'now' | 'soon';      // タイミング
}
```

**通知UI**:
```
┌────────────────────────────────────────────┐
│ 🎯 提案チャンス！                           │
│                                            │
│ お客様が「乾燥」と発言しました              │
│                                            │
│ ▶ 保湿シャンプーを提案しましょう            │
│                                            │
│ 💡 成功トーク例：                           │
│ 「同じお悩みだった○○様は...」              │
└────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] 悩みキーワード検出後3分以内に通知が表示される
- [ ] 通知は施術の邪魔にならない形式である
- [ ] 通知を閉じることができる
- [ ] 成功トーク例が含まれる

---

#### FR-401: 成功事例登録

**概要**: 成約に成功したセッションを成功事例として登録する

**入力**:
- セッションID
- 成約情報（商品、金額）
- 成功要因（手動入力または自動抽出）

**処理**:
1. セッションデータの取得
2. 成功要因の抽出（Claude APIによる分析）
3. ベクトル埋め込みの生成
4. データベースへの登録

**出力**:
```typescript
interface SuccessCase {
  id: string;
  sessionId: string;
  salonId: string;
  stylistId: string;
  concernKeywords: string[];
  customerProfile: {
    ageGroup: string;
    visitFrequency: string;
  };
  successfulTalk: string;
  keyTactics: string[];
  soldProduct: string;
  conversionRate: number;
  embedding: number[];         // ベクトル埋め込み
  createdAt: Date;
}
```

**受け入れ基準**:
- [ ] 成約セッションが正しく登録される
- [ ] ベクトル埋め込みが生成される
- [ ] 成功要因が自動抽出される

---

#### FR-501: セッションレポート生成

**概要**: 施術終了後に詳細な分析レポートを生成する

**入力**:
- セッションID
- 全分析結果

**処理**:
1. 全分析データの集約
2. Claude APIによるレポート生成
3. 改善ポイントの抽出
4. アクションアイテムの生成
5. レポートの保存

**出力**:
```typescript
interface SessionReport {
  sessionId: string;
  generatedAt: Date;
  summary: {
    date: Date;
    duration: number;
    stylistName: string;
    overallScore: number;
  };
  analysis: {
    talkRatio: TalkRatioAnalysis;
    questions: QuestionAnalysis;
    emotion: EmotionAnalysis;
    concerns: ConcernKeywordResult;
    proposalTiming: ProposalTimingAnalysis;
    proposalQuality: ProposalQualityAnalysis;
    conversion: ConversionResult;
  };
  goodPoints: string[];
  improvementPoints: string[];
  actionItems: string[];
  similarSuccessCases: SuccessCase[];
}
```

**レポート形式**:
- 総合スコア（0-100点）
- 7つの指標の詳細分析
- 良かった点（3-5項目）
- 改善点（2-3項目）
- 次回へのアクションアイテム（3項目）
- 類似成功事例（1-3件）

**受け入れ基準**:
- [ ] セッション終了後5分以内にレポートが生成される
- [ ] 全7指標の分析が含まれる
- [ ] 具体的な改善アドバイスが含まれる
- [ ] 日本語で自然な文章である

---

#### FR-601: AIロールプレイ

**概要**: Claude Sonnet 4.5がお客様役となり、トレーニングを実施する

**入力**:
- シナリオ選択
- ユーザーの発話

**処理**:
1. シナリオに基づくお客様キャラクター設定
2. ユーザー発話への応答生成
3. 会話の評価
4. フィードバック生成

**出力**:
```typescript
interface RoleplaySession {
  scenarioId: string;
  difficulty: 'beginner' | 'intermediate' | 'advanced';
  customerProfile: {
    age: number;
    concern: string;
    personality: string;
  };
  conversation: {
    role: 'user' | 'ai';
    text: string;
    timestamp: Date;
  }[];
  evaluation: {
    score: number;
    goodPoints: string[];
    improvementPoints: string[];
    modelAnswer: string;
  };
}
```

**シナリオ例**:

| 難易度 | シナリオ | 目標 |
|--------|---------|------|
| 初級 | 髪のパサつきを気にする25歳女性 | 基本的な提案練習 |
| 中級 | 「今使ってるシャンプーがある」と言う35歳女性 | 異議処理 |
| 上級 | 「価格が高い」と言う45歳女性 | 異議処理 + クロージング |

**受け入れ基準**:
- [ ] シナリオ選択が可能
- [ ] AIが自然な会話を行う
- [ ] 終了後に評価とフィードバックが提供される
- [ ] モデル回答が提示される

---

#### FR-701: スタッフ一覧・管理

**概要**: 店舗内のスタッフを一覧表示し、管理する

**入力**:
- 店舗ID

**処理**:
1. 店舗に紐づくスタッフの取得
2. 各スタッフの基本情報・統計の集計
3. 一覧表示

**出力**:
```typescript
interface StaffListItem {
  id: string;
  name: string;
  role: 'stylist' | 'assistant' | 'receptionist';
  joinDate: Date;
  profileImage?: string;
  stats: {
    totalSessions: number;
    averageScore: number;
    conversionRate: number;
    lastSessionDate: Date;
  };
}
```

**画面項目**:
| 項目 | 説明 |
|------|------|
| プロフィール画像 | スタッフの顔写真 |
| 氏名 | スタッフ名 |
| 役職 | スタイリスト/アシスタント等 |
| 入社日 | 入社日 |
| 総セッション数 | これまでの分析セッション数 |
| 平均スコア | 総合スコアの平均 |
| 成約率 | 店販成約率 |

**受け入れ基準**:
- [ ] 全スタッフが一覧表示される
- [ ] スタッフの検索・フィルタが可能
- [ ] スタッフ詳細画面への遷移が可能
- [ ] 新規スタッフの追加が可能

---
