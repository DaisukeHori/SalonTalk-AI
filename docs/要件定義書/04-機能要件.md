## 4. 機能要件

### 4.1 機能要件一覧

#### FR-100: 音声処理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-101 | リアルタイム音声取得 | 必須 | 1 |
| FR-102 | オンデバイス文字起こし | 必須 | 1 |
| FR-103 | 話者分離処理 | 必須 | 1 |
| FR-104 | 音声チャンク送信 | 必須 | 1 |
| FR-105 | 文字起こし結果保存 | 必須 | 1 |

#### FR-200: AI分析機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-201 | トーク比率分析 | 必須 | 1 |
| FR-202 | 質問分析 | 必須 | 1 |
| FR-203 | 感情分析 | 必須 | 1 |
| FR-204 | 悩みキーワード検出 | 必須 | 1 |
| FR-205 | 提案タイミング分析 | 必須 | 2 |
| FR-206 | 提案品質分析 | 必須 | 2 |
| FR-207 | 成約判定 | 必須 | 2 |
| FR-208 | 総合スコアリング | 必須 | 2 |

#### FR-300: リアルタイムアシスト機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-301 | リアルタイムスコア表示 | 必須 | 1 |
| FR-302 | 提案タイミング通知 | 必須 | 2 |
| FR-303 | 成功トーク提案 | 必須 | 2 |
| FR-304 | アラート表示 | 任意 | 3 |

#### FR-400: 成功事例マッチング機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-401 | 成功事例登録 | 必須 | 2 |
| FR-402 | ベクトル埋め込み生成 | 必須 | 2 |
| FR-403 | 類似事例検索 | 必須 | 2 |
| FR-404 | 成功事例表示 | 必須 | 2 |

#### FR-500: レポート機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-501 | セッションレポート生成 | 必須 | 1 |
| FR-502 | 改善ポイント提示 | 必須 | 1 |
| FR-503 | アクションアイテム生成 | 必須 | 2 |
| FR-504 | レポート履歴管理 | 必須 | 2 |
| FR-505 | レポートエクスポート | 任意 | 3 |

#### FR-600: 教育・トレーニング機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-601 | AIロールプレイ | 必須 | 3 |
| FR-602 | シナリオ選択 | 必須 | 3 |
| FR-603 | ロールプレイ評価 | 必須 | 3 |
| FR-604 | ベストプラクティスDB | 必須 | 3 |
| FR-605 | ゲーミフィケーション | 任意 | 3 |

#### FR-700: 管理ダッシュボード機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-701 | スタッフ一覧・管理 | 必須 | 1 |
| FR-702 | スタッフ別分析 | 必須 | 2 |
| FR-703 | 店舗全体分析 | 必須 | 2 |
| FR-704 | 期間比較分析 | 必須 | 2 |
| FR-705 | 複数店舗統合分析 | 任意 | 3 |

#### FR-800: 認証・アカウント管理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-801 | ユーザー認証 | 必須 | 1 |
| FR-802 | ロールベースアクセス制御 | 必須 | 1 |
| FR-803 | 店舗アカウント管理 | 必須 | 1 |
| FR-804 | スタッフ招待・管理 | 必須 | 1 |
| FR-805 | パスワードリセット | 必須 | 1 |

---

### 4.2 機能要件詳細

#### FR-101: リアルタイム音声取得

**概要**: iPadのマイクから施術中の会話音声を継続的に取得する

**入力**:
- iPadのマイクからの音声ストリーム
- サンプリングレート: 16kHz
- チャンネル: モノラル

**処理**:
1. マイクアクセス権限の確認・要求
2. AVAudioEngineによる音声キャプチャ開始
3. 1分間隔での音声チャンク分割
4. WAV形式での一時保存

**出力**:
- 1分間の音声チャンク（WAVファイル）

**受け入れ基準**:
- [ ] マイク権限取得のUIが表示される
- [ ] 施術開始ボタンタップで録音が開始される
- [ ] バックグラウンドでも録音が継続する
- [ ] 1分ごとに音声チャンクが生成される
- [ ] 音声品質: SNR 20dB以上

**例外処理**:
- マイク権限拒否時: 権限要求ダイアログ再表示
- ストレージ不足時: ユーザーへの警告表示

---

#### FR-102: オンデバイス文字起こし

**概要**: Apple SpeechAnalyzerを使用してiPad上で音声を文字起こしする

**入力**:
- 音声チャンク（WAVファイル）
- 言語設定（日本語）

**処理**:
1. SpeechAnalyzerの初期化
2. 日本語言語モデルのダウンロード確認（初回のみ）
3. 音声ファイルの読み込み
4. 文字起こし実行
5. タイムスタンプ付きセグメント生成

**出力**:
```typescript
interface TranscriptionResult {
  text: string;
  segments: {
    text: string;
    startTime: number;
    endTime: number;
    confidence: number;
  }[];
  durationInSeconds: number;
}
```

**受け入れ基準**:
- [ ] 文字起こし精度: 95%以上（標準的な会話環境）
- [ ] 処理時間: 1分音声に対して10秒以内
- [ ] オフライン動作が可能
- [ ] セグメントごとにタイムスタンプが付与される

**依存関係**:
- iOS 26以上
- @react-native-ai/appleパッケージ

---

#### FR-103: 話者分離処理

**概要**: pyannote.audioを使用して美容師とお客様の発話を分離する

**入力**:
- 音声チャンク（WAVファイル）
- セッションID
- 想定話者数: 2名

**処理**:
1. 音声ファイルをpyannoteサーバーにアップロード
2. 話者分離処理実行
3. 発話時間に基づく役割推定（発話量が多い方を美容師と推定）
4. 結果をデータベースに保存

**出力**:
```typescript
interface DiarizationResult {
  sessionId: string;
  segments: {
    role: 'stylist' | 'customer';
    startTime: number;
    endTime: number;
    speakerLabel: string;
  }[];
}
```

**受け入れ基準**:
- [ ] 話者分離精度: 90%以上（DER 10%未満）
- [ ] 処理時間: 1時間音声に対して5分以内
- [ ] 2話者の識別が正確に行われる

**設定パラメータ**:
| パラメータ | 値 | 説明 |
|-----------|-----|------|
| num_speakers | 2 | 想定話者数 |
| min_duration | 0.5 | 最小発話長（秒） |

---

#### FR-201: トーク比率分析

**概要**: 美容師とお客様の発話時間比率を計算・評価する

**入力**:
- 話者分離結果（DiarizationResult）

**処理**:
1. 美容師の総発話時間を計算
2. お客様の総発話時間を計算
3. 比率を計算
4. 理想値（40:60）との比較による評価

**出力**:
```typescript
interface TalkRatioAnalysis {
  stylistPercent: number;      // 美容師の発話比率（%）
  customerPercent: number;     // お客様の発話比率（%）
  judgment: 'excellent' | 'good' | 'needs_improvement';
  comment: string;
}
```

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 美容師35-45% かつ お客様55-65% |
| good | 美容師30-50% かつ お客様50-70% |
| needs_improvement | 上記以外 |

**受け入れ基準**:
- [ ] 比率が正確に計算される（誤差1%以内）
- [ ] 評価判定が正しく行われる
- [ ] 日本語でのコメントが生成される

---

#### FR-202: 質問分析

**概要**: 美容師の質問を検出し、オープン質問とクローズド質問の比率を分析する

**入力**:
- 美容師の発話テキスト一覧

**処理**:
1. 質問文の検出（「？」「か」で終わる文）
2. オープン質問の分類（「どう」「何」「どんな」等で始まる）
3. クローズド質問の分類（「〜ですか？」「〜しますか？」等）
4. 比率計算と評価

**出力**:
```typescript
interface QuestionAnalysis {
  totalCount: number;          // 質問総数
  openCount: number;           // オープン質問数
  closedCount: number;         // クローズド質問数
  openRatio: number;           // オープン質問比率（%）
  judgment: 'excellent' | 'good' | 'needs_improvement';
  examples: {
    open: string[];            // オープン質問例
    closed: string[];          // クローズド質問例
  };
}
```

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 質問8-12回 かつ オープン比率60%以上 |
| good | 質問6-15回 かつ オープン比率40%以上 |
| needs_improvement | 上記以外 |

**オープン質問の判定キーワード**:
- 「どう」「どのように」「どんな」
- 「何」「なに」
- 「いつ」「どこ」「誰」「なぜ」

---

#### FR-203: 感情分析

**概要**: お客様の発話から感情の傾向を分析する

**入力**:
- お客様の発話テキスト一覧

**処理**:
1. 肯定的キーワードの検出
2. 否定的キーワードの検出
3. 比率計算
4. 感情傾向の評価

**出力**:
```typescript
interface EmotionAnalysis {
  positiveRatio: number;       // 肯定的比率（%）
  detectedKeywords: {
    positive: string[];        // 検出した肯定的キーワード
    negative: string[];        // 検出した否定的キーワード
  };
  judgment: 'excellent' | 'good' | 'needs_improvement';
  overallSentiment: 'positive' | 'neutral' | 'negative';
}
```

**キーワード辞書**:

肯定的キーワード:
- 「いいですね」「素敵」「嬉しい」「楽しみ」「気に入った」
- 「ありがとう」「助かる」「さすが」「きれい」「かわいい」

否定的キーワード:
- 「困る」「嫌」「ちょっと」「微妙」「心配」
- 「痛い」「不安」「高い」「面倒」「難しい」

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 肯定比率70%以上 |
| good | 肯定比率50%以上 |
| needs_improvement | 肯定比率50%未満 |

---

#### FR-204: 悩みキーワード検出

**概要**: お客様が発した髪の悩みに関するキーワードを検出する

**入力**:
- お客様の発話テキスト一覧

**処理**:
1. 悩みキーワード辞書との照合
2. キーワードの出現位置（タイムスタンプ）の記録
3. カテゴリ分類

**出力**:
```typescript
interface ConcernKeywordResult {
  keywords: {
    keyword: string;           // 検出キーワード
    category: string;          // カテゴリ
    timestamp: number;         // 検出時刻（秒）
    context: string;           // 前後の文脈
  }[];
  categories: string[];        // 検出されたカテゴリ一覧
}
```

**悩みキーワード辞書**:

| カテゴリ | キーワード |
|---------|-----------|
| 乾燥・パサつき | 乾燥、パサパサ、パサつき、ツヤがない |
| 広がり・まとまり | 広がる、まとまらない、ボサボサ、うねり |
| ダメージ | 傷み、切れ毛、枝毛、ダメージ |
| 白髪 | 白髪、グレイヘア、染まりにくい |
| 薄毛・抜け毛 | 薄い、抜け毛、ボリュームがない |
| スタイリング | 朝大変、セットが持たない、崩れる |
| 頭皮 | 頭皮、かゆい、フケ、べたつき |

---

#### FR-301: リアルタイムスコア表示

**概要**: 施術中にiPad上でリアルタイムにスコアを表示する

**入力**:
- 現在までの分析結果

**処理**:
1. 1分ごとのスコア再計算
2. UI更新
3. トレンド表示

**出力（UI表示項目）**:

| 表示項目 | 表示形式 | 更新頻度 |
|---------|---------|---------|
| 傾聴スコア（総合スコア） | 0-100点 + ゲージ | 1分 |
| 質問数 | 数値 | リアルタイム |
| 感情インジケータ | 😊 😐 😞 | 1分 |
| 経過時間 | mm:ss | リアルタイム |
| 悩みキーワード | タグ表示 | リアルタイム |

**受け入れ基準**:
- [ ] スコアがリアルタイムで更新される
- [ ] UIがスムーズに動作する（60fps維持）
- [ ] 施術の邪魔にならない控えめな表示

---

#### FR-302: 提案タイミング通知

**概要**: 悩みキーワード検出後、適切なタイミングで提案を促す通知を表示する

**入力**:
- 悩みキーワード検出結果
- 現在の会話状態

**処理**:
1. 悩みキーワード検出をトリガーとする
2. 検出後2-5分のタイミングを計測
3. 適切なタイミングで通知を生成
4. 関連する成功トーク例を取得

**出力**:
```typescript
interface ProposalNotification {
  type: 'proposal_timing';
  concernKeyword: string;      // 検出した悩み
  suggestedProduct: string;    // 提案推奨商品
  successTalkExample: string;  // 成功トーク例
  timing: 'now' | 'soon';      // タイミング
}
```

**通知UI**:
```
┌────────────────────────────────────────────┐
│ 🎯 提案チャンス！                           │
│                                            │
│ お客様が「乾燥」と発言しました              │
│                                            │
│ ▶ 保湿シャンプーを提案しましょう            │
│                                            │
│ 💡 成功トーク例：                           │
│ 「同じお悩みだった○○様は...」              │
└────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] 悩みキーワード検出後3分以内に通知が表示される
- [ ] 通知は施術の邪魔にならない形式である
- [ ] 通知を閉じることができる
- [ ] 成功トーク例が含まれる

---

#### FR-401: 成功事例登録

**概要**: 成約に成功したセッションを成功事例として登録する

**入力**:
- セッションID
- 成約情報（商品、金額）
- 成功要因（手動入力または自動抽出）

**処理**:
1. セッションデータの取得
2. 成功要因の抽出（Claude APIによる分析）
3. ベクトル埋め込みの生成
4. データベースへの登録

**出力**:
```typescript
interface SuccessCase {
  id: string;
  sessionId: string;
  salonId: string;
  stylistId: string;
  concernKeywords: string[];
  customerProfile: {
    ageGroup: string;
    visitFrequency: string;
  };
  successfulTalk: string;
  keyTactics: string[];
  soldProduct: string;
  conversionRate: number;
  embedding: number[];         // ベクトル埋め込み
  createdAt: Date;
}
```

**受け入れ基準**:
- [ ] 成約セッションが正しく登録される
- [ ] ベクトル埋め込みが生成される
- [ ] 成功要因が自動抽出される

---

#### FR-501: セッションレポート生成

**概要**: 施術終了後に詳細な分析レポートを生成する

**入力**:
- セッションID
- 全分析結果

**処理**:
1. 全分析データの集約
2. Claude APIによるレポート生成
3. 改善ポイントの抽出
4. アクションアイテムの生成
5. レポートの保存

**出力**:
```typescript
interface SessionReport {
  sessionId: string;
  generatedAt: Date;
  summary: {
    date: Date;
    duration: number;
    stylistName: string;
    overallScore: number;
  };
  analysis: {
    talkRatio: TalkRatioAnalysis;
    questions: QuestionAnalysis;
    emotion: EmotionAnalysis;
    concerns: ConcernKeywordResult;
    proposalTiming: ProposalTimingAnalysis;
    proposalQuality: ProposalQualityAnalysis;
    conversion: ConversionResult;
  };
  goodPoints: string[];
  improvementPoints: string[];
  actionItems: string[];
  similarSuccessCases: SuccessCase[];
}
```

**レポート形式**:
- 総合スコア（0-100点）
- 7つの指標の詳細分析
- 良かった点（3-5項目）
- 改善点（2-3項目）
- 次回へのアクションアイテム（3項目）
- 類似成功事例（1-3件）

**受け入れ基準**:
- [ ] セッション終了後5分以内にレポートが生成される
- [ ] 全7指標の分析が含まれる
- [ ] 具体的な改善アドバイスが含まれる
- [ ] 日本語で自然な文章である

---

#### FR-601: AIロールプレイ

**概要**: Claude Sonnet 4.5がお客様役となり、トレーニングを実施する

**入力**:
- シナリオ選択
- ユーザーの発話

**処理**:
1. シナリオに基づくお客様キャラクター設定
2. ユーザー発話への応答生成
3. 会話の評価
4. フィードバック生成

**出力**:
```typescript
interface RoleplaySession {
  scenarioId: string;
  difficulty: 'beginner' | 'intermediate' | 'advanced';
  customerProfile: {
    age: number;
    concern: string;
    personality: string;
  };
  conversation: {
    role: 'user' | 'ai';
    text: string;
    timestamp: Date;
  }[];
  evaluation: {
    score: number;
    goodPoints: string[];
    improvementPoints: string[];
    modelAnswer: string;
  };
}
```

**シナリオ例**:

| 難易度 | シナリオ | 目標 |
|--------|---------|------|
| 初級 | 髪のパサつきを気にする25歳女性 | 基本的な提案練習 |
| 中級 | 「今使ってるシャンプーがある」と言う35歳女性 | 異議処理 |
| 上級 | 「価格が高い」と言う45歳女性 | 異議処理 + クロージング |

**受け入れ基準**:
- [ ] シナリオ選択が可能
- [ ] AIが自然な会話を行う
- [ ] 終了後に評価とフィードバックが提供される
- [ ] モデル回答が提示される

---

#### FR-701: スタッフ一覧・管理

**概要**: 店舗内のスタッフを一覧表示し、管理する

**入力**:
- 店舗ID

**処理**:
1. 店舗に紐づくスタッフの取得
2. 各スタッフの基本情報・統計の集計
3. 一覧表示

**出力**:
```typescript
interface StaffListItem {
  id: string;
  name: string;
  role: 'stylist' | 'assistant' | 'receptionist';
  joinDate: Date;
  profileImage?: string;
  stats: {
    totalSessions: number;
    averageScore: number;
    conversionRate: number;
    lastSessionDate: Date;
  };
}
```

**画面項目**:
| 項目 | 説明 |
|------|------|
| プロフィール画像 | スタッフの顔写真 |
| 氏名 | スタッフ名 |
| 役職 | スタイリスト/アシスタント等 |
| 入社日 | 入社日 |
| 総セッション数 | これまでの分析セッション数 |
| 平均スコア | 総合スコアの平均 |
| 成約率 | 店販成約率 |

**受け入れ基準**:
- [ ] 全スタッフが一覧表示される
- [ ] スタッフの検索・フィルタが可能
- [ ] スタッフ詳細画面への遷移が可能
- [ ] 新規スタッフの追加が可能

---

#### FR-900: 初回セットアップウィザード機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-901 | 店舗初回セットアップ（Web） | 必須 | 1 |
| FR-902 | スタッフ初回セットアップ（iPad） | 必須 | 1 |
| FR-903 | セットアップ進捗管理 | 必須 | 1 |
| FR-904 | セットアップスキップ・後で設定 | 任意 | 1 |

#### FR-1000: 声紋識別（顧客識別）機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-1001 | 声紋（話者埋め込み）抽出 | 必須 | 2 |
| FR-1002 | 顧客声紋登録 | 必須 | 2 |
| FR-1003 | 顧客声紋マッチング | 必須 | 2 |
| FR-1004 | 顧客名抽出・設定 | 必須 | 2 |
| FR-1005 | 顧客識別結果表示 | 必須 | 2 |
| FR-1006 | 顧客情報管理 | 任意 | 3 |

---

### 4.3 初回セットアップウィザード詳細

#### FR-901: 店舗初回セットアップ（Web）

**概要**: オーナー/マネージャーが初回ログイン時に店舗の基本設定を行うウィザード

**トリガー条件**:
- 新規登録後の初回ログイン
- `salons.setup_completed = false` の場合

**ステップ構成**:

| ステップ | 画面名 | 必須 | 入力項目 |
|---------|--------|------|---------|
| 1 | ようこそ | - | （説明のみ） |
| 2 | 店舗情報 | 必須 | 店舗名、住所、電話番号、営業時間 |
| 3 | プラン選択 | 必須 | 料金プラン（Free/Standard/Premium） |
| 4 | スタッフ招待 | 任意 | メールアドレスによる招待（複数可） |
| 5 | プライバシー設定 | 必須 | 録音同意フロー設定、データ保持期間 |
| 6 | 完了 | - | セットアップ完了確認 |

**入力項目詳細**:

```typescript
interface SalonSetupData {
  // Step 2: 店舗情報
  salon_info: {
    name: string;              // 店舗名（必須）
    address?: string;          // 住所（任意）
    phone?: string;            // 電話番号（任意）
    business_hours?: {
      open: string;            // 開店時間 "09:00"
      close: string;           // 閉店時間 "21:00"
    };
  };

  // Step 3: プラン選択
  plan: 'free' | 'standard' | 'premium';

  // Step 4: スタッフ招待
  staff_invitations: {
    email: string;
    role: 'stylist' | 'manager';
  }[];

  // Step 5: プライバシー設定
  privacy_settings: {
    require_customer_consent: boolean;   // お客様同意必須
    consent_message?: string;            // 同意文言カスタマイズ
    data_retention_days: number;         // データ保持期間（日）
    auto_delete_audio: boolean;          // 音声自動削除
  };
}
```

**受け入れ基準**:
- [ ] 初回ログイン時に自動的にウィザードが開始される
- [ ] 各ステップで「戻る」「次へ」ナビゲーションが機能する
- [ ] 必須項目未入力時はエラー表示される
- [ ] プログレスバーで進捗が表示される
- [ ] 途中離脱しても進捗が保存される
- [ ] 完了後は `salons.setup_completed = true` に更新される
- [ ] 完了後はダッシュボードへ遷移する

---

#### FR-902: スタッフ初回セットアップ（iPad）

**概要**: スタイリストが初回ログイン時に個人設定を行うウィザード

**トリガー条件**:
- 招待リンクからの初回ログイン
- `staffs.setup_completed = false` の場合

**ステップ構成**:

| ステップ | 画面名 | 必須 | 入力項目 |
|---------|--------|------|---------|
| 1 | ようこそ | - | アプリ概要説明 |
| 2 | プロフィール設定 | 必須 | 表示名、プロフィール画像 |
| 3 | 権限許可 | 必須 | マイク権限、通知権限 |
| 4 | 機能チュートリアル | 任意 | セッション機能の説明（スキップ可） |
| 5 | 完了 | - | セットアップ完了、最初のセッション開始促し |

**入力項目詳細**:

```typescript
interface StaffSetupData {
  // Step 2: プロフィール設定
  profile: {
    display_name: string;      // 表示名（必須）
    avatar_url?: string;       // プロフィール画像URL（任意）
  };

  // Step 3: 権限許可（デバイス側で処理）
  permissions: {
    microphone: boolean;       // マイク権限
    notifications: boolean;    // 通知権限
  };

  // Step 4: チュートリアル完了フラグ
  tutorial_completed: boolean;
}
```

**機能チュートリアル内容**:

1. **セッション開始方法**: 「施術開始」ボタンの説明
2. **リアルタイムスコア**: 傾聴スコア、質問数、感情の見方
3. **提案通知**: 悩み検出時の通知の使い方
4. **セッション終了**: レポート確認方法

**受け入れ基準**:
- [ ] 初回ログイン時に自動的にウィザードが開始される
- [ ] マイク権限許可のシステムダイアログが表示される
- [ ] 権限拒否時は再度許可を促すメッセージが表示される
- [ ] チュートリアルはスキップ可能
- [ ] 完了後は `staffs.setup_completed = true` に更新される
- [ ] 完了後はホーム画面へ遷移する

---

#### FR-903: セットアップ進捗管理

**概要**: セットアップの進捗状態を管理し、中断からの再開を可能にする

**データ構造**:

```typescript
interface SetupProgress {
  user_id: string;
  user_type: 'salon' | 'staff';
  current_step: number;
  completed_steps: number[];
  step_data: Record<string, unknown>;  // 各ステップの入力データ
  started_at: string;
  updated_at: string;
}
```

**処理**:
1. 各ステップ完了時にデータを自動保存
2. 中断時は最後に完了したステップまでの進捗を保持
3. 再ログイン時は中断したステップから再開

**受け入れ基準**:
- [ ] ブラウザ/アプリを閉じても進捗が保持される
- [ ] 再開時は最後のステップから継続できる
- [ ] 入力済みデータが復元される

---

#### FR-904: セットアップスキップ・後で設定

**概要**: 任意項目のスキップおよび後からの設定変更を可能にする

**スキップ可能項目**:

| 項目 | スキップ時のデフォルト値 |
|------|------------------------|
| 住所・電話番号 | 未設定 |
| 営業時間 | 未設定 |
| スタッフ招待 | 0名（後から設定画面で追加可能） |
| プロフィール画像 | デフォルトアバター |
| チュートリアル | 未完了（後からヘルプで確認可能） |

**後から設定可能な場所**:
- Web: 設定画面（Web-008）
- iPad: 設定画面（iPad-008）

**受け入れ基準**:
- [ ] 「スキップ」または「後で設定」ボタンが表示される
- [ ] スキップ時は次のステップへ進む
- [ ] スキップした項目は設定画面から後で入力可能
- [ ] 未設定項目がある場合は設定画面でリマインダー表示

---

### 4.4 声紋識別（顧客識別）機能詳細

#### FR-1001: 声紋（話者埋め込み）抽出

**概要**: pyannote.audioを使用して音声から話者の声紋（話者埋め込みベクトル）を抽出する

**入力**:
- 音声チャンク（WAVファイル）
- セッションID
- 話者ラベル（stylist / customer）

**処理**:
1. 話者分離結果から顧客の発話セグメントを特定
2. 顧客発話セグメントを結合（最低10秒以上推奨）
3. pyannote.audio の SpeakerEmbedding モデルで埋め込みベクトルを生成
4. 512次元のベクトルとして返却

**出力**:
```typescript
interface VoiceEmbeddingResult {
  session_id: string;
  speaker: 'stylist' | 'customer';
  embedding: number[];          // 512次元ベクトル
  duration_seconds: number;     // 抽出に使用した音声の長さ
  confidence: number;           // 信頼度スコア（0-1）
  extracted_at: string;
}
```

**技術仕様**:
| パラメータ | 値 | 説明 |
|-----------|-----|------|
| モデル | pyannote/embedding | 話者埋め込みモデル |
| 次元数 | 512 | 埋め込みベクトルの次元 |
| 最小音声長 | 10秒 | 信頼性のある埋め込みに必要な最小音声長 |
| 推奨音声長 | 30秒以上 | より高精度な埋め込みのための推奨音声長 |

**受け入れ基準**:
- [ ] 10秒以上の音声から埋め込みベクトルが生成される
- [ ] 埋め込みベクトルは512次元である
- [ ] 同一話者の異なる発話から生成された埋め込みの類似度が0.8以上
- [ ] 異なる話者の埋め込みの類似度が0.6未満

---

#### FR-1002: 顧客声紋登録

**概要**: 新規顧客の声紋をデータベースに登録する

**入力**:
- 声紋埋め込みベクトル（VoiceEmbeddingResult）
- 店舗ID
- 顧客情報（任意）

**処理**:
1. 既存顧客との声紋マッチングを実行（FR-1003）
2. マッチする顧客がいない場合、新規顧客として登録
3. 顧客IDを生成し、声紋埋め込みを保存
4. 関連セッションと紐付け

**出力**:
```typescript
interface CustomerRegistrationResult {
  customer_id: string;
  is_new_customer: boolean;
  matched_customer_id?: string;  // 既存顧客にマッチした場合
  match_confidence?: number;     // マッチング信頼度
  created_at: string;
}
```

**データ構造（customers テーブル）**:
```sql
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id),
  name TEXT,                              -- 顧客名（後から設定可能）
  voice_embedding VECTOR(512),            -- 声紋埋め込みベクトル
  embedding_updated_at TIMESTAMPTZ,       -- 埋め込み最終更新日時
  total_visits INTEGER DEFAULT 1,         -- 来店回数
  first_visit_at TIMESTAMPTZ DEFAULT NOW(),
  last_visit_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'::jsonb,     -- 追加情報（年齢層、性別等）
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**受け入れ基準**:
- [ ] 新規顧客の声紋が正しく保存される
- [ ] 既存顧客とのマッチング判定が行われる
- [ ] 顧客IDが一意に生成される
- [ ] 店舗ごとに顧客が分離される（マルチテナント対応）

---

#### FR-1003: 顧客声紋マッチング

**概要**: セッション開始時に顧客の声紋を既存データと照合し、リピーターを識別する

**入力**:
- 声紋埋め込みベクトル
- 店舗ID

**処理**:
1. 店舗内の全顧客の声紋埋め込みを取得
2. コサイン類似度で類似検索（pgvector）
3. 閾値以上の類似度を持つ顧客を候補として返却
4. 最も類似度の高い顧客を推定顧客として特定

**出力**:
```typescript
interface VoiceMatchResult {
  matched: boolean;
  customer_id?: string;
  customer_name?: string;
  similarity_score: number;      // 0-1のコサイン類似度
  confidence: 'high' | 'medium' | 'low';
  previous_visits: number;
  last_visit_at?: string;
  alternative_candidates: {
    customer_id: string;
    customer_name?: string;
    similarity_score: number;
  }[];
}
```

**マッチング閾値**:
| 信頼度 | 類似度範囲 | 動作 |
|--------|-----------|------|
| high | 0.85以上 | 自動的に顧客を特定 |
| medium | 0.75-0.85 | 候補として表示、確認を促す |
| low | 0.65-0.75 | 複数候補を表示、手動選択を促す |
| 不一致 | 0.65未満 | 新規顧客として扱う |

**pgvector 検索関数**:
```sql
CREATE OR REPLACE FUNCTION match_customer_by_voice(
  query_embedding VECTOR(512),
  salon_id_param UUID,
  match_threshold FLOAT DEFAULT 0.65,
  match_count INT DEFAULT 5
)
RETURNS TABLE (
  customer_id UUID,
  customer_name TEXT,
  similarity FLOAT,
  total_visits INTEGER,
  last_visit_at TIMESTAMPTZ
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    c.id,
    c.name,
    1 - (c.voice_embedding <=> query_embedding) AS similarity,
    c.total_visits,
    c.last_visit_at
  FROM customers c
  WHERE c.salon_id = salon_id_param
    AND c.voice_embedding IS NOT NULL
    AND 1 - (c.voice_embedding <=> query_embedding) > match_threshold
  ORDER BY c.voice_embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```

**受け入れ基準**:
- [ ] リピーターの識別精度が90%以上
- [ ] 検索応答時間が500ms以内
- [ ] 類似度スコアが正確に計算される
- [ ] 候補が複数ある場合は全て返却される

---

#### FR-1004: 顧客名抽出・設定

**概要**: 会話内容から顧客名を自動抽出、または手動で設定する

**入力**:
- セッションの会話トランスクリプト
- 顧客ID

**処理**:
1. Claude APIで会話から顧客名を抽出
2. 名前の候補を信頼度順にリスト化
3. 美容師の発話から呼びかけパターンを検出
4. 顧客の自己紹介を検出

**出力**:
```typescript
interface CustomerNameExtractionResult {
  extracted_names: {
    name: string;
    confidence: number;
    source: 'stylist_address' | 'customer_intro' | 'context';
    context: string;             // 抽出元の文脈
  }[];
  recommended_name?: string;     // 最も信頼度の高い名前
}
```

**名前抽出プロンプト**:
```
以下の美容室での会話トランスクリプトから、お客様の名前を抽出してください。

抽出ルール:
1. 美容師がお客様を呼ぶ際の名前（「○○さん」「○○様」）
2. お客様の自己紹介（「○○です」「○○といいます」）
3. 予約確認の際の名前

出力形式:
{
  "names": [
    {"name": "田中", "confidence": 0.95, "source": "stylist_address", "context": "田中さん、いつもありがとうございます"},
    ...
  ]
}

会話:
{transcript}
```

**手動設定UI**:
- セッション終了後のレポート画面から顧客名を設定可能
- リアルタイム表示パネルからも設定可能
- 過去のセッションから顧客情報を編集可能

**受け入れ基準**:
- [ ] 会話から顧客名が自動抽出される
- [ ] 複数候補がある場合はリスト表示される
- [ ] 手動での名前設定が可能
- [ ] 名前が設定されると以降のセッションで表示される

---

#### FR-1005: 顧客識別結果表示

**概要**: セッション中にリアルタイムで顧客識別結果を表示する

**入力**:
- 声紋マッチング結果（VoiceMatchResult）
- 顧客情報

**処理**:
1. セッション開始から60秒後に初回識別を実行
2. 識別結果をリアルタイムパネルに表示
3. リピーターの場合は過去の来店情報を表示
4. 新規顧客の場合はその旨を表示

**出力（UI表示項目）**:

| 表示項目 | リピーター | 新規顧客 |
|---------|-----------|---------|
| 顧客アイコン | 写真またはアバター | デフォルトアバター |
| 顧客名 | 設定済み名前 | 「新規のお客様」 |
| 来店回数 | 「X回目のご来店」 | 「初めてのご来店」 |
| 前回来店日 | 「前回: YYYY/MM/DD」 | - |
| 信頼度インジケータ | ●●●（高）/ ●●○（中）/ ●○○（低） | - |
| 確認ボタン | 「この方で合っていますか？」 | 「お名前を設定」 |

**UI モックアップ**:
```
┌─────────────────────────────────────────────┐
│ 👤 顧客識別                                 │
├─────────────────────────────────────────────┤
│ リピーターの場合:                           │
│ ┌─────┐                                     │
│ │ 👩  │ 田中様（3回目のご来店）             │
│ └─────┘ 前回: 2025/11/15                    │
│         信頼度: ●●● 高                      │
│                                             │
│ [✓ この方で合っています] [✗ 別の方です]     │
├─────────────────────────────────────────────┤
│ 新規顧客の場合:                             │
│ ┌─────┐                                     │
│ │ 👤  │ 新規のお客様                        │
│ └─────┘ 初めてのご来店                      │
│                                             │
│ [📝 お名前を設定する]                        │
└─────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] セッション開始後1分以内に識別結果が表示される
- [ ] リピーターの場合は過去の来店情報が表示される
- [ ] 識別結果の確認・修正が可能
- [ ] UIが施術の邪魔にならない

---

#### FR-1006: 顧客情報管理

**概要**: 登録済み顧客の情報を管理画面から閲覧・編集する

**入力**:
- 店舗ID

**処理**:
1. 店舗に紐づく全顧客を取得
2. 顧客情報の一覧表示
3. 顧客詳細の閲覧・編集

**出力（顧客一覧）**:
```typescript
interface CustomerListItem {
  customer_id: string;
  name?: string;
  total_visits: number;
  first_visit_at: string;
  last_visit_at: string;
  assigned_stylist?: string;     // 主な担当スタイリスト
  total_sessions: number;
  average_score?: number;        // 平均セッションスコア
}
```

**画面項目（顧客詳細）**:
| 項目 | 説明 |
|------|------|
| 顧客名 | 編集可能 |
| 来店履歴 | 日付、担当者、スコアの一覧 |
| 過去のセッション | セッションレポートへのリンク |
| 声紋情報 | 最終更新日時、再登録ボタン |
| メモ | 自由入力メモ欄 |
| 顧客メタデータ | 年齢層、性別、好み等 |

**受け入れ基準**:
- [ ] 顧客一覧が表示される
- [ ] 顧客名での検索が可能
- [ ] 来店回数、最終来店日でソート可能
- [ ] 顧客詳細画面で情報編集が可能
- [ ] 過去のセッションへ遷移可能

---
