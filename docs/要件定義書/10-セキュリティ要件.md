## 10. セキュリティ要件

### 10.1 認証・認可

#### SEC-A01: 認証方式

| 要件 | 仕様 |
|------|------|
| 認証プロバイダ | Supabase Auth |
| 認証方式 | メール/パスワード |
| トークン形式 | JWT（RS256） |
| トークン有効期限 | アクセストークン: 1時間、リフレッシュトークン: 7日 |
| MFA | 将来対応予定（Phase 3） |

#### SEC-A02: ロールベースアクセス制御（RBAC）

| ロール | 権限 |
|--------|------|
| owner | 全機能アクセス、店舗設定変更、スタッフ管理 |
| manager | スタッフ管理、レポート閲覧、分析閲覧 |
| stylist | 自身のセッション・レポートのみ |
| assistant | 閲覧のみ |

### 10.2 データ保護

#### SEC-D01: 暗号化

| 対象 | 方式 |
|------|------|
| 通信 | TLS 1.3 |
| データベース（保存時） | AES-256（Supabase標準） |
| バックアップ | AES-256 |

#### SEC-D02: 個人情報保護

```sql
-- 個人情報マスキング関数
CREATE OR REPLACE FUNCTION anonymize_text(input_text TEXT)
RETURNS TEXT AS $$
BEGIN
  -- 氏名パターンのマスキング
  input_text := regexp_replace(
    input_text, 
    '[一-龯ぁ-んァ-ヶー]{2,4}(さん|様|氏)', 
    '○○様', 
    'g'
  );
  
  -- 電話番号のマスキング
  input_text := regexp_replace(
    input_text,
    '\d{2,4}-\d{2,4}-\d{4}',
    '***-****-****',
    'g'
  );
  
  -- 郵便番号のマスキング
  input_text := regexp_replace(
    input_text,
    '\d{3}-\d{4}',
    '***-****',
    'g'
  );
  
  RETURN input_text;
END;
$$ LANGUAGE plpgsql;
```

#### SEC-D03: データ保持ポリシー

| データ種別 | 保持期間 | 削除方法 |
|-----------|---------|---------|
| 音声ファイル | 処理完了後即時削除 | 自動 |
| 文字起こしテキスト | 6年 | 自動（cron） |
| 分析結果 | 6年 | 自動（cron） |
| レポート | 6年 | 自動（cron） |
| ログ | 1年 | 自動 |

### 10.3 アクセス制御

#### SEC-AC01: Row Level Security

全テーブルにRLSを適用し、店舗単位でデータを分離する（7.3節参照）。

#### SEC-AC02: API レート制限

| エンドポイント | 制限 |
|--------------|------|
| 認証API | 10 req/min/IP |
| 一般API | 100 req/min/user |
| AI分析API | 20 req/min/user |

### 10.4 監査・ログ

#### SEC-L01: 監査ログ

| イベント | 記録内容 |
|---------|---------|
| ログイン/ログアウト | ユーザーID、日時、IPアドレス |
| データアクセス | ユーザーID、テーブル、アクション、日時 |
| 設定変更 | ユーザーID、変更内容、日時 |
| エラー | エラー詳細、スタックトレース |

#### SEC-L02: ログ保管

- **保管場所**: Supabase Logs + 外部保管（CloudWatch等）
- **保管期間**: 1年
- **アクセス権限**: システム管理者のみ

### 10.5 脆弱性対策

| 脅威 | 対策 |
|------|------|
| SQLインジェクション | パラメータ化クエリ、Supabase RPC |
| XSS | React自動エスケープ、CSP設定 |
| CSRF | SameSite Cookie、Originチェック |
| 中間者攻撃 | TLS 1.3必須、HSTS |

---
