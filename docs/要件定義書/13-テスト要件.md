## 13. テスト要件

### 13.1 テスト戦略

```
┌─────────────────────────────────────────────────────────────────┐
│                    テストピラミッド                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                         ┌───┐                                   │
│                        ╱ E2E ╲                                  │
│                       ╱───────╲                                 │
│                      ╱   10%   ╲                                │
│                     ╱───────────╲                               │
│                    ╱ Integration ╲                              │
│                   ╱───────────────╲                             │
│                  ╱      20%        ╲                            │
│                 ╱───────────────────╲                           │
│                ╱      Unit Tests     ╲                          │
│               ╱─────────────────────────╲                       │
│              ╱          70%              ╲                      │
│             └─────────────────────────────┘                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 13.2 テスト種別

#### 13.2.1 単体テスト

| 対象 | ツール | カバレッジ目標 |
|------|--------|--------------|
| React Nativeコンポーネント | Jest + React Native Testing Library | 80% |
| TypeScript関数 | Jest | 80% |
| Edge Functions | Deno Test | 80% |
| SQL関数 | pgTAP | 70% |

#### 13.2.2 統合テスト

| 対象 | ツール | 範囲 |
|------|--------|------|
| API統合 | Supertest + Jest | 全エンドポイント |
| DB統合 | Supabase Test Helpers | CRUD操作、RLS |
| 外部API統合 | Mock Service Worker | Claude、OpenAI |

#### 13.2.3 E2Eテスト

| 対象 | ツール | シナリオ数 |
|------|--------|-----------|
| Webダッシュボード | Playwright | 20シナリオ |
| iPadアプリ | Detox | 15シナリオ |

### 13.3 テストシナリオ（主要）

#### TS-001: セッション開始〜終了

**目的**: 基本的なセッションフローの動作確認

**前提条件**:
- スタイリストとしてログイン済み
- マイク権限許可済み

**手順**:
1. ホーム画面で「セッション開始」をタップ
2. お客様情報を入力
3. 録音開始を確認
4. 5分間会話を模擬
5. 「セッション終了」をタップ
6. レポート生成を確認

**期待結果**:
- セッションが正常に開始される
- リアルタイムスコアが表示される
- セッション終了後、5分以内にレポートが生成される

#### TS-002: 提案タイミング通知

**目的**: 悩みキーワード検出と通知の動作確認

**手順**:
1. セッションを開始
2. お客様役で「髪が乾燥してパサパサなんです」と発話
3. 通知表示を確認
4. 成功トーク例の内容を確認

**期待結果**:
- 「乾燥」「パサパサ」が悩みキーワードとして検出される
- 3分以内に提案通知が表示される
- 成功トーク例が表示される

#### TS-003: 成功事例検索

**目的**: ベクトル検索の精度確認

**手順**:
1. テスト用成功事例データを投入
2. 「乾燥、広がる」をキーワードに検索
3. 類似度スコアと結果を確認

**期待結果**:
- 類似度0.7以上の事例が返される
- 最も類似度の高い事例が先頭に表示される
- 応答時間が2秒以内

### 13.4 性能テスト

#### 13.4.1 負荷テスト

| テスト | 条件 | 目標 |
|--------|------|------|
| 同時セッション | 100セッション同時 | 応答3秒以内 |
| API負荷 | 100 req/s | エラー率 < 1% |
| DB負荷 | 1000クエリ/分 | 応答100ms以内 |

#### 13.4.2 長時間テスト

| テスト | 条件 | 目標 |
|--------|------|------|
| 連続稼働 | 24時間連続運用 | メモリリークなし |
| セッション長時間 | 3時間セッション | 正常動作 |

### 13.5 セキュリティテスト

| テスト | ツール | 頻度 |
|--------|--------|------|
| 脆弱性スキャン | OWASP ZAP | 月次 |
| 依存関係チェック | npm audit / Snyk | CI/CD毎 |
| ペネトレーションテスト | 外部委託 | 年次 |

---
