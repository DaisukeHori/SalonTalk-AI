## 6. システムアーキテクチャ

### 6.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           クライアント層                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────┐        ┌───────────────────────────────────┐ │
│  │    iPadアプリ          │        │    Webダッシュボード               │ │
│  │    (React Native)      │        │    (Next.js 14 + TypeScript)      │ │
│  │                        │        │                                   │ │
│  │  ┌─────────────────┐  │        │  ┌─────────────────────────────┐  │ │
│  │  │ SpeechAnalyzer   │  │        │  │ 管理者向けダッシュボード      │  │ │
│  │  │ (オンデバイス)    │  │        │  │ - スタッフ管理               │  │ │
│  │  └─────────────────┘  │        │  │ - 分析レポート               │  │ │
│  │  ┌─────────────────┐  │        │  │ - 店舗設定                   │  │ │
│  │  │ Realtime UI     │  │        │  └─────────────────────────────┘  │ │
│  │  └─────────────────┘  │        │                                   │ │
│  └───────────────────────┘        └───────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────┬─┘
                                                                        │
                                    HTTPS / WebSocket                   │
                                                                        │
┌───────────────────────────────────────────────────────────────────────┴─┐
│                           サービス層                                     │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Supabase (BaaS)                               │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │    │
│  │  │ Auth        │  │ Realtime    │  │ Edge Functions          │  │    │
│  │  │ (認証)       │  │ (WebSocket) │  │ (サーバーレス処理)        │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │    │
│  │  ┌─────────────┐  ┌─────────────────────────────────────────┐   │    │
│  │  │ Storage     │  │ PostgreSQL + pgvector                    │   │    │
│  │  │ (音声一時保存)│  │ (メインDB + ベクトル検索)                  │   │    │
│  │  └─────────────┘  └─────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │              外部AI/MLサービス                                    │    │
│  │  ┌─────────────────────┐  ┌─────────────────────────────────┐   │    │
│  │  │ pyannote Server     │  │ Anthropic Claude API            │   │    │
│  │  │ (話者分離)           │  │ (AI分析・レポート生成)            │   │    │
│  │  │                     │  │                                  │   │    │
│  │  │ - GPU: RTX 4060     │  │ - Model: Claude Sonnet 4.5      │   │    │
│  │  │ - Self-hosted       │  │ - Batch API / Streaming         │   │    │
│  │  └─────────────────────┘  └─────────────────────────────────┘   │    │
│  │  ┌─────────────────────┐  ┌─────────────────────────────────┐   │    │
│  │  │ OpenAI API          │  │ Qdrant Cloud (Optional)         │   │    │
│  │  │ (Embedding生成)      │  │ (大規模ベクトル検索)              │   │    │
│  │  │ text-embedding-3    │  │ 10万件以上時に検討               │   │    │
│  │  └─────────────────────┘  └─────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                        │
┌───────────────────────────────────────┴─────────────────────────────────┐
│                           インフラ層                                     │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Vercel                                        │    │
│  │  - Next.js ホスティング                                           │    │
│  │  - Edge Network (CDN)                                            │    │
│  │  - 自動スケーリング                                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    GPU VPS (pyannote用)                          │    │
│  │  - Provider: VAST.ai / AWS g4dn                                  │    │
│  │  - GPU: RTX 3060/4060 または T4                                   │    │
│  │  - Ubuntu 22.04                                                   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 データフロー図

#### 6.2.1 リアルタイム分析フロー

```
┌─────────┐    ┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│  iPad   │───▶│ SpeechAnalyzer │───▶│ テキスト保存   │───▶│ Supabase    │
│ (マイク) │    │ (オンデバイス)  │    │              │    │ Realtime    │
└─────────┘    └─────────────┘    └──────────────┘    └─────────────┘
                                         │
                                         ▼
                                  ┌──────────────┐
                                  │ 1分チャンク   │
                                  │ 音声ファイル  │
                                  └──────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    バックエンド処理                                   │
│                                                                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────┐ │
│  │ Supabase    │───▶│ pyannote    │───▶│ 話者分離結果             │ │
│  │ Storage     │    │ Server      │    │ (speaker_segments)       │ │
│  └─────────────┘    └─────────────┘    └─────────────────────────┘ │
│                                                │                    │
│                                                ▼                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              文字起こし + 話者分離 結合                        │   │
│  │              (transcript_with_speakers)                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                │                    │
│                                                ▼                    │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────┐ │
│  │ Claude API  │◀───│ 分析リクエスト │◀───│ Edge Function           │ │
│  │ (Sonnet 4.5)│    │             │    │ (analyze-session)        │ │
│  └─────────────┘    └─────────────┘    └─────────────────────────┘ │
│         │                                                          │
│         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              分析結果 (session_analysis)                       │   │
│  │              - トーク比率                                      │   │
│  │              - 質問分析                                        │   │
│  │              - 感情分析                                        │   │
│  │              - 悩みキーワード                                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                         │
                                         ▼
                              ┌──────────────────┐
                              │ Supabase Realtime │
                              │ (結果プッシュ)     │
                              └──────────────────┘
                                         │
                                         ▼
                              ┌──────────────────┐
                              │ iPad UI更新      │
                              │ (リアルタイムスコア)│
                              └──────────────────┘
```

#### 6.2.2 成功事例マッチングフロー

```
┌─────────────────┐
│ 悩みキーワード検出 │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    成功事例検索フロー                              │
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────────────────────────┐ │
│  │ シーン情報構築    │    │ 検索クエリ:                          │ │
│  │                  │───▶│ - 悩みキーワード: 乾燥, 広がる         │ │
│  │ - 悩みキーワード  │    │ - 年代: 30代                         │ │
│  │ - お客様属性     │    │ - 来店頻度: 月1回                     │ │
│  └─────────────────┘    └─────────────────────────────────────┘ │
│                                        │                        │
│                                        ▼                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    OpenAI Embedding API                      │ │
│  │                    text-embedding-3-small                    │ │
│  │                    → 1536次元ベクトル生成                     │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                        │                        │
│                                        ▼                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    pgvector / Qdrant                         │ │
│  │                    コサイン類似度検索                          │ │
│  │                    閾値: 0.7以上                              │ │
│  │                    最大: 5件                                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                        │                        │
│                                        ▼                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    成功事例結果                               │ │
│  │  [                                                           │ │
│  │    {                                                         │ │
│  │      similarity: 0.92,                                       │ │
│  │      successfulTalk: "同じお悩みだった○○様は...",             │ │
│  │      keyTactics: ["ベネフィット提示", "お客様の声活用"],        │ │
│  │      conversionRate: 0.78                                    │ │
│  │    },                                                        │ │
│  │    ...                                                       │ │
│  │  ]                                                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│ 通知表示 (iPad)  │
└─────────────────┘
```

### 6.3 コンポーネント図

#### 6.3.1 iPadアプリ コンポーネント

```
┌─────────────────────────────────────────────────────────────────┐
│                    SalonTalk iPad App                            │
│                    (React Native + TypeScript)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Presentation Layer                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │ │
│  │  │ SessionScreen│  │ ReportScreen │  │ TrainingScreen     │  │ │
│  │  │ (施術中画面) │  │ (レポート)   │  │ (トレーニング)       │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │ │
│  │  │ HomeScreen  │  │ SettingsScreen│ │ LoginScreen        │  │ │
│  │  │ (ホーム)     │  │ (設定)       │  │ (ログイン)          │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Business Logic Layer                      │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │                    Hooks                                 │ │ │
│  │  │  useSession    useTranscription    useAnalysis          │ │ │
│  │  │  useRealtime   useNotification     useAuth              │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │                    Stores (Zustand)                      │ │ │
│  │  │  sessionStore    userStore    notificationStore         │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Infrastructure Layer                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │ │
│  │  │ SpeechService│ │ SupabaseClient│ │ NotificationService│  │ │
│  │  │ (音声処理)   │  │ (API通信)    │  │ (通知管理)         │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │ │
│  │  ┌─────────────┐  ┌─────────────┐                          │ │
│  │  │ StorageService│ │ AudioService│                          │ │
│  │  │ (ローカル保存)│  │ (録音管理)  │                          │ │
│  │  └─────────────┘  └─────────────┘                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Native Modules                            │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │  @react-native-ai/apple (SpeechAnalyzer)                │ │ │
│  │  │  @react-native-community/audio (録音)                    │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.3.2 バックエンド コンポーネント

```
┌─────────────────────────────────────────────────────────────────┐
│                    Supabase Edge Functions                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Session Management                        │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ create-session   │  │ end-session                     │   │ │
│  │  │ セッション開始    │  │ セッション終了・レポート生成      │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Audio Processing                          │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ process-audio    │  │ trigger-diarization             │   │ │
│  │  │ 音声チャンク受信  │  │ 話者分離トリガー                 │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    AI Analysis                               │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ analyze-segment  │  │ generate-report                 │   │ │
│  │  │ セグメント分析    │  │ レポート生成                     │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ search-cases     │  │ roleplay-chat                   │   │ │
│  │  │ 成功事例検索     │  │ ロールプレイ会話                  │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Webhook Handlers                          │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ diarization-     │  │ stripe-webhook                  │   │ │
│  │  │ callback         │  │ 決済Webhook                      │   │ │
│  │  │ 話者分離完了通知  │  │                                  │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    pyannote Server (FastAPI)                     │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    API Endpoints                             │ │
│  │  POST /diarize/{session_id}  - 話者分離リクエスト             │ │
│  │  GET  /status/{session_id}   - 処理状況確認                   │ │
│  │  GET  /health                - ヘルスチェック                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Background Workers                        │ │
│  │  DiarizationWorker - pyannote.audio処理実行                  │ │
│  │  CallbackWorker    - 結果通知                                │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 6.4 デプロイメント図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Production Environment                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    Vercel (Web Hosting)                            │  │
│  │  Region: Tokyo (hnd1)                                              │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  Next.js Application                                        │  │  │
│  │  │  - Web Dashboard                                             │  │  │
│  │  │  - Landing Page                                              │  │  │
│  │  │  Instance: Pro Plan                                          │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    Supabase (BaaS)                                 │  │
│  │  Region: Tokyo (ap-northeast-1)                                    │  │
│  │  Plan: Pro ($25/month)                                             │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────┐   │  │
│  │  │ PostgreSQL   │  │ Auth         │  │ Realtime               │   │  │
│  │  │ + pgvector   │  │              │  │ (WebSocket)            │   │  │
│  │  │ 8GB RAM      │  │              │  │                        │   │  │
│  │  └──────────────┘  └──────────────┘  └────────────────────────┘   │  │
│  │  ┌──────────────┐  ┌──────────────────────────────────────────┐   │  │
│  │  │ Storage      │  │ Edge Functions (Deno)                     │   │  │
│  │  │ 100GB        │  │ 10+ functions                             │   │  │
│  │  └──────────────┘  └──────────────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    GPU VPS (VAST.ai / AWS)                        │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  pyannote Server                                            │  │  │
│  │  │  - GPU: RTX 4060 (8GB VRAM)                                 │  │  │
│  │  │  - RAM: 16GB                                                 │  │  │
│  │  │  - OS: Ubuntu 22.04                                          │  │  │
│  │  │  - Docker Container                                          │  │  │
│  │  │  Cost: ~$0.20/hour                                           │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    External APIs                                   │  │
│  │  ┌──────────────────────┐  ┌──────────────────────────────────┐   │  │
│  │  │ Anthropic Claude API │  │ OpenAI API                        │   │  │
│  │  │ claude-sonnet-4-5    │  │ text-embedding-3-small           │   │  │
│  │  └──────────────────────┘  └──────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    Apple App Store                                 │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  SalonTalk iPad App                                         │  │  │
│  │  │  - React Native (Expo)                                       │  │  │
│  │  │  - iOS 26+ required                                          │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---
