## 7. データモデル設計

### 7.1 ER図

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    salons       │       │    staffs       │       │    sessions     │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │───┐   │ id (PK)         │───┐   │ id (PK)         │
│ name            │   │   │ salon_id (FK)   │◀──┼───│ salon_id (FK)   │
│ address         │   │   │ name            │   │   │ stylist_id (FK) │◀──┐
│ phone           │   └──▶│ email           │   └──▶│ started_at      │   │
│ plan            │       │ role            │       │ ended_at        │   │
│ settings (JSON) │       │ avatar_url      │       │ status          │   │
│ created_at      │       │ is_active       │       │ customer_info   │   │
│ updated_at      │       │ created_at      │       │ diarization_sta │   │
└─────────────────┘       └─────────────────┘       └─────────────────┘   │
                                   │                        │             │
                     ┌─────────────┼─────────────┬──────────┤             │
                     │             │             │          │             │
                     ▼             ▼             ▼          ▼             │
          ┌──────────────┐ ┌───────────────┐ ┌──────────┐ ┌──────────────┐│
          │push_tokens   │ │roleplay_      │ │training_ │ │transcripts   ││
          ├──────────────┤ │sessions       │ │stats     │ ├──────────────┤│
          │ id (PK)      │ ├───────────────┤ ├──────────┤ │ id (PK)      ││
          │ staff_id (FK)│ │ id (PK)       │ │id (PK)   │ │ session_id   ││
          │ token        │ │ staff_id (FK) │ │staff_id  │ │ chunk_index  ││
          │ platform     │ │ scenario_id   │ │avg_score │ │ text         ││
          │ is_active    │ │ status        │ │highest   │ │ start_time_ms││
          └──────────────┘ │ messages      │ └──────────┘ └──────────────┘│
                           │ evaluation    │                              │
                           └───────┬───────┘       ┌──────────────────────┘
                                   │               │
                                   ▼               ▼
                          ┌───────────────┐ ┌──────────────┐
                          │ training_     │ │ speaker_     │
                          │ scenarios     │ │ segments     │
                          ├───────────────┤ ├──────────────┤
                          │ id (PK)       │ │ id (PK)      │
                          │ salon_id (FK) │ │ session_id   │
                          │ title         │ │ speaker      │
                          │ description   │ │ start_time_ms│
                          │ customer_pers │ │ text         │
                          │ difficulty    │ │ confidence   │
                          └───────────────┘ └──────────────┘

┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│session_analyses │       │ session_reports │       │ success_cases   │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │       │ id (PK)         │       │ id (PK)         │
│ session_id (FK) │       │ session_id (FK) │       │ salon_id (FK)   │
│ chunk_index     │       │ summary         │       │ session_id (FK) │
│ indicator_type  │       │ overall_score   │       │ stylist_id (FK) │
│ value           │       │ metrics (JSON)  │       │ concern_keywords│
│ score           │       │ stylist_ratio   │       │ approach_text   │
│ details (JSON)  │       │ improvements    │       │ result          │
│ created_at      │       │ strengths       │       │ embedding       │
└─────────────────┘       └─────────────────┘       │ is_public       │
                                                    └─────────────────┘

┌─────────────────┐
│notification_logs│
├─────────────────┤
│ id (PK)         │
│ staff_id (FK)   │
│ type            │
│ title           │
│ body            │
│ status          │
│ sent_at         │
└─────────────────┘
```

### 7.2 テーブル定義

#### 7.2.1 salons（店舗）

> ⚠️ **実装に合わせて修正（2025-12-05）**
>
> **旧定義:** ~~plan: 'standard', 'professional', 'enterprise'~~
>
> **新定義:** plan: 'free', 'standard', 'premium', 'enterprise'
>
> **理由:** 実装でfreeプラン追加、professionalをpremiumに改名（一般的な名称）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| name | varchar(100) | NO | - | 店舗名 |
| address | text | YES | - | 住所 |
| phone | varchar(20) | YES | - | 電話番号 |
| plan | varchar(20) | NO | 'free' | 契約プラン（free/standard/premium/enterprise） |
| seats_count | integer | YES | - | セット面数 |
| settings | jsonb | NO | '{}' | 設定情報 |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE salons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  address TEXT,
  phone VARCHAR(20),
  plan VARCHAR(20) NOT NULL DEFAULT 'free'
    CHECK (plan IN ('free', 'standard', 'premium', 'enterprise')),
  seats_count INTEGER,
  settings JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_salons_plan ON salons(plan);
```

#### 7.2.2 staffs（スタッフ）

> ⚠️ **実装に合わせて修正（2025-12-05）**
>
> **旧定義（削除）:**
> - ~~id: UUID PRIMARY KEY DEFAULT gen_random_uuid()~~（自動生成ID）
> - ~~auth_user_id: UUID REFERENCES auth.users(id)~~（別カラム）
> - ~~role: 'owner', 'manager', 'stylist', 'assistant'~~
>
> **新定義（実装と統一）:**
> - id = auth.users(id)（Supabase推奨パターン：スタッフIDと認証IDを同一に）
> - role: 'stylist', 'manager', 'owner', 'admin'
> - avatar_url追加（実装に存在）
>
> **理由:**
> - Supabase推奨パターン：ユーザーテーブルのIDをauth.usersと同一にする
> - シンプルな構造でJOIN不要
> - adminロールは管理者機能で必要

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | - | 主キー（= auth.users.id） |
| salon_id | uuid | NO | - | 所属店舗（FK） |
| name | varchar(50) | NO | - | 氏名 |
| email | varchar(255) | NO | - | メールアドレス |
| role | varchar(20) | NO | 'stylist' | 役割（stylist/manager/owner/admin/assistant） |
| avatar_url | text | YES | - | アバター画像URL |
| is_active | boolean | NO | true | アクティブフラグ |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE staffs (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'stylist'
    CHECK (role IN ('stylist', 'manager', 'owner', 'admin', 'assistant')),
  avatar_url TEXT,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (email)
);

-- インデックス
CREATE INDEX idx_staffs_salon_id ON staffs(salon_id);
CREATE INDEX idx_staffs_role ON staffs(role);
CREATE INDEX idx_staffs_is_active ON staffs(is_active);
```

#### 7.2.3 sessions（セッション）

> ⚠️ **実装に合わせて修正（2025-12-05）**
> - status: 'analyzing'追加、'failed'→'error'に変更
> - total_duration_ms追加

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| salon_id | uuid | NO | - | 店舗（FK） |
| stylist_id | uuid | NO | - | 担当スタイリスト（FK） |
| started_at | timestamptz | NO | now() | 開始日時 |
| ended_at | timestamptz | YES | - | 終了日時 |
| total_duration_ms | integer | YES | - | 合計時間（ミリ秒） |
| status | varchar(20) | NO | 'recording' | ステータス |
| customer_info | jsonb | YES | '{}' | お客様情報 |
| diarization_status | varchar(20) | YES | 'pending' | 話者分離ステータス |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  stylist_id UUID NOT NULL REFERENCES staffs(id) ON DELETE CASCADE,
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  total_duration_ms INTEGER,
  status VARCHAR(20) NOT NULL DEFAULT 'recording'
    CHECK (status IN ('recording', 'processing', 'analyzing', 'completed', 'error')),
  customer_info JSONB DEFAULT '{}',
  diarization_status VARCHAR(20) DEFAULT 'pending'
    CHECK (diarization_status IN ('pending', 'processing', 'completed', 'failed')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_sessions_salon_id ON sessions(salon_id);
CREATE INDEX idx_sessions_stylist_id ON sessions(stylist_id);
CREATE INDEX idx_sessions_status ON sessions(status);
CREATE INDEX idx_sessions_started_at ON sessions(started_at DESC);
```

#### 7.2.4 transcripts（文字起こし）

> **⚠️ 設計変更（2025-12-05）**
>
> 時間単位をミリ秒に統一、音声再生用URLを追加。
> 基本設計書・詳細設計書・実装コードとの整合性を確保。

**旧定義（廃止）:**

~~| カラム名 | 型 | NULL | デフォルト | 説明 |~~
~~|---------|-----|------|-----------|------|~~
~~| id | uuid | NO | gen_random_uuid() | 主キー |~~
~~| session_id | uuid | NO | - | セッション（FK） |~~
~~| text | text | NO | - | 文字起こしテキスト |~~
~~| start_time | numeric(10,3) | NO | - | 開始時間（秒） |~~
~~| end_time | numeric(10,3) | NO | - | 終了時間（秒） |~~
~~| confidence | numeric(5,4) | YES | - | 信頼度 |~~
~~| chunk_index | integer | NO | - | チャンク番号 |~~
~~| created_at | timestamptz | NO | now() | 作成日時 |~~

**新定義:**

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| chunk_index | integer | NO | - | チャンク番号 |
| text | text | NO | - | 文字起こしテキスト |
| start_time_ms | bigint | NO | - | 開始時間（ミリ秒） |
| end_time_ms | bigint | NO | - | 終了時間（ミリ秒） |
| audio_url | text | YES | - | 音声ファイルURL |
| confidence | numeric(5,4) | YES | - | 認識信頼度 |
| created_at | timestamptz | NO | now() | 作成日時 |

**変更理由:**
- `start_time`/`end_time` → `start_time_ms`/`end_time_ms`: 時間単位をミリ秒に統一（実装・speaker_segmentsに合わせる）
- `audio_url` 追加: 音声チャンクの再生・検証用（基本設計書に合わせる）
- `UNIQUE (session_id, chunk_index)` 追加: チャンク単位の一意性を担保

```sql
-- 旧SQL（廃止）
-- CREATE TABLE transcripts (
--   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
--   session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
--   text TEXT NOT NULL,
--   start_time NUMERIC(10, 3) NOT NULL,
--   end_time NUMERIC(10, 3) NOT NULL,
--   confidence NUMERIC(5, 4),
--   chunk_index INTEGER NOT NULL,
--   created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
-- );

-- 新SQL
CREATE TABLE transcripts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  text TEXT NOT NULL,
  start_time_ms BIGINT NOT NULL,
  end_time_ms BIGINT NOT NULL,
  audio_url TEXT,
  confidence NUMERIC(5, 4),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (session_id, chunk_index)
);

-- インデックス
CREATE INDEX idx_transcripts_session_id ON transcripts(session_id);
CREATE INDEX idx_transcripts_session_chunk ON transcripts(session_id, chunk_index);
```

#### 7.2.5 speaker_segments（話者セグメント）

> **⚠️ 設計変更（2025-12-05）**
>
> 時間単位をミリ秒に統一、話者識別失敗時のunknown対応を追加。
> 基本設計書・詳細設計書・実装コードとの整合性を確保。

**旧定義（廃止）:**

~~| カラム名 | 型 | NULL | デフォルト | 説明 |~~
~~|---------|-----|------|-----------|------|~~
~~| id | uuid | NO | gen_random_uuid() | 主キー |~~
~~| session_id | uuid | NO | - | セッション（FK） |~~
~~| role | varchar(20) | NO | - | 役割 |~~
~~| start_time | numeric(10,3) | NO | - | 開始時間（秒） |~~
~~| end_time | numeric(10,3) | NO | - | 終了時間（秒） |~~
~~| speaker_label | varchar(10) | YES | - | 話者ラベル |~~
~~| text | text | YES | - | テキスト（結合後） |~~
~~| created_at | timestamptz | NO | now() | 作成日時 |~~

**新定義:**

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| chunk_index | integer | NO | - | チャンク番号 |
| speaker | varchar(20) | NO | - | 話者 |
| start_time_ms | bigint | NO | - | 開始時間（ミリ秒） |
| end_time_ms | bigint | NO | - | 終了時間（ミリ秒） |
| text | text | YES | - | テキスト（結合後） |
| confidence | numeric(5,4) | YES | - | 話者識別の信頼度 |
| created_at | timestamptz | NO | now() | 作成日時 |

**変更理由:**
- `role` → `speaker`: 用語統一（基本設計書・詳細設計書・実装に合わせる）
- `'unknown'` 追加: pyannote話者分離失敗時のエッジケース対応
- `start_time`/`end_time` → `start_time_ms`/`end_time_ms`: 時間単位をミリ秒に統一（実装に合わせる）
- `chunk_index` 追加: チャンク単位の管理に対応
- `confidence` 追加: 話者識別の信頼度を保存（品質管理用）
- `speaker_label` 削除: `speaker`カラムに統合

```sql
-- 旧SQL（廃止）
-- CREATE TABLE speaker_segments (
--   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
--   session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
--   role VARCHAR(20) NOT NULL CHECK (role IN ('stylist', 'customer')),
--   start_time NUMERIC(10, 3) NOT NULL,
--   end_time NUMERIC(10, 3) NOT NULL,
--   speaker_label VARCHAR(10),
--   text TEXT,
--   created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
-- );

-- 新SQL
CREATE TABLE speaker_segments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  speaker VARCHAR(20) NOT NULL CHECK (speaker IN ('stylist', 'customer', 'unknown')),
  start_time_ms BIGINT NOT NULL,
  end_time_ms BIGINT NOT NULL,
  text TEXT,
  confidence NUMERIC(5, 4),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_speaker_segments_session_id ON speaker_segments(session_id);
CREATE INDEX idx_speaker_segments_speaker ON speaker_segments(session_id, speaker);
CREATE INDEX idx_speaker_segments_time ON speaker_segments(session_id, start_time_ms);
```

#### 7.2.6 session_analyses（セッション分析）

> **⚠️ 設計変更（2025-12-05）**
>
> リアルタイム分析に対応するため、チャンク単位での分析結果保存に変更。
> 基本設計書・詳細設計書との整合性を確保。

**旧定義（廃止）:**

~~| カラム名 | 型 | NULL | デフォルト | 説明 |~~
~~|---------|-----|------|-----------|------|~~
~~| id | uuid | NO | gen_random_uuid() | 主キー |~~
~~| session_id | uuid | NO | - | セッション（FK） |~~
~~| analysis_type | varchar(30) | NO | - | 分析タイプ |~~
~~| result | jsonb | NO | - | 分析結果 |~~
~~| created_at | timestamptz | NO | now() | 作成日時 |~~

**新定義:**

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| chunk_index | integer | NO | - | チャンク番号 |
| indicator_type | varchar(30) | NO | - | 指標種別 |
| value | numeric(10,4) | NO | - | 測定値 |
| score | integer | NO | - | スコア（0-100） |
| details | jsonb | YES | - | 詳細データ |
| created_at | timestamptz | NO | now() | 作成日時 |

**変更理由:**
- `chunk_index` 追加: 60秒チャンク単位でのリアルタイム分析に対応
- `analysis_type` → `indicator_type`: 用語統一（7つの評価指標に合わせる）
- `result` → `value` + `score` + `details`: 構造化データで検索・集計を効率化
- `UNIQUE` 制約変更: セッション×チャンク×指標の組み合わせで一意性を担保

```sql
-- 旧SQL（廃止）
-- CREATE TABLE session_analyses (
--   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
--   session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
--   analysis_type VARCHAR(30) NOT NULL
--     CHECK (analysis_type IN (
--       'talk_ratio', 'questions', 'emotion',
--       'concern_keywords', 'proposal_timing',
--       'proposal_quality', 'conversion'
--     )),
--   result JSONB NOT NULL,
--   created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
--   UNIQUE (session_id, analysis_type)
-- );

-- 新SQL
CREATE TABLE session_analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  indicator_type VARCHAR(30) NOT NULL
    CHECK (indicator_type IN (
      'talk_ratio', 'question_analysis', 'emotion_analysis',
      'concern_keywords', 'proposal_timing',
      'proposal_quality', 'conversion'
    )),
  value NUMERIC(10, 4) NOT NULL,
  score INTEGER NOT NULL CHECK (score >= 0 AND score <= 100),
  details JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (session_id, chunk_index, indicator_type)
);

-- インデックス
CREATE INDEX idx_session_analyses_session_id ON session_analyses(session_id);
CREATE INDEX idx_session_analyses_indicator ON session_analyses(indicator_type);
CREATE INDEX idx_session_analyses_session_chunk ON session_analyses(session_id, chunk_index);
```

#### 7.2.7 session_reports（セッションレポート）

> **⚠️ 設計変更（2025-12-05）**
>
> DBスキーマに合わせて詳細な分析カラムを明示的に定義。
> 7指標の詳細データを個別カラムで管理し、集計・検索を効率化。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK、UNIQUE） |
| summary | text | NO | - | セッション要約 |
| overall_score | integer | NO | - | 総合スコア（0-100） |
| metrics | jsonb | NO | '{}' | 7指標の詳細メトリクス |
| stylist_ratio | integer | YES | - | スタイリスト発話比率 |
| customer_ratio | integer | YES | - | お客様発話比率 |
| open_question_count | integer | YES | 0 | オープン質問数 |
| closed_question_count | integer | YES | 0 | クローズド質問数 |
| positive_ratio | integer | YES | - | ポジティブ感情比率 |
| concern_keywords | text[] | YES | '{}' | 検出された悩みキーワード |
| proposal_timing_ms | integer | YES | - | 提案タイミング（ミリ秒） |
| proposal_match_rate | integer | YES | - | 提案と悩みの適合率 |
| is_converted | boolean | YES | false | 成約フラグ |
| improvements | text[] | YES | '{}' | 改善点リスト |
| strengths | text[] | YES | '{}' | 良かった点リスト |
| matched_cases | jsonb | YES | '[]' | マッチした成功事例 |
| generated_at | timestamptz | NO | now() | レポート生成日時 |

```sql
CREATE TABLE session_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE UNIQUE,
  summary TEXT NOT NULL,
  overall_score INTEGER NOT NULL CHECK (overall_score >= 0 AND overall_score <= 100),
  metrics JSONB NOT NULL DEFAULT '{}',
  stylist_ratio INTEGER,
  customer_ratio INTEGER,
  open_question_count INTEGER DEFAULT 0,
  closed_question_count INTEGER DEFAULT 0,
  positive_ratio INTEGER,
  concern_keywords TEXT[] DEFAULT '{}',
  proposal_timing_ms INTEGER,
  proposal_match_rate INTEGER,
  is_converted BOOLEAN DEFAULT FALSE,
  improvements TEXT[] DEFAULT '{}',
  strengths TEXT[] DEFAULT '{}',
  matched_cases JSONB DEFAULT '[]',
  generated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_session_reports_session_id ON session_reports(session_id);
CREATE INDEX idx_session_reports_score ON session_reports(overall_score DESC);
```

#### 7.2.8 success_cases（成功事例）

> **⚠️ 設計変更（2025-12-05）**
>
> DBスキーマに合わせて全カラムを明示。approach_text/resultを必須化。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| salon_id | uuid | NO | - | 店舗（FK） |
| session_id | uuid | YES | - | 元セッション（FK、SET NULL） |
| stylist_id | uuid | YES | - | スタイリスト（FK、SET NULL） |
| concern_keywords | text[] | NO | - | 悩みキーワード（必須） |
| customer_profile | jsonb | YES | - | お客様プロファイル |
| approach_text | text | NO | - | アプローチ内容（必須） |
| successful_talk | text | YES | - | 成功トーク例 |
| key_tactics | text[] | YES | - | 成功要因・戦術 |
| result | text | NO | - | 結果・成果（必須） |
| sold_product | text | YES | - | 販売商品名 |
| conversion_rate | real | YES | - | 成約率 |
| embedding | vector(1536) | YES | - | ベクトル埋め込み |
| is_active | boolean | NO | true | アクティブフラグ |
| is_public | boolean | NO | false | 全店舗公開フラグ |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
-- pgvector拡張を有効化
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE success_cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
  stylist_id UUID REFERENCES staffs(id) ON DELETE SET NULL,
  concern_keywords TEXT[] NOT NULL,
  customer_profile JSONB,
  approach_text TEXT NOT NULL,
  successful_talk TEXT,
  key_tactics TEXT[],
  result TEXT NOT NULL,
  sold_product TEXT,
  conversion_rate REAL,
  embedding VECTOR(1536),
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  is_public BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- IVFFlatインデックス（ベクトル検索用）
CREATE INDEX idx_success_cases_embedding ON success_cases
  USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 100);

-- その他のインデックス
CREATE INDEX idx_success_cases_salon_id ON success_cases(salon_id);
CREATE INDEX idx_success_cases_active ON success_cases(is_active) WHERE is_active = TRUE;
CREATE INDEX idx_success_cases_public ON success_cases(is_public) WHERE is_public = TRUE;
CREATE INDEX idx_success_cases_concern ON success_cases USING GIN(concern_keywords);
```

#### 7.2.9 training_scenarios（トレーニングシナリオ）

> **新規追加（2025-12-05）**
>
> AIロールプレイ機能のシナリオマスターデータ。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| salon_id | uuid | YES | - | 店舗（FK、NULLの場合は全店舗共通） |
| title | text | NO | - | シナリオタイトル |
| description | text | NO | - | シナリオ説明 |
| customer_persona | jsonb | NO | - | お客様ペルソナ設定 |
| objectives | text[] | NO | - | 学習目標 |
| difficulty | text | NO | 'beginner' | 難易度（beginner/intermediate/advanced） |
| estimated_minutes | integer | NO | 10 | 想定所要時間（分） |
| is_active | boolean | NO | true | アクティブフラグ |
| created_at | timestamptz | NO | now() | 作成日時 |

```sql
CREATE TABLE training_scenarios (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID REFERENCES salons(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  customer_persona JSONB NOT NULL,
  objectives TEXT[] NOT NULL,
  difficulty TEXT NOT NULL DEFAULT 'beginner'
    CHECK (difficulty IN ('beginner', 'intermediate', 'advanced')),
  estimated_minutes INTEGER NOT NULL DEFAULT 10,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_training_scenarios_salon_id ON training_scenarios(salon_id);
CREATE INDEX idx_training_scenarios_difficulty ON training_scenarios(difficulty);
CREATE INDEX idx_training_scenarios_active ON training_scenarios(is_active);
```

#### 7.2.10 roleplay_sessions（ロールプレイセッション）

> **新規追加（2025-12-05）**
>
> スタッフのAIロールプレイ実施記録。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| staff_id | uuid | NO | - | スタッフ（FK） |
| scenario_id | uuid | NO | - | シナリオ（FK） |
| status | text | NO | 'in_progress' | ステータス（in_progress/completed/abandoned） |
| messages | jsonb | NO | '[]' | 会話履歴 |
| evaluation | jsonb | YES | - | 評価結果 |
| started_at | timestamptz | NO | now() | 開始日時 |
| ended_at | timestamptz | YES | - | 終了日時 |

```sql
CREATE TABLE roleplay_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  staff_id UUID NOT NULL REFERENCES staffs(id) ON DELETE CASCADE,
  scenario_id UUID NOT NULL REFERENCES training_scenarios(id) ON DELETE CASCADE,
  status TEXT NOT NULL DEFAULT 'in_progress'
    CHECK (status IN ('in_progress', 'completed', 'abandoned')),
  messages JSONB NOT NULL DEFAULT '[]'::jsonb,
  evaluation JSONB,
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMPTZ
);

-- インデックス
CREATE INDEX idx_roleplay_sessions_staff_id ON roleplay_sessions(staff_id);
CREATE INDEX idx_roleplay_sessions_scenario_id ON roleplay_sessions(scenario_id);
CREATE INDEX idx_roleplay_sessions_status ON roleplay_sessions(status);
```

#### 7.2.11 staff_training_stats（スタッフトレーニング統計）

> **新規追加（2025-12-05）**
>
> スタッフごとのトレーニング累積統計。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| staff_id | uuid | NO | - | スタッフ（FK、UNIQUE） |
| total_training_count | integer | NO | 0 | 累計トレーニング回数 |
| total_score_sum | integer | NO | 0 | スコア合計 |
| average_score | real | - | (生成列) | 平均スコア（自動計算） |
| highest_score | integer | YES | 0 | 最高スコア |
| last_training_at | timestamptz | YES | - | 最終トレーニング日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE staff_training_stats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  staff_id UUID NOT NULL REFERENCES staffs(id) ON DELETE CASCADE UNIQUE,
  total_training_count INTEGER NOT NULL DEFAULT 0,
  total_score_sum INTEGER NOT NULL DEFAULT 0,
  average_score REAL GENERATED ALWAYS AS (
    CASE WHEN total_training_count > 0
    THEN total_score_sum::REAL / total_training_count
    ELSE 0 END
  ) STORED,
  highest_score INTEGER DEFAULT 0,
  last_training_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### 7.2.12 push_tokens（プッシュ通知トークン）

> **新規追加（2025-12-05）**
>
> スタッフのプッシュ通知用デバイストークン管理。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| staff_id | uuid | NO | - | スタッフ（FK） |
| token | text | NO | - | プッシュ通知トークン |
| platform | text | NO | - | プラットフォーム（ios/android/web） |
| device_id | text | YES | - | デバイス識別子 |
| is_active | boolean | NO | true | アクティブフラグ |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE push_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  staff_id UUID NOT NULL REFERENCES staffs(id) ON DELETE CASCADE,
  token TEXT NOT NULL,
  platform TEXT NOT NULL CHECK (platform IN ('ios', 'android', 'web')),
  device_id TEXT,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_push_tokens_staff_id ON push_tokens(staff_id);
CREATE UNIQUE INDEX idx_push_tokens_unique ON push_tokens(staff_id, token);
```

#### 7.2.13 notification_logs（通知ログ）

> **新規追加（2025-12-05）**
>
> 送信した通知の履歴と配信ステータス管理。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| staff_id | uuid | NO | - | スタッフ（FK） |
| type | text | NO | - | 通知タイプ |
| title | text | NO | - | 通知タイトル |
| body | text | NO | - | 通知本文 |
| data | jsonb | YES | '{}' | 追加データ |
| status | text | NO | 'sent' | ステータス（sent/delivered/failed/read） |
| sent_at | timestamptz | NO | now() | 送信日時 |
| read_at | timestamptz | YES | - | 既読日時 |

```sql
CREATE TABLE notification_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  staff_id UUID NOT NULL REFERENCES staffs(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  body TEXT NOT NULL,
  data JSONB DEFAULT '{}',
  status TEXT NOT NULL DEFAULT 'sent'
    CHECK (status IN ('sent', 'delivered', 'failed', 'read')),
  sent_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  read_at TIMESTAMPTZ
);

-- インデックス
CREATE INDEX idx_notification_logs_staff_id ON notification_logs(staff_id);
CREATE INDEX idx_notification_logs_sent_at ON notification_logs(sent_at DESC);
```

### 7.3 Row Level Security（RLS）ポリシー

```sql
-- RLS有効化
ALTER TABLE salons ENABLE ROW LEVEL SECURITY;
ALTER TABLE staffs ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE transcripts ENABLE ROW LEVEL SECURITY;
ALTER TABLE speaker_segments ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE success_cases ENABLE ROW LEVEL SECURITY;

-- salonsポリシー（所属店舗のみアクセス可能）
-- 注: staffs.id = auth.users(id) パターン
CREATE POLICY "Users can view their salon" ON salons
  FOR SELECT USING (
    id = (
      SELECT salon_id FROM staffs
      WHERE id = auth.uid()
    )
  );

-- staffsポリシー（同一店舗のスタッフのみ閲覧可能）
CREATE POLICY "Users can view staff in their salon" ON staffs
  FOR SELECT USING (
    salon_id = (
      SELECT salon_id FROM staffs
      WHERE id = auth.uid()
    )
  );

-- sessionsポリシー（店舗データ分離）
CREATE POLICY "Sessions belong to salon" ON sessions
  FOR ALL USING (
    salon_id = (
      SELECT salon_id FROM staffs
      WHERE id = auth.uid()
    )
  );

-- transcriptsポリシー
CREATE POLICY "Transcripts belong to salon" ON transcripts
  FOR ALL USING (
    session_id IN (
      SELECT id FROM sessions
      WHERE salon_id = (
        SELECT salon_id FROM staffs
        WHERE id = auth.uid()
      )
    )
  );

-- success_casesポリシー（自店舗 or 公開事例）
CREATE POLICY "Success cases access" ON success_cases
  FOR SELECT USING (
    is_public = true
    OR salon_id = (
      SELECT salon_id FROM staffs
      WHERE id = auth.uid()
    )
  );

-- training_scenariosポリシー（共通 or 自店舗）
ALTER TABLE training_scenarios ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Training scenarios access" ON training_scenarios
  FOR SELECT USING (
    salon_id IS NULL  -- 共通シナリオ
    OR salon_id = (
      SELECT salon_id FROM staffs
      WHERE id = auth.uid()
    )
  );

-- roleplay_sessionsポリシー（自分のセッションのみ）
ALTER TABLE roleplay_sessions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Roleplay sessions access" ON roleplay_sessions
  FOR ALL USING (
    staff_id = auth.uid()
  );

-- staff_training_statsポリシー（自分の統計のみ）
ALTER TABLE staff_training_stats ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Training stats access" ON staff_training_stats
  FOR ALL USING (
    staff_id = auth.uid()
  );

-- push_tokensポリシー（自分のトークンのみ）
ALTER TABLE push_tokens ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Push tokens access" ON push_tokens
  FOR ALL USING (
    staff_id = auth.uid()
  );

-- notification_logsポリシー（自分の通知のみ）
ALTER TABLE notification_logs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Notification logs access" ON notification_logs
  FOR ALL USING (
    staff_id = auth.uid()
  );
```

---
