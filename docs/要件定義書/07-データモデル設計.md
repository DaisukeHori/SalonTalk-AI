## 7. データモデル設計

### 7.1 ER図

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    salons       │       │    staffs       │       │    sessions     │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │───┐   │ id (PK)         │───┐   │ id (PK)         │
│ name            │   │   │ salon_id (FK)   │◀──┼───│ salon_id (FK)   │
│ address         │   │   │ name            │   │   │ stylist_id (FK) │◀──┐
│ phone           │   └──▶│ email           │   └──▶│ started_at      │   │
│ plan            │       │ role            │       │ ended_at        │   │
│ created_at      │       │ created_at      │       │ status          │   │
│ settings (JSON) │       │ settings (JSON) │       │ customer_info   │   │
└─────────────────┘       └─────────────────┘       └─────────────────┘   │
                                   │                        │             │
                                   │                        │             │
                                   │               ┌────────┴───────┐    │
                                   │               │                │    │
                          ┌────────┴───────┐       ▼                ▼    │
                          │                │  ┌──────────────┐ ┌─────────┴────┐
                          ▼                │  │ transcripts  │ │ speaker_     │
                    ┌───────────────┐      │  ├──────────────┤ │ segments     │
                    │ session_      │      │  │ id (PK)      │ ├──────────────┤
                    │ analyses      │      │  │ session_id   │ │ id (PK)      │
                    ├───────────────┤      │  │ text         │ │ session_id   │
                    │ id (PK)       │      │  │ start_time   │ │ role         │
                    │ session_id    │◀─────┘  │ end_time     │ │ start_time   │
                    │ analysis_type │         │ confidence   │ │ end_time     │
                    │ result (JSON) │         │ created_at   │ │ speaker_label│
                    │ created_at    │         └──────────────┘ └──────────────┘
                    └───────────────┘
                          │
                          │
                          ▼
                    ┌───────────────┐       ┌─────────────────┐
                    │ session_      │       │ success_cases   │
                    │ reports       │       ├─────────────────┤
                    ├───────────────┤       │ id (PK)         │
                    │ id (PK)       │       │ salon_id (FK)   │
                    │ session_id    │       │ session_id (FK) │
                    │ overall_score │       │ concern_keywords│
                    │ good_points   │       │ successful_talk │
                    │ improvements  │       │ key_tactics     │
                    │ action_items  │       │ conversion_rate │
                    │ report_data   │       │ embedding       │
                    │ created_at    │       │ created_at      │
                    └───────────────┘       └─────────────────┘
```

### 7.2 テーブル定義

#### 7.2.1 salons（店舗）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| name | varchar(100) | NO | - | 店舗名 |
| address | text | YES | - | 住所 |
| phone | varchar(20) | YES | - | 電話番号 |
| plan | varchar(20) | NO | 'standard' | 契約プラン |
| seats_count | integer | NO | 10 | セット面数 |
| settings | jsonb | YES | '{}' | 設定情報 |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE salons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  address TEXT,
  phone VARCHAR(20),
  plan VARCHAR(20) NOT NULL DEFAULT 'standard'
    CHECK (plan IN ('standard', 'professional', 'enterprise')),
  seats_count INTEGER NOT NULL DEFAULT 10,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_salons_plan ON salons(plan);
```

#### 7.2.2 staffs（スタッフ）

> ⚠️ **設計書整合性修正（2025-12-05）**
>
> **旧定義（削除）:**
> - ~~auth_user_id: NULL許可、ON DELETE SET NULL~~
> - ~~role: 'owner', 'manager', 'stylist', 'assistant', 'receptionist'~~
>
> **新定義:**
> - auth_user_id: NOT NULL必須、ON DELETE CASCADE、UNIQUE制約追加
> - role: 'owner', 'manager', 'stylist', 'assistant'（receptionist削除）
>
> **理由:**
> - auth_user_idはSupabase Authとの紐付けに必須（ログインできないスタッフは存在しない）
> - ユーザー削除時はスタッフも削除されるべき（SET NULLは孤立レコードを生む）
> - auth_user_idの一意性を保証（同じユーザーが複数スタッフになることを防止）
> - receptionist役割は基本設計書・詳細設計書に記載なし（4役割に統一）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| salon_id | uuid | NO | - | 所属店舗（FK） |
| auth_user_id | uuid | NO | - | Supabase Auth ID（UNIQUE） |
| name | varchar(50) | NO | - | 氏名 |
| email | varchar(255) | NO | - | メールアドレス |
| role | varchar(20) | NO | 'stylist' | 役割（owner/manager/stylist/assistant） |
| position | varchar(50) | YES | - | 役職 |
| join_date | date | YES | - | 入社日 |
| profile_image_url | text | YES | - | プロフィール画像URL |
| settings | jsonb | YES | '{}' | 個人設定 |
| is_active | boolean | NO | true | アクティブフラグ |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
-- 旧SQL（削除）:
-- auth_user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
-- CHECK (role IN ('owner', 'manager', 'stylist', 'assistant', 'receptionist')),
-- UNIQUE (salon_id, email)

-- 新SQL:
CREATE TABLE staffs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  auth_user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'stylist'
    CHECK (role IN ('owner', 'manager', 'stylist', 'assistant')),
  position VARCHAR(50),
  join_date DATE,
  profile_image_url TEXT,
  settings JSONB DEFAULT '{}',
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (salon_id, email)
);

-- インデックス
CREATE INDEX idx_staffs_salon_id ON staffs(salon_id);
CREATE INDEX idx_staffs_auth_user_id ON staffs(auth_user_id);
CREATE INDEX idx_staffs_is_active ON staffs(is_active);
```

#### 7.2.3 sessions（セッション）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| salon_id | uuid | NO | - | 店舗（FK） |
| stylist_id | uuid | NO | - | 担当スタイリスト（FK） |
| started_at | timestamptz | NO | now() | 開始日時 |
| ended_at | timestamptz | YES | - | 終了日時 |
| status | varchar(20) | NO | 'recording' | ステータス |
| customer_info | jsonb | YES | '{}' | お客様情報 |
| diarization_status | varchar(20) | YES | 'pending' | 話者分離ステータス |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  stylist_id UUID NOT NULL REFERENCES staffs(id) ON DELETE CASCADE,
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  status VARCHAR(20) NOT NULL DEFAULT 'recording'
    CHECK (status IN ('recording', 'processing', 'completed', 'failed')),
  customer_info JSONB DEFAULT '{}',
  diarization_status VARCHAR(20) DEFAULT 'pending'
    CHECK (diarization_status IN ('pending', 'processing', 'completed', 'failed')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_sessions_salon_id ON sessions(salon_id);
CREATE INDEX idx_sessions_stylist_id ON sessions(stylist_id);
CREATE INDEX idx_sessions_status ON sessions(status);
CREATE INDEX idx_sessions_started_at ON sessions(started_at DESC);
```

#### 7.2.4 transcripts（文字起こし）

> **⚠️ 設計変更（2025-12-05）**
>
> 時間単位をミリ秒に統一、音声再生用URLを追加。
> 基本設計書・詳細設計書・実装コードとの整合性を確保。

**旧定義（廃止）:**

~~| カラム名 | 型 | NULL | デフォルト | 説明 |~~
~~|---------|-----|------|-----------|------|~~
~~| id | uuid | NO | gen_random_uuid() | 主キー |~~
~~| session_id | uuid | NO | - | セッション（FK） |~~
~~| text | text | NO | - | 文字起こしテキスト |~~
~~| start_time | numeric(10,3) | NO | - | 開始時間（秒） |~~
~~| end_time | numeric(10,3) | NO | - | 終了時間（秒） |~~
~~| confidence | numeric(5,4) | YES | - | 信頼度 |~~
~~| chunk_index | integer | NO | - | チャンク番号 |~~
~~| created_at | timestamptz | NO | now() | 作成日時 |~~

**新定義:**

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| chunk_index | integer | NO | - | チャンク番号 |
| text | text | NO | - | 文字起こしテキスト |
| start_time_ms | bigint | NO | - | 開始時間（ミリ秒） |
| end_time_ms | bigint | NO | - | 終了時間（ミリ秒） |
| audio_url | text | YES | - | 音声ファイルURL |
| confidence | numeric(5,4) | YES | - | 認識信頼度 |
| created_at | timestamptz | NO | now() | 作成日時 |

**変更理由:**
- `start_time`/`end_time` → `start_time_ms`/`end_time_ms`: 時間単位をミリ秒に統一（実装・speaker_segmentsに合わせる）
- `audio_url` 追加: 音声チャンクの再生・検証用（基本設計書に合わせる）
- `UNIQUE (session_id, chunk_index)` 追加: チャンク単位の一意性を担保

```sql
-- 旧SQL（廃止）
-- CREATE TABLE transcripts (
--   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
--   session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
--   text TEXT NOT NULL,
--   start_time NUMERIC(10, 3) NOT NULL,
--   end_time NUMERIC(10, 3) NOT NULL,
--   confidence NUMERIC(5, 4),
--   chunk_index INTEGER NOT NULL,
--   created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
-- );

-- 新SQL
CREATE TABLE transcripts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  text TEXT NOT NULL,
  start_time_ms BIGINT NOT NULL,
  end_time_ms BIGINT NOT NULL,
  audio_url TEXT,
  confidence NUMERIC(5, 4),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (session_id, chunk_index)
);

-- インデックス
CREATE INDEX idx_transcripts_session_id ON transcripts(session_id);
CREATE INDEX idx_transcripts_session_chunk ON transcripts(session_id, chunk_index);
```

#### 7.2.5 speaker_segments（話者セグメント）

> **⚠️ 設計変更（2025-12-05）**
>
> 時間単位をミリ秒に統一、話者識別失敗時のunknown対応を追加。
> 基本設計書・詳細設計書・実装コードとの整合性を確保。

**旧定義（廃止）:**

~~| カラム名 | 型 | NULL | デフォルト | 説明 |~~
~~|---------|-----|------|-----------|------|~~
~~| id | uuid | NO | gen_random_uuid() | 主キー |~~
~~| session_id | uuid | NO | - | セッション（FK） |~~
~~| role | varchar(20) | NO | - | 役割 |~~
~~| start_time | numeric(10,3) | NO | - | 開始時間（秒） |~~
~~| end_time | numeric(10,3) | NO | - | 終了時間（秒） |~~
~~| speaker_label | varchar(10) | YES | - | 話者ラベル |~~
~~| text | text | YES | - | テキスト（結合後） |~~
~~| created_at | timestamptz | NO | now() | 作成日時 |~~

**新定義:**

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| chunk_index | integer | NO | - | チャンク番号 |
| speaker | varchar(20) | NO | - | 話者 |
| start_time_ms | bigint | NO | - | 開始時間（ミリ秒） |
| end_time_ms | bigint | NO | - | 終了時間（ミリ秒） |
| text | text | YES | - | テキスト（結合後） |
| confidence | numeric(5,4) | YES | - | 話者識別の信頼度 |
| created_at | timestamptz | NO | now() | 作成日時 |

**変更理由:**
- `role` → `speaker`: 用語統一（基本設計書・詳細設計書・実装に合わせる）
- `'unknown'` 追加: pyannote話者分離失敗時のエッジケース対応
- `start_time`/`end_time` → `start_time_ms`/`end_time_ms`: 時間単位をミリ秒に統一（実装に合わせる）
- `chunk_index` 追加: チャンク単位の管理に対応
- `confidence` 追加: 話者識別の信頼度を保存（品質管理用）
- `speaker_label` 削除: `speaker`カラムに統合

```sql
-- 旧SQL（廃止）
-- CREATE TABLE speaker_segments (
--   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
--   session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
--   role VARCHAR(20) NOT NULL CHECK (role IN ('stylist', 'customer')),
--   start_time NUMERIC(10, 3) NOT NULL,
--   end_time NUMERIC(10, 3) NOT NULL,
--   speaker_label VARCHAR(10),
--   text TEXT,
--   created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
-- );

-- 新SQL
CREATE TABLE speaker_segments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  speaker VARCHAR(20) NOT NULL CHECK (speaker IN ('stylist', 'customer', 'unknown')),
  start_time_ms BIGINT NOT NULL,
  end_time_ms BIGINT NOT NULL,
  text TEXT,
  confidence NUMERIC(5, 4),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_speaker_segments_session_id ON speaker_segments(session_id);
CREATE INDEX idx_speaker_segments_speaker ON speaker_segments(session_id, speaker);
CREATE INDEX idx_speaker_segments_time ON speaker_segments(session_id, start_time_ms);
```

#### 7.2.6 session_analyses（セッション分析）

> **⚠️ 設計変更（2025-12-05）**
>
> リアルタイム分析に対応するため、チャンク単位での分析結果保存に変更。
> 基本設計書・詳細設計書との整合性を確保。

**旧定義（廃止）:**

~~| カラム名 | 型 | NULL | デフォルト | 説明 |~~
~~|---------|-----|------|-----------|------|~~
~~| id | uuid | NO | gen_random_uuid() | 主キー |~~
~~| session_id | uuid | NO | - | セッション（FK） |~~
~~| analysis_type | varchar(30) | NO | - | 分析タイプ |~~
~~| result | jsonb | NO | - | 分析結果 |~~
~~| created_at | timestamptz | NO | now() | 作成日時 |~~

**新定義:**

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| chunk_index | integer | NO | - | チャンク番号 |
| indicator_type | varchar(30) | NO | - | 指標種別 |
| value | numeric(10,4) | NO | - | 測定値 |
| score | integer | NO | - | スコア（0-100） |
| details | jsonb | YES | - | 詳細データ |
| created_at | timestamptz | NO | now() | 作成日時 |

**変更理由:**
- `chunk_index` 追加: 60秒チャンク単位でのリアルタイム分析に対応
- `analysis_type` → `indicator_type`: 用語統一（7つの評価指標に合わせる）
- `result` → `value` + `score` + `details`: 構造化データで検索・集計を効率化
- `UNIQUE` 制約変更: セッション×チャンク×指標の組み合わせで一意性を担保

```sql
-- 旧SQL（廃止）
-- CREATE TABLE session_analyses (
--   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
--   session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
--   analysis_type VARCHAR(30) NOT NULL
--     CHECK (analysis_type IN (
--       'talk_ratio', 'questions', 'emotion',
--       'concern_keywords', 'proposal_timing',
--       'proposal_quality', 'conversion'
--     )),
--   result JSONB NOT NULL,
--   created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
--   UNIQUE (session_id, analysis_type)
-- );

-- 新SQL
CREATE TABLE session_analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  indicator_type VARCHAR(30) NOT NULL
    CHECK (indicator_type IN (
      'talk_ratio', 'question_analysis', 'emotion_analysis',
      'concern_keywords', 'proposal_timing',
      'proposal_quality', 'conversion'
    )),
  value NUMERIC(10, 4) NOT NULL,
  score INTEGER NOT NULL CHECK (score >= 0 AND score <= 100),
  details JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (session_id, chunk_index, indicator_type)
);

-- インデックス
CREATE INDEX idx_session_analyses_session_id ON session_analyses(session_id);
CREATE INDEX idx_session_analyses_indicator ON session_analyses(indicator_type);
CREATE INDEX idx_session_analyses_session_chunk ON session_analyses(session_id, chunk_index);
```

#### 7.2.7 session_reports（セッションレポート）

> **⚠️ 設計変更（2025-12-05）**
>
> レポートデータの構造化とAIフィードバック機能追加のため変更。
> 基本設計書・詳細設計書との整合性を確保。

**旧定義（廃止）:**

~~| カラム名 | 型 | NULL | デフォルト | 説明 |~~
~~|---------|-----|------|-----------|------|~~
~~| id | uuid | NO | gen_random_uuid() | 主キー |~~
~~| session_id | uuid | NO | - | セッション（FK） |~~
~~| overall_score | integer | NO | - | 総合スコア |~~
~~| good_points | text[] | YES | - | 良かった点 |~~
~~| improvement_points | text[] | YES | - | 改善点 |~~
~~| action_items | text[] | YES | - | アクションアイテム |~~
~~| report_data | jsonb | NO | - | 詳細レポートデータ |~~
~~| created_at | timestamptz | NO | now() | 作成日時 |~~

**新定義:**

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| overall_score | integer | NO | - | 総合スコア |
| good_points | text[] | NO | '{}' | 良かった点 |
| improvement_points | text[] | NO | '{}' | 改善点 |
| action_items | text[] | NO | '{}' | アクションアイテム |
| transcript_summary | text | YES | - | 会話要約 |
| ai_feedback | text | YES | - | AIフィードバック |
| indicator_scores | jsonb | NO | - | 指標別スコア |
| created_at | timestamptz | NO | now() | 作成日時 |

**変更理由:**
- `good_points`, `improvement_points`, `action_items`: NULL可 → NOT NULL DEFAULT '{}'（空配列保証）
- `report_data` → `indicator_scores`: より明確な名称に変更
- `transcript_summary` 追加: 会話要約を独立カラムで保存
- `ai_feedback` 追加: AIによる総合フィードバックを保存

```sql
-- 旧SQL（廃止）
-- CREATE TABLE session_reports (
--   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
--   session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE UNIQUE,
--   overall_score INTEGER NOT NULL CHECK (overall_score >= 0 AND overall_score <= 100),
--   good_points TEXT[],
--   improvement_points TEXT[],
--   action_items TEXT[],
--   report_data JSONB NOT NULL,
--   created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
-- );

-- 新SQL
CREATE TABLE session_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE UNIQUE,
  overall_score INTEGER NOT NULL CHECK (overall_score >= 0 AND overall_score <= 100),
  good_points TEXT[] NOT NULL DEFAULT '{}',
  improvement_points TEXT[] NOT NULL DEFAULT '{}',
  action_items TEXT[] NOT NULL DEFAULT '{}',
  transcript_summary TEXT,
  ai_feedback TEXT,
  indicator_scores JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_session_reports_session_id ON session_reports(session_id);
CREATE INDEX idx_session_reports_overall_score ON session_reports(overall_score);
```

#### 7.2.8 success_cases（成功事例）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| salon_id | uuid | NO | - | 店舗（FK） |
| session_id | uuid | YES | - | 元セッション（FK） |
| stylist_id | uuid | YES | - | スタイリスト（FK） |
| concern_keywords | text[] | NO | - | 悩みキーワード |
| customer_profile | jsonb | YES | - | お客様プロファイル |
| successful_talk | text | NO | - | 成功トーク |
| key_tactics | text[] | YES | - | 成功要因 |
| sold_product | varchar(100) | YES | - | 販売商品 |
| conversion_rate | numeric(5,4) | NO | - | 成約率 |
| embedding | vector(1536) | NO | - | ベクトル埋め込み |
| is_public | boolean | NO | false | 全店舗公開フラグ |
| created_at | timestamptz | NO | now() | 作成日時 |

```sql
-- pgvector拡張を有効化
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE success_cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
  stylist_id UUID REFERENCES staffs(id) ON DELETE SET NULL,
  concern_keywords TEXT[] NOT NULL,
  customer_profile JSONB,
  successful_talk TEXT NOT NULL,
  key_tactics TEXT[],
  sold_product VARCHAR(100),
  conversion_rate NUMERIC(5, 4) NOT NULL,
  embedding VECTOR(1536) NOT NULL,
  is_public BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- HNSWインデックス（ベクトル検索用）
CREATE INDEX ON success_cases 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- その他のインデックス
CREATE INDEX idx_success_cases_salon_id ON success_cases(salon_id);
CREATE INDEX idx_success_cases_concern_keywords ON success_cases USING GIN(concern_keywords);
```

### 7.3 Row Level Security（RLS）ポリシー

```sql
-- RLS有効化
ALTER TABLE salons ENABLE ROW LEVEL SECURITY;
ALTER TABLE staffs ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE transcripts ENABLE ROW LEVEL SECURITY;
ALTER TABLE speaker_segments ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE success_cases ENABLE ROW LEVEL SECURITY;

-- salonsポリシー（所属店舗のみアクセス可能）
CREATE POLICY "Users can view their salon" ON salons
  FOR SELECT USING (
    id = (
      SELECT salon_id FROM staffs 
      WHERE auth_user_id = auth.uid()
    )
  );

-- staffsポリシー（同一店舗のスタッフのみ閲覧可能）
CREATE POLICY "Users can view staff in their salon" ON staffs
  FOR SELECT USING (
    salon_id = (
      SELECT salon_id FROM staffs 
      WHERE auth_user_id = auth.uid()
    )
  );

-- sessionsポリシー（店舗データ分離）
CREATE POLICY "Sessions belong to salon" ON sessions
  FOR ALL USING (
    salon_id = (
      SELECT salon_id FROM staffs 
      WHERE auth_user_id = auth.uid()
    )
  );

-- transcriptsポリシー
CREATE POLICY "Transcripts belong to salon" ON transcripts
  FOR ALL USING (
    session_id IN (
      SELECT id FROM sessions 
      WHERE salon_id = (
        SELECT salon_id FROM staffs 
        WHERE auth_user_id = auth.uid()
      )
    )
  );

-- success_casesポリシー（自店舗 or 公開事例）
CREATE POLICY "Success cases access" ON success_cases
  FOR SELECT USING (
    is_public = true
    OR salon_id = (
      SELECT salon_id FROM staffs 
      WHERE auth_user_id = auth.uid()
    )
  );
```

---
