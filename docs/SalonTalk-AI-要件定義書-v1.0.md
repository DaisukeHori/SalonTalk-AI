# 美容室向けリアルタイムコミュニケーション分析システム

## ソフトウェア要件定義書（SRS）

**プロジェクト名**: SalonTalk AI（仮称）  
**バージョン**: 1.0  
**作成日**: 2025年12月4日  
**作成者**: Revol Corporation  
**機密区分**: 社外秘

---

## 目次

1. [はじめに](#1-はじめに)
2. [システム概要](#2-システム概要)
3. [ステークホルダー分析](#3-ステークホルダー分析)
4. [機能要件](#4-機能要件)
5. [非機能要件](#5-非機能要件)
6. [システムアーキテクチャ](#6-システムアーキテクチャ)
7. [データモデル設計](#7-データモデル設計)
8. [API仕様](#8-api仕様)
9. [UI/UX要件](#9-uiux要件)
10. [セキュリティ要件](#10-セキュリティ要件)
11. [外部インターフェース](#11-外部インターフェース)
12. [運用・保守要件](#12-運用保守要件)
13. [テスト要件](#13-テスト要件)
14. [開発計画・マイルストーン](#14-開発計画マイルストーン)
15. [制約事項・前提条件](#15-制約事項前提条件)
16. [用語集](#16-用語集)
17. [変更履歴](#17-変更履歴)

---

## 1. はじめに

### 1.1 文書の目的

本文書は、美容室向けリアルタイムコミュニケーション分析システム「SalonTalk AI」の開発において、システムが満たすべき機能的・非機能的要件を明確に定義することを目的とする。本文書は、開発チーム、プロジェクトマネージャー、品質保証チーム、および関連ステークホルダーが参照する基準文書として機能する。

### 1.2 プロジェクトビジョン

**「売れる美容師の暗黙知を科学し、再現可能なスキルに変換する」**

美容室における接客会話をAIがリアルタイムで分析し、トップスタイリストの「売れるトーク」パターンを可視化・共有することで、店舗全体の売上向上と人材育成の効率化を実現する。

### 1.3 文書の範囲

本要件定義書は以下の範囲をカバーする：

- iPadアプリケーション（施術者向けフロントエンド）
- Webダッシュボード（管理者向け）
- バックエンドAPI・サービス
- 外部サービス連携
- データ処理パイプライン

### 1.4 参照文書

| 文書名 | バージョン | 説明 |
|--------|-----------|------|
| 事業企画書 | v3.7 | システムのビジネス要件・目標を定義 |
| Apple SpeechAnalyzer Documentation | iOS 26 | 音声認識APIリファレンス |
| Supabase Documentation | Latest | データベース・認証リファレンス |
| Claude API Documentation | Latest | AI分析APIリファレンス |

### 1.5 用語・略語

詳細は「16. 用語集」を参照のこと。

---

## 2. システム概要

### 2.1 システムの目的

本システムは以下の課題を解決することを目的とする：

| 課題 | 現状 | 目標 |
|------|------|------|
| スタッフ間売上格差 | トップ:平均 = 3.3:1 | 格差を2:1以下に縮小 |
| 新人早期離職 | 3年未満で36.7%が離職 | 離職率30%削減 |
| 店販苦手意識 | 美容師の70%が店販を苦手 | 店販購入率20%向上 |

### 2.2 システム構成概要

```
┌─────────────────────────────────────────────────────────────────┐
│                    クライアント層                                 │
│  ┌─────────────────────┐    ┌─────────────────────────────────┐ │
│  │   iPadアプリ         │    │   Webダッシュボード              │ │
│  │   (React Native)     │    │   (Next.js)                     │ │
│  └─────────────────────┘    └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                    サービス層                                    │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│  │ Supabase    │  │ pyannote     │  │ Claude API             │ │
│  │ (BaaS)      │  │ Server       │  │ (AI分析)               │ │
│  └─────────────┘  └──────────────┘  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                    データ層                                      │
│  ┌─────────────────────┐    ┌─────────────────────────────────┐ │
│  │ PostgreSQL          │    │ Qdrant / pgvector              │ │
│  │ (トランザクション)     │    │ (ベクトル検索)                   │ │
│  └─────────────────────┘    └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 主要機能一覧

| 機能カテゴリ | 機能名 | 概要 |
|-------------|--------|------|
| 音声処理 | リアルタイム文字起こし | Apple SpeechAnalyzerによるオンデバイス処理 |
| 音声処理 | 話者分離 | pyannote.audioによる美容師/お客様の発話分離 |
| AI分析 | 7指標スコアリング | Claude Sonnet 4.5による科学的トーク分析 |
| AI分析 | 成功事例マッチング | ベクトル検索による類似トークの提案 |
| 通知 | リアルタイムアシスト | 提案タイミングの通知 |
| レポート | セッションレポート | 施術後の詳細分析レポート生成 |
| 教育 | AIロールプレイ | シナリオベースのトレーニング |
| 管理 | ダッシュボード | 店舗・スタッフ分析 |

### 2.4 想定ユーザー

| ユーザー種別 | 説明 | 主な利用機能 |
|-------------|------|------------|
| スタイリスト | 施術を行う美容師 | iPadアプリ、リアルタイム分析、レポート閲覧 |
| 店長/マネージャー | 店舗運営責任者 | ダッシュボード、スタッフ分析、教育機能 |
| オーナー | 経営者 | 経営ダッシュボード、複数店舗分析 |
| システム管理者 | Revol社内管理者 | システム設定、顧客管理 |

---

## 3. ステークホルダー分析

### 3.1 内部ステークホルダー

| ステークホルダー | 役割 | 関心事項 | 影響度 |
|----------------|------|---------|--------|
| プロジェクトオーナー | 意思決定・予算管理 | ROI、市場投入時期 | 高 |
| 開発PM | 開発統括 | スケジュール、品質 | 高 |
| Prestoグループ店舗 | βテスト実施 | 使いやすさ、効果 | 高 |

### 3.2 外部ステークホルダー

| ステークホルダー | 役割 | 関心事項 | 影響度 |
|----------------|------|---------|--------|
| 導入美容室 | エンドユーザー | 売上向上、育成効率化 | 高 |
| 美容師（スタッフ） | 実利用者 | 使いやすさ、プライバシー | 高 |
| サロンのお客様 | 間接影響者 | プライバシー、接客品質 | 中 |
| 美容ディーラー | 販売パートナー | 販売手数料、差別化 | 中 |

### 3.3 ユーザーペルソナ

#### ペルソナ1: 店長・田中さん（42歳）

- **背景**: 中規模サロン（スタッフ12名）の店長。店販売上の向上とスタッフ育成が課題
- **目標**: スタッフ間の売上格差を縮小し、新人の早期戦力化を実現
- **課題**: トップスタイリストのノウハウが言語化されておらず、共有できない
- **技術スキル**: スマートフォン・タブレットは日常的に使用

#### ペルソナ2: 新人スタイリスト・佐藤さん（24歳）

- **背景**: 美容師歴2年目。店販への苦手意識が強い
- **目標**: 自信を持って商品提案ができるようになりたい
- **課題**: 何をどのタイミングで提案すべきかわからない
- **技術スキル**: デジタルネイティブ、新しいツールへの抵抗なし

#### ペルソナ3: オーナー・山田さん（55歳）

- **背景**: 3店舗展開する経営者。DX推進に積極的
- **目標**: データドリブンな経営判断を行いたい
- **課題**: 各店舗の状況を客観的に把握する手段がない
- **技術スキル**: 基本的なPC操作は可能、詳細な設定は苦手

---

## 4. 機能要件

### 4.1 機能要件一覧

#### FR-100: 音声処理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-101 | リアルタイム音声取得 | 必須 | 1 |
| FR-102 | オンデバイス文字起こし | 必須 | 1 |
| FR-103 | 話者分離処理 | 必須 | 1 |
| FR-104 | 音声チャンク送信 | 必須 | 1 |
| FR-105 | 文字起こし結果保存 | 必須 | 1 |

#### FR-200: AI分析機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-201 | トーク比率分析 | 必須 | 1 |
| FR-202 | 質問分析 | 必須 | 1 |
| FR-203 | 感情分析 | 必須 | 1 |
| FR-204 | 悩みキーワード検出 | 必須 | 1 |
| FR-205 | 提案タイミング分析 | 必須 | 2 |
| FR-206 | 提案品質分析 | 必須 | 2 |
| FR-207 | 成約判定 | 必須 | 2 |
| FR-208 | 総合スコアリング | 必須 | 2 |

#### FR-300: リアルタイムアシスト機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-301 | リアルタイムスコア表示 | 必須 | 1 |
| FR-302 | 提案タイミング通知 | 必須 | 2 |
| FR-303 | 成功トーク提案 | 必須 | 2 |
| FR-304 | アラート表示 | 任意 | 3 |

#### FR-400: 成功事例マッチング機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-401 | 成功事例登録 | 必須 | 2 |
| FR-402 | ベクトル埋め込み生成 | 必須 | 2 |
| FR-403 | 類似事例検索 | 必須 | 2 |
| FR-404 | 成功事例表示 | 必須 | 2 |

#### FR-500: レポート機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-501 | セッションレポート生成 | 必須 | 1 |
| FR-502 | 改善ポイント提示 | 必須 | 1 |
| FR-503 | アクションアイテム生成 | 必須 | 2 |
| FR-504 | レポート履歴管理 | 必須 | 2 |
| FR-505 | レポートエクスポート | 任意 | 3 |

#### FR-600: 教育・トレーニング機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-601 | AIロールプレイ | 必須 | 3 |
| FR-602 | シナリオ選択 | 必須 | 3 |
| FR-603 | ロールプレイ評価 | 必須 | 3 |
| FR-604 | ベストプラクティスDB | 必須 | 3 |
| FR-605 | ゲーミフィケーション | 任意 | 3 |

#### FR-700: 管理ダッシュボード機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-701 | スタッフ一覧・管理 | 必須 | 1 |
| FR-702 | スタッフ別分析 | 必須 | 2 |
| FR-703 | 店舗全体分析 | 必須 | 2 |
| FR-704 | 期間比較分析 | 必須 | 2 |
| FR-705 | 複数店舗統合分析 | 任意 | 3 |

#### FR-800: 認証・アカウント管理機能

| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| FR-801 | ユーザー認証 | 必須 | 1 |
| FR-802 | ロールベースアクセス制御 | 必須 | 1 |
| FR-803 | 店舗アカウント管理 | 必須 | 1 |
| FR-804 | スタッフ招待・管理 | 必須 | 1 |
| FR-805 | パスワードリセット | 必須 | 1 |

---

### 4.2 機能要件詳細

#### FR-101: リアルタイム音声取得

**概要**: iPadのマイクから施術中の会話音声を継続的に取得する

**入力**:
- iPadのマイクからの音声ストリーム
- サンプリングレート: 16kHz
- チャンネル: モノラル

**処理**:
1. マイクアクセス権限の確認・要求
2. AVAudioEngineによる音声キャプチャ開始
3. 1分間隔での音声チャンク分割
4. WAV形式での一時保存

**出力**:
- 1分間の音声チャンク（WAVファイル）

**受け入れ基準**:
- [ ] マイク権限取得のUIが表示される
- [ ] 施術開始ボタンタップで録音が開始される
- [ ] バックグラウンドでも録音が継続する
- [ ] 1分ごとに音声チャンクが生成される
- [ ] 音声品質: SNR 20dB以上

**例外処理**:
- マイク権限拒否時: 権限要求ダイアログ再表示
- ストレージ不足時: ユーザーへの警告表示

---

#### FR-102: オンデバイス文字起こし

**概要**: Apple SpeechAnalyzerを使用してiPad上で音声を文字起こしする

**入力**:
- 音声チャンク（WAVファイル）
- 言語設定（日本語）

**処理**:
1. SpeechAnalyzerの初期化
2. 日本語言語モデルのダウンロード確認（初回のみ）
3. 音声ファイルの読み込み
4. 文字起こし実行
5. タイムスタンプ付きセグメント生成

**出力**:
```typescript
interface TranscriptionResult {
  text: string;
  segments: {
    text: string;
    startTime: number;
    endTime: number;
    confidence: number;
  }[];
  durationInSeconds: number;
}
```

**受け入れ基準**:
- [ ] 文字起こし精度: 95%以上（標準的な会話環境）
- [ ] 処理時間: 1分音声に対して10秒以内
- [ ] オフライン動作が可能
- [ ] セグメントごとにタイムスタンプが付与される

**依存関係**:
- iOS 26以上
- @react-native-ai/appleパッケージ

---

#### FR-103: 話者分離処理

**概要**: pyannote.audioを使用して美容師とお客様の発話を分離する

**入力**:
- 音声チャンク（WAVファイル）
- セッションID
- 想定話者数: 2名

**処理**:
1. 音声ファイルをpyannoteサーバーにアップロード
2. 話者分離処理実行
3. 発話時間に基づく役割推定（発話量が多い方を美容師と推定）
4. 結果をデータベースに保存

**出力**:
```typescript
interface DiarizationResult {
  sessionId: string;
  segments: {
    role: 'stylist' | 'customer';
    startTime: number;
    endTime: number;
    speakerLabel: string;
  }[];
}
```

**受け入れ基準**:
- [ ] 話者分離精度: 90%以上（DER 10%未満）
- [ ] 処理時間: 1時間音声に対して5分以内
- [ ] 2話者の識別が正確に行われる

**設定パラメータ**:
| パラメータ | 値 | 説明 |
|-----------|-----|------|
| num_speakers | 2 | 想定話者数 |
| min_duration | 0.5 | 最小発話長（秒） |

---

#### FR-201: トーク比率分析

**概要**: 美容師とお客様の発話時間比率を計算・評価する

**入力**:
- 話者分離結果（DiarizationResult）

**処理**:
1. 美容師の総発話時間を計算
2. お客様の総発話時間を計算
3. 比率を計算
4. 理想値（40:60）との比較による評価

**出力**:
```typescript
interface TalkRatioAnalysis {
  stylistPercent: number;      // 美容師の発話比率（%）
  customerPercent: number;     // お客様の発話比率（%）
  judgment: 'excellent' | 'good' | 'needs_improvement';
  comment: string;
}
```

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 美容師35-45% かつ お客様55-65% |
| good | 美容師30-50% かつ お客様50-70% |
| needs_improvement | 上記以外 |

**受け入れ基準**:
- [ ] 比率が正確に計算される（誤差1%以内）
- [ ] 評価判定が正しく行われる
- [ ] 日本語でのコメントが生成される

---

#### FR-202: 質問分析

**概要**: 美容師の質問を検出し、オープン質問とクローズド質問の比率を分析する

**入力**:
- 美容師の発話テキスト一覧

**処理**:
1. 質問文の検出（「？」「か」で終わる文）
2. オープン質問の分類（「どう」「何」「どんな」等で始まる）
3. クローズド質問の分類（「〜ですか？」「〜しますか？」等）
4. 比率計算と評価

**出力**:
```typescript
interface QuestionAnalysis {
  totalCount: number;          // 質問総数
  openCount: number;           // オープン質問数
  closedCount: number;         // クローズド質問数
  openRatio: number;           // オープン質問比率（%）
  judgment: 'excellent' | 'good' | 'needs_improvement';
  examples: {
    open: string[];            // オープン質問例
    closed: string[];          // クローズド質問例
  };
}
```

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 質問8-12回 かつ オープン比率60%以上 |
| good | 質問6-15回 かつ オープン比率40%以上 |
| needs_improvement | 上記以外 |

**オープン質問の判定キーワード**:
- 「どう」「どのように」「どんな」
- 「何」「なに」
- 「いつ」「どこ」「誰」「なぜ」

---

#### FR-203: 感情分析

**概要**: お客様の発話から感情の傾向を分析する

**入力**:
- お客様の発話テキスト一覧

**処理**:
1. 肯定的キーワードの検出
2. 否定的キーワードの検出
3. 比率計算
4. 感情傾向の評価

**出力**:
```typescript
interface EmotionAnalysis {
  positiveRatio: number;       // 肯定的比率（%）
  detectedKeywords: {
    positive: string[];        // 検出した肯定的キーワード
    negative: string[];        // 検出した否定的キーワード
  };
  judgment: 'excellent' | 'good' | 'needs_improvement';
  overallSentiment: 'positive' | 'neutral' | 'negative';
}
```

**キーワード辞書**:

肯定的キーワード:
- 「いいですね」「素敵」「嬉しい」「楽しみ」「気に入った」
- 「ありがとう」「助かる」「さすが」「きれい」「かわいい」

否定的キーワード:
- 「困る」「嫌」「ちょっと」「微妙」「心配」
- 「痛い」「不安」「高い」「面倒」「難しい」

**評価基準**:
| 判定 | 条件 |
|------|------|
| excellent | 肯定比率70%以上 |
| good | 肯定比率50%以上 |
| needs_improvement | 肯定比率50%未満 |

---

#### FR-204: 悩みキーワード検出

**概要**: お客様が発した髪の悩みに関するキーワードを検出する

**入力**:
- お客様の発話テキスト一覧

**処理**:
1. 悩みキーワード辞書との照合
2. キーワードの出現位置（タイムスタンプ）の記録
3. カテゴリ分類

**出力**:
```typescript
interface ConcernKeywordResult {
  keywords: {
    keyword: string;           // 検出キーワード
    category: string;          // カテゴリ
    timestamp: number;         // 検出時刻（秒）
    context: string;           // 前後の文脈
  }[];
  categories: string[];        // 検出されたカテゴリ一覧
}
```

**悩みキーワード辞書**:

| カテゴリ | キーワード |
|---------|-----------|
| 乾燥・パサつき | 乾燥、パサパサ、パサつき、ツヤがない |
| 広がり・まとまり | 広がる、まとまらない、ボサボサ、うねり |
| ダメージ | 傷み、切れ毛、枝毛、ダメージ |
| 白髪 | 白髪、グレイヘア、染まりにくい |
| 薄毛・抜け毛 | 薄い、抜け毛、ボリュームがない |
| スタイリング | 朝大変、セットが持たない、崩れる |
| 頭皮 | 頭皮、かゆい、フケ、べたつき |

---

#### FR-301: リアルタイムスコア表示

**概要**: 施術中にiPad上でリアルタイムにスコアを表示する

**入力**:
- 現在までの分析結果

**処理**:
1. 1分ごとのスコア再計算
2. UI更新
3. トレンド表示

**出力（UI表示項目）**:

| 表示項目 | 表示形式 | 更新頻度 |
|---------|---------|---------|
| 傾聴スコア | 0-100点 + ゲージ | 1分 |
| 質問数 | 数値 | リアルタイム |
| 感情インジケータ | 😊 😐 😞 | 1分 |
| 経過時間 | mm:ss | リアルタイム |
| 悩みキーワード | タグ表示 | リアルタイム |

**受け入れ基準**:
- [ ] スコアがリアルタイムで更新される
- [ ] UIがスムーズに動作する（60fps維持）
- [ ] 施術の邪魔にならない控えめな表示

---

#### FR-302: 提案タイミング通知

**概要**: 悩みキーワード検出後、適切なタイミングで提案を促す通知を表示する

**入力**:
- 悩みキーワード検出結果
- 現在の会話状態

**処理**:
1. 悩みキーワード検出をトリガーとする
2. 検出後2-5分のタイミングを計測
3. 適切なタイミングで通知を生成
4. 関連する成功トーク例を取得

**出力**:
```typescript
interface ProposalNotification {
  type: 'proposal_timing';
  concernKeyword: string;      // 検出した悩み
  suggestedProduct: string;    // 提案推奨商品
  successTalkExample: string;  // 成功トーク例
  timing: 'now' | 'soon';      // タイミング
}
```

**通知UI**:
```
┌────────────────────────────────────────────┐
│ 🎯 提案チャンス！                           │
│                                            │
│ お客様が「乾燥」と発言しました              │
│                                            │
│ ▶ 保湿シャンプーを提案しましょう            │
│                                            │
│ 💡 成功トーク例：                           │
│ 「同じお悩みだった○○様は...」              │
└────────────────────────────────────────────┘
```

**受け入れ基準**:
- [ ] 悩みキーワード検出後3分以内に通知が表示される
- [ ] 通知は施術の邪魔にならない形式である
- [ ] 通知を閉じることができる
- [ ] 成功トーク例が含まれる

---

#### FR-401: 成功事例登録

**概要**: 成約に成功したセッションを成功事例として登録する

**入力**:
- セッションID
- 成約情報（商品、金額）
- 成功要因（手動入力または自動抽出）

**処理**:
1. セッションデータの取得
2. 成功要因の抽出（Claude APIによる分析）
3. ベクトル埋め込みの生成
4. データベースへの登録

**出力**:
```typescript
interface SuccessCase {
  id: string;
  sessionId: string;
  salonId: string;
  stylistId: string;
  concernKeywords: string[];
  customerProfile: {
    ageGroup: string;
    visitFrequency: string;
  };
  successfulTalk: string;
  keyTactics: string[];
  soldProduct: string;
  conversionRate: number;
  embedding: number[];         // ベクトル埋め込み
  createdAt: Date;
}
```

**受け入れ基準**:
- [ ] 成約セッションが正しく登録される
- [ ] ベクトル埋め込みが生成される
- [ ] 成功要因が自動抽出される

---

#### FR-501: セッションレポート生成

**概要**: 施術終了後に詳細な分析レポートを生成する

**入力**:
- セッションID
- 全分析結果

**処理**:
1. 全分析データの集約
2. Claude APIによるレポート生成
3. 改善ポイントの抽出
4. アクションアイテムの生成
5. レポートの保存

**出力**:
```typescript
interface SessionReport {
  sessionId: string;
  generatedAt: Date;
  summary: {
    date: Date;
    duration: number;
    stylistName: string;
    overallScore: number;
  };
  analysis: {
    talkRatio: TalkRatioAnalysis;
    questions: QuestionAnalysis;
    emotion: EmotionAnalysis;
    concerns: ConcernKeywordResult;
    proposalTiming: ProposalTimingAnalysis;
    proposalQuality: ProposalQualityAnalysis;
    conversion: ConversionResult;
  };
  goodPoints: string[];
  improvementPoints: string[];
  actionItems: string[];
  similarSuccessCases: SuccessCase[];
}
```

**レポート形式**:
- 総合スコア（0-100点）
- 7つの指標の詳細分析
- 良かった点（3-5項目）
- 改善点（2-3項目）
- 次回へのアクションアイテム（3項目）
- 類似成功事例（1-3件）

**受け入れ基準**:
- [ ] セッション終了後5分以内にレポートが生成される
- [ ] 全7指標の分析が含まれる
- [ ] 具体的な改善アドバイスが含まれる
- [ ] 日本語で自然な文章である

---

#### FR-601: AIロールプレイ

**概要**: Claude Sonnet 4.5がお客様役となり、トレーニングを実施する

**入力**:
- シナリオ選択
- ユーザーの発話

**処理**:
1. シナリオに基づくお客様キャラクター設定
2. ユーザー発話への応答生成
3. 会話の評価
4. フィードバック生成

**出力**:
```typescript
interface RoleplaySession {
  scenarioId: string;
  difficulty: 'beginner' | 'intermediate' | 'advanced';
  customerProfile: {
    age: number;
    concern: string;
    personality: string;
  };
  conversation: {
    role: 'user' | 'ai';
    text: string;
    timestamp: Date;
  }[];
  evaluation: {
    score: number;
    goodPoints: string[];
    improvementPoints: string[];
    modelAnswer: string;
  };
}
```

**シナリオ例**:

| 難易度 | シナリオ | 目標 |
|--------|---------|------|
| 初級 | 髪のパサつきを気にする25歳女性 | 基本的な提案練習 |
| 中級 | 「今使ってるシャンプーがある」と言う35歳女性 | 異議処理 |
| 上級 | 「価格が高い」と言う45歳女性 | 異議処理 + クロージング |

**受け入れ基準**:
- [ ] シナリオ選択が可能
- [ ] AIが自然な会話を行う
- [ ] 終了後に評価とフィードバックが提供される
- [ ] モデル回答が提示される

---

#### FR-701: スタッフ一覧・管理

**概要**: 店舗内のスタッフを一覧表示し、管理する

**入力**:
- 店舗ID

**処理**:
1. 店舗に紐づくスタッフの取得
2. 各スタッフの基本情報・統計の集計
3. 一覧表示

**出力**:
```typescript
interface StaffListItem {
  id: string;
  name: string;
  role: 'stylist' | 'assistant' | 'receptionist';
  joinDate: Date;
  profileImage?: string;
  stats: {
    totalSessions: number;
    averageScore: number;
    conversionRate: number;
    lastSessionDate: Date;
  };
}
```

**画面項目**:
| 項目 | 説明 |
|------|------|
| プロフィール画像 | スタッフの顔写真 |
| 氏名 | スタッフ名 |
| 役職 | スタイリスト/アシスタント等 |
| 入社日 | 入社日 |
| 総セッション数 | これまでの分析セッション数 |
| 平均スコア | 総合スコアの平均 |
| 成約率 | 店販成約率 |

**受け入れ基準**:
- [ ] 全スタッフが一覧表示される
- [ ] スタッフの検索・フィルタが可能
- [ ] スタッフ詳細画面への遷移が可能
- [ ] 新規スタッフの追加が可能

---

## 5. 非機能要件

### 5.1 性能要件

#### NFR-P01: レスポンスタイム

| 操作 | 目標値 | 最大許容値 |
|------|--------|-----------|
| アプリ起動 | 3秒以内 | 5秒 |
| セッション開始 | 1秒以内 | 2秒 |
| リアルタイムスコア更新 | 500ms以内 | 1秒 |
| レポート生成 | 30秒以内 | 60秒 |
| 成功事例検索 | 2秒以内 | 5秒 |
| ダッシュボード表示 | 3秒以内 | 5秒 |

#### NFR-P02: スループット

| 項目 | 目標値 |
|------|--------|
| 同時セッション数（1店舗） | 20セッション |
| 同時セッション数（システム全体） | 1,000セッション |
| API リクエスト/秒 | 100 req/s |

#### NFR-P03: 処理能力

| 処理 | 目標値 |
|------|--------|
| 文字起こし | 1分音声 → 10秒以内（オンデバイス） |
| 話者分離 | 1時間音声 → 5分以内（サーバー） |
| AI分析 | 1セッション → 30秒以内 |

### 5.2 可用性要件

#### NFR-A01: 稼働率

| 項目 | 目標値 |
|------|--------|
| システム全体稼働率 | 99.5%以上 |
| 計画停止時間 | 月4時間以内 |
| 非計画停止時間 | 月1時間以内 |

#### NFR-A02: 障害復旧

| 項目 | 目標値 |
|------|--------|
| RTO（目標復旧時間） | 4時間以内 |
| RPO（目標復旧時点） | 1時間以内 |

#### NFR-A03: オフライン対応

| 機能 | オフライン対応 |
|------|--------------|
| 文字起こし | ○（オンデバイス処理） |
| 話者分離 | ×（サーバー必須） |
| AI分析 | ×（API必須） |
| レポート閲覧 | ○（キャッシュ） |

### 5.3 拡張性要件

#### NFR-S01: スケーラビリティ

| 項目 | 初期 | 1年後 | 3年後 |
|------|------|-------|-------|
| 導入店舗数 | 5店舗 | 50店舗 | 200店舗 |
| 月間セッション数 | 500 | 5,000 | 20,000 |
| データ保存量 | 10GB | 100GB | 500GB |

#### NFR-S02: 水平スケーリング

- Supabase: 自動スケーリング対応
- pyannoteサーバー: GPUインスタンス追加で対応
- ベクトルDB: シャーディング対応

### 5.4 保守性要件

#### NFR-M01: コード品質

| 項目 | 基準 |
|------|------|
| テストカバレッジ | 80%以上 |
| コード複雑度 | Cyclomatic Complexity ≤ 10 |
| ドキュメント | API仕様書、設計書完備 |

#### NFR-M02: ログ・監視

| 項目 | 要件 |
|------|------|
| アプリケーションログ | 全API呼び出し、エラー詳細 |
| 監視 | CPU、メモリ、ディスク、レスポンスタイム |
| アラート | エラー率1%超過、レスポンス5秒超過 |

### 5.5 移植性要件

#### NFR-T01: 対応プラットフォーム

| プラットフォーム | 対応バージョン |
|----------------|--------------|
| iOS/iPadOS | 26以上 |
| Webブラウザ | Chrome 120+, Safari 17+, Edge 120+ |

#### NFR-T02: デバイス要件

| デバイス | 最小要件 |
|---------|---------|
| iPad | iPad Pro 2020以降、iPad Air 4以降 |
| PC（管理画面） | 4GB RAM以上、1920x1080解像度 |

---

## 6. システムアーキテクチャ

### 6.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           クライアント層                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────┐        ┌───────────────────────────────────┐ │
│  │    iPadアプリ          │        │    Webダッシュボード               │ │
│  │    (React Native)      │        │    (Next.js 14 + TypeScript)      │ │
│  │                        │        │                                   │ │
│  │  ┌─────────────────┐  │        │  ┌─────────────────────────────┐  │ │
│  │  │ SpeechAnalyzer   │  │        │  │ 管理者向けダッシュボード      │  │ │
│  │  │ (オンデバイス)    │  │        │  │ - スタッフ管理               │  │ │
│  │  └─────────────────┘  │        │  │ - 分析レポート               │  │ │
│  │  ┌─────────────────┐  │        │  │ - 店舗設定                   │  │ │
│  │  │ Realtime UI     │  │        │  └─────────────────────────────┘  │ │
│  │  └─────────────────┘  │        │                                   │ │
│  └───────────────────────┘        └───────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────┬─┘
                                                                        │
                                    HTTPS / WebSocket                   │
                                                                        │
┌───────────────────────────────────────────────────────────────────────┴─┐
│                           サービス層                                     │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Supabase (BaaS)                               │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │    │
│  │  │ Auth        │  │ Realtime    │  │ Edge Functions          │  │    │
│  │  │ (認証)       │  │ (WebSocket) │  │ (サーバーレス処理)        │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │    │
│  │  ┌─────────────┐  ┌─────────────────────────────────────────┐   │    │
│  │  │ Storage     │  │ PostgreSQL + pgvector                    │   │    │
│  │  │ (音声一時保存)│  │ (メインDB + ベクトル検索)                  │   │    │
│  │  └─────────────┘  └─────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │              外部AI/MLサービス                                    │    │
│  │  ┌─────────────────────┐  ┌─────────────────────────────────┐   │    │
│  │  │ pyannote Server     │  │ Anthropic Claude API            │   │    │
│  │  │ (話者分離)           │  │ (AI分析・レポート生成)            │   │    │
│  │  │                     │  │                                  │   │    │
│  │  │ - GPU: RTX 4060     │  │ - Model: Claude Sonnet 4.5      │   │    │
│  │  │ - Self-hosted       │  │ - Batch API / Streaming         │   │    │
│  │  └─────────────────────┘  └─────────────────────────────────┘   │    │
│  │  ┌─────────────────────┐  ┌─────────────────────────────────┐   │    │
│  │  │ OpenAI API          │  │ Qdrant Cloud (Optional)         │   │    │
│  │  │ (Embedding生成)      │  │ (大規模ベクトル検索)              │   │    │
│  │  │ text-embedding-3    │  │ 10万件以上時に検討               │   │    │
│  │  └─────────────────────┘  └─────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                        │
┌───────────────────────────────────────┴─────────────────────────────────┐
│                           インフラ層                                     │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Vercel                                        │    │
│  │  - Next.js ホスティング                                           │    │
│  │  - Edge Network (CDN)                                            │    │
│  │  - 自動スケーリング                                                │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    GPU VPS (pyannote用)                          │    │
│  │  - Provider: VAST.ai / AWS g4dn                                  │    │
│  │  - GPU: RTX 3060/4060 または T4                                   │    │
│  │  - Ubuntu 22.04                                                   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 データフロー図

#### 6.2.1 リアルタイム分析フロー

```
┌─────────┐    ┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│  iPad   │───▶│ SpeechAnalyzer │───▶│ テキスト保存   │───▶│ Supabase    │
│ (マイク) │    │ (オンデバイス)  │    │              │    │ Realtime    │
└─────────┘    └─────────────┘    └──────────────┘    └─────────────┘
                                         │
                                         ▼
                                  ┌──────────────┐
                                  │ 1分チャンク   │
                                  │ 音声ファイル  │
                                  └──────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    バックエンド処理                                   │
│                                                                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────┐ │
│  │ Supabase    │───▶│ pyannote    │───▶│ 話者分離結果             │ │
│  │ Storage     │    │ Server      │    │ (speaker_segments)       │ │
│  └─────────────┘    └─────────────┘    └─────────────────────────┘ │
│                                                │                    │
│                                                ▼                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              文字起こし + 話者分離 結合                        │   │
│  │              (transcript_with_speakers)                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                │                    │
│                                                ▼                    │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────┐ │
│  │ Claude API  │◀───│ 分析リクエスト │◀───│ Edge Function           │ │
│  │ (Sonnet 4.5)│    │             │    │ (analyze-session)        │ │
│  └─────────────┘    └─────────────┘    └─────────────────────────┘ │
│         │                                                          │
│         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              分析結果 (session_analysis)                       │   │
│  │              - トーク比率                                      │   │
│  │              - 質問分析                                        │   │
│  │              - 感情分析                                        │   │
│  │              - 悩みキーワード                                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                         │
                                         ▼
                              ┌──────────────────┐
                              │ Supabase Realtime │
                              │ (結果プッシュ)     │
                              └──────────────────┘
                                         │
                                         ▼
                              ┌──────────────────┐
                              │ iPad UI更新      │
                              │ (リアルタイムスコア)│
                              └──────────────────┘
```

#### 6.2.2 成功事例マッチングフロー

```
┌─────────────────┐
│ 悩みキーワード検出 │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    成功事例検索フロー                              │
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────────────────────────┐ │
│  │ シーン情報構築    │    │ 検索クエリ:                          │ │
│  │                  │───▶│ - 悩みキーワード: 乾燥, 広がる         │ │
│  │ - 悩みキーワード  │    │ - 年代: 30代                         │ │
│  │ - お客様属性     │    │ - 来店頻度: 月1回                     │ │
│  └─────────────────┘    └─────────────────────────────────────┘ │
│                                        │                        │
│                                        ▼                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    OpenAI Embedding API                      │ │
│  │                    text-embedding-3-small                    │ │
│  │                    → 1536次元ベクトル生成                     │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                        │                        │
│                                        ▼                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    pgvector / Qdrant                         │ │
│  │                    コサイン類似度検索                          │ │
│  │                    閾値: 0.7以上                              │ │
│  │                    最大: 5件                                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                        │                        │
│                                        ▼                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    成功事例結果                               │ │
│  │  [                                                           │ │
│  │    {                                                         │ │
│  │      similarity: 0.92,                                       │ │
│  │      successfulTalk: "同じお悩みだった○○様は...",             │ │
│  │      keyTactics: ["ベネフィット提示", "お客様の声活用"],        │ │
│  │      conversionRate: 0.78                                    │ │
│  │    },                                                        │ │
│  │    ...                                                       │ │
│  │  ]                                                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│ 通知表示 (iPad)  │
└─────────────────┘
```

### 6.3 コンポーネント図

#### 6.3.1 iPadアプリ コンポーネント

```
┌─────────────────────────────────────────────────────────────────┐
│                    SalonTalk iPad App                            │
│                    (React Native + TypeScript)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Presentation Layer                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │ │
│  │  │ SessionScreen│  │ ReportScreen │  │ TrainingScreen     │  │ │
│  │  │ (施術中画面) │  │ (レポート)   │  │ (トレーニング)       │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │ │
│  │  │ HomeScreen  │  │ SettingsScreen│ │ LoginScreen        │  │ │
│  │  │ (ホーム)     │  │ (設定)       │  │ (ログイン)          │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Business Logic Layer                      │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │                    Hooks                                 │ │ │
│  │  │  useSession    useTranscription    useAnalysis          │ │ │
│  │  │  useRealtime   useNotification     useAuth              │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │                    Stores (Zustand)                      │ │ │
│  │  │  sessionStore    userStore    notificationStore         │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Infrastructure Layer                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │ │
│  │  │ SpeechService│ │ SupabaseClient│ │ NotificationService│  │ │
│  │  │ (音声処理)   │  │ (API通信)    │  │ (通知管理)         │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │ │
│  │  ┌─────────────┐  ┌─────────────┐                          │ │
│  │  │ StorageService│ │ AudioService│                          │ │
│  │  │ (ローカル保存)│  │ (録音管理)  │                          │ │
│  │  └─────────────┘  └─────────────┘                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Native Modules                            │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │  @react-native-ai/apple (SpeechAnalyzer)                │ │ │
│  │  │  @react-native-community/audio (録音)                    │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.3.2 バックエンド コンポーネント

```
┌─────────────────────────────────────────────────────────────────┐
│                    Supabase Edge Functions                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Session Management                        │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ create-session   │  │ end-session                     │   │ │
│  │  │ セッション開始    │  │ セッション終了・レポート生成      │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Audio Processing                          │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ process-audio    │  │ trigger-diarization             │   │ │
│  │  │ 音声チャンク受信  │  │ 話者分離トリガー                 │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    AI Analysis                               │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ analyze-segment  │  │ generate-report                 │   │ │
│  │  │ セグメント分析    │  │ レポート生成                     │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ search-cases     │  │ roleplay-chat                   │   │ │
│  │  │ 成功事例検索     │  │ ロールプレイ会話                  │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Webhook Handlers                          │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────┐   │ │
│  │  │ diarization-     │  │ stripe-webhook                  │   │ │
│  │  │ callback         │  │ 決済Webhook                      │   │ │
│  │  │ 話者分離完了通知  │  │                                  │   │ │
│  │  └─────────────────┘  └─────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    pyannote Server (FastAPI)                     │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    API Endpoints                             │ │
│  │  POST /diarize/{session_id}  - 話者分離リクエスト             │ │
│  │  GET  /status/{session_id}   - 処理状況確認                   │ │
│  │  GET  /health                - ヘルスチェック                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Background Workers                        │ │
│  │  DiarizationWorker - pyannote.audio処理実行                  │ │
│  │  CallbackWorker    - 結果通知                                │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 6.4 デプロイメント図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Production Environment                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    Vercel (Web Hosting)                            │  │
│  │  Region: Tokyo (hnd1)                                              │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  Next.js Application                                        │  │  │
│  │  │  - Web Dashboard                                             │  │  │
│  │  │  - Landing Page                                              │  │  │
│  │  │  Instance: Pro Plan                                          │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    Supabase (BaaS)                                 │  │
│  │  Region: Tokyo (ap-northeast-1)                                    │  │
│  │  Plan: Pro ($25/month)                                             │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────┐   │  │
│  │  │ PostgreSQL   │  │ Auth         │  │ Realtime               │   │  │
│  │  │ + pgvector   │  │              │  │ (WebSocket)            │   │  │
│  │  │ 8GB RAM      │  │              │  │                        │   │  │
│  │  └──────────────┘  └──────────────┘  └────────────────────────┘   │  │
│  │  ┌──────────────┐  ┌──────────────────────────────────────────┐   │  │
│  │  │ Storage      │  │ Edge Functions (Deno)                     │   │  │
│  │  │ 100GB        │  │ 10+ functions                             │   │  │
│  │  └──────────────┘  └──────────────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    GPU VPS (VAST.ai / AWS)                        │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  pyannote Server                                            │  │  │
│  │  │  - GPU: RTX 4060 (8GB VRAM)                                 │  │  │
│  │  │  - RAM: 16GB                                                 │  │  │
│  │  │  - OS: Ubuntu 22.04                                          │  │  │
│  │  │  - Docker Container                                          │  │  │
│  │  │  Cost: ~$0.20/hour                                           │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    External APIs                                   │  │
│  │  ┌──────────────────────┐  ┌──────────────────────────────────┐   │  │
│  │  │ Anthropic Claude API │  │ OpenAI API                        │   │  │
│  │  │ claude-sonnet-4-5    │  │ text-embedding-3-small           │   │  │
│  │  └──────────────────────┘  └──────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    Apple App Store                                 │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  SalonTalk iPad App                                         │  │  │
│  │  │  - React Native (Expo)                                       │  │  │
│  │  │  - iOS 26+ required                                          │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. データモデル設計

### 7.1 ER図

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    salons       │       │    staffs       │       │    sessions     │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │───┐   │ id (PK)         │───┐   │ id (PK)         │
│ name            │   │   │ salon_id (FK)   │◀──┼───│ salon_id (FK)   │
│ address         │   │   │ name            │   │   │ stylist_id (FK) │◀──┐
│ phone           │   └──▶│ email           │   └──▶│ started_at      │   │
│ plan            │       │ role            │       │ ended_at        │   │
│ created_at      │       │ created_at      │       │ status          │   │
│ settings (JSON) │       │ settings (JSON) │       │ customer_info   │   │
└─────────────────┘       └─────────────────┘       └─────────────────┘   │
                                   │                        │             │
                                   │                        │             │
                                   │               ┌────────┴───────┐    │
                                   │               │                │    │
                          ┌────────┴───────┐       ▼                ▼    │
                          │                │  ┌──────────────┐ ┌─────────┴────┐
                          ▼                │  │ transcripts  │ │ speaker_     │
                    ┌───────────────┐      │  ├──────────────┤ │ segments     │
                    │ session_      │      │  │ id (PK)      │ ├──────────────┤
                    │ analyses      │      │  │ session_id   │ │ id (PK)      │
                    ├───────────────┤      │  │ text         │ │ session_id   │
                    │ id (PK)       │      │  │ start_time   │ │ role         │
                    │ session_id    │◀─────┘  │ end_time     │ │ start_time   │
                    │ analysis_type │         │ confidence   │ │ end_time     │
                    │ result (JSON) │         │ created_at   │ │ speaker_label│
                    │ created_at    │         └──────────────┘ └──────────────┘
                    └───────────────┘
                          │
                          │
                          ▼
                    ┌───────────────┐       ┌─────────────────┐
                    │ session_      │       │ success_cases   │
                    │ reports       │       ├─────────────────┤
                    ├───────────────┤       │ id (PK)         │
                    │ id (PK)       │       │ salon_id (FK)   │
                    │ session_id    │       │ session_id (FK) │
                    │ overall_score │       │ concern_keywords│
                    │ good_points   │       │ successful_talk │
                    │ improvements  │       │ key_tactics     │
                    │ action_items  │       │ conversion_rate │
                    │ report_data   │       │ embedding       │
                    │ created_at    │       │ created_at      │
                    └───────────────┘       └─────────────────┘
```

### 7.2 テーブル定義

#### 7.2.1 salons（店舗）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| name | varchar(100) | NO | - | 店舗名 |
| address | text | YES | - | 住所 |
| phone | varchar(20) | YES | - | 電話番号 |
| plan | varchar(20) | NO | 'standard' | 契約プラン |
| seats_count | integer | NO | 10 | セット面数 |
| settings | jsonb | YES | '{}' | 設定情報 |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE salons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  address TEXT,
  phone VARCHAR(20),
  plan VARCHAR(20) NOT NULL DEFAULT 'standard'
    CHECK (plan IN ('standard', 'professional', 'enterprise')),
  seats_count INTEGER NOT NULL DEFAULT 10,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_salons_plan ON salons(plan);
```

#### 7.2.2 staffs（スタッフ）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| salon_id | uuid | NO | - | 所属店舗（FK） |
| auth_user_id | uuid | YES | - | Supabase Auth ID |
| name | varchar(50) | NO | - | 氏名 |
| email | varchar(255) | NO | - | メールアドレス |
| role | varchar(20) | NO | 'stylist' | 役割 |
| position | varchar(50) | YES | - | 役職 |
| join_date | date | YES | - | 入社日 |
| profile_image_url | text | YES | - | プロフィール画像URL |
| settings | jsonb | YES | '{}' | 個人設定 |
| is_active | boolean | NO | true | アクティブフラグ |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE staffs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  auth_user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'stylist'
    CHECK (role IN ('owner', 'manager', 'stylist', 'assistant', 'receptionist')),
  position VARCHAR(50),
  join_date DATE,
  profile_image_url TEXT,
  settings JSONB DEFAULT '{}',
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (salon_id, email)
);

-- インデックス
CREATE INDEX idx_staffs_salon_id ON staffs(salon_id);
CREATE INDEX idx_staffs_auth_user_id ON staffs(auth_user_id);
CREATE INDEX idx_staffs_is_active ON staffs(is_active);
```

#### 7.2.3 sessions（セッション）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| salon_id | uuid | NO | - | 店舗（FK） |
| stylist_id | uuid | NO | - | 担当スタイリスト（FK） |
| started_at | timestamptz | NO | now() | 開始日時 |
| ended_at | timestamptz | YES | - | 終了日時 |
| status | varchar(20) | NO | 'recording' | ステータス |
| customer_info | jsonb | YES | '{}' | お客様情報 |
| diarization_status | varchar(20) | YES | 'pending' | 話者分離ステータス |
| created_at | timestamptz | NO | now() | 作成日時 |
| updated_at | timestamptz | NO | now() | 更新日時 |

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  stylist_id UUID NOT NULL REFERENCES staffs(id) ON DELETE CASCADE,
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  status VARCHAR(20) NOT NULL DEFAULT 'recording'
    CHECK (status IN ('recording', 'processing', 'completed', 'failed')),
  customer_info JSONB DEFAULT '{}',
  diarization_status VARCHAR(20) DEFAULT 'pending'
    CHECK (diarization_status IN ('pending', 'processing', 'completed', 'failed')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_sessions_salon_id ON sessions(salon_id);
CREATE INDEX idx_sessions_stylist_id ON sessions(stylist_id);
CREATE INDEX idx_sessions_status ON sessions(status);
CREATE INDEX idx_sessions_started_at ON sessions(started_at DESC);
```

#### 7.2.4 transcripts（文字起こし）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| text | text | NO | - | 文字起こしテキスト |
| start_time | numeric(10,3) | NO | - | 開始時間（秒） |
| end_time | numeric(10,3) | NO | - | 終了時間（秒） |
| confidence | numeric(5,4) | YES | - | 信頼度 |
| chunk_index | integer | NO | - | チャンク番号 |
| created_at | timestamptz | NO | now() | 作成日時 |

```sql
CREATE TABLE transcripts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  text TEXT NOT NULL,
  start_time NUMERIC(10, 3) NOT NULL,
  end_time NUMERIC(10, 3) NOT NULL,
  confidence NUMERIC(5, 4),
  chunk_index INTEGER NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_transcripts_session_id ON transcripts(session_id);
CREATE INDEX idx_transcripts_start_time ON transcripts(session_id, start_time);
```

#### 7.2.5 speaker_segments（話者セグメント）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| role | varchar(20) | NO | - | 役割 |
| start_time | numeric(10,3) | NO | - | 開始時間（秒） |
| end_time | numeric(10,3) | NO | - | 終了時間（秒） |
| speaker_label | varchar(10) | YES | - | 話者ラベル |
| text | text | YES | - | テキスト（結合後） |
| created_at | timestamptz | NO | now() | 作成日時 |

```sql
CREATE TABLE speaker_segments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  role VARCHAR(20) NOT NULL CHECK (role IN ('stylist', 'customer')),
  start_time NUMERIC(10, 3) NOT NULL,
  end_time NUMERIC(10, 3) NOT NULL,
  speaker_label VARCHAR(10),
  text TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_speaker_segments_session_id ON speaker_segments(session_id);
CREATE INDEX idx_speaker_segments_role ON speaker_segments(session_id, role);
```

#### 7.2.6 session_analyses（セッション分析）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| analysis_type | varchar(30) | NO | - | 分析タイプ |
| result | jsonb | NO | - | 分析結果 |
| created_at | timestamptz | NO | now() | 作成日時 |

```sql
CREATE TABLE session_analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  analysis_type VARCHAR(30) NOT NULL
    CHECK (analysis_type IN (
      'talk_ratio', 'questions', 'emotion', 
      'concern_keywords', 'proposal_timing', 
      'proposal_quality', 'conversion'
    )),
  result JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (session_id, analysis_type)
);

-- インデックス
CREATE INDEX idx_session_analyses_session_id ON session_analyses(session_id);
```

#### 7.2.7 session_reports（セッションレポート）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| session_id | uuid | NO | - | セッション（FK） |
| overall_score | integer | NO | - | 総合スコア |
| good_points | text[] | YES | - | 良かった点 |
| improvement_points | text[] | YES | - | 改善点 |
| action_items | text[] | YES | - | アクションアイテム |
| report_data | jsonb | NO | - | 詳細レポートデータ |
| created_at | timestamptz | NO | now() | 作成日時 |

```sql
CREATE TABLE session_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE UNIQUE,
  overall_score INTEGER NOT NULL CHECK (overall_score >= 0 AND overall_score <= 100),
  good_points TEXT[],
  improvement_points TEXT[],
  action_items TEXT[],
  report_data JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_session_reports_session_id ON session_reports(session_id);
CREATE INDEX idx_session_reports_overall_score ON session_reports(overall_score);
```

#### 7.2.8 success_cases（成功事例）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|-----------|------|
| id | uuid | NO | gen_random_uuid() | 主キー |
| salon_id | uuid | NO | - | 店舗（FK） |
| session_id | uuid | YES | - | 元セッション（FK） |
| stylist_id | uuid | YES | - | スタイリスト（FK） |
| concern_keywords | text[] | NO | - | 悩みキーワード |
| customer_profile | jsonb | YES | - | お客様プロファイル |
| successful_talk | text | NO | - | 成功トーク |
| key_tactics | text[] | YES | - | 成功要因 |
| sold_product | varchar(100) | YES | - | 販売商品 |
| conversion_rate | numeric(5,4) | NO | - | 成約率 |
| embedding | vector(1536) | NO | - | ベクトル埋め込み |
| is_public | boolean | NO | false | 全店舗公開フラグ |
| created_at | timestamptz | NO | now() | 作成日時 |

```sql
-- pgvector拡張を有効化
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE success_cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
  stylist_id UUID REFERENCES staffs(id) ON DELETE SET NULL,
  concern_keywords TEXT[] NOT NULL,
  customer_profile JSONB,
  successful_talk TEXT NOT NULL,
  key_tactics TEXT[],
  sold_product VARCHAR(100),
  conversion_rate NUMERIC(5, 4) NOT NULL,
  embedding VECTOR(1536) NOT NULL,
  is_public BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- HNSWインデックス（ベクトル検索用）
CREATE INDEX ON success_cases 
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- その他のインデックス
CREATE INDEX idx_success_cases_salon_id ON success_cases(salon_id);
CREATE INDEX idx_success_cases_concern_keywords ON success_cases USING GIN(concern_keywords);
```

### 7.3 Row Level Security（RLS）ポリシー

```sql
-- RLS有効化
ALTER TABLE salons ENABLE ROW LEVEL SECURITY;
ALTER TABLE staffs ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE transcripts ENABLE ROW LEVEL SECURITY;
ALTER TABLE speaker_segments ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE success_cases ENABLE ROW LEVEL SECURITY;

-- salonsポリシー（所属店舗のみアクセス可能）
CREATE POLICY "Users can view their salon" ON salons
  FOR SELECT USING (
    id = (
      SELECT salon_id FROM staffs 
      WHERE auth_user_id = auth.uid()
    )
  );

-- staffsポリシー（同一店舗のスタッフのみ閲覧可能）
CREATE POLICY "Users can view staff in their salon" ON staffs
  FOR SELECT USING (
    salon_id = (
      SELECT salon_id FROM staffs 
      WHERE auth_user_id = auth.uid()
    )
  );

-- sessionsポリシー（店舗データ分離）
CREATE POLICY "Sessions belong to salon" ON sessions
  FOR ALL USING (
    salon_id = (
      SELECT salon_id FROM staffs 
      WHERE auth_user_id = auth.uid()
    )
  );

-- transcriptsポリシー
CREATE POLICY "Transcripts belong to salon" ON transcripts
  FOR ALL USING (
    session_id IN (
      SELECT id FROM sessions 
      WHERE salon_id = (
        SELECT salon_id FROM staffs 
        WHERE auth_user_id = auth.uid()
      )
    )
  );

-- success_casesポリシー（自店舗 or 公開事例）
CREATE POLICY "Success cases access" ON success_cases
  FOR SELECT USING (
    is_public = true
    OR salon_id = (
      SELECT salon_id FROM staffs 
      WHERE auth_user_id = auth.uid()
    )
  );
```

---

## 8. API仕様

### 8.1 API設計方針

- **プロトコル**: HTTPS
- **認証**: Supabase Auth（JWT）
- **レスポンス形式**: JSON
- **エラー形式**: RFC 7807準拠

### 8.2 エンドポイント一覧

#### 8.2.1 セッション管理

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| POST | /functions/v1/create-session | セッション開始 |
| POST | /functions/v1/end-session | セッション終了 |
| GET | /rest/v1/sessions | セッション一覧取得 |
| GET | /rest/v1/sessions/{id} | セッション詳細取得 |

#### 8.2.2 音声処理

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| POST | /functions/v1/process-audio | 音声チャンク処理 |
| POST | /functions/v1/trigger-diarization | 話者分離開始 |
| POST | /functions/v1/diarization-callback | 話者分離完了コールバック |

#### 8.2.3 AI分析

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| POST | /functions/v1/analyze-segment | セグメント分析 |
| POST | /functions/v1/generate-report | レポート生成 |
| POST | /functions/v1/search-cases | 成功事例検索 |

#### 8.2.4 トレーニング

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| POST | /functions/v1/roleplay-chat | ロールプレイ会話 |
| GET | /rest/v1/scenarios | シナリオ一覧取得 |

### 8.3 API詳細仕様

#### POST /functions/v1/create-session

**説明**: 新規セッションを開始する

**リクエストヘッダー**:
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```

**リクエストボディ**:
```json
{
  "stylistId": "uuid",
  "customerInfo": {
    "ageGroup": "30s",
    "gender": "female",
    "visitFrequency": "monthly",
    "notes": "パーマの予約"
  }
}
```

**レスポンス（成功: 201）**:
```json
{
  "sessionId": "uuid",
  "status": "recording",
  "startedAt": "2025-12-04T10:00:00Z",
  "realtimeChannel": "session:uuid"
}
```

**レスポンス（エラー: 400）**:
```json
{
  "type": "https://api.salontalk.jp/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "stylistId is required",
  "instance": "/functions/v1/create-session"
}
```

---

#### POST /functions/v1/process-audio

**説明**: 音声チャンクを処理し、文字起こしを保存する

**リクエストヘッダー**:
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: multipart/form-data
```

**リクエストボディ**:
```
sessionId: uuid
chunkIndex: 1
audio: (binary WAV file)
transcripts: [
  {"text": "今日はどんな...", "startTime": 0.1, "endTime": 0.5}
]
```

**レスポンス（成功: 200）**:
```json
{
  "status": "processed",
  "chunkIndex": 1,
  "transcriptCount": 15,
  "diarizationTriggered": true
}
```

---

#### POST /functions/v1/search-cases

**説明**: 類似の成功事例を検索する

**リクエストボディ**:
```json
{
  "concernKeywords": ["乾燥", "広がる"],
  "customerProfile": {
    "ageGroup": "30s",
    "visitFrequency": "monthly"
  },
  "limit": 5,
  "minConversionRate": 0.3
}
```

**レスポンス（成功: 200）**:
```json
{
  "cases": [
    {
      "id": "uuid",
      "similarity": 0.92,
      "concernKeywords": ["乾燥", "パサつき"],
      "successfulTalk": "同じお悩みだった○○様は...",
      "keyTactics": ["ベネフィット提示", "お客様の声活用"],
      "conversionRate": 0.78,
      "soldProduct": "モイスチャーシャンプー"
    }
  ],
  "totalFound": 12
}
```

---

#### POST /functions/v1/roleplay-chat

**説明**: AIロールプレイの会話を行う

**リクエストボディ**:
```json
{
  "scenarioId": "uuid",
  "sessionId": "uuid",
  "userMessage": "このシャンプーは乾燥に効果的ですよ",
  "conversationHistory": [
    {"role": "ai", "content": "最近、髪がパサパサして困ってるんです..."},
    {"role": "user", "content": "そうなんですね、乾燥が気になりますか？"}
  ]
}
```

**レスポンス（成功: 200）**:
```json
{
  "aiResponse": "そうですか...でも、シャンプー変えても大丈夫かな。今使ってるのがあるので...",
  "hint": "異議処理のチャンス！現在のシャンプーとの違いを具体的に説明しましょう",
  "evaluation": {
    "current": {
      "score": 65,
      "feedback": "ベネフィット提示が弱い"
    }
  },
  "isCompleted": false
}
```

---

### 8.4 Realtime API（WebSocket）

#### チャンネル構成

| チャンネル | 用途 | イベント |
|-----------|------|---------|
| session:{id} | セッション状態 | transcript, analysis, notification |
| staff:{id} | スタッフ通知 | session_update, alert |
| salon:{id} | 店舗全体 | announcement |

#### イベント形式

```typescript
// 文字起こし更新
{
  event: "transcript",
  payload: {
    sessionId: "uuid",
    segments: [
      { text: "今日はどんな...", role: "stylist", startTime: 0.1 }
    ]
  }
}

// 分析結果更新
{
  event: "analysis",
  payload: {
    sessionId: "uuid",
    type: "realtime_score",
    data: {
      listeningScore: 75,
      questionCount: 5,
      emotionIndicator: "positive"
    }
  }
}

// 提案通知
{
  event: "notification",
  payload: {
    type: "proposal_timing",
    concernKeyword: "乾燥",
    suggestedProduct: "モイスチャーシャンプー",
    successTalkExample: "同じお悩みだった○○様は..."
  }
}
```

---

## 9. UI/UX要件

### 9.1 デザイン原則

1. **シンプルさ**: 施術中でも瞬時に理解できるUI
2. **控えめさ**: 施術の邪魔にならない表示
3. **即時性**: リアルタイム更新による臨場感
4. **アクセシビリティ**: 視認性の高い配色・フォントサイズ

### 9.2 画面一覧

| 画面ID | 画面名 | 概要 |
|--------|--------|------|
| SCR-001 | ログイン画面 | 認証 |
| SCR-002 | ホーム画面 | メニュー選択 |
| SCR-003 | セッション画面 | 施術中のメイン画面 |
| SCR-004 | レポート一覧 | 過去レポート閲覧 |
| SCR-005 | レポート詳細 | 個別レポート詳細 |
| SCR-006 | トレーニング画面 | AIロールプレイ |
| SCR-007 | 設定画面 | アプリ設定 |
| SCR-101 | ダッシュボード | 管理者トップ |
| SCR-102 | スタッフ管理 | スタッフ一覧・詳細 |
| SCR-103 | 分析画面 | 店舗分析 |

### 9.3 画面遷移図

```
┌─────────────┐
│  SCR-001    │
│  ログイン    │
└──────┬──────┘
       │ 認証成功
       ▼
┌─────────────┐
│  SCR-002    │◀────────────────────────────────────┐
│  ホーム      │                                     │
└──────┬──────┘                                     │
       │                                            │
       ├───────────┬───────────┬───────────────────┤
       ▼           ▼           ▼                   │
┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │
│  SCR-003    │ │  SCR-004    │ │  SCR-006    │    │
│  セッション  │ │  レポート一覧 │ │  トレーニング │    │
└──────┬──────┘ └──────┬──────┘ └─────────────┘    │
       │               │                           │
       │ 終了          │ 選択                       │
       ▼               ▼                           │
┌─────────────┐ ┌─────────────┐                    │
│  SCR-005    │ │  SCR-005    │                    │
│  レポート詳細│ │  レポート詳細│                    │
└──────┬──────┘ └──────┬──────┘                    │
       │               │                           │
       └───────────────┴───────────────────────────┘
```

### 9.4 セッション画面（SCR-003）ワイヤーフレーム

```
┌─────────────────────────────────────────────────────────────────┐
│  ← 戻る                    セッション中                  ⏱ 45:23 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    リアルタイムスコア                       │  │
│  │                                                           │  │
│  │   傾聴スコア         質問数           感情               │  │
│  │   ┌─────────┐      ┌─────────┐      ┌─────────┐          │  │
│  │   │   72    │      │   8     │      │   😊    │          │  │
│  │   │  ████▓░░│      │  回     │      │         │          │  │
│  │   └─────────┘      └─────────┘      └─────────┘          │  │
│  │                                                           │  │
│  │   検出された悩み:                                          │  │
│  │   ┌──────┐ ┌──────┐                                       │  │
│  │   │ 乾燥  │ │広がる │                                       │  │
│  │   └──────┘ └──────┘                                       │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 🎯 提案チャンス！                                          │  │
│  │                                                           │  │
│  │ お客様が「乾燥」「広がる」と発言しました                     │  │
│  │                                                           │  │
│  │ ▶ 保湿シャンプーを提案しましょう                           │  │
│  │                                                           │  │
│  │ 💡 成功トーク例：                                          │  │
│  │ 「同じお悩みだった○○様は、このシャンプーで                 │  │
│  │   朝のドライヤー時間が5分短縮できたとおっしゃってました」    │  │
│  │                                                     [閉じる]│  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    会話ログ                                │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ 👤 今日はどんな感じにしますか？                       │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ 💇 最近、髪が乾燥してパサパサなんです...              │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ 👤 乾燥が気になりますか？朝とか広がったりします？      │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ 💇 そうなんです、広がって困ってて...                   │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  [● セッション終了]                        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.5 レスポンシブ対応

| デバイス | 解像度 | レイアウト |
|---------|--------|-----------|
| iPad Pro 12.9" | 2048 x 2732 | フル機能表示 |
| iPad Pro 11" | 1668 x 2388 | フル機能表示 |
| iPad Air | 1640 x 2360 | フル機能表示 |
| Web（デスクトップ） | 1920 x 1080以上 | サイドバー + メインコンテンツ |
| Web（タブレット） | 768 x 1024以上 | 折りたたみサイドバー |

### 9.6 カラーパレット

| 用途 | カラーコード | 説明 |
|------|------------|------|
| Primary | #6366F1 | ブランドカラー（インディゴ） |
| Secondary | #EC4899 | アクセントカラー（ピンク） |
| Success | #10B981 | 成功・良好（エメラルド） |
| Warning | #F59E0B | 警告（アンバー） |
| Error | #EF4444 | エラー（レッド） |
| Background | #F9FAFB | 背景（グレー50） |
| Text Primary | #111827 | 本文（グレー900） |
| Text Secondary | #6B7280 | 補足文（グレー500） |

### 9.7 タイポグラフィ

| 用途 | フォント | サイズ | 行高 |
|------|---------|--------|------|
| 見出し1 | Noto Sans JP Bold | 28px | 1.3 |
| 見出し2 | Noto Sans JP Bold | 24px | 1.3 |
| 見出し3 | Noto Sans JP Medium | 20px | 1.4 |
| 本文 | Noto Sans JP Regular | 16px | 1.6 |
| キャプション | Noto Sans JP Regular | 14px | 1.5 |
| スコア数値 | SF Pro Display Bold | 48px | 1.0 |

---

## 10. セキュリティ要件

### 10.1 認証・認可

#### SEC-A01: 認証方式

| 要件 | 仕様 |
|------|------|
| 認証プロバイダ | Supabase Auth |
| 認証方式 | メール/パスワード |
| トークン形式 | JWT（RS256） |
| トークン有効期限 | アクセストークン: 1時間、リフレッシュトークン: 7日 |
| MFA | 将来対応予定（Phase 3） |

#### SEC-A02: ロールベースアクセス制御（RBAC）

| ロール | 権限 |
|--------|------|
| owner | 全機能アクセス、店舗設定変更、スタッフ管理 |
| manager | スタッフ管理、レポート閲覧、分析閲覧 |
| stylist | 自身のセッション・レポートのみ |
| assistant | 閲覧のみ |

### 10.2 データ保護

#### SEC-D01: 暗号化

| 対象 | 方式 |
|------|------|
| 通信 | TLS 1.3 |
| データベース（保存時） | AES-256（Supabase標準） |
| バックアップ | AES-256 |

#### SEC-D02: 個人情報保護

```sql
-- 個人情報マスキング関数
CREATE OR REPLACE FUNCTION anonymize_text(input_text TEXT)
RETURNS TEXT AS $$
BEGIN
  -- 氏名パターンのマスキング
  input_text := regexp_replace(
    input_text, 
    '[一-龯ぁ-んァ-ヶー]{2,4}(さん|様|氏)', 
    '○○様', 
    'g'
  );
  
  -- 電話番号のマスキング
  input_text := regexp_replace(
    input_text,
    '\d{2,4}-\d{2,4}-\d{4}',
    '***-****-****',
    'g'
  );
  
  -- 郵便番号のマスキング
  input_text := regexp_replace(
    input_text,
    '\d{3}-\d{4}',
    '***-****',
    'g'
  );
  
  RETURN input_text;
END;
$$ LANGUAGE plpgsql;
```

#### SEC-D03: データ保持ポリシー

| データ種別 | 保持期間 | 削除方法 |
|-----------|---------|---------|
| 音声ファイル | 処理完了後即時削除 | 自動 |
| 文字起こしテキスト | 6年 | 自動（cron） |
| 分析結果 | 6年 | 自動（cron） |
| レポート | 6年 | 自動（cron） |
| ログ | 1年 | 自動 |

### 10.3 アクセス制御

#### SEC-AC01: Row Level Security

全テーブルにRLSを適用し、店舗単位でデータを分離する（7.3節参照）。

#### SEC-AC02: API レート制限

| エンドポイント | 制限 |
|--------------|------|
| 認証API | 10 req/min/IP |
| 一般API | 100 req/min/user |
| AI分析API | 20 req/min/user |

### 10.4 監査・ログ

#### SEC-L01: 監査ログ

| イベント | 記録内容 |
|---------|---------|
| ログイン/ログアウト | ユーザーID、日時、IPアドレス |
| データアクセス | ユーザーID、テーブル、アクション、日時 |
| 設定変更 | ユーザーID、変更内容、日時 |
| エラー | エラー詳細、スタックトレース |

#### SEC-L02: ログ保管

- **保管場所**: Supabase Logs + 外部保管（CloudWatch等）
- **保管期間**: 1年
- **アクセス権限**: システム管理者のみ

### 10.5 脆弱性対策

| 脅威 | 対策 |
|------|------|
| SQLインジェクション | パラメータ化クエリ、Supabase RPC |
| XSS | React自動エスケープ、CSP設定 |
| CSRF | SameSite Cookie、Originチェック |
| 中間者攻撃 | TLS 1.3必須、HSTS |

---

## 11. 外部インターフェース

### 11.1 外部サービス一覧

| サービス | 用途 | 接続方式 |
|---------|------|---------|
| Supabase | BaaS（DB、Auth、Realtime） | REST API / WebSocket |
| Anthropic Claude | AI分析 | REST API |
| OpenAI | Embedding生成 | REST API |
| pyannote Server | 話者分離 | REST API（自己ホスト） |
| Apple Push Notification | プッシュ通知 | APNs |
| Stripe | 決済（将来） | REST API / Webhook |

### 11.2 インターフェース仕様

#### 11.2.1 Anthropic Claude API

**用途**: セッション分析、レポート生成、ロールプレイ

**接続情報**:
| 項目 | 値 |
|------|-----|
| エンドポイント | https://api.anthropic.com/v1/messages |
| 認証 | x-api-key ヘッダー |
| モデル | claude-sonnet-4-5-20250929 |

**リクエスト例**:
```typescript
const response = await anthropic.messages.create({
  model: "claude-sonnet-4-5-20250929",
  max_tokens: 4096,
  messages: [{
    role: "user",
    content: analysisPrompt
  }]
});
```

**エラーハンドリング**:
| HTTPステータス | 対応 |
|---------------|------|
| 429 | リトライ（指数バックオフ） |
| 500-503 | リトライ（最大3回） |
| 400 | ログ記録、ユーザー通知 |

#### 11.2.2 OpenAI Embedding API

**用途**: 成功事例のベクトル埋め込み生成

**接続情報**:
| 項目 | 値 |
|------|-----|
| エンドポイント | https://api.openai.com/v1/embeddings |
| 認証 | Bearer トークン |
| モデル | text-embedding-3-small |
| 次元数 | 1536 |

**リクエスト例**:
```typescript
const response = await openai.embeddings.create({
  model: "text-embedding-3-small",
  input: sceneDescription
});
const embedding = response.data[0].embedding;
```

#### 11.2.3 pyannote Server API

**用途**: 話者分離処理

**接続情報**:
| 項目 | 値 |
|------|-----|
| エンドポイント | http://{pyannote-server}/diarize/{session_id} |
| 認証 | API Key（カスタムヘッダー） |
| プロトコル | HTTP（内部ネットワーク） |

**リクエスト**:
- Method: POST
- Content-Type: multipart/form-data
- Body: audio (WAVファイル)

**レスポンス**:
```json
{
  "status": "processing",
  "session_id": "uuid",
  "callback_url": "https://..."
}
```

### 11.3 外部データ連携（将来計画）

#### 11.3.1 POSシステム連携

**対象システム**: サロンアンサー、Bionly等

**連携データ**:
- お客様情報（年代、来店履歴）
- 購買履歴
- 予約情報

**連携方式**: REST API / CSVインポート

#### 11.3.2 予約システム連携

**対象システム**: ホットペッパービューティー、各種予約システム

**連携データ**:
- 予約情報
- お客様属性

---

## 12. 運用・保守要件

### 12.1 運用体制

| 役割 | 担当 | 責務 |
|------|------|------|
| システム運用 | PM + AI | 監視、障害対応、デプロイ |
| カスタマーサポート | 専任（Phase 2〜） | 問い合わせ対応、オンボーディング |
| 開発保守 | PM + AI | バグ修正、機能追加 |

### 12.2 監視要件

#### 12.2.1 監視項目

| 項目 | 閾値 | アラート先 |
|------|------|-----------|
| APIレスポンスタイム | 平均 > 3秒 | Slack |
| エラー率 | > 1% | Slack + メール |
| CPU使用率（pyannote） | > 80% | Slack |
| ディスク使用率 | > 80% | Slack |
| セッション異常終了 | > 5%/日 | Slack |

#### 12.2.2 監視ツール

| ツール | 用途 |
|--------|------|
| Supabase Dashboard | DB監視、ログ確認 |
| Vercel Analytics | Webパフォーマンス |
| Sentry | エラートラッキング |
| UptimeRobot | 死活監視 |

### 12.3 バックアップ・リカバリ

#### 12.3.1 バックアップ方針

| 対象 | 方式 | 頻度 | 保持期間 |
|------|------|------|---------|
| PostgreSQL | Supabase自動バックアップ | 日次 | 7日 |
| PostgreSQL（追加） | pg_dump | 週次 | 30日 |
| ファイルストレージ | Supabase Storage | リアルタイム | - |
| 設定ファイル | Git | 変更時 | 無期限 |

#### 12.3.2 リカバリ手順

**RTO**: 4時間以内
**RPO**: 1時間以内

1. Supabaseの自動バックアップからリストア
2. 必要に応じて手動バックアップから差分適用
3. アプリケーション再デプロイ
4. 動作確認

### 12.4 デプロイメント

#### 12.4.1 デプロイ方式

| コンポーネント | デプロイ方式 |
|--------------|------------|
| Webアプリ | Vercel自動デプロイ（GitHub連携） |
| Edge Functions | Supabase CLI |
| iPadアプリ | App Store Connect |
| pyannote Server | Docker + SSH |

#### 12.4.2 デプロイフロー

```
開発 → PR作成 → レビュー → マージ（main）
                              ↓
                   ┌──────────┴──────────┐
                   ▼                     ▼
             Vercel自動デプロイ     Supabase自動デプロイ
             (Preview → Production)  (Edge Functions)
```

### 12.5 SLA

| 項目 | 目標 |
|------|------|
| 稼働率 | 99.5% |
| 計画メンテナンス | 月4時間以内（深夜実施） |
| 障害復旧時間 | 4時間以内 |
| サポート応答時間 | 24時間以内（営業日） |

---

## 13. テスト要件

### 13.1 テスト戦略

```
┌─────────────────────────────────────────────────────────────────┐
│                    テストピラミッド                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                         ┌───┐                                   │
│                        ╱ E2E ╲                                  │
│                       ╱───────╲                                 │
│                      ╱   10%   ╲                                │
│                     ╱───────────╲                               │
│                    ╱ Integration ╲                              │
│                   ╱───────────────╲                             │
│                  ╱      20%        ╲                            │
│                 ╱───────────────────╲                           │
│                ╱      Unit Tests     ╲                          │
│               ╱─────────────────────────╲                       │
│              ╱          70%              ╲                      │
│             └─────────────────────────────┘                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 13.2 テスト種別

#### 13.2.1 単体テスト

| 対象 | ツール | カバレッジ目標 |
|------|--------|--------------|
| React Nativeコンポーネント | Jest + React Native Testing Library | 80% |
| TypeScript関数 | Jest | 80% |
| Edge Functions | Deno Test | 80% |
| SQL関数 | pgTAP | 70% |

#### 13.2.2 統合テスト

| 対象 | ツール | 範囲 |
|------|--------|------|
| API統合 | Supertest + Jest | 全エンドポイント |
| DB統合 | Supabase Test Helpers | CRUD操作、RLS |
| 外部API統合 | Mock Service Worker | Claude、OpenAI |

#### 13.2.3 E2Eテスト

| 対象 | ツール | シナリオ数 |
|------|--------|-----------|
| Webダッシュボード | Playwright | 20シナリオ |
| iPadアプリ | Detox | 15シナリオ |

### 13.3 テストシナリオ（主要）

#### TS-001: セッション開始〜終了

**目的**: 基本的なセッションフローの動作確認

**前提条件**:
- スタイリストとしてログイン済み
- マイク権限許可済み

**手順**:
1. ホーム画面で「セッション開始」をタップ
2. お客様情報を入力
3. 録音開始を確認
4. 5分間会話を模擬
5. 「セッション終了」をタップ
6. レポート生成を確認

**期待結果**:
- セッションが正常に開始される
- リアルタイムスコアが表示される
- セッション終了後、5分以内にレポートが生成される

#### TS-002: 提案タイミング通知

**目的**: 悩みキーワード検出と通知の動作確認

**手順**:
1. セッションを開始
2. お客様役で「髪が乾燥してパサパサなんです」と発話
3. 通知表示を確認
4. 成功トーク例の内容を確認

**期待結果**:
- 「乾燥」「パサパサ」が悩みキーワードとして検出される
- 3分以内に提案通知が表示される
- 成功トーク例が表示される

#### TS-003: 成功事例検索

**目的**: ベクトル検索の精度確認

**手順**:
1. テスト用成功事例データを投入
2. 「乾燥、広がる」をキーワードに検索
3. 類似度スコアと結果を確認

**期待結果**:
- 類似度0.7以上の事例が返される
- 最も類似度の高い事例が先頭に表示される
- 応答時間が2秒以内

### 13.4 性能テスト

#### 13.4.1 負荷テスト

| テスト | 条件 | 目標 |
|--------|------|------|
| 同時セッション | 100セッション同時 | 応答3秒以内 |
| API負荷 | 100 req/s | エラー率 < 1% |
| DB負荷 | 1000クエリ/分 | 応答100ms以内 |

#### 13.4.2 長時間テスト

| テスト | 条件 | 目標 |
|--------|------|------|
| 連続稼働 | 24時間連続運用 | メモリリークなし |
| セッション長時間 | 3時間セッション | 正常動作 |

### 13.5 セキュリティテスト

| テスト | ツール | 頻度 |
|--------|--------|------|
| 脆弱性スキャン | OWASP ZAP | 月次 |
| 依存関係チェック | npm audit / Snyk | CI/CD毎 |
| ペネトレーションテスト | 外部委託 | 年次 |

---

## 14. 開発計画・マイルストーン

### 14.1 フェーズ概要

```
2026年
  1月       2月       3月       4月〜9月      10月〜
   │        │         │         │            │
   ├────────┴─────────┤         │            │
   │   Phase 1        │         │            │
   │   初期版開発      │         │            │
   │   (3ヶ月)        │         │            │
   │                   ├─────────┤            │
   │                   │ Phase 2 │            │
   │                   │ AI強化   │            │
   │                   │ (6ヶ月) │            │
   │                   │         ├────────────┤
   │                   │         │  Phase 3   │
   │                   │         │  教育機能   │
   │                   │         │  (9ヶ月)   │
```

### 14.2 Phase 1: 初期版開発（2026年1月〜3月）

**目標**: 基本機能を実装し、Prestoグループ3店舗でβテスト

#### マイルストーン

| 週 | マイルストーン | 成果物 |
|----|--------------|--------|
| 1-2 | 開発環境構築 | プロジェクト構成、CI/CD |
| 3-4 | 音声処理実装 | SpeechAnalyzer統合 |
| 5-6 | 話者分離実装 | pyannoteサーバー構築 |
| 7-8 | AI分析実装 | Claude統合、基本分析 |
| 9-10 | iPad UI実装 | セッション画面 |
| 11-12 | βテスト | フィードバック収集 |

#### 成果物

| 成果物 | 説明 |
|--------|------|
| iPadアプリ v0.1 | 基本的なセッション機能 |
| 管理ダッシュボード v0.1 | スタッフ管理、レポート閲覧 |
| pyannoteサーバー | 話者分離処理 |
| βテストレポート | フィードバック集約 |

### 14.3 Phase 2: AI分析強化（2026年4月〜9月）

**目標**: AI分析精度を向上し、10店舗に拡大

#### マイルストーン

| 月 | マイルストーン | 成果物 |
|----|--------------|--------|
| 4月 | 成功事例DB構築 | pgvector実装 |
| 5月 | 類似事例検索 | ベクトル検索機能 |
| 6月 | リアルタイムアシスト | 提案通知機能 |
| 7月 | スコアリング改善 | 分析精度向上 |
| 8月 | レポート強化 | 詳細レポート生成 |
| 9月 | 10店舗展開 | 本番環境安定化 |

#### 成果物

| 成果物 | 説明 |
|--------|------|
| iPadアプリ v1.0 | リアルタイムアシスト機能 |
| 成功事例DB | 初期データ100件 |
| 改善されたAI分析 | 7指標の精度向上 |

### 14.4 Phase 3: 教育機能追加（2026年10月〜2027年6月）

**目標**: 教育機能を追加し、正式ローンチ

#### マイルストーン

| 四半期 | マイルストーン | 成果物 |
|--------|--------------|--------|
| 2026Q4 | AIロールプレイ | トレーニング機能 |
| 2027Q1 | ゲーミフィケーション | バッジ・ランキング |
| 2027Q2 | 正式ローンチ | 一般販売開始 |

#### 成果物

| 成果物 | 説明 |
|--------|------|
| iPadアプリ v2.0 | 教育機能搭載 |
| Webダッシュボード v2.0 | 詳細分析機能 |
| ドキュメント | ユーザーマニュアル、API仕様書 |

### 14.5 リソース計画

| フェーズ | 期間 | 人員 | 予算 |
|---------|------|------|------|
| Phase 1 | 3ヶ月 | PM 1名 + AI | 45万円 |
| Phase 2 | 6ヶ月 | PM 1名 + AI | 90万円 |
| Phase 3 | 9ヶ月 | PM 1名 + CS 1名 + AI | 200万円 |

---

## 15. 制約事項・前提条件

### 15.1 技術的制約

| 制約 | 詳細 | 影響 |
|------|------|------|
| iOS 26必須 | SpeechAnalyzerはiOS 26以降のみ対応 | 対応デバイスの制限 |
| iPadのみ対応 | iPhoneは画面サイズの関係で非対応 | 端末の制限 |
| 話者分離はサーバー処理 | pyannoteはオンデバイス実行不可 | ネットワーク必須 |
| 日本語のみ対応（初期） | 多言語対応はPhase 4以降 | 海外展開の制限 |

### 15.2 ビジネス的制約

| 制約 | 詳細 | 対応 |
|------|------|------|
| 開発予算 | 初期45万円 | AI駆動開発で対応 |
| 開発人員 | PM 1名のみ | AI活用で補完 |
| 初期導入店舗 | Prestoグループ5店舗 | 自社検証で品質担保 |

### 15.3 前提条件

| 前提 | 詳細 | リスク |
|------|------|--------|
| iOS 26リリース | 2026年秋にiOS 26が正式リリースされる | リリース遅延時は代替手段検討 |
| Claude API安定稼働 | Anthropic APIが安定的に利用可能 | 代替LLM検討 |
| Supabase継続 | Supabaseサービスが継続される | 移行計画策定 |
| 美容室の協力 | Prestoグループがβテストに協力 | 協力体制の確認 |

### 15.4 規制・コンプライアンス

| 規制 | 対応 |
|------|------|
| 個人情報保護法 | 個人情報の適切な取り扱い、利用目的の明示 |
| 録音の法的要件 | お客様への事前説明、同意取得 |
| データ越境 | 国内リージョン（Tokyo）でのデータ保存 |

### 15.5 外部依存関係

| 依存先 | リスク | 緩和策 |
|--------|--------|--------|
| Apple (iOS/SpeechAnalyzer) | API変更、非推奨化 | 代替手段の調査 |
| Anthropic (Claude) | 料金変更、API変更 | 他LLMへの切り替え準備 |
| OpenAI (Embedding) | 料金変更、API変更 | 他Embeddingモデル検討 |
| Supabase | サービス終了、料金変更 | 移行計画の策定 |

---

## 16. 用語集

| 用語 | 定義 |
|------|------|
| **セッション** | 1回の施術における会話分析の単位 |
| **文字起こし** | 音声をテキストに変換する処理 |
| **話者分離** | 複数話者の発話を個別に識別する技術 |
| **SpeechAnalyzer** | iOS 26で導入されたAppleの音声認識API |
| **pyannote.audio** | オープンソースの話者分離フレームワーク |
| **トーク比率** | 美容師とお客様の発話時間の比率 |
| **オープン質問** | 「どう」「何」等で始まる、自由回答を促す質問 |
| **クローズド質問** | はい/いいえで答えられる質問 |
| **悩みキーワード** | お客様が発した髪の悩みに関する言葉 |
| **提案タイミング** | 商品を提案するのに適切な会話の瞬間 |
| **成功事例** | 成約に至った会話パターンのデータベース |
| **ベクトル埋め込み** | テキストを数値ベクトルに変換したもの |
| **pgvector** | PostgreSQLのベクトル検索拡張 |
| **Qdrant** | ベクトル検索に特化したデータベース |
| **RLS** | Row Level Security（行レベルセキュリティ） |
| **店販** | 美容室で販売するシャンプー等の商品 |
| **成約率** | 提案に対して購入に至った割合 |
| **AIロールプレイ** | AIがお客様役となるトレーニング機能 |
| **ゲーミフィケーション** | ゲーム要素を取り入れた動機付け手法 |

---

## 17. 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|---------|
| 1.0 | 2025-12-04 | Daisuke | 初版作成 |

---

## 付録

### 付録A: APIエラーコード一覧

| コード | 説明 | HTTPステータス |
|--------|------|--------------|
| AUTH_001 | 認証トークン無効 | 401 |
| AUTH_002 | 権限不足 | 403 |
| VAL_001 | 必須パラメータ不足 | 400 |
| VAL_002 | パラメータ形式エラー | 400 |
| SES_001 | セッション未開始 | 400 |
| SES_002 | セッション既に終了 | 400 |
| AI_001 | AI分析タイムアウト | 504 |
| AI_002 | AI分析エラー | 500 |
| DB_001 | データベースエラー | 500 |

### 付録B: 設定パラメータ一覧

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| AUDIO_CHUNK_DURATION | 60 | 音声チャンクの長さ（秒） |
| DIARIZATION_NUM_SPEAKERS | 2 | 想定話者数 |
| ANALYSIS_TIMEOUT | 30000 | AI分析タイムアウト（ms） |
| VECTOR_SEARCH_THRESHOLD | 0.7 | 類似度検索閾値 |
| VECTOR_SEARCH_LIMIT | 5 | 検索結果最大件数 |
| PROPOSAL_TIMING_DELAY | 180 | 提案通知遅延（秒） |

### 付録C: 環境変数一覧

```env
# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx

# Anthropic
ANTHROPIC_API_KEY=sk-ant-xxx

# OpenAI
OPENAI_API_KEY=sk-xxx

# pyannote
PYANNOTE_SERVER_URL=http://xxx:8000
PYANNOTE_API_KEY=xxx
HUGGINGFACE_TOKEN=hf_xxx

# App
APP_ENV=production
LOG_LEVEL=info
```

---

**本文書は機密情報を含みます。無断転載・複製を禁止します。**

© 2025 Revol Corporation. All Rights Reserved.
