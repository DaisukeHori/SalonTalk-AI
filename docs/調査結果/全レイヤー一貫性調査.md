# 全レイヤー一貫性調査レポート

調査日: 2025-12-05
調査対象: 企画書・設計書・DB・UI・ワーカー（Edge Functions）

## 調査目的
全レイヤー間で用語・カラム名・データ構造の一貫性を確保する

---

## 調査ラウンド記録

### ラウンド1-10: DBスキーマと型定義の比較

#### ラウンド1: salonsテーブル
- **DB**: `supabase/migrations/00000000000000_initial_schema.sql`
- **shared型**: `packages/shared/src/infrastructure/supabase/types.ts`
- **UI型**: `apps/web/src/types/database.ts`
- **結果**: ✅ 一致

#### ラウンド2: staffsテーブル
- **結果**: ⚠️ 不一致発見
- **問題**: UI型に存在しないカラムあり
  - `position` - DBに存在しない
  - `join_date` - DBに存在しない
  - `profile_image_url` - DBに存在しない（`avatar_url`が正解）
  - `settings` - DBに存在しない

#### ラウンド3: sessionsテーブル
- **結果**: ⚠️ 不一致発見
- **問題**:
  - UI型に`diarization_status`があるが、DBスキーマ（migration）には存在しない
  - 設計書・企画書には`diarization_status`の記載あり

#### ラウンド4: transcriptsテーブル
- **結果**: ⚠️ 不一致発見
- **問題**: UI型に`confidence`カラムが欠けている

#### ラウンド5: speaker_segmentsテーブル
- **結果**: ✅ 一致

#### ラウンド6: session_analysesテーブル
- **結果**: ✅ 一致（正規化構造で統一済み）

#### ラウンド7: session_reportsテーブル
- **結果**: ⚠️ 設計書と実装で差異
- **設計書**: `good_points`, `improvement_points`, `action_items`, `transcript_summary`, `ai_feedback`
- **DB実装**: `summary`, `improvements`, `strengths`, `metrics`, `concern_keywords`

#### ラウンド8: success_casesテーブル
- **結果**: ⚠️ 設計書に一部カラム欠け
- **設計書に欠け**: `approach_text`, `result`, `is_active`

#### ラウンド9: training_scenariosテーブル
- **結果**: ✅ 一致（title/difficultyで統一済み）

#### ラウンド10: roleplay_sessionsテーブル
- **結果**: ✅ 一致（messages/ended_atで統一済み）

---

### ラウンド11-15: Edge Functions確認

#### ラウンド11: process-audio
- **ファイル**: `supabase/functions/process-audio/index.ts`
- **結果**: ✅ 正しく`start_time_ms`/`end_time_ms`を使用

#### ラウンド12: diarization-callback
- **ファイル**: `supabase/functions/diarization-callback/index.ts`
- **結果**: ✅ 正しく`start_time_ms`/`end_time_ms`を使用

#### ラウンド13: analyze-segment
- **ファイル**: `supabase/functions/analyze-segment/index.ts`
- **結果**: ✅ 正しく`start_time_ms`/`end_time_ms`と正規化スキーマを使用

#### ラウンド14: generate-report
- **ファイル**: `supabase/functions/generate-report/index.ts`
- **結果**: ✅ 正しく正規化session_analysesを使用

#### ラウンド15: roleplay-chat
- **ファイル**: `supabase/functions/roleplay-chat/index.ts`
- **結果**: ✅ 正しく`messages`/`ended_at`を使用

---

### ラウンド16-20: 設計書との整合性

#### ラウンド16: データベース物理設計
- **ファイル**: `docs/詳細設計書/07-データベース物理設計.md`
- **結果**: ⚠️ 問題発見
- **問題**: session_reportsのカラム名がDB実装と不一致

#### ラウンド17: API設計
- **ファイル**: `docs/詳細設計書/03-API詳細仕様.md`
- **結果**: ⚠️ 重大な問題発見
- **問題**:
  - process-audio実装例で`start_time`/`end_time`を使用（正しくは`start_time_ms`/`end_time_ms`）
  - diarization-callback実装例で同様の問題
  - analyze-segment実装例で`.order('start_time')`を使用

#### ラウンド18: RLS設計
- **結果**: ✅ 一致（id = auth.uid()パターンで統一済み）

#### ラウンド19: 統計関数設計
- **結果**: ✅ 一致

#### ラウンド20: インデックス設計
- **結果**: ✅ 一致

---

### ラウンド21-25: UIコンポーネント確認

#### ラウンド21: StaffTable.tsx
- **ファイル**: `apps/web/src/components/staff/StaffTable.tsx`
- **結果**: ⚠️ 問題発見
- **問題**:
  - `role: 'stylist' | 'manager' | 'receptionist'`
  - DBでは `'stylist' | 'manager' | 'owner' | 'admin'`
  - `receptionist`は存在しない、`owner`/`admin`が欠け

#### ラウンド22: ReportViewer.tsx
- **ファイル**: `apps/web/src/components/report/ReportViewer.tsx`
- **結果**: ✅ UIインターフェースのみ（DB直接参照なし）

#### ラウンド23: RecentSessions.tsx
- **ファイル**: `apps/web/src/components/dashboard/RecentSessions.tsx`
- **結果**: ✅ UIインターフェースのみ

#### ラウンド24: database.ts型定義
- **ファイル**: `apps/web/src/types/database.ts`
- **結果**: ⚠️ 複数問題発見（ラウンド2-4参照）

#### ラウンド25: 不足テーブル確認
- **結果**: ⚠️ 問題発見
- **問題**: `staff_training_stats`テーブルがUI型定義に欠けている

---

### ラウンド26-30: 企画書との整合性

#### ラウンド26: 技術アーキテクチャ
- **ファイル**: `docs/企画書/04-技術アーキテクチャ.md`
- **結果**: ⚠️ 問題発見
- **問題**:
  - コード例で`start_time`/`end_time`を使用（line 168-175）
  - `role`カラムを使用（正しくは`speaker`）

#### ラウンド27: 機能詳細
- **ファイル**: `docs/企画書/05-機能詳細.md`
- **結果**: ✅ 用語は整合（トーク比率等）

#### ラウンド28: diarization_statusの扱い
- **結果**: ⚠️ 不整合
- **設計書/企画書**: `diarization_status`あり
- **DBスキーマ**: `diarization_status`なし
- **UI型**: `diarization_status`あり
- **決定が必要**: 追加するか削除するか

#### ラウンド29: 用語統一確認
- **結果**: ✅ 主要用語は統一済み
  - トーク比率（傾聴スコアではない）
  - title/difficulty
  - messages/ended_at

#### ラウンド30: speaker_segments.speaker値
- **結果**: ✅ 統一済み
- `'stylist' | 'customer' | 'unknown'`で一致

---

## 発見された問題一覧

| # | 問題 | 影響レイヤー | 重要度 | ステータス |
|---|------|-------------|--------|-----------|
| 1 | UI型(database.ts)にstaffsの不要カラム | UI | 高 | ✅ 修正済 |
| 2 | UI型にdiarization_statusがあるがDBにない | DB・UI・設計 | 高 | ✅ 修正済 (DBに追加) |
| 3 | UI型にtranscripts.confidenceが欠け | UI | 中 | ✅ 修正済 |
| 4 | UI型にstaff_training_statsテーブルが欠け | UI | 中 | ✅ 修正済 |
| 5 | StaffTableのrole型が不正 | UI | 高 | ✅ 修正済 |
| 6 | API設計書でstart_time使用 | 設計 | 高 | ✅ 修正済 |
| 7 | 企画書でstart_time/role使用 | 企画 | 中 | ✅ 修正済 |
| 8 | session_reportsのカラム名不一致 | 設計 | 中 | ✅ 修正済 |
| 9 | success_casesのカラム欠け | 設計 | 低 | ✅ 修正済 |
| 10 | notification_logs.read_atがUI型に欠け | UI | 低 | ✅ 修正済 |

---

## 問題詳細と推奨対応

### 問題1: UI型にstaffsの不要カラム

**影響レイヤー**: UI
**ファイル**: `apps/web/src/types/database.ts`

**現状**:
```typescript
staffs: {
  Row: {
    position: string | null;      // DBに存在しない
    join_date: string | null;     // DBに存在しない
    profile_image_url: string | null;  // avatar_urlが正解
    settings: Json | null;        // DBに存在しない
  }
}
```

**推奨対応**:
- `position`, `join_date`, `settings`を削除
- `profile_image_url`を削除（`avatar_url`のみ使用）

**理由**:
- **設計**: DBスキーマにこれらのカラムは存在しない
- **UI**: 存在しないカラムを参照するとランタイムエラーの原因になる
- **ユーザービリティ**: 一貫性がないとメンテナンスが困難になる

---

### 問題2: diarization_statusの不整合

**影響レイヤー**: DB・UI・設計・企画
**関連ファイル**:
- `supabase/migrations/00000000000000_initial_schema.sql`
- `apps/web/src/types/database.ts`
- `docs/詳細設計書/07-データベース物理設計.md`
- `docs/企画書/04-技術アーキテクチャ.md`

**現状**:
- 設計書・企画書: `diarization_status`あり
- DBスキーマ: なし
- UI型: あり

**推奨対応（2つの選択肢）**:

**選択肢A（推奨）**: DBに追加
```sql
ALTER TABLE sessions ADD COLUMN diarization_status TEXT
  DEFAULT 'pending'
  CHECK (diarization_status IN ('pending', 'processing', 'completed', 'failed'));
```

**選択肢B**: 設計書・UI型から削除

**理由**:
- **設計**: 話者分離の状態管理は企画書で明示されている機能要件
- **ワーカー**: diarization-callbackが状態更新を試みる可能性がある
- **ユーザービリティ**: 話者分離の進捗表示に必要

---

### 問題3: UI型にtranscripts.confidenceが欠け

**影響レイヤー**: UI
**ファイル**: `apps/web/src/types/database.ts`

**推奨対応**: `confidence`を追加
```typescript
transcripts: {
  Row: {
    confidence: number | null;  // 追加
  }
}
```

**理由**:
- **DB**: transcriptsテーブルにconfidenceカラムが存在
- **UI**: 信頼度に基づく表示フィルタリングに使用可能

---

### 問題4: staff_training_statsテーブル欠け

**影響レイヤー**: UI
**ファイル**: `apps/web/src/types/database.ts`

**推奨対応**: テーブル定義を追加
```typescript
staff_training_stats: {
  Row: {
    id: string;
    staff_id: string;
    total_training_count: number;
    total_score_sum: number;
    average_score: number;
    highest_score: number;
    last_training_at: string | null;
    updated_at: string;
  };
  // Insert/Update も追加
}
```

**理由**:
- **DB**: テーブルが存在する
- **UI**: トレーニング統計表示に必要

---

### 問題5: StaffTableのrole型が不正

**影響レイヤー**: UI
**ファイル**: `apps/web/src/components/staff/StaffTable.tsx`

**現状**:
```typescript
role: 'stylist' | 'manager' | 'receptionist';  // 不正
```

**推奨対応**:
```typescript
role: 'stylist' | 'manager' | 'owner' | 'admin';  // 正しい値
```

**理由**:
- **DB**: roleは`'stylist' | 'manager' | 'owner' | 'admin'`
- **設計**: `receptionist`は存在しない
- **ユーザービリティ**: 管理者（owner/admin）表示ができない

---

### 問題6-7: 設計書・企画書でstart_time使用

**影響レイヤー**: 設計・企画
**ファイル**:
- `docs/詳細設計書/03-API詳細仕様.md`
- `docs/企画書/04-技術アーキテクチャ.md`

**推奨対応**:
- `start_time` → `start_time_ms`
- `end_time` → `end_time_ms`
- `role` → `speaker`（speaker_segmentsの場合）

**理由**:
- **DB**: ミリ秒単位で統一済み
- **ワーカー**: 実装は正しく`start_time_ms`を使用
- **設計**: 設計書と実装の乖離は混乱を招く

---

### 問題8: session_reportsのカラム名不一致

**影響レイヤー**: 設計
**ファイル**: `docs/詳細設計書/07-データベース物理設計.md`

**設計書**:
- `good_points`, `improvement_points`, `action_items`
- `transcript_summary`, `ai_feedback`, `indicator_scores`

**DB実装**:
- `summary`, `improvements`, `strengths`
- `metrics`, `concern_keywords`, `proposal_timing_ms`

**推奨対応**: 設計書をDB実装に合わせて更新

**理由**:
- **DB**: 実装が既に存在
- **ワーカー**: generate-reportが実装済みカラムを使用

---

## 調査完了後の推奨事項

### 優先度: 高
1. **UI型定義の修正** (問題1, 3, 4, 10)
   - staffsから不要カラムを削除
   - transcripts.confidenceを追加
   - staff_training_statsを追加
   - notification_logs.read_atを追加

2. **StaffTableコンポーネントの修正** (問題5)
   - role型を正しい値に修正

3. **diarization_statusの決定** (問題2)
   - DBに追加するか、設計から削除するか決定

### 優先度: 中
4. **設計書の更新** (問題6, 8)
   - API設計書のコード例を`start_time_ms`/`end_time_ms`に修正
   - session_reportsのカラム名を実装に合わせて修正

5. **企画書の更新** (問題7)
   - コード例を実装に合わせて修正

### 優先度: 低
6. **設計書の補完** (問題9)
   - success_casesに欠けているカラムを追加

---

## 結論

30ラウンドの調査の結果、**10件の不整合**を発見し、**全て修正完了**しました。

修正前:
- **Edge Functions（ワーカー）**: ✅ 正しく実装されている
- **DBスキーマ**: ⚠️ diarization_statusが欠けていた
- **shared型定義**: ✅ 正しく定義されている
- **UI型定義**: ⚠️ 複数の不整合あり
- **設計書**: ⚠️ 一部コード例が古い
- **企画書**: ⚠️ 一部コード例が古い

修正後（2025-12-05）:
- **Edge Functions（ワーカー）**: ✅ 正しく実装されている
- **DBスキーマ**: ✅ diarization_statusを追加
- **shared型定義**: ✅ diarization_statusを追加
- **UI型定義**: ✅ 全て修正完了
- **設計書**: ✅ 全て修正完了
- **企画書**: ✅ 全て修正完了

**全レイヤー（企画・設計・DB・UI・ワーカー）の一貫性が確保されました。**
