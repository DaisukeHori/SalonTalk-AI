# 美容室向けリアルタイムコミュニケーション分析システム

## 基本設計書（外部設計書）

**プロジェクト名**: SalonTalk AI  
**バージョン**: 1.0  
**作成日**: 2025年12月4日  
**作成者**: Revol Corporation  
**機密区分**: 社外秘

---

## 目次

1. [はじめに](#1-はじめに)
2. [システム概要](#2-システム概要)
3. [システムアーキテクチャ設計](#3-システムアーキテクチャ設計)
4. [機能設計](#4-機能設計)
5. [画面設計](#5-画面設計)
6. [データ設計](#6-データ設計)
7. [外部インターフェース設計](#7-外部インターフェース設計)
8. [セキュリティ設計](#8-セキュリティ設計)
9. [性能設計](#9-性能設計)
10. [運用設計](#10-運用設計)
11. [移行設計](#11-移行設計)
12. [テスト設計](#12-テスト設計)

---

## 1. はじめに

### 1.1 文書の目的

本基本設計書は、「SalonTalk AI」システムの外部仕様を定義し、システムがユーザーおよび外部システムとどのように相互作用するかを明確にすることを目的とする。本文書は要件定義書に基づき作成され、詳細設計書の基盤となる。

### 1.2 対象読者

| 対象者 | 本文書の利用目的 |
|--------|----------------|
| プロジェクトマネージャー | プロジェクト全体の把握、進捗管理 |
| システムアーキテクト | アーキテクチャ決定の根拠確認 |
| 開発エンジニア | 実装の基準、詳細設計への入力 |
| 品質保証エンジニア | テスト計画・設計の基準 |
| 運用担当者 | 運用設計・手順の把握 |
| ステークホルダー | システム仕様の承認 |

### 1.3 参照文書

| 文書名 | バージョン | 説明 |
|--------|-----------|------|
| 事業企画書 | v3.7 | ビジネス要件・目標・財務計画 |
| 要件定義書 | v1.0 | 機能要件・非機能要件・制約事項 |
| Apple SpeechAnalyzer Documentation | iOS 26 Beta | 音声認識APIリファレンス |
| Supabase Documentation | Latest | BaaSプラットフォームリファレンス |
| pyannote.audio Documentation | v3.x | 話者分離ライブラリリファレンス |
| Anthropic Claude API Documentation | Latest | AI分析APIリファレンス |

### 1.4 用語定義

| 用語 | 英語表記 | 定義 |
|------|---------|------|
| セッション | Session | 1回の施術における会話分析の単位。録音開始から終了まで |
| 話者分離 | Speaker Diarization | 複数話者の発話を個別に識別・分離する処理 |
| リアルタイム分析 | Real-time Analysis | 施術中にリアルタイムで行われる会話分析 |
| 成功事例 | Success Case | 店販成約に至った会話パターンのデータベース化されたもの |
| トーク比率 | Talk Ratio | 美容師とお客様の発話時間の比率 |
| 悩みキーワード | Concern Keywords | お客様の髪に関する悩みを示すキーワード群 |
| 提案タイミング | Proposal Timing | 悩み検出後から商品提案までの時間 |
| 傾聴スコア | Listening Score | 会話の質を数値化した総合指標 |
| ベクトル埋め込み | Vector Embedding | テキストを1536次元の数値ベクトルに変換したもの |
| RLS | Row Level Security | データベースの行単位アクセス制御機能 |

### 1.5 表記規則

- 【必須】: 実装が必須の機能・仕様
- 【推奨】: 実装を推奨する機能・仕様
- 【オプション】: 将来実装を検討する機能・仕様
- `コード表記`: プログラムコード、コマンド、技術用語
- **強調**: 重要な概念や注意事項

---

## 2. システム概要

### 2.1 システムの目的と範囲

#### 2.1.1 システムの目的

SalonTalk AIは、美容室における接客会話をAIがリアルタイムで分析し、以下のビジネス目標を達成するためのシステムである：

| 目標 | 数値目標 | 達成期間 |
|------|---------|---------|
| 店販売上向上 | 20〜36%向上 | 導入後12ヶ月 |
| 人材育成効率化 | 育成期間50%短縮 | 導入後12ヶ月 |
| 新人離職率低下 | 30%削減 | 導入後24ヶ月 |
| スタッフ間売上格差縮小 | 3.3:1→2:1以下 | 導入後12ヶ月 |

#### 2.1.2 システムの範囲

**システム範囲図**:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          SalonTalk AI システム範囲                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      フロントエンド (システム内)                       │ │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────────┐│ │
│  │  │       iPadアプリ         │  │        Webダッシュボード             ││ │
│  │  │  ● セッション管理        │  │  ● 管理者機能                       ││ │
│  │  │  ● リアルタイム分析表示   │  │  ● 分析・レポート閲覧               ││ │
│  │  │  ● トレーニング機能      │  │  ● スタッフ管理                     ││ │
│  │  │  ● 成功事例閲覧          │  │  ● 成功事例管理                     ││ │
│  │  └─────────────────────────┘  └─────────────────────────────────────┘│ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│  ┌───────────────────────────────────┼───────────────────────────────────┐ │
│  │                      バックエンド (システム内)                         │ │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────────┐│ │
│  │  │       API層             │  │          処理層                     ││ │
│  │  │  ● 認証・認可           │  │  ● 音声処理（文字起こし結合）       ││ │
│  │  │  ● セッション管理API    │  │  ● AI分析処理                       ││ │
│  │  │  ● データ管理API        │  │  ● レポート生成処理                 ││ │
│  │  │  ● リアルタイム配信      │  │  ● 成功事例マッチング               ││ │
│  │  └─────────────────────────┘  └─────────────────────────────────────┘│ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│  ┌───────────────────────────────────┼───────────────────────────────────┐ │
│  │                      データ層 (システム内)                            │ │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────────┐│ │
│  │  │    PostgreSQL           │  │       ベクトルDB (pgvector)         ││ │
│  │  │  ● マスタデータ         │  │  ● 成功事例ベクトル                 ││ │
│  │  │  ● トランザクションデータ│  │  ● 類似度検索                       ││ │
│  │  │  ● 分析結果             │  │                                     ││ │
│  │  └─────────────────────────┘  └─────────────────────────────────────┘│ │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────────┐│ │
│  │  │    ファイルストレージ    │  │       pyannoteサーバー              ││ │
│  │  │  ● 音声チャンク（一時）  │  │  ● 話者分離処理                     ││ │
│  │  │  ● レポートファイル      │  │  ● GPUコンピューティング            ││ │
│  │  └─────────────────────────┘  └─────────────────────────────────────┘│ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│   外部システム       │  │   外部システム       │  │   外部システム       │
├─────────────────────┤  ├─────────────────────┤  ├─────────────────────┤
│ ● Anthropic Claude  │  │ ● OpenAI Embedding  │  │ ● Apple Speech      │
│   API               │  │   API               │  │   Analyzer          │
│ ● AI分析・生成      │  │ ● ベクトル生成      │  │ ● オンデバイス      │
│                     │  │                     │  │   文字起こし        │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘
```

#### 2.1.3 システム境界

**システム内（開発・運用対象）**:

| コンポーネント | 技術スタック | 責務 |
|--------------|-------------|------|
| iPadアプリケーション | React Native + Expo | 音声取得、文字起こし、UI表示 |
| Webダッシュボード | Next.js 14 + TypeScript | 管理機能、分析閲覧 |
| バックエンドAPI | Supabase Edge Functions | ビジネスロジック、API提供 |
| データベース | PostgreSQL + pgvector | データ永続化、ベクトル検索 |
| ファイルストレージ | Supabase Storage | 音声ファイル一時保存 |
| pyannoteサーバー | FastAPI + pyannote.audio | 話者分離処理 |

**システム外（連携対象）**:

| コンポーネント | 連携方式 | 責務 |
|--------------|---------|------|
| Anthropic Claude API | REST API | AI分析、レポート生成、ロールプレイ |
| OpenAI Embedding API | REST API | テキストのベクトル埋め込み生成 |
| Apple SpeechAnalyzer | ネイティブAPI | オンデバイス文字起こし |
| Apple Push Notification | APNs | プッシュ通知配信 |
| Stripe API（将来） | REST API + Webhook | 決済処理 |

### 2.2 システム構成

#### 2.2.1 論理構成（レイヤードアーキテクチャ）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          論理アーキテクチャ                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    プレゼンテーション層                                │ │
│  │                    (Presentation Layer)                               │ │
│  │                                                                       │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │    iPad UI       │  │    Web UI        │  │   通知UI          │   │ │
│  │   │    Components    │  │    Components    │  │  (Push/In-App)    │   │ │
│  │   │                  │  │                  │  │                   │   │ │
│  │   │ ・Screens        │  │ ・Pages          │  │ ・NotificationBanner│ │ │
│  │   │ ・Components     │  │ ・Components     │  │ ・Toast           │   │ │
│  │   │ ・Hooks          │  │ ・Hooks          │  │                   │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    アプリケーション層                                  │ │
│  │                    (Application Layer)                                │ │
│  │                                                                       │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   セッション      │  │    分析          │  │  教育・トレーニング │  │ │
│  │   │   管理サービス    │  │   サービス        │  │   サービス        │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │    認証          │  │   レポート        │  │    通知          │   │ │
│  │   │   サービス        │  │   サービス        │  │   サービス        │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    ドメイン層                                          │ │
│  │                    (Domain Layer)                                     │ │
│  │                                                                       │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   Session        │  │   Analysis       │  │   SuccessCase    │   │ │
│  │   │   Domain         │  │   Domain         │  │   Domain         │   │ │
│  │   │                  │  │                  │  │                  │   │ │
│  │   │ ・SessionEntity  │  │ ・AnalysisEntity │  │ ・SuccessCaseEntity│ │ │
│  │   │ ・SessionValue   │  │ ・ScoreValue     │  │ ・EmbeddingValue  │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   Staff          │  │   Salon          │  │   Training       │   │ │
│  │   │   Domain         │  │   Domain         │  │   Domain         │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    インフラストラクチャ層                               │ │
│  │                    (Infrastructure Layer)                             │ │
│  │                                                                       │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   Repository     │  │   External       │  │   Storage        │   │ │
│  │   │   (Supabase)     │  │   API Client     │  │   Service        │   │ │
│  │   │                  │  │                  │  │                  │   │ │
│  │   │ ・SessionRepo    │  │ ・ClaudeClient   │  │ ・AudioStorage   │   │ │
│  │   │ ・AnalysisRepo   │  │ ・OpenAIClient   │  │ ・ReportStorage  │   │ │
│  │   │ ・StaffRepo      │  │ ・PyannoteClient │  │                  │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   Cache          │  │   Queue          │  │   Logger         │   │ │
│  │   │   Service        │  │   Service        │  │   Service        │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 物理構成（デプロイメント図）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          物理アーキテクチャ                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        エンドユーザー環境                              │ │
│  │                                                                       │ │
│  │   ┌─────────────────────────┐     ┌─────────────────────────────┐    │ │
│  │   │        iPad             │     │       Web Browser           │    │ │
│  │   │      (iOS 26+)          │     │   (Chrome/Safari/Edge)      │    │ │
│  │   │                         │     │                             │    │ │
│  │   │  ┌───────────────────┐  │     │   ┌───────────────────────┐ │    │ │
│  │   │  │  SalonTalk App    │  │     │   │   https://salon       │ │    │ │
│  │   │  │                   │  │     │   │   talk.app            │ │    │ │
│  │   │  │  ┌─────────────┐  │  │     │   │                       │ │    │ │
│  │   │  │  │SpeechAnalyzer│  │  │     │   └───────────────────────┘ │    │ │
│  │   │  │  │(オンデバイス) │  │  │     │                             │    │ │
│  │   │  │  └─────────────┘  │  │     │                             │    │ │
│  │   │  └───────────────────┘  │     │                             │    │ │
│  │   └───────────┬─────────────┘     └──────────────┬──────────────┘    │ │
│  └───────────────┼──────────────────────────────────┼────────────────────┘ │
│                  │           HTTPS / WSS            │                      │
│                  │           (TLS 1.3)              │                      │
│  ┌───────────────┼──────────────────────────────────┼────────────────────┐ │
│  │               ▼          CDN/Edge Layer          ▼                    │ │
│  │   ┌───────────────────────────────────────────────────────────────┐   │ │
│  │   │                  Vercel Edge Network                          │   │ │
│  │   │                  (Tokyo Region: hnd1)                         │   │ │
│  │   │                                                               │   │ │
│  │   │   ● 静的アセット配信（キャッシュ）                               │   │ │
│  │   │   ● SSL終端                                                   │   │ │
│  │   │   ● DDoS保護                                                  │   │ │
│  │   └───────────────────────────────────────────────────────────────┘   │ │
│  │                              │                                        │ │
│  └──────────────────────────────┼────────────────────────────────────────┘ │
│                                 │                                          │
│  ┌──────────────────────────────┼────────────────────────────────────────┐ │
│  │                              ▼          Application Layer             │ │
│  │   ┌───────────────────────────────────────────────────────────────┐   │ │
│  │   │                  Vercel Application                           │   │ │
│  │   │                  (Tokyo Region: hnd1)                         │   │ │
│  │   │                                                               │   │ │
│  │   │   ┌─────────────────────────────────────────────────────┐    │   │ │
│  │   │   │  Next.js 14 Application                             │    │   │ │
│  │   │   │                                                     │    │   │ │
│  │   │   │  ● Server Components                                │    │   │ │
│  │   │   │  ● API Routes (Optional)                            │    │   │ │
│  │   │   │  ● Static Generation                                │    │   │ │
│  │   │   └─────────────────────────────────────────────────────┘    │   │ │
│  │   │                                                               │   │ │
│  │   │   Plan: Pro                                                   │   │ │
│  │   └───────────────────────────────────────────────────────────────┘   │ │
│  │                              │                                        │ │
│  └──────────────────────────────┼────────────────────────────────────────┘ │
│                                 │                                          │
│  ┌──────────────────────────────┼────────────────────────────────────────┐ │
│  │                              ▼          Backend Layer                 │ │
│  │   ┌───────────────────────────────────────────────────────────────┐   │ │
│  │   │                  Supabase Platform                            │   │ │
│  │   │                  (Tokyo: ap-northeast-1)                      │   │ │
│  │   │                                                               │   │ │
│  │   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │   │ │
│  │   │   │    Auth     │  │  Realtime   │  │   Edge Functions    │  │   │ │
│  │   │   │             │  │             │  │                     │  │   │ │
│  │   │   │ ・JWT認証    │  │ ・WebSocket │  │ ・create-session   │  │   │ │
│  │   │   │ ・OAuth     │  │ ・Presence  │  │ ・process-audio    │  │   │ │
│  │   │   │ ・RBAC      │  │ ・Broadcast │  │ ・analyze-segment  │  │   │ │
│  │   │   └─────────────┘  └─────────────┘  │ ・generate-report  │  │   │ │
│  │   │                                     │ ・search-cases     │  │   │ │
│  │   │   ┌─────────────┐  ┌─────────────┐  │ ・roleplay-chat    │  │   │ │
│  │   │   │ PostgreSQL  │  │   Storage   │  └─────────────────────┘  │   │ │
│  │   │   │             │  │             │                           │   │ │
│  │   │   │ ・8GB RAM   │  │ ・100GB     │                           │   │ │
│  │   │   │ ・pgvector  │  │ ・音声一時  │                           │   │ │
│  │   │   │ ・RLS       │  │             │                           │   │ │
│  │   │   └─────────────┘  └─────────────┘                           │   │ │
│  │   │                                                               │   │ │
│  │   │   Plan: Pro ($25/月)                                          │   │ │
│  │   └───────────────────────────────────────────────────────────────┘   │ │
│  │                              │                                        │ │
│  └──────────────────────────────┼────────────────────────────────────────┘ │
│                                 │                                          │
│  ┌──────────────────────────────┼────────────────────────────────────────┐ │
│  │                              ▼          GPU Compute Layer             │ │
│  │   ┌───────────────────────────────────────────────────────────────┐   │ │
│  │   │                  pyannote Server                              │   │ │
│  │   │                  (VAST.ai / AWS g4dn)                         │   │ │
│  │   │                                                               │   │ │
│  │   │   ┌─────────────────────────────────────────────────────────┐│   │ │
│  │   │   │  Docker Container                                       ││   │ │
│  │   │   │                                                         ││   │ │
│  │   │   │  ● GPU: RTX 4060 (8GB VRAM) または T4                    ││   │ │
│  │   │   │  ● RAM: 16GB                                            ││   │ │
│  │   │   │  ● OS: Ubuntu 22.04                                     ││   │ │
│  │   │   │                                                         ││   │ │
│  │   │   │  ┌─────────────────────────────────────────────────┐   ││   │ │
│  │   │   │  │  FastAPI Application                            │   ││   │ │
│  │   │   │  │                                                 │   ││   │ │
│  │   │   │  │  ● POST /diarize/{session_id}                   │   ││   │ │
│  │   │   │  │  ● GET /status/{session_id}                     │   ││   │ │
│  │   │   │  │  ● GET /health                                  │   ││   │ │
│  │   │   │  │                                                 │   ││   │ │
│  │   │   │  │  pyannote.audio Pipeline                        │   ││   │ │
│  │   │   │  │  ● speaker-diarization-community-1              │   ││   │ │
│  │   │   │  │  ● CUDA acceleration                            │   ││   │ │
│  │   │   │  └─────────────────────────────────────────────────┘   ││   │ │
│  │   │   └─────────────────────────────────────────────────────────┘│   │ │
│  │   │                                                               │   │ │
│  │   │   Cost: ~$0.20/hour (オンデマンド)                             │   │ │
│  │   └───────────────────────────────────────────────────────────────┘   │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                          External APIs                                │ │
│  │                                                                       │ │
│  │   ┌─────────────────────┐  ┌─────────────────────────────────────┐   │ │
│  │   │   Anthropic API     │  │          OpenAI API                 │   │ │
│  │   │                     │  │                                     │   │ │
│  │   │ ● claude-sonnet-4-5 │  │ ● text-embedding-3-small            │   │ │
│  │   │ ● 分析・生成        │  │ ● 1536次元ベクトル                   │   │ │
│  │   │ ● $3/1M入力トークン │  │ ● $0.02/1M トークン                 │   │ │
│  │   └─────────────────────┘  └─────────────────────────────────────┘   │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 システム利用者

#### 2.3.1 利用者分類

| 利用者種別 | 説明 | 主な利用機能 | 同時利用者数（初期） |
|-----------|------|------------|-------------------|
| スタイリスト | 施術を行う美容師 | iPadアプリ全機能 | 10名/店舗 × 5店舗 = 50名 |
| 店長/マネージャー | 店舗運営責任者 | Web全機能、iPad閲覧 | 2名/店舗 × 5店舗 = 10名 |
| オーナー | 複数店舗経営者 | Web全機能（複数店舗統合） | 5名 |
| アシスタント | 補助スタッフ | iPad閲覧のみ | 5名/店舗 × 5店舗 = 25名 |
| システム管理者 | Revol社内管理 | 管理機能全般 | 2名 |

#### 2.3.2 利用パターン

**時間帯別利用パターン**:

```
利用者数
    │
100 ┤                     ╭────╮
    │                   ╭─╯    ╰─╮
 80 ┤                  ╱          ╲
    │                 ╱            ╲
 60 ┤            ╭───╯              ╲
    │           ╱                    ╲
 40 ┤          ╱                      ╲
    │        ╭╯                        ╲
 20 ┤      ╭─╯                          ╲
    │    ╭─╯                             ╰────
  0 ┼────╯─────────────────────────────────────
    9   10  11  12  13  14  15  16  17  18  19  20  時

    ━━━ スタイリスト（iPad）
    ─── 管理者（Web）
```

**ピーク時想定**:
- 同時セッション数: 50（全スタッフの50%が同時施術）
- 同時Web接続数: 20
- API呼び出し: 100 req/min

#### 2.3.3 利用シーン詳細

**シーン1: 施術中のリアルタイム分析**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    利用シーン1: 施術中のリアルタイム分析                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  スタイリスト                           システム                          │
│       │                                    │                            │
│       │ 1. セッション開始ボタンタップ        │                            │
│       │────────────────────────────────────▶│                            │
│       │                                    │ 2. セッション作成            │
│       │                                    │ 3. Realtimeチャンネル接続    │
│       │ 4. 接続完了通知                     │                            │
│       │◀────────────────────────────────────│                            │
│       │                                    │                            │
│       │ 5. 会話開始（施術中）                │                            │
│       │ ═══════════════════════════════════ │                            │
│       │                                    │                            │
│       │      │ 6. 音声チャンク（60秒ごと）   │                            │
│       │      │─────────────────────────────▶│                            │
│       │      │                              │ 7. 文字起こし保存           │
│       │      │                              │ 8. pyannote呼び出し         │
│       │      │                              │ 9. 話者分離処理             │
│       │      │                              │ 10. AI分析                  │
│       │      │ 11. スコア更新               │                            │
│       │      │◀─────────────────────────────│                            │
│       │      │                              │                            │
│       │      │ ≪悩みキーワード検出時≫        │                            │
│       │      │                              │ 12. 成功事例検索            │
│       │      │ 13. 提案通知表示              │                            │
│       │      │◀─────────────────────────────│                            │
│       │      │                              │                            │
│       │ ═══════════════════════════════════ │                            │
│       │                                    │                            │
│       │ 14. セッション終了ボタンタップ       │                            │
│       │────────────────────────────────────▶│                            │
│       │                                    │ 15. レポート生成            │
│       │ 16. レポート表示                    │                            │
│       │◀────────────────────────────────────│                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**シーン2: 管理者による分析確認**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    利用シーン2: 管理者による分析確認                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  店長/マネージャー                      システム                          │
│       │                                    │                            │
│       │ 1. Webダッシュボードアクセス        │                            │
│       │────────────────────────────────────▶│                            │
│       │                                    │ 2. 認証確認                 │
│       │ 3. ダッシュボード表示               │                            │
│       │◀────────────────────────────────────│                            │
│       │                                    │                            │
│       │    ┌──────────────────────────────┐│                            │
│       │    │ ダッシュボード                ││                            │
│       │    │ ● 今日のセッション: 12       ││                            │
│       │    │ ● 平均スコア: 78.5           ││                            │
│       │    │ ● 成約率: 23.4%              ││                            │
│       │    └──────────────────────────────┘│                            │
│       │                                    │                            │
│       │ 4. スタッフ選択                     │                            │
│       │────────────────────────────────────▶│                            │
│       │                                    │ 5. スタッフ分析データ取得   │
│       │ 6. スタッフ詳細分析表示             │                            │
│       │◀────────────────────────────────────│                            │
│       │                                    │                            │
│       │    ┌──────────────────────────────┐│                            │
│       │    │ 佐藤花子 詳細分析            ││                            │
│       │    │ ● 傾聴スコア推移グラフ       ││                            │
│       │    │ ● 成約率: 35%                ││                            │
│       │    │ ● 強み: 感情分析             ││                            │
│       │    │ ● 改善点: 質問のバリエーション││                            │
│       │    └──────────────────────────────┘│                            │
│       │                                    │                            │
│       │ 7. 期間指定（先月比較）             │                            │
│       │────────────────────────────────────▶│                            │
│       │ 8. 比較レポート表示                 │                            │
│       │◀────────────────────────────────────│                            │
│       │                                    │                            │
│       │ 9. CSVエクスポート                  │                            │
│       │────────────────────────────────────▶│                            │
│       │ 10. ファイルダウンロード            │                            │
│       │◀────────────────────────────────────│                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. システムアーキテクチャ設計

### 3.1 アーキテクチャ方針

#### 3.1.1 設計原則

| 原則 | 説明 | 適用方法 | メリット |
|------|------|---------|---------|
| **クラウドネイティブ** | クラウドサービスを最大限活用 | Supabase、Vercelの採用 | インフラ管理コスト削減 |
| **サーバーレス優先** | サーバー管理の最小化 | Edge Functions、マネージドDB | スケーラビリティ、コスト最適化 |
| **リアルタイム性** | 低遅延のデータ配信 | WebSocket、Realtime DB | UX向上、即時フィードバック |
| **スケーラビリティ** | 店舗数増加への対応 | 水平スケーリング設計 | ビジネス成長対応 |
| **コスト最適化** | 変動費モデルの採用 | 従量課金サービスの活用 | 初期投資抑制 |
| **セキュリティファースト** | セキュリティを設計に組み込む | RLS、暗号化、監査ログ | データ保護 |

#### 3.1.2 技術選定理由

| 技術 | 選定理由 | 代替案 | 代替案を選ばなかった理由 |
|------|---------|--------|----------------------|
| **React Native** | iOS/Web共通コードベース、TypeScript対応、Expo対応 | Swift UI | Web版も必要、開発リソース効率化 |
| **Next.js 14** | App Router、Server Components、Vercel統合 | Remix、SvelteKit | Vercelとの親和性、エコシステム |
| **Supabase** | PostgreSQL、Realtime、Auth統合、pgvector対応 | Firebase | RDB必要、ベクトル検索、コスト |
| **pgvector** | Supabase統合、追加コストなし、十分な性能 | Qdrant、Pinecone | 初期コスト、管理の簡便さ |
| **Claude Sonnet 4.5** | 日本語精度、コスト効率、分析品質 | GPT-4、Gemini | 日本語性能、API安定性 |
| **pyannote.audio** | MIT License、高精度、セルフホスト可 | AssemblyAI、Speechmatics | コスト、カスタマイズ性 |

### 3.2 コンポーネント設計

#### 3.2.1 フロントエンドコンポーネント構成

**iPadアプリケーション（React Native）**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    iPadアプリ コンポーネント構成                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  src/                                                                   │
│  ├── app/                          # Expo Router (App Directory)        │
│  │   ├── (auth)/                   # 認証が必要なルート                  │
│  │   │   ├── _layout.tsx                                               │
│  │   │   ├── home.tsx              # ホーム画面                         │
│  │   │   ├── session.tsx           # セッション画面                     │
│  │   │   ├── reports/                                                  │
│  │   │   │   ├── index.tsx         # レポート一覧                       │
│  │   │   │   └── [id].tsx          # レポート詳細                       │
│  │   │   ├── training/                                                 │
│  │   │   │   ├── index.tsx         # トレーニングメニュー                │
│  │   │   │   └── roleplay.tsx      # ロールプレイ画面                   │
│  │   │   └── settings.tsx          # 設定画面                           │
│  │   ├── login.tsx                 # ログイン画面                       │
│  │   └── _layout.tsx               # ルートレイアウト                   │
│  │                                                                      │
│  ├── components/                   # 再利用可能コンポーネント             │
│  │   ├── common/                   # 共通コンポーネント                  │
│  │   │   ├── Button.tsx                                                │
│  │   │   ├── Card.tsx                                                  │
│  │   │   ├── Header.tsx                                                │
│  │   │   ├── Loading.tsx                                               │
│  │   │   └── Modal.tsx                                                 │
│  │   ├── session/                  # セッション関連                      │
│  │   │   ├── RealtimeScoreCard.tsx # リアルタイムスコア表示              │
│  │   │   ├── ConversationLog.tsx   # 会話ログ表示                       │
│  │   │   ├── ProposalNotification.tsx # 提案通知                        │
│  │   │   ├── KeywordBadge.tsx      # キーワードバッジ                   │
│  │   │   ├── ScoreGauge.tsx        # スコアゲージ                       │
│  │   │   ├── EmotionIndicator.tsx  # 感情インジケータ                   │
│  │   │   └── TimerDisplay.tsx      # 経過時間表示                       │
│  │   ├── report/                   # レポート関連                        │
│  │   │   ├── ReportCard.tsx        # レポートカード                     │
│  │   │   ├── ScoreChart.tsx        # スコアチャート                     │
│  │   │   └── ActionItems.tsx       # アクションアイテム                 │
│  │   └── training/                 # トレーニング関連                    │
│  │       ├── ScenarioCard.tsx      # シナリオカード                     │
│  │       ├── ChatBubble.tsx        # チャットバブル                     │
│  │       └── EvaluationResult.tsx  # 評価結果                           │
│  │                                                                      │
│  ├── hooks/                        # カスタムフック                       │
│  │   ├── useAuth.ts                # 認証フック                         │
│  │   ├── useSession.ts             # セッション管理                     │
│  │   ├── useTranscript.ts          # 文字起こしフック                   │
│  │   ├── useRealtimeAnalysis.ts    # リアルタイム分析                   │
│  │   ├── useSuccessCase.ts         # 成功事例検索                       │
│  │   ├── useNotification.ts        # 通知管理                           │
│  │   └── useSpeech.ts              # 音声認識フック                     │
│  │                                                                      │
│  ├── services/                     # 外部サービス連携                    │
│  │   ├── supabase.ts               # Supabaseクライアント               │
│  │   ├── speech.ts                 # SpeechAnalyzer連携                 │
│  │   ├── audio.ts                  # 音声処理サービス                   │
│  │   ├── storage.ts                # ストレージサービス                 │
│  │   ├── notification.ts           # 通知サービス                       │
│  │   └── analytics.ts              # アナリティクス                     │
│  │                                                                      │
│  ├── stores/                       # 状態管理（Zustand）                 │
│  │   ├── sessionStore.ts           # セッション状態                     │
│  │   ├── userStore.ts              # ユーザー状態                       │
│  │   ├── analysisStore.ts          # 分析結果状態                       │
│  │   ├── notificationStore.ts      # 通知状態                           │
│  │   └── settingsStore.ts          # 設定状態                           │
│  │                                                                      │
│  ├── types/                        # 型定義                              │
│  │   ├── session.ts                                                    │
│  │   ├── analysis.ts                                                   │
│  │   ├── user.ts                                                       │
│  │   └── api.ts                                                        │
│  │                                                                      │
│  ├── utils/                        # ユーティリティ                       │
│  │   ├── format.ts                 # フォーマット関数                   │
│  │   ├── validation.ts             # バリデーション                     │
│  │   └── constants.ts              # 定数定義                           │
│  │                                                                      │
│  └── config/                       # 設定                                │
│      ├── env.ts                    # 環境変数                           │
│      └── theme.ts                  # テーマ設定                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Webダッシュボード（Next.js 14）**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Webダッシュボード コンポーネント構成                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  src/                                                                   │
│  ├── app/                          # App Router                         │
│  │   ├── (public)/                 # 公開ルート                         │
│  │   │   ├── page.tsx              # ランディングページ                  │
│  │   │   └── login/page.tsx        # ログインページ                     │
│  │   ├── (dashboard)/              # ダッシュボード（認証必須）           │
│  │   │   ├── layout.tsx            # ダッシュボードレイアウト             │
│  │   │   ├── page.tsx              # ダッシュボードトップ                │
│  │   │   ├── staff/                                                    │
│  │   │   │   ├── page.tsx          # スタッフ一覧                       │
│  │   │   │   └── [id]/page.tsx     # スタッフ詳細                       │
│  │   │   ├── reports/                                                  │
│  │   │   │   ├── page.tsx          # レポート一覧                       │
│  │   │   │   └── [id]/page.tsx     # レポート詳細                       │
│  │   │   ├── analytics/page.tsx    # 分析画面                           │
│  │   │   ├── success-cases/page.tsx # 成功事例管理                      │
│  │   │   └── settings/page.tsx     # 設定                               │
│  │   ├── api/                      # API Routes（必要に応じて）          │
│  │   │   └── webhook/              # Webhook受信                        │
│  │   ├── layout.tsx                # ルートレイアウト                   │
│  │   └── globals.css               # グローバルスタイル                 │
│  │                                                                      │
│  ├── components/                   # コンポーネント                       │
│  │   ├── layout/                   # レイアウト系                        │
│  │   │   ├── Sidebar.tsx           # サイドバー                         │
│  │   │   ├── Header.tsx            # ヘッダー                           │
│  │   │   └── Footer.tsx            # フッター                           │
│  │   ├── dashboard/                # ダッシュボード系                    │
│  │   │   ├── MetricCard.tsx        # メトリクスカード                   │
│  │   │   ├── ScoreChart.tsx        # スコアチャート                     │
│  │   │   ├── StaffRanking.tsx      # スタッフランキング                 │
│  │   │   └── RecentSessions.tsx    # 最近のセッション                   │
│  │   ├── staff/                    # スタッフ管理系                      │
│  │   │   ├── StaffTable.tsx        # スタッフテーブル                   │
│  │   │   ├── StaffCard.tsx         # スタッフカード                     │
│  │   │   └── StaffForm.tsx         # スタッフ登録フォーム               │
│  │   ├── report/                   # レポート系                          │
│  │   │   ├── ReportViewer.tsx      # レポートビューア                   │
│  │   │   └── ReportExport.tsx      # エクスポートボタン                 │
│  │   ├── analytics/                # 分析系                              │
│  │   │   ├── TrendChart.tsx        # トレンドチャート                   │
│  │   │   ├── ComparisonTable.tsx   # 比較テーブル                       │
│  │   │   └── DateRangePicker.tsx   # 期間選択                           │
│  │   └── ui/                       # 汎用UIコンポーネント                │
│  │       ├── Button.tsx                                                │
│  │       ├── Card.tsx                                                  │
│  │       ├── Table.tsx                                                 │
│  │       ├── Modal.tsx                                                 │
│  │       └── ...                   # その他shadcn/ui                   │
│  │                                                                      │
│  ├── lib/                          # ライブラリ・ユーティリティ           │
│  │   ├── supabase/                                                     │
│  │   │   ├── client.ts             # クライアントサイド                 │
│  │   │   └── server.ts             # サーバーサイド                     │
│  │   ├── utils.ts                  # ユーティリティ関数                 │
│  │   └── constants.ts              # 定数                               │
│  │                                                                      │
│  ├── hooks/                        # カスタムフック                       │
│  │   ├── useAuth.ts                                                    │
│  │   ├── useStaff.ts                                                   │
│  │   ├── useAnalytics.ts                                               │
│  │   └── useExport.ts                                                  │
│  │                                                                      │
│  └── types/                        # 型定義                              │
│      └── index.ts                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 バックエンドコンポーネント構成

**Supabase Edge Functions**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Edge Functions 構成                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  supabase/functions/                                                    │
│  │                                                                      │
│  ├── _shared/                      # 共通モジュール                       │
│  │   ├── supabase.ts               # Supabaseクライアント               │
│  │   ├── claude.ts                 # Claude APIクライアント             │
│  │   ├── openai.ts                 # OpenAI APIクライアント             │
│  │   ├── pyannote.ts               # pyannoteクライアント               │
│  │   ├── validation.ts             # バリデーション                     │
│  │   ├── errors.ts                 # エラーハンドリング                 │
│  │   └── types.ts                  # 型定義                             │
│  │                                                                      │
│  ├── create-session/               # セッション作成                       │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── end-session/                  # セッション終了                       │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── process-audio/                # 音声チャンク処理                     │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── trigger-diarization/          # 話者分離トリガー                     │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── diarization-callback/         # 話者分離コールバック                 │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── analyze-segment/              # セグメント分析                       │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── generate-report/              # レポート生成                         │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── search-cases/                 # 成功事例検索                         │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── create-embedding/             # Embedding生成                       │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── roleplay-chat/                # ロールプレイチャット                 │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── evaluate-roleplay/            # ロールプレイ評価                     │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  └── send-notification/            # 通知送信                             │
│      └── index.ts                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**pyannote Server（FastAPI）**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    pyannote Server 構成                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  pyannote-server/                                                       │
│  │                                                                      │
│  ├── app/                                                              │
│  │   ├── main.py                   # FastAPIアプリケーション             │
│  │   ├── api/                                                          │
│  │   │   ├── __init__.py                                               │
│  │   │   ├── routes.py             # APIルート定義                      │
│  │   │   └── deps.py               # 依存関係                           │
│  │   ├── core/                                                         │
│  │   │   ├── __init__.py                                               │
│  │   │   ├── config.py             # 設定                               │
│  │   │   └── security.py           # セキュリティ                       │
│  │   ├── services/                                                     │
│  │   │   ├── __init__.py                                               │
│  │   │   ├── diarization.py        # 話者分離サービス                   │
│  │   │   ├── storage.py            # ストレージサービス                 │
│  │   │   └── callback.py           # コールバックサービス               │
│  │   ├── models/                                                       │
│  │   │   ├── __init__.py                                               │
│  │   │   └── schemas.py            # Pydanticスキーマ                   │
│  │   └── workers/                                                      │
│  │       ├── __init__.py                                               │
│  │       └── diarization_worker.py # バックグラウンドワーカー           │
│  │                                                                      │
│  ├── tests/                        # テスト                              │
│  │   ├── __init__.py                                                   │
│  │   ├── test_api.py                                                   │
│  │   └── test_diarization.py                                           │
│  │                                                                      │
│  ├── Dockerfile                    # Dockerイメージ定義                  │
│  ├── docker-compose.yml            # 開発用compose                      │
│  ├── requirements.txt              # 依存パッケージ                      │
│  └── README.md                     # ドキュメント                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 通信設計

#### 3.3.1 通信方式一覧

| 通信種別 | プロトコル | ポート | 用途 | 認証方式 |
|---------|-----------|-------|------|---------|
| REST API | HTTPS | 443 | CRUD操作、データ取得 | JWT Bearer |
| WebSocket | WSS | 443 | リアルタイム更新 | JWT認証後接続 |
| Webhook | HTTPS | 443 | 外部サービスからの通知 | API Key + Signature |
| gRPC（将来）| HTTPS | 443 | 高性能内部通信 | mTLS |

#### 3.3.2 通信シーケンス詳細

**シーケンス1: セッション開始〜リアルタイム分析**

```
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│  iPad   │ │Supabase │ │  Edge   │ │ Storage │ │pyannote │ │ Claude  │
│   App   │ │Realtime │ │Functions│ │         │ │ Server  │ │   API   │
└────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
     │          │          │          │          │          │
     │ 1. POST /create-session                   │          │
     │─────────────────────▶                     │          │
     │          │          │                     │          │
     │          │          │ 2. INSERT sessions  │          │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │ 3. { sessionId, realtimeChannel }         │          │
     │◀─────────────────────                     │          │
     │          │          │                     │          │
     │ 4. WebSocket Connect │                     │          │
     │──────────▶          │                     │          │
     │          │          │                     │          │
     │ 5. Subscribed       │                     │          │
     │◀──────────          │                     │          │
     │          │          │                     │          │
     ║══════════║══════════║═══ 施術開始 ═══════║══════════║══════════║
     │          │          │                     │          │
     │ 6. 音声録音開始（ローカル）                │          │
     │          │          │                     │          │
     │ 7. SpeechAnalyzer 文字起こし（60秒ごと）  │          │
     │          │          │                     │          │
     │ 8. POST /process-audio (audio + transcript)          │
     │─────────────────────▶                     │          │
     │          │          │                     │          │
     │          │          │ 9. Upload WAV       │          │
     │          │          │────────────▶        │          │
     │          │          │                     │          │
     │          │          │ 10. INSERT transcripts         │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 11. POST /diarize/{session_id} │
     │          │          │──────────────────────▶         │
     │          │          │                     │          │
     │          │          │ 12. { status: "processing" }   │
     │          │          │◀──────────────────────         │
     │          │          │                     │          │
     │          │          │          ┌─────────┴─────────┐│
     │          │          │          │ pyannote処理      ││
     │          │          │          │ (GPU, 非同期)     ││
     │          │          │          └─────────┬─────────┘│
     │          │          │                     │          │
     │          │          │ 13. POST /diarization-callback │
     │          │          │◀──────────────────────         │
     │          │          │                     │          │
     │          │          │ 14. INSERT speaker_segments    │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 15. Merge transcript + speakers│
     │          │          │                     │          │
     │          │          │ 16. POST /v1/messages          │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 17. AI分析結果      │          │
     │          │          │◀──────────────────────────────────────────
     │          │          │                     │          │
     │          │          │ 18. INSERT session_analyses    │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │ 19. Broadcast (analysis)       │          │
     │          │◀─────────│                     │          │
     │          │          │                     │          │
     │ 20. onAnalysis      │                     │          │
     │◀──────────          │                     │          │
     │          │          │                     │          │
     │ 21. UI更新（スコア表示）                   │          │
     │          │          │                     │          │
     ║══════════║══════════║═══ 悩みキーワード検出時 ═══════║══════════║
     │          │          │                     │          │
     │          │          │ 22. POST /v1/embeddings (OpenAI)
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 23. Embedding vector│          │
     │          │          │◀──────────────────────────────────────────
     │          │          │                     │          │
     │          │          │ 24. pgvector cosine similarity │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 25. Top 5 success cases        │
     │          │          │◀──────────────────────────────────────────
     │          │          │                     │          │
     │          │ 26. Broadcast (notification)   │          │
     │          │◀─────────│                     │          │
     │          │          │                     │          │
     │ 27. onNotification  │                     │          │
     │◀──────────          │                     │          │
     │          │          │                     │          │
     │ 28. 提案通知表示    │                     │          │
     │          │          │                     │          │
```

### 3.4 エラーハンドリング設計

#### 3.4.1 エラー分類体系

| カテゴリ | コード範囲 | HTTP Status | 説明 | リトライ |
|---------|-----------|-------------|------|---------|
| AUTH | AUTH_001-099 | 401, 403 | 認証・認可エラー | 不可 |
| VALIDATION | VAL_001-099 | 400 | 入力バリデーションエラー | 不可 |
| SESSION | SES_001-099 | 400, 404 | セッション状態エラー | 条件付き |
| AI | AI_001-099 | 500, 503 | AI API障害 | 可 |
| DIARIZATION | DIA_001-099 | 500, 503 | 話者分離障害 | 可 |
| DATABASE | DB_001-099 | 500 | データベースエラー | 可 |
| NETWORK | NET_001-099 | 503 | ネットワークエラー | 可 |
| SYSTEM | SYS_001-099 | 500 | システムエラー | 条件付き |

#### 3.4.2 エラーコード詳細

| コード | 名称 | 説明 | 対応アクション |
|--------|------|------|--------------|
| AUTH_001 | INVALID_TOKEN | JWTトークンが無効 | 再ログイン誘導 |
| AUTH_002 | TOKEN_EXPIRED | トークン期限切れ | リフレッシュトークンで更新 |
| AUTH_003 | INSUFFICIENT_PERMISSION | 権限不足 | エラーメッセージ表示 |
| VAL_001 | REQUIRED_FIELD_MISSING | 必須項目未入力 | フィールドハイライト |
| VAL_002 | INVALID_FORMAT | 形式不正 | 入力形式ガイド表示 |
| SES_001 | SESSION_NOT_FOUND | セッションが存在しない | ホームへ戻す |
| SES_002 | SESSION_ALREADY_ENDED | セッション終了済み | レポート画面へ |
| SES_003 | SESSION_IN_PROGRESS | セッション処理中 | 待機またはリトライ |
| AI_001 | CLAUDE_API_ERROR | Claude API エラー | リトライ後フォールバック |
| AI_002 | CLAUDE_RATE_LIMIT | レート制限 | 指数バックオフリトライ |
| AI_003 | CLAUDE_TIMEOUT | タイムアウト | リトライ |
| DIA_001 | PYANNOTE_ERROR | 話者分離エラー | リトライ後スキップ |
| DIA_002 | PYANNOTE_TIMEOUT | 話者分離タイムアウト | リトライ |
| DB_001 | CONNECTION_ERROR | DB接続エラー | リトライ |
| DB_002 | QUERY_ERROR | クエリエラー | ログ記録、ユーザー通知 |

#### 3.4.3 リトライ戦略

```typescript
// リトライ設定
const retryConfig = {
  // ネットワークエラー
  network: {
    maxRetries: 3,
    baseDelay: 1000,      // 1秒
    maxDelay: 30000,      // 30秒
    backoffType: 'exponential',
    jitter: true,
  },
  
  // Claude API 429
  claudeRateLimit: {
    maxRetries: 5,
    baseDelay: 5000,      // 5秒
    maxDelay: 60000,      // 60秒
    backoffType: 'exponential',
    jitter: true,
  },
  
  // Claude API 500
  claudeServerError: {
    maxRetries: 3,
    baseDelay: 2000,      // 2秒
    maxDelay: 10000,      // 10秒
    backoffType: 'fixed',
    jitter: false,
  },
  
  // DB接続エラー
  database: {
    maxRetries: 3,
    baseDelay: 1000,
    maxDelay: 10000,
    backoffType: 'exponential',
    jitter: true,
  },
  
  // pyannote
  pyannote: {
    maxRetries: 2,
    baseDelay: 5000,
    maxDelay: 30000,
    backoffType: 'exponential',
    jitter: false,
  },
};
```

#### 3.4.4 フォールバック設計

| 機能 | プライマリ | フォールバック | 条件 |
|------|-----------|---------------|------|
| 話者分離 | pyannote Server | 話者分離スキップ（全文スタイリスト扱い） | 3回リトライ失敗後 |
| AI分析 | Claude Sonnet 4.5 | ルールベース分析 | API障害時 |
| ベクトル検索 | pgvector | キーワードベース検索 | Embedding生成失敗時 |
| 文字起こし | SpeechAnalyzer | オフラインキュー蓄積 | ネットワーク障害時 |
| リアルタイム通知 | WebSocket | ポーリング（30秒間隔） | WebSocket切断時 |

---

（続きは Part2 に記載）
# 基本設計書 Part 2: 機能設計・画面設計

---

## 4. 機能設計

### 4.1 機能階層図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           機能階層図                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  SalonTalk AI                                                               │
│  │                                                                          │
│  ├── 1. 認証・アカウント管理機能 [AUTH]                                       │
│  │   ├── 1.1 ユーザー認証 [AUTH-001]                                        │
│  │   │   ├── 1.1.1 メール/パスワードログイン                                 │
│  │   │   ├── 1.1.2 セッション管理                                           │
│  │   │   ├── 1.1.3 ログアウト                                               │
│  │   │   └── 1.1.4 パスワードリセット                                       │
│  │   ├── 1.2 ロール管理 [AUTH-002]                                          │
│  │   │   ├── 1.2.1 ロール割り当て                                           │
│  │   │   └── 1.2.2 権限チェック                                             │
│  │   ├── 1.3 店舗アカウント管理 [AUTH-003]                                   │
│  │   │   ├── 1.3.1 店舗登録                                                 │
│  │   │   ├── 1.3.2 店舗情報編集                                             │
│  │   │   └── 1.3.3 プラン管理                                               │
│  │   └── 1.4 スタッフ管理 [AUTH-004]                                        │
│  │       ├── 1.4.1 スタッフ招待                                             │
│  │       ├── 1.4.2 スタッフ情報編集                                         │
│  │       └── 1.4.3 スタッフ無効化                                           │
│  │                                                                          │
│  ├── 2. セッション管理機能 [SESSION]                                         │
│  │   ├── 2.1 セッション開始 [SESSION-001]                                    │
│  │   │   ├── 2.1.1 お客様情報入力                                           │
│  │   │   ├── 2.1.2 録音開始                                                 │
│  │   │   └── 2.1.3 Realtimeチャンネル接続                                   │
│  │   ├── 2.2 セッション監視 [SESSION-002]                                    │
│  │   │   ├── 2.2.1 録音状態監視                                             │
│  │   │   ├── 2.2.2 ネットワーク状態監視                                     │
│  │   │   └── 2.2.3 処理状態監視                                             │
│  │   ├── 2.3 セッション終了 [SESSION-003]                                    │
│  │   │   ├── 2.3.1 録音停止                                                 │
│  │   │   ├── 2.3.2 最終処理実行                                             │
│  │   │   └── 2.3.3 レポート生成トリガー                                     │
│  │   └── 2.4 セッション履歴 [SESSION-004]                                    │
│  │       ├── 2.4.1 履歴一覧表示                                             │
│  │       └── 2.4.2 履歴検索                                                 │
│  │                                                                          │
│  ├── 3. 音声処理機能 [AUDIO]                                                 │
│  │   ├── 3.1 音声取得 [AUDIO-001]                                            │
│  │   │   ├── 3.1.1 マイク入力キャプチャ                                     │
│  │   │   ├── 3.1.2 音声バッファリング                                       │
│  │   │   └── 3.1.3 チャンク分割（60秒）                                     │
│  │   ├── 3.2 文字起こし [AUDIO-002]                                          │
│  │   │   ├── 3.2.1 SpeechAnalyzer初期化                                     │
│  │   │   ├── 3.2.2 リアルタイム文字起こし                                   │
│  │   │   └── 3.2.3 タイムスタンプ付与                                       │
│  │   ├── 3.3 話者分離 [AUDIO-003]                                            │
│  │   │   ├── 3.3.1 音声ファイルアップロード                                 │
│  │   │   ├── 3.3.2 pyannote処理                                             │
│  │   │   └── 3.3.3 結果受信（Callback）                                     │
│  │   └── 3.4 テキスト結合 [AUDIO-004]                                        │
│  │       ├── 3.4.1 文字起こし＋話者分離マージ                               │
│  │       └── 3.4.2 話者ラベル付与                                           │
│  │                                                                          │
│  ├── 4. AI分析機能 [ANALYSIS]                                                │
│  │   ├── 4.1 トーク比率分析 [ANALYSIS-001]                                   │
│  │   │   ├── 4.1.1 発話時間集計                                             │
│  │   │   └── 4.1.2 比率計算                                                 │
│  │   ├── 4.2 質問分析 [ANALYSIS-002]                                         │
│  │   │   ├── 4.2.1 質問検出                                                 │
│  │   │   ├── 4.2.2 オープン/クローズド判定                                  │
│  │   │   └── 4.2.3 質問品質評価                                             │
│  │   ├── 4.3 感情分析 [ANALYSIS-003]                                         │
│  │   │   ├── 4.3.1 感情キーワード検出                                       │
│  │   │   └── 4.3.2 ポジティブ/ネガティブ判定                                │
│  │   ├── 4.4 悩みキーワード検出 [ANALYSIS-004]                               │
│  │   │   ├── 4.4.1 7カテゴリ検出                                            │
│  │   │   └── 4.4.2 検出タイミング記録                                       │
│  │   ├── 4.5 提案タイミング分析 [ANALYSIS-005]                               │
│  │   │   ├── 4.5.1 提案行為検出                                             │
│  │   │   └── 4.5.2 タイミング評価                                           │
│  │   ├── 4.6 提案品質分析 [ANALYSIS-006]                                     │
│  │   │   ├── 4.6.1 ベネフィット/スペック判定                                │
│  │   │   └── 4.6.2 品質スコア算出                                           │
│  │   ├── 4.7 成約判定 [ANALYSIS-007]                                         │
│  │   │   ├── 4.7.1 購入意思検出                                             │
│  │   │   └── 4.7.2 商品名特定                                               │
│  │   └── 4.8 総合スコアリング [ANALYSIS-008]                                 │
│  │       ├── 4.8.1 重み付け計算                                             │
│  │       └── 4.8.2 スコア正規化                                             │
│  │                                                                          │
│  ├── 5. リアルタイムアシスト機能 [ASSIST]                                    │
│  │   ├── 5.1 スコア表示 [ASSIST-001]                                         │
│  │   │   ├── 5.1.1 リアルタイムスコア更新                                   │
│  │   │   └── 5.1.2 スコアゲージ表示                                         │
│  │   ├── 5.2 提案タイミング通知 [ASSIST-002]                                 │
│  │   │   ├── 5.2.1 悩み検出トリガー                                         │
│  │   │   └── 5.2.2 通知カード表示                                           │
│  │   ├── 5.3 成功トーク提案 [ASSIST-003]                                     │
│  │   │   ├── 5.3.1 類似事例検索                                             │
│  │   │   └── 5.3.2 トーク例表示                                             │
│  │   └── 5.4 アラート表示 [ASSIST-004]                                       │
│  │       ├── 5.4.1 トーク比率警告                                           │
│  │       └── 5.4.2 質問数不足警告                                           │
│  │                                                                          │
│  ├── 6. 成功事例管理機能 [CASE]                                              │
│  │   ├── 6.1 成功事例登録 [CASE-001]                                         │
│  │   │   ├── 6.1.1 自動登録（高スコア＋成約）                               │
│  │   │   ├── 6.1.2 手動登録                                                 │
│  │   │   └── 6.1.3 Embedding生成                                            │
│  │   ├── 6.2 成功事例検索 [CASE-002]                                         │
│  │   │   ├── 6.2.1 ベクトル類似検索                                         │
│  │   │   └── 6.2.2 キーワード検索（フォールバック）                         │
│  │   ├── 6.3 成功事例閲覧 [CASE-003]                                         │
│  │   │   ├── 6.3.1 一覧表示                                                 │
│  │   │   └── 6.3.2 詳細表示                                                 │
│  │   └── 6.4 成功事例評価 [CASE-004]                                         │
│  │       └── 6.4.1 有用性評価                                               │
│  │                                                                          │
│  ├── 7. レポート機能 [REPORT]                                                │
│  │   ├── 7.1 セッションレポート生成 [REPORT-001]                             │
│  │   │   ├── 7.1.1 分析データ集約                                           │
│  │   │   ├── 7.1.2 AIレポート生成                                           │
│  │   │   └── 7.1.3 アクションアイテム生成                                   │
│  │   ├── 7.2 スタッフ分析レポート [REPORT-002]                               │
│  │   │   ├── 7.2.1 期間集計                                                 │
│  │   │   ├── 7.2.2 トレンド分析                                             │
│  │   │   └── 7.2.3 強み/弱み分析                                            │
│  │   ├── 7.3 店舗分析レポート [REPORT-003]                                   │
│  │   │   ├── 7.3.1 店舗全体集計                                             │
│  │   │   ├── 7.3.2 スタッフ比較                                             │
│  │   │   └── 7.3.3 目標達成度                                               │
│  │   └── 7.4 レポートエクスポート [REPORT-004]                               │
│  │       ├── 7.4.1 PDF出力                                                  │
│  │       └── 7.4.2 CSV出力                                                  │
│  │                                                                          │
│  ├── 8. 教育・トレーニング機能 [TRAINING]                                    │
│  │   ├── 8.1 AIロールプレイ [TRAINING-001]                                   │
│  │   │   ├── 8.1.1 お客様役AI生成                                           │
│  │   │   ├── 8.1.2 会話進行                                                 │
│  │   │   └── 8.1.3 リアルタイム評価                                         │
│  │   ├── 8.2 シナリオ管理 [TRAINING-002]                                     │
│  │   │   ├── 8.2.1 シナリオ一覧                                             │
│  │   │   └── 8.2.2 難易度選択                                               │
│  │   ├── 8.3 ベストプラクティス [TRAINING-003]                               │
│  │   │   ├── 8.3.1 成功パターン閲覧                                         │
│  │   │   └── 8.3.2 学習教材表示                                             │
│  │   └── 8.4 ゲーミフィケーション [TRAINING-004]                             │
│  │       ├── 8.4.1 バッジ管理                                               │
│  │       └── 8.4.2 ランキング表示                                           │
│  │                                                                          │
│  └── 9. 管理機能 [ADMIN]                                                     │
│      ├── 9.1 ダッシュボード [ADMIN-001]                                      │
│      │   ├── 9.1.1 KPI表示                                                  │
│      │   └── 9.1.2 アラート表示                                             │
│      ├── 9.2 設定管理 [ADMIN-002]                                            │
│      │   ├── 9.2.1 店舗設定                                                 │
│      │   ├── 9.2.2 通知設定                                                 │
│      │   └── 9.2.3 分析パラメータ設定                                       │
│      ├── 9.3 通知管理 [ADMIN-003]                                            │
│      │   ├── 9.3.1 通知テンプレート                                         │
│      │   └── 9.3.2 通知履歴                                                 │
│      └── 9.4 システム監視 [ADMIN-004]                                        │
│          ├── 9.4.1 利用状況監視                                             │
│          └── 9.4.2 エラー監視                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 ユースケース設計

#### 4.2.1 ユースケース一覧

| UC-ID | ユースケース名 | アクター | 優先度 | Phase |
|-------|--------------|---------|-------|-------|
| UC-001 | セッション開始 | スタイリスト | 高 | 1 |
| UC-002 | リアルタイム分析受信 | スタイリスト | 高 | 1 |
| UC-003 | 成功事例検索 | システム/スタイリスト | 高 | 2 |
| UC-004 | セッションレポート生成 | システム | 高 | 1 |
| UC-005 | AIロールプレイ | スタイリスト | 中 | 3 |
| UC-006 | スタッフ管理 | 店長/マネージャー | 中 | 1 |
| UC-007 | 店舗分析閲覧 | 店長/オーナー | 中 | 2 |
| UC-008 | 成功事例登録 | 店長/マネージャー | 中 | 2 |
| UC-009 | レポートエクスポート | 店長/オーナー | 低 | 2 |
| UC-010 | 複数店舗統合分析 | オーナー | 低 | 3 |

#### 4.2.2 主要ユースケース詳細

**UC-001: セッション開始**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-001 |
| ユースケース名 | セッション開始 |
| 概要 | スタイリストが施術開始時にセッションを開始し、会話分析を開始する |
| アクター | スタイリスト |
| 事前条件 | - スタイリストがログイン済みである<br>- iPadにマイク権限が許可されている<br>- ネットワーク接続が有効である |
| 事後条件 | - セッションが作成されている<br>- 録音が開始されている<br>- リアルタイム分析が開始されている |
| トリガー | スタイリストがホーム画面で「セッション開始」ボタンをタップ |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | 「セッション開始」をタップ | - |
| 2 | - | お客様情報入力画面を表示 |
| 3 | お客様情報を入力（任意） | - |
| 4 | 「開始」をタップ | - |
| 5 | - | マイク権限を確認 |
| 6 | - | create-session APIを呼び出し |
| 7 | - | セッションレコードを作成 |
| 8 | - | Realtimeチャンネルを作成 |
| 9 | - | クライアントをチャンネルに接続 |
| 10 | - | 録音を開始（AVAudioEngine） |
| 11 | - | セッション画面に遷移 |

**代替フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| A1 | ステップ5でマイク権限がない | 5a. 権限要求ダイアログを表示<br>5b. ユーザーが許可→基本フロー6へ<br>5c. ユーザーが拒否→エラー表示、終了 |
| A2 | ステップ3をスキップ | 3a. 「スキップ」をタップ<br>3b. 基本フロー4へ（customer_info: null） |

**例外フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| E1 | ステップ6でネットワークエラー | 6a. オフラインモードで録音を開始<br>6b. ローカルにデータを蓄積<br>6c. ネットワーク回復時に同期 |
| E2 | ステップ7でDB書き込みエラー | 7a. エラーログを記録<br>7b. 3回リトライ<br>7c. 失敗時はエラー表示、終了 |

---

**UC-002: リアルタイム分析受信**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-002 |
| ユースケース名 | リアルタイム分析受信 |
| 概要 | セッション中に分析結果をリアルタイムで受信し、表示する |
| アクター | スタイリスト（閲覧）、システム（処理） |
| 事前条件 | - セッションが開始されている<br>- Realtimeチャンネルに接続されている |
| 事後条件 | - 分析結果がUIに表示されている<br>- 分析結果がDBに保存されている |
| トリガー | 60秒ごとの音声チャンク処理完了 |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | - | 60秒分の音声をバッファリング |
| 2 | - | SpeechAnalyzerで文字起こし実行 |
| 3 | - | 文字起こし結果をローカルDBに一時保存 |
| 4 | - | 音声チャンク＋文字起こしをサーバーに送信 |
| 5 | - | Storageに音声ファイルを保存 |
| 6 | - | transcriptsテーブルに文字起こしを保存 |
| 7 | - | pyannoteサーバーに話者分離をリクエスト |
| 8 | - | pyannoteが非同期で処理実行 |
| 9 | - | Callback受信、speaker_segmentsに保存 |
| 10 | - | 文字起こし＋話者分離をマージ |
| 11 | - | Claude APIで7指標分析を実行 |
| 12 | - | 分析結果をsession_analysesに保存 |
| 13 | - | Realtimeチャンネルで分析結果をブロードキャスト |
| 14 | - | クライアントが分析結果を受信 |
| 15 | - | UIのスコア・会話ログを更新 |

**代替フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| A1 | ステップ8で悩みキーワード検出 | 8a. 成功事例検索をトリガー<br>8b. UC-003を実行<br>8c. 提案通知を生成 |

**例外フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| E1 | ステップ7でpyannoteエラー | 7a. 3回リトライ<br>7b. 失敗時は話者分離をスキップ<br>7c. 全テキストをスタイリスト発話として処理 |
| E2 | ステップ11でClaude APIエラー | 11a. 5回リトライ（指数バックオフ）<br>11b. 失敗時はルールベース分析にフォールバック |

---

**UC-003: 成功事例検索**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-003 |
| ユースケース名 | 成功事例検索 |
| 概要 | 悩みキーワード検出時に類似の成功事例を検索し、提案トークを表示する |
| アクター | システム（自動）、スタイリスト（手動） |
| 事前条件 | - 悩みキーワードが検出されている<br>- 成功事例DBにデータが存在する |
| 事後条件 | - 類似成功事例が取得されている<br>- 提案通知がUIに表示されている |
| トリガー | 悩みキーワード検出（自動）または「成功事例検索」ボタンタップ（手動） |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | - | 悩みキーワードとコンテキスト情報を収集 |
| 2 | - | シーン情報を構築（キーワード、お客様属性） |
| 3 | - | OpenAI Embedding APIでベクトル生成 |
| 4 | - | pgvectorでコサイン類似度検索 |
| 5 | - | 類似度0.7以上の上位5件を取得 |
| 6 | - | 成功トーク例を整形 |
| 7 | - | Realtimeチャンネルで通知をブロードキャスト |
| 8 | - | クライアントが通知を受信 |
| 9 | - | 提案通知カードを表示 |
| 10 | 通知を確認 | - |

**代替フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| A1 | ステップ5で類似事例なし | 5a. 汎用提案テンプレートを使用<br>5b. 基本フロー6へ |

**例外フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| E1 | ステップ3でEmbedding生成失敗 | 3a. キーワードベース検索にフォールバック<br>3b. concern_keywordsカラムで部分一致検索<br>3c. 基本フロー6へ |

---

**UC-004: セッションレポート生成**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-004 |
| ユースケース名 | セッションレポート生成 |
| 概要 | セッション終了時に詳細なレポートを自動生成する |
| アクター | システム（自動） |
| 事前条件 | - セッションが終了されている<br>- 分析データが保存されている |
| 事後条件 | - レポートが生成されている<br>- レポートがDBに保存されている<br>- レポート画面が表示されている |
| トリガー | スタイリストが「セッション終了」ボタンをタップ |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | 「セッション終了」をタップ | - |
| 2 | - | 終了確認ダイアログを表示 |
| 3 | 「終了」を選択 | - |
| 4 | - | 録音を停止 |
| 5 | - | 残りの音声チャンクを処理 |
| 6 | - | sessionsテーブルのstatusを「processing」に更新 |
| 7 | - | 全分析データを集約 |
| 8 | - | Claude APIでレポートテキストを生成 |
| 9 | - | 良かった点を抽出（2-3項目） |
| 10 | - | 改善ポイントを抽出（2-3項目） |
| 11 | - | アクションアイテムを生成（3項目） |
| 12 | - | session_reportsテーブルに保存 |
| 13 | - | sessionsテーブルのstatusを「completed」に更新 |
| 14 | - | レポート画面に遷移 |

**例外フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| E1 | ステップ8でClaude APIエラー | 8a. 3回リトライ<br>8b. 失敗時は簡易レポート生成<br>8c. スコアのみのレポートを表示 |

---

**UC-005: AIロールプレイ**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-005 |
| ユースケース名 | AIロールプレイ |
| 概要 | AIがお客様役となり、スタイリストの接客スキルをトレーニングする |
| アクター | スタイリスト |
| 事前条件 | - スタイリストがログイン済みである |
| 事後条件 | - トレーニングが完了している<br>- 評価結果が記録されている |
| トリガー | トレーニング画面でシナリオを選択 |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | トレーニング画面を開く | - |
| 2 | - | シナリオ一覧を表示 |
| 3 | シナリオを選択 | - |
| 4 | - | AIお客様役を初期化（Claude API） |
| 5 | - | 最初の発話を生成・表示 |
| 6 | 応答を入力（テキストまたは音声） | - |
| 7 | - | 応答を評価 |
| 8 | - | 評価スコアを表示 |
| 9 | - | 次のAI発話を生成・表示 |
| 10 | ステップ6-9を繰り返す | - |
| 11 | 「終了」をタップ | - |
| 12 | - | 総合評価を生成 |
| 13 | - | 評価結果画面を表示 |

### 4.3 機能詳細設計

#### 4.3.1 セッション管理機能

**F-SESSION-001: セッション開始**

**処理フロー**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    セッション開始 処理フロー                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [開始]                                                                  │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 1. マイク権限確認                    │                                │
│  │    AVAudioSession.requestRecordPermission()                         │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│              ┌──────┴──────┐                                            │
│              │ 権限あり？   │                                            │
│              └──────┬──────┘                                            │
│           Yes │          │ No                                           │
│               │          ▼                                              │
│               │  ┌─────────────────────────────┐                        │
│               │  │ 1a. 権限要求ダイアログ表示   │                        │
│               │  └───────────────┬─────────────┘                        │
│               │           ┌─────┴─────┐                                 │
│               │           │ 許可？    │                                 │
│               │           └─────┬─────┘                                 │
│               │        Yes │        │ No                                │
│               │            │        ▼                                   │
│               │            │  ┌─────────────────┐                       │
│               │            │  │ エラー表示      │                       │
│               │            │  │ "マイク権限が   │                       │
│               │            │  │  必要です"      │                       │
│               │            │  └────────┬────────┘                       │
│               │            │           │                                │
│               │            │           ▼                                │
│               │            │       [終了]                               │
│               ◀────────────┘                                            │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 2. お客様情報入力画面表示            │                                │
│  │    - ageGroup (選択式)              │                                │
│  │    - gender (選択式)                │                                │
│  │    - visitFrequency (選択式)        │                                │
│  │    - notes (自由入力、max 500字)    │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│              ┌──────┴──────┐                                            │
│              │ スキップ？   │                                            │
│              └──────┬──────┘                                            │
│           Yes │          │ No                                           │
│               │          ▼                                              │
│               │  ┌─────────────────────────────┐                        │
│               │  │ 2a. 入力値バリデーション     │                        │
│               │  └───────────────┬─────────────┘                        │
│               │                  │                                      │
│               ◀──────────────────┘                                      │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 3. API呼び出し: create-session      │                                │
│  │                                     │                                │
│  │    Request:                         │                                │
│  │    POST /functions/v1/create-session│                                │
│  │    {                                │                                │
│  │      stylistId: UUID,               │                                │
│  │      customerInfo: {                │                                │
│  │        ageGroup?: string,           │                                │
│  │        gender?: string,             │                                │
│  │        visitFrequency?: string,     │                                │
│  │        notes?: string               │                                │
│  │      }                              │                                │
│  │    }                                │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│              ┌──────┴──────┐                                            │
│              │ 成功？      │                                            │
│              └──────┬──────┘                                            │
│           Yes │          │ No                                           │
│               │          ▼                                              │
│               │  ┌─────────────────────────────┐                        │
│               │  │ 3a. エラーハンドリング       │                        │
│               │  │                             │                        │
│               │  │ ・ネットワークエラー         │                        │
│               │  │   → オフラインモード開始     │                        │
│               │  │ ・認証エラー                │                        │
│               │  │   → ログイン画面へ          │                        │
│               │  │ ・その他エラー              │                        │
│               │  │   → エラー表示、リトライ     │                        │
│               │  └───────────────┬─────────────┘                        │
│               │                  │                                      │
│               ◀──────────────────┘                                      │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 4. レスポンス処理                    │                                │
│  │                                     │                                │
│  │    Response:                        │                                │
│  │    {                                │                                │
│  │      sessionId: UUID,               │                                │
│  │      status: "recording",           │                                │
│  │      startedAt: ISO8601,            │                                │
│  │      realtimeChannel: string        │                                │
│  │    }                                │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 5. Realtime接続                      │                                │
│  │                                     │                                │
│  │    supabase.channel(realtimeChannel)│                                │
│  │      .on('broadcast', { event: 'analysis' }, ...)                   │
│  │      .on('broadcast', { event: 'notification' }, ...)               │
│  │      .subscribe()                   │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 6. 録音開始                          │                                │
│  │                                     │                                │
│  │    AVAudioEngine configuration:     │                                │
│  │    - sampleRate: 16000 Hz           │                                │
│  │    - channels: 1 (mono)             │                                │
│  │    - format: PCM 16bit              │                                │
│  │                                     │                                │
│  │    Buffer: 60秒ごとにチャンク化      │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 7. セッション画面遷移                │                                │
│  │                                     │                                │
│  │    sessionStore.setSession({        │                                │
│  │      id: sessionId,                 │                                │
│  │      status: "recording",           │                                │
│  │      startedAt,                     │                                │
│  │      ...                            │                                │
│  │    })                               │                                │
│  │                                     │                                │
│  │    navigation.navigate("Session")   │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│     ▼                                                                   │
│  [終了]                                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**入力項目詳細**:

| 項目ID | 項目名 | 論理名 | データ型 | 必須 | バリデーション | 初期値 |
|--------|--------|--------|---------|------|---------------|-------|
| IN-001 | stylistId | スタイリストID | UUID | ○ | ログインユーザーのID | 自動設定 |
| IN-002 | ageGroup | 年代 | string | × | "10s"/"20s"/"30s"/"40s"/"50s"/"60s+" | null |
| IN-003 | gender | 性別 | string | × | "male"/"female"/"other" | null |
| IN-004 | visitFrequency | 来店頻度 | string | × | "first"/"monthly"/"bimonthly"/"quarterly"/"irregular" | null |
| IN-005 | notes | メモ | string | × | 最大500文字、特殊文字エスケープ | null |

**出力項目詳細**:

| 項目ID | 項目名 | 論理名 | データ型 | 説明 |
|--------|--------|--------|---------|------|
| OUT-001 | sessionId | セッションID | UUID | 作成されたセッションのID |
| OUT-002 | status | ステータス | string | "recording" |
| OUT-003 | startedAt | 開始日時 | ISO8601 | セッション開始日時 |
| OUT-004 | realtimeChannel | チャンネル名 | string | "session:{sessionId}" |

---

#### 4.3.2 AI分析機能

**F-ANALYSIS-008: 総合スコアリング**

**処理ロジック**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    総合スコアリング 計算ロジック                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  入力: 7指標の個別スコア（0-100点）                                       │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 指標              │ 重み   │ 計算方法                            │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 1. トーク比率     │  15%   │ 理想比率（40:60）からの乖離度で計算  │   │
│  │                   │        │ 35-45%: 100点                       │   │
│  │                   │        │ 30-35% or 45-50%: 80点              │   │
│  │                   │        │ 25-30% or 50-55%: 60点              │   │
│  │                   │        │ それ以外: 40点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 2. 質問分析       │  15%   │ 質問数×質問品質で計算               │   │
│  │                   │        │ 8-12回 かつ オープン60%以上: 100点  │   │
│  │                   │        │ 6-14回 かつ オープン50%以上: 80点   │   │
│  │                   │        │ 4-16回 かつ オープン40%以上: 60点   │   │
│  │                   │        │ それ以外: 40点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 3. 感情分析       │  15%   │ ポジティブキーワード比率            │   │
│  │                   │        │ 70%以上: 100点                       │   │
│  │                   │        │ 60-70%: 80点                        │   │
│  │                   │        │ 50-60%: 60点                        │   │
│  │                   │        │ それ以外: 40点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 4. 悩みキーワード │  10%   │ 検出の有無                           │   │
│  │                   │        │ 検出あり: 100点                      │   │
│  │                   │        │ 検出なし: 50点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 5. 提案タイミング │  15%   │ 悩み検出から提案までの時間          │   │
│  │                   │        │ 2-5分: 100点                        │   │
│  │                   │        │ 1-2分 or 5-7分: 80点                │   │
│  │                   │        │ 7-10分: 60点                        │   │
│  │                   │        │ 10分以上 or 提案なし: 40点          │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 6. 提案品質       │  15%   │ ベネフィット提示率                  │   │
│  │                   │        │ 70%以上: 100点                       │   │
│  │                   │        │ 50-70%: 80点                        │   │
│  │                   │        │ 30-50%: 60点                        │   │
│  │                   │        │ それ以外: 40点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 7. 成約判定       │  15%   │ 成約の有無                           │   │
│  │                   │        │ 成約あり: 100点                      │   │
│  │                   │        │ 成約なし: 50点                       │   │
│  └───────────────────┴────────┴─────────────────────────────────────┘   │
│                                                                         │
│  計算式:                                                                 │
│  総合スコア = Σ(指標スコア × 重み)                                       │
│                                                                         │
│  例:                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 指標              │ スコア │ 重み  │ 加重スコア                   │   │
│  ├───────────────────┼────────┼───────┼──────────────────────────────┤   │
│  │ トーク比率        │   85   │ 0.15  │ 12.75                        │   │
│  │ 質問分析          │   80   │ 0.15  │ 12.00                        │   │
│  │ 感情分析          │   90   │ 0.15  │ 13.50                        │   │
│  │ 悩みキーワード    │  100   │ 0.10  │ 10.00                        │   │
│  │ 提案タイミング    │   85   │ 0.15  │ 12.75                        │   │
│  │ 提案品質          │   70   │ 0.15  │ 10.50                        │   │
│  │ 成約判定          │  100   │ 0.15  │ 15.00                        │   │
│  ├───────────────────┼────────┼───────┼──────────────────────────────┤   │
│  │ 合計              │   -    │ 1.00  │ 86.50                        │   │
│  └───────────────────┴────────┴───────┴──────────────────────────────┘   │
│                                                                         │
│  出力: overall_score = 87 (四捨五入)                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 画面設計

### 5.1 画面一覧

| 画面ID | 画面名 | 種別 | 概要 | 対応機能 |
|--------|--------|------|------|---------|
| iPad-001 | ログイン画面 | iPad | メール/パスワード認証 | AUTH-001 |
| iPad-002 | ホーム画面 | iPad | メニュー選択、クイックスタート | - |
| iPad-003 | セッション画面 | iPad | リアルタイム分析表示 | SESSION-002, ASSIST |
| iPad-004 | レポート一覧画面 | iPad | 過去レポート一覧 | REPORT-001 |
| iPad-005 | レポート詳細画面 | iPad | 個別レポート詳細 | REPORT-001 |
| iPad-006 | トレーニング画面 | iPad | 教育機能メニュー | TRAINING |
| iPad-007 | ロールプレイ画面 | iPad | AIロールプレイ | TRAINING-001 |
| iPad-008 | 設定画面 | iPad | アプリ設定 | ADMIN-002 |
| Web-001 | ランディングページ | Web | サービス紹介 | - |
| Web-002 | ログイン画面 | Web | メール/パスワード認証 | AUTH-001 |
| Web-003 | ダッシュボード | Web | 管理トップ、KPI表示 | ADMIN-001 |
| Web-004 | スタッフ一覧画面 | Web | スタッフ管理 | AUTH-004 |
| Web-005 | スタッフ詳細画面 | Web | 個別スタッフ分析 | REPORT-002 |
| Web-006 | 店舗分析画面 | Web | 店舗全体分析 | REPORT-003 |
| Web-007 | 成功事例画面 | Web | 成功事例管理 | CASE |
| Web-008 | 設定画面 | Web | 店舗設定 | ADMIN-002 |

### 5.2 画面遷移図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    iPad アプリ 画面遷移図                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ┌──────────────┐                               │
│                              │  iPad-001    │                               │
│                              │  ログイン     │                               │
│                              └──────┬───────┘                               │
│                                     │ 認証成功                               │
│                                     ▼                                       │
│                              ┌──────────────┐                               │
│           ┌──────────────────│  iPad-002    │──────────────────┐            │
│           │                  │  ホーム       │                  │            │
│           │                  └──────┬───────┘                  │            │
│           │                         │                          │            │
│           │    ┌────────────────────┼────────────────────┐     │            │
│           │    │                    │                    │     │            │
│           ▼    ▼                    ▼                    ▼     ▼            │
│    ┌────────────┐           ┌────────────┐          ┌────────────┐          │
│    │ iPad-003   │           │ iPad-004   │          │ iPad-006   │          │
│    │ セッション  │           │ レポート一覧 │          │トレーニング │          │
│    │            │           │            │          │            │          │
│    └─────┬──────┘           └─────┬──────┘          └─────┬──────┘          │
│          │                        │                       │               │
│          │ 終了                   │ 選択                  │ 選択          │
│          ▼                        ▼                       ▼               │
│    ┌────────────┐           ┌────────────┐          ┌────────────┐          │
│    │ iPad-005   │           │ iPad-005   │          │ iPad-007   │          │
│    │レポート詳細 │           │レポート詳細 │          │ロールプレイ │          │
│    └────────────┘           └────────────┘          └────────────┘          │
│                                                                             │
│    ※ 全画面からiPad-008（設定）へ遷移可能（ヘッダーから）                      │
│    ※ 全画面からiPad-002（ホーム）へ戻る可能（ヘッダーから）                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    Web ダッシュボード 画面遷移図                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌──────────────┐                                                         │
│    │  Web-001     │                                                         │
│    │ランディング   │                                                         │
│    └──────┬───────┘                                                         │
│           │ ログインクリック                                                  │
│           ▼                                                                 │
│    ┌──────────────┐                                                         │
│    │  Web-002     │                                                         │
│    │  ログイン     │                                                         │
│    └──────┬───────┘                                                         │
│           │ 認証成功                                                         │
│           ▼                                                                 │
│    ┌────────────────────────────────────────────────────────────────────┐  │
│    │                    サイドバーナビゲーション                          │  │
│    │                                                                    │  │
│    │  ┌─────────────┐                                                   │  │
│    │  │  サイドバー   │     ┌──────────────────────────────────────────┐│  │
│    │  │             │     │                メインエリア               ││  │
│    │  │ ● ダッシュボード│────▶│    ┌────────────┐                      ││  │
│    │  │             │     │    │  Web-003   │                      ││  │
│    │  │ ● スタッフ   │────▶│    │ダッシュボード│                      ││  │
│    │  │             │     │    └────────────┘                      ││  │
│    │  │ ● 分析      │────▶│    ┌────────────┐   ┌────────────┐     ││  │
│    │  │             │     │    │  Web-004   │──▶│  Web-005   │     ││  │
│    │  │ ● 成功事例   │────▶│    │スタッフ一覧 │   │スタッフ詳細 │     ││  │
│    │  │             │     │    └────────────┘   └────────────┘     ││  │
│    │  │ ● 設定      │────▶│    ┌────────────┐                      ││  │
│    │  │             │     │    │  Web-006   │                      ││  │
│    │  └─────────────┘     │    │ 店舗分析    │                      ││  │
│    │                      │    └────────────┘                      ││  │
│    │                      │    ┌────────────┐                      ││  │
│    │                      │    │  Web-007   │                      ││  │
│    │                      │    │ 成功事例    │                      ││  │
│    │                      │    └────────────┘                      ││  │
│    │                      │    ┌────────────┐                      ││  │
│    │                      │    │  Web-008   │                      ││  │
│    │                      │    │  設定      │                      ││  │
│    │                      │    └────────────┘                      ││  │
│    │                      └──────────────────────────────────────────┘│  │
│    │                                                                    │  │
│    └────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 画面レイアウト詳細

#### 5.3.1 iPad-003: セッション画面

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    iPad-003: セッション画面 レイアウト                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ヘッダー (Height: 60px)                                             │   │
│  │ ┌────────┐                                           ┌──────────┐  │   │
│  │ │ ← 戻る │           セッション中                     │ ⏱ 45:23  │  │   │
│  │ └────────┘                                           └──────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ リアルタイムスコアエリア (Height: 20%)                               │   │
│  │                                                                     │   │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │   │
│  │   │   傾聴スコア     │  │    質問数       │  │     感情        │    │   │
│  │   │                 │  │                 │  │                 │    │   │
│  │   │      72         │  │       8         │  │      😊         │    │   │
│  │   │   ████▓░░░░    │  │      回         │  │                 │    │   │
│  │   │                 │  │                 │  │                 │    │   │
│  │   └─────────────────┘  └─────────────────┘  └─────────────────┘    │   │
│  │                                                                     │   │
│  │   検出された悩み:  ┌────────┐ ┌────────┐                            │   │
│  │                   │  乾燥   │ │ 広がる  │                            │   │
│  │                   └────────┘ └────────┘                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 通知エリア (Height: 15%, 条件付き表示)                               │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │  🎯 提案チャンス！                                    [閉じる] │ │   │
│  │  │                                                               │ │   │
│  │  │  お客様が「乾燥」「広がる」と発言しました                       │ │   │
│  │  │                                                               │ │   │
│  │  │  ▶ 保湿シャンプーを提案しましょう                              │ │   │
│  │  │                                                               │ │   │
│  │  │  💡 成功トーク例：                                            │ │   │
│  │  │  「同じお悩みだった○○様は、このシャンプーで                    │ │   │
│  │  │   朝のドライヤー時間が5分短縮できたとおっしゃってました」       │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 会話ログエリア (Height: 50%, スクロール可能)                         │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │  👤 スタイリスト                                    14:23      │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │ │   │
│  │  │  │ 今日はどんな感じにしますか？                             │  │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘  │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                                          💇 お客様     14:25   │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │ │   │
│  │  │  │ 最近、髪が乾燥してパサパサなんです。広がっちゃって...    │  │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘  │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │  👤 スタイリスト                                    14:26      │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐  │ │   │
│  │  │  │ 乾燥が気になりますか？朝とか広がったりしますか？         │  │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘  │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                                                                     │   │
│  │                              ▼ スクロール可能                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ アクションエリア (Height: 10%)                                      │   │
│  │                                                                     │   │
│  │                ┌─────────────────────────────────┐                  │   │
│  │                │      ● セッション終了            │                  │   │
│  │                │        (赤いボタン)             │                  │   │
│  │                └─────────────────────────────────┘                  │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**画面項目定義 - iPad-003**:

| 項目ID | 項目名 | 種別 | データ型 | 説明 | 更新頻度 |
|--------|--------|------|---------|------|---------|
| S003-01 | 戻るボタン | ボタン | - | ホーム画面へ戻る（確認ダイアログあり） | - |
| S003-02 | タイトル | ラベル | string | 「セッション中」固定 | - |
| S003-03 | 経過時間 | ラベル | string | mm:ss形式 | 1秒ごと |
| S003-04 | 傾聴スコア | ゲージ | number | 0-100、ゲージ表示 | 分析結果受信時 |
| S003-05 | スコアラベル | ラベル | number | スコア数値 | 分析結果受信時 |
| S003-06 | 質問数 | ラベル | number | 累計質問回数 | 分析結果受信時 |
| S003-07 | 感情インジケータ | アイコン | string | 😊😐😞の3段階 | 分析結果受信時 |
| S003-08 | 悩みタグ | タグリスト | string[] | 検出されたキーワード | 検出時追加 |
| S003-09 | 通知カード | カード | object | 提案通知（条件表示） | 通知受信時 |
| S003-10 | 通知タイトル | ラベル | string | 「🎯 提案チャンス！」等 | - |
| S003-11 | 通知メッセージ | テキスト | string | 検出内容 | - |
| S003-12 | 推奨商品 | ラベル | string | 推奨商品名 | - |
| S003-13 | 成功トーク例 | テキスト | string | 成功事例からの引用 | - |
| S003-14 | 閉じるボタン | ボタン | - | 通知を閉じる | - |
| S003-15 | 会話ログ | リスト | array | スクロール可能なログ | 文字起こし完了時 |
| S003-16 | 発話者アイコン | アイコン | string | 👤または💇 | - |
| S003-17 | 発話者ラベル | ラベル | string | 「スタイリスト」または「お客様」 | - |
| S003-18 | タイムスタンプ | ラベル | string | HH:mm形式 | - |
| S003-19 | 発話テキスト | テキスト | string | 発話内容 | - |
| S003-20 | 終了ボタン | ボタン | - | セッション終了 | - |

#### 5.3.2 Web-003: ダッシュボード

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Web-003: ダッシュボード レイアウト                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ヘッダー (Height: 64px)                                             │   │
│  │ ┌────────┐                                    ┌─────┐ ┌───────────┐ │   │
│  │ │  Logo  │     SalonTalk AI                   │ 🔔  │ │ 山田太郎 ▼│ │   │
│  │ └────────┘                                    └─────┘ └───────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────┐ ┌─────────────────────────────────────────────────────┐   │
│  │サイドバー    │ │ メインコンテンツ                                    │   │
│  │(Width: 240px)│ │                                                     │   │
│  │             │ │  ┌───────────────────────────────────────────────┐ │   │
│  │ ┌─────────┐ │ │  │ サマリーカード (Height: 120px)                 │ │   │
│  │ │ 📊      │ │ │  │                                               │ │   │
│  │ │ダッシュボード◀│ │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐│ │   │
│  │ └─────────┘ │ │  │  │今日の   │ │ 平均    │ │ 成約率  │ │ 活動    ││ │   │
│  │ ┌─────────┐ │ │  │  │セッション│ │ スコア  │ │        │ │スタッフ ││ │   │
│  │ │ 👥      │ │ │  │  │        │ │        │ │        │ │        ││ │   │
│  │ │スタッフ  │ │ │  │  │   12   │ │  78.5  │ │ 23.4%  │ │  8/10  ││ │   │
│  │ └─────────┘ │ │  │  │  +3 ↑  │ │ +2.3 ↑ │ │ +1.2 ↑ │ │        ││ │   │
│  │ ┌─────────┐ │ │  │  └────────┘ └────────┘ └────────┘ └────────┘│ │   │
│  │ │ 📈      │ │ │  │                                               │ │   │
│  │ │分析     │ │ │  └───────────────────────────────────────────────┘ │   │
│  │ └─────────┘ │ │                                                     │   │
│  │ ┌─────────┐ │ │  ┌─────────────────────┐ ┌───────────────────────┐│   │
│  │ │ 📚      │ │ │  │ スコア推移グラフ     │ │ スタッフランキング     ││   │
│  │ │成功事例  │ │ │  │ (Height: 280px)     │ │ (Height: 280px)       ││   │
│  │ └─────────┘ │ │  │                     │ │                       ││   │
│  │ ┌─────────┐ │ │  │   100 ┤             │ │ 1. 佐藤花子   85.2    ││   │
│  │ │ ⚙️      │ │ │  │       │    ╭──╮     │ │ 2. 田中一郎   82.1    ││   │
│  │ │設定     │ │ │  │    80 ┤   ╱  ╲    │ │ 3. 山田太郎   78.5    ││   │
│  │ └─────────┘ │ │  │       │  ╱    ╲   │ │ 4. 鈴木次郎   75.3    ││   │
│  │             │ │  │    60 ┤ ╱      ╲──│ │ 5. 高橋三郎   72.0    ││   │
│  │             │ │  │       │╱           │ │                       ││   │
│  │             │ │  │    40 ┤            │ │ ▶ 全て表示            ││   │
│  │             │ │  │       └────────────│ │                       ││   │
│  │             │ │  │        月 火 水 木 金│ │                       ││   │
│  │             │ │  └─────────────────────┘ └───────────────────────┘│   │
│  │             │ │                                                     │   │
│  │             │ │  ┌───────────────────────────────────────────────┐ │   │
│  │             │ │  │ 最近のセッション (Height: 240px)               │ │   │
│  │             │ │  │                                               │ │   │
│  │             │ │  │ ┌─────────┬──────────┬────────┬────────┬────┐│ │   │
│  │             │ │  │ │スタッフ │ 日時     │スコア  │ 成約   │詳細││ │   │
│  │             │ │  │ ├─────────┼──────────┼────────┼────────┼────┤│ │   │
│  │             │ │  │ │佐藤花子 │14:00-15:30│  92   │ ✅     │ ▶ ││ │   │
│  │             │ │  │ │田中一郎 │13:30-14:30│  78   │ ❌     │ ▶ ││ │   │
│  │             │ │  │ │山田太郎 │12:00-13:00│  85   │ ✅     │ ▶ ││ │   │
│  │             │ │  │ └─────────┴──────────┴────────┴────────┴────┘│ │   │
│  │             │ │  │                                               │ │   │
│  │             │ │  │                    ▶ 全て表示                  │ │   │
│  │             │ │  └───────────────────────────────────────────────┘ │   │
│  │             │ │                                                     │   │
│  └─────────────┘ └─────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 デザインガイドライン

#### 5.4.1 カラーパレット

| カラー名 | HEX | 用途 |
|---------|-----|------|
| Primary | #6366F1 | メインアクション、ブランドカラー |
| Primary Light | #818CF8 | ホバー状態 |
| Primary Dark | #4F46E5 | アクティブ状態 |
| Secondary | #EC4899 | アクセント、重要な通知 |
| Success | #10B981 | 成功状態、ポジティブ指標 |
| Warning | #F59E0B | 警告、注意 |
| Error | #EF4444 | エラー、ネガティブ指標 |
| Gray 50 | #F9FAFB | 背景 |
| Gray 100 | #F3F4F6 | カード背景 |
| Gray 200 | #E5E7EB | ボーダー |
| Gray 500 | #6B7280 | セカンダリテキスト |
| Gray 900 | #111827 | プライマリテキスト |

#### 5.4.2 タイポグラフィ

| 用途 | フォント | サイズ | 行高 | ウェイト |
|------|---------|-------|------|---------|
| 見出し1 | Noto Sans JP | 28px | 1.3 | Bold |
| 見出し2 | Noto Sans JP | 24px | 1.3 | Bold |
| 見出し3 | Noto Sans JP | 20px | 1.4 | Medium |
| 本文 | Noto Sans JP | 16px | 1.6 | Regular |
| 小テキスト | Noto Sans JP | 14px | 1.5 | Regular |
| キャプション | Noto Sans JP | 12px | 1.5 | Regular |
| スコア数値 | SF Pro Display | 48px | 1.0 | Bold |
| モノスペース | JetBrains Mono | 14px | 1.5 | Regular |

#### 5.4.3 スペーシング

| サイズ | ピクセル | 用途 |
|--------|---------|------|
| xs | 4px | 最小マージン |
| sm | 8px | 要素内パディング |
| md | 16px | 標準マージン |
| lg | 24px | セクション間 |
| xl | 32px | 大きなセクション間 |
| 2xl | 48px | ページセクション間 |

#### 5.4.4 コンポーネントスタイル

**ボタン**:

| 種類 | 背景色 | テキスト | ボーダー | 用途 |
|------|--------|---------|---------|------|
| Primary | Primary | White | None | 主要アクション |
| Secondary | White | Primary | Primary 1px | 副次アクション |
| Danger | Error | White | None | 削除、終了 |
| Ghost | Transparent | Gray 700 | None | テキストボタン |

**カード**:

```css
.card {
  background: #FFFFFF;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  padding: 24px;
}
```

**入力フィールド**:

```css
.input {
  border: 1px solid #E5E7EB;
  border-radius: 8px;
  padding: 12px 16px;
  font-size: 16px;
}

.input:focus {
  border-color: #6366F1;
  outline: none;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}
```

### 5.5 レスポンシブ対応

| デバイス | 画面サイズ | レイアウト |
|---------|-----------|-----------|
| iPad Pro 12.9" | 2048×2732 | フル機能表示 |
| iPad Pro 11" | 1668×2388 | フル機能表示 |
| iPad Air | 1640×2360 | フル機能表示 |
| iPad mini | 1488×2266 | フル機能表示（一部縮小） |
| Desktop | 1920×1080以上 | サイドバー + メインコンテンツ |
| Laptop | 1366×768以上 | サイドバー + メインコンテンツ |
| Tablet | 768×1024以上 | 折りたたみサイドバー |

---

（続きは Part3 に記載）
# 基本設計書 Part 3: データ設計・外部インターフェース設計・セキュリティ設計

---

## 6. データ設計

### 6.1 論理データモデル

#### 6.1.1 ER図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ER図（論理モデル）                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                                                                 │     │
│    │   ┌─────────────┐         ┌─────────────┐                      │     │
│    │   │   salons    │ 1     n │   staffs    │                      │     │
│    │   │─────────────│─────────│─────────────│                      │     │
│    │   │ id (PK)     │         │ id (PK)     │                      │     │
│    │   │ name        │         │ salon_id(FK)│                      │     │
│    │   │ address     │         │auth_user_id │                      │     │
│    │   │ phone       │         │ name        │                      │     │
│    │   │ plan        │         │ email       │                      │     │
│    │   │ seats_count │         │ role        │                      │     │
│    │   │ settings    │         │ position    │                      │     │
│    │   │ created_at  │         │ join_date   │                      │     │
│    │   │ updated_at  │         │ is_active   │                      │     │
│    │   └─────────────┘         │ settings    │                      │     │
│    │          │                │ created_at  │                      │     │
│    │          │                │ updated_at  │                      │     │
│    │          │                └──────┬──────┘                      │     │
│    │          │                       │                             │     │
│    │          │ 1                   n │                             │     │
│    │          │                       │                             │     │
│    │          ▼                       ▼                             │     │
│    │   ┌─────────────────────────────────────┐                      │     │
│    │   │             sessions                │                      │     │
│    │   │─────────────────────────────────────│                      │     │
│    │   │ id (PK)                             │                      │     │
│    │   │ salon_id (FK)                       │                      │     │
│    │   │ stylist_id (FK)                     │                      │     │
│    │   │ started_at                          │                      │     │
│    │   │ ended_at                            │                      │     │
│    │   │ status                              │                      │     │
│    │   │ customer_info (JSONB)               │                      │     │
│    │   │ diarization_status                  │                      │     │
│    │   │ created_at                          │                      │     │
│    │   │ updated_at                          │                      │     │
│    │   └──────────────────┬──────────────────┘                      │     │
│    │                      │                                         │     │
│    │          ┌───────────┼───────────┬───────────┐                │     │
│    │          │           │           │           │                │     │
│    │        1 │         1 │         1 │         1 │                │     │
│    │          │           │           │           │                │     │
│    │          ▼           ▼           ▼           ▼                │     │
│    │   ┌───────────┐┌───────────┐┌───────────┐┌───────────┐        │     │
│    │   │transcripts││ speaker_  ││ session_  ││ session_  │        │     │
│    │   │           ││ segments  ││ analyses  ││ reports   │        │     │
│    │   │───────────││───────────││───────────││───────────│        │     │
│    │   │id (PK)    ││id (PK)    ││id (PK)    ││id (PK)    │        │     │
│    │   │session_id ││session_id ││session_id ││session_id │        │     │
│    │   │chunk_index││speaker    ││chunk_index││overall_   │        │     │
│    │   │text       ││start_time ││indicator  ││score      │        │     │
│    │   │start_time ││end_time   ││value      ││good_points│        │     │
│    │   │end_time   ││text       ││score      ││improve_   │        │     │
│    │   │audio_url  ││confidence ││details    ││points     │        │     │
│    │   │created_at ││created_at ││created_at ││action_    │        │     │
│    │   └───────────┘└───────────┘└───────────┘│items      │        │     │
│    │          n           n           n       │transcript │        │     │
│    │                                          │summary    │        │     │
│    │                                          │ai_feedback│        │     │
│    │                                          │created_at │        │     │
│    │                                          └───────────┘        │     │
│    │                                                 1             │     │
│    │                                                               │     │
│    │   ┌─────────────────────────────────────────────────────┐     │     │
│    │   │                  success_cases                      │     │     │
│    │   │─────────────────────────────────────────────────────│     │     │
│    │   │ id (PK)                                             │     │     │
│    │   │ salon_id (FK)                                       │     │     │
│    │   │ session_id (FK, nullable)                           │     │     │
│    │   │ stylist_id (FK, nullable)                           │     │     │
│    │   │ concern_keywords (TEXT[])                           │     │     │
│    │   │ customer_profile (JSONB)                            │     │     │
│    │   │ successful_talk (TEXT)                              │     │     │
│    │   │ key_tactics (TEXT[])                                │     │     │
│    │   │ sold_product (VARCHAR)                              │     │     │
│    │   │ conversion_rate (NUMERIC)                           │     │     │
│    │   │ embedding (VECTOR(1536))                            │     │     │
│    │   │ is_public (BOOLEAN)                                 │     │     │
│    │   │ created_at                                          │     │     │
│    │   └─────────────────────────────────────────────────────┘     │     │
│    │                                                               │     │
│    └───────────────────────────────────────────────────────────────┘     │
│                                                                             │
│  カーディナリティ:                                                           │
│  salon ─1:n─ staff                                                         │
│  salon ─1:n─ session                                                       │
│  staff ─1:n─ session                                                       │
│  session ─1:n─ transcript                                                  │
│  session ─1:n─ speaker_segment                                             │
│  session ─1:n─ session_analysis                                            │
│  session ─1:1─ session_report                                              │
│  salon ─1:n─ success_case                                                  │
│  session ─0..1:n─ success_case (optional)                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 テーブル定義

#### 6.2.1 salons（店舗）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| name | VARCHAR(100) | NOT NULL | - | 店舗名 |
| address | TEXT | NULL | - | 住所 |
| phone | VARCHAR(20) | NULL | - | 電話番号 |
| plan | VARCHAR(20) | NOT NULL | 'standard' | 契約プラン |
| seats_count | INTEGER | NULL | - | 席数 |
| settings | JSONB | NOT NULL | '{}' | 店舗設定 |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | 更新日時 |

**制約**:

```sql
CREATE TABLE salons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  address TEXT,
  phone VARCHAR(20),
  plan VARCHAR(20) NOT NULL DEFAULT 'standard'
    CHECK (plan IN ('standard', 'professional', 'enterprise')),
  seats_count INTEGER CHECK (seats_count > 0),
  settings JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_salons_plan ON salons(plan);
CREATE INDEX idx_salons_created_at ON salons(created_at);
```

**settings JSONB構造**:

```json
{
  "notification": {
    "enablePush": true,
    "enableEmail": true,
    "concernDetectionAlert": true,
    "sessionCompleteAlert": true
  },
  "analysis": {
    "idealTalkRatio": 40,
    "minQuestionCount": 8,
    "concernKeywords": ["乾燥", "広がり", "パサつき", "ダメージ", "うねり", "薄毛", "白髪"]
  },
  "display": {
    "showRanking": true,
    "anonymizeCustomer": false
  }
}
```

---

#### 6.2.2 staffs（スタッフ）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| salon_id | UUID | NOT NULL | - | 所属店舗（FK） |
| auth_user_id | UUID | NOT NULL | - | Supabase Auth ID |
| name | VARCHAR(50) | NOT NULL | - | 氏名 |
| email | VARCHAR(255) | NOT NULL | - | メールアドレス |
| role | VARCHAR(20) | NOT NULL | 'stylist' | ロール |
| position | VARCHAR(50) | NULL | - | 役職名 |
| join_date | DATE | NULL | - | 入社日 |
| profile_image_url | TEXT | NULL | - | プロフィール画像URL |
| settings | JSONB | NOT NULL | '{}' | 個人設定 |
| is_active | BOOLEAN | NOT NULL | true | 有効フラグ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | 更新日時 |

**制約**:

```sql
CREATE TABLE staffs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  auth_user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'stylist'
    CHECK (role IN ('owner', 'manager', 'stylist', 'assistant')),
  position VARCHAR(50),
  join_date DATE,
  profile_image_url TEXT,
  settings JSONB NOT NULL DEFAULT '{}',
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (salon_id, email),
  UNIQUE (auth_user_id)
);

-- インデックス
CREATE INDEX idx_staffs_salon_id ON staffs(salon_id);
CREATE INDEX idx_staffs_auth_user_id ON staffs(auth_user_id);
CREATE INDEX idx_staffs_role ON staffs(role);
CREATE INDEX idx_staffs_is_active ON staffs(is_active);
```

---

#### 6.2.3 sessions（セッション）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| salon_id | UUID | NOT NULL | - | 店舗（FK） |
| stylist_id | UUID | NOT NULL | - | スタイリスト（FK） |
| started_at | TIMESTAMPTZ | NOT NULL | NOW() | 開始日時 |
| ended_at | TIMESTAMPTZ | NULL | - | 終了日時 |
| status | VARCHAR(20) | NOT NULL | 'recording' | ステータス |
| customer_info | JSONB | NULL | - | お客様情報 |
| diarization_status | VARCHAR(20) | NOT NULL | 'pending' | 話者分離状態 |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | 更新日時 |

**制約**:

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  stylist_id UUID NOT NULL REFERENCES staffs(id) ON DELETE CASCADE,
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  status VARCHAR(20) NOT NULL DEFAULT 'recording'
    CHECK (status IN ('recording', 'processing', 'completed', 'failed')),
  customer_info JSONB,
  diarization_status VARCHAR(20) NOT NULL DEFAULT 'pending'
    CHECK (diarization_status IN ('pending', 'processing', 'completed', 'failed')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_sessions_salon_id ON sessions(salon_id);
CREATE INDEX idx_sessions_stylist_id ON sessions(stylist_id);
CREATE INDEX idx_sessions_status ON sessions(status);
CREATE INDEX idx_sessions_started_at ON sessions(started_at DESC);
CREATE INDEX idx_sessions_salon_started ON sessions(salon_id, started_at DESC);
```

**customer_info JSONB構造**:

```json
{
  "ageGroup": "30s",
  "gender": "female",
  "visitFrequency": "monthly",
  "notes": "カラーアレルギーあり"
}
```

---

#### 6.2.4 transcripts（文字起こし）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| session_id | UUID | NOT NULL | - | セッション（FK） |
| chunk_index | INTEGER | NOT NULL | - | チャンク番号 |
| text | TEXT | NOT NULL | - | 文字起こしテキスト |
| start_time | NUMERIC(10,3) | NOT NULL | - | 開始時間（秒） |
| end_time | NUMERIC(10,3) | NOT NULL | - | 終了時間（秒） |
| audio_url | TEXT | NULL | - | 音声ファイルURL |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
CREATE TABLE transcripts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  text TEXT NOT NULL,
  start_time NUMERIC(10, 3) NOT NULL,
  end_time NUMERIC(10, 3) NOT NULL,
  audio_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (session_id, chunk_index)
);

-- インデックス
CREATE INDEX idx_transcripts_session_id ON transcripts(session_id);
CREATE INDEX idx_transcripts_session_chunk ON transcripts(session_id, chunk_index);
```

---

#### 6.2.5 speaker_segments（話者セグメント）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| session_id | UUID | NOT NULL | - | セッション（FK） |
| speaker | VARCHAR(20) | NOT NULL | - | 話者ラベル |
| start_time | NUMERIC(10,3) | NOT NULL | - | 開始時間（秒） |
| end_time | NUMERIC(10,3) | NOT NULL | - | 終了時間（秒） |
| text | TEXT | NULL | - | 該当テキスト |
| confidence | NUMERIC(5,4) | NULL | - | 信頼度 |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
CREATE TABLE speaker_segments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  speaker VARCHAR(20) NOT NULL
    CHECK (speaker IN ('stylist', 'customer', 'unknown')),
  start_time NUMERIC(10, 3) NOT NULL,
  end_time NUMERIC(10, 3) NOT NULL,
  text TEXT,
  confidence NUMERIC(5, 4) CHECK (confidence >= 0 AND confidence <= 1),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_speaker_segments_session_id ON speaker_segments(session_id);
CREATE INDEX idx_speaker_segments_speaker ON speaker_segments(speaker);
CREATE INDEX idx_speaker_segments_time ON speaker_segments(session_id, start_time);
```

---

#### 6.2.6 session_analyses（セッション分析）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| session_id | UUID | NOT NULL | - | セッション（FK） |
| chunk_index | INTEGER | NOT NULL | - | チャンク番号 |
| indicator_type | VARCHAR(30) | NOT NULL | - | 指標種別 |
| value | NUMERIC(10,4) | NOT NULL | - | 測定値 |
| score | INTEGER | NOT NULL | - | スコア（0-100） |
| details | JSONB | NULL | - | 詳細データ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
CREATE TABLE session_analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  indicator_type VARCHAR(30) NOT NULL
    CHECK (indicator_type IN (
      'talk_ratio',
      'question_analysis',
      'emotion_analysis',
      'concern_keywords',
      'proposal_timing',
      'proposal_quality',
      'conversion'
    )),
  value NUMERIC(10, 4) NOT NULL,
  score INTEGER NOT NULL CHECK (score >= 0 AND score <= 100),
  details JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (session_id, chunk_index, indicator_type)
);

-- インデックス
CREATE INDEX idx_session_analyses_session_id ON session_analyses(session_id);
CREATE INDEX idx_session_analyses_indicator ON session_analyses(indicator_type);
CREATE INDEX idx_session_analyses_session_chunk ON session_analyses(session_id, chunk_index);
```

**details JSONB構造例**:

```json
// talk_ratio
{
  "stylistSeconds": 1800,
  "customerSeconds": 2700,
  "totalSeconds": 4500,
  "ratio": 40.0
}

// question_analysis
{
  "totalQuestions": 12,
  "openQuestions": 8,
  "closedQuestions": 4,
  "openRatio": 66.67,
  "questionList": [
    {"text": "今日はどうされますか？", "type": "open", "time": 120.5}
  ]
}

// concern_keywords
{
  "detected": true,
  "keywords": ["乾燥", "広がり"],
  "detectedAt": [180.5, 245.2],
  "context": "髪が乾燥してパサパサなんです"
}
```

---

#### 6.2.7 session_reports（セッションレポート）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| session_id | UUID | NOT NULL | - | セッション（FK） |
| overall_score | INTEGER | NOT NULL | - | 総合スコア |
| good_points | TEXT[] | NOT NULL | - | 良かった点 |
| improvement_points | TEXT[] | NOT NULL | - | 改善ポイント |
| action_items | TEXT[] | NOT NULL | - | アクションアイテム |
| transcript_summary | TEXT | NULL | - | 会話要約 |
| ai_feedback | TEXT | NULL | - | AIフィードバック |
| indicator_scores | JSONB | NOT NULL | - | 指標別スコア |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
CREATE TABLE session_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  overall_score INTEGER NOT NULL CHECK (overall_score >= 0 AND overall_score <= 100),
  good_points TEXT[] NOT NULL DEFAULT '{}',
  improvement_points TEXT[] NOT NULL DEFAULT '{}',
  action_items TEXT[] NOT NULL DEFAULT '{}',
  transcript_summary TEXT,
  ai_feedback TEXT,
  indicator_scores JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (session_id)
);

-- インデックス
CREATE INDEX idx_session_reports_session_id ON session_reports(session_id);
CREATE INDEX idx_session_reports_score ON session_reports(overall_score DESC);
```

**indicator_scores JSONB構造**:

```json
{
  "talk_ratio": {"score": 85, "value": 42.5},
  "question_analysis": {"score": 80, "value": 10},
  "emotion_analysis": {"score": 90, "value": 75.0},
  "concern_keywords": {"score": 100, "value": 1},
  "proposal_timing": {"score": 85, "value": 3.5},
  "proposal_quality": {"score": 70, "value": 65.0},
  "conversion": {"score": 100, "value": 1}
}
```

---

#### 6.2.8 success_cases（成功事例）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| salon_id | UUID | NOT NULL | - | 店舗（FK） |
| session_id | UUID | NULL | - | 元セッション（FK） |
| stylist_id | UUID | NULL | - | スタイリスト（FK） |
| concern_keywords | TEXT[] | NOT NULL | - | 悩みキーワード |
| customer_profile | JSONB | NULL | - | お客様属性 |
| successful_talk | TEXT | NOT NULL | - | 成功トーク例 |
| key_tactics | TEXT[] | NOT NULL | - | キーポイント |
| sold_product | VARCHAR(100) | NULL | - | 成約商品 |
| conversion_rate | NUMERIC(5,4) | NULL | - | 成約率 |
| embedding | VECTOR(1536) | NULL | - | ベクトル埋め込み |
| is_public | BOOLEAN | NOT NULL | false | 公開フラグ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
-- pgvector拡張を有効化
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE success_cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
  stylist_id UUID REFERENCES staffs(id) ON DELETE SET NULL,
  concern_keywords TEXT[] NOT NULL DEFAULT '{}',
  customer_profile JSONB,
  successful_talk TEXT NOT NULL,
  key_tactics TEXT[] NOT NULL DEFAULT '{}',
  sold_product VARCHAR(100),
  conversion_rate NUMERIC(5, 4) CHECK (conversion_rate >= 0 AND conversion_rate <= 1),
  embedding VECTOR(1536),
  is_public BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_success_cases_salon_id ON success_cases(salon_id);
CREATE INDEX idx_success_cases_concern ON success_cases USING GIN(concern_keywords);
CREATE INDEX idx_success_cases_is_public ON success_cases(is_public);

-- HNSWベクトルインデックス（近似最近傍探索）
CREATE INDEX idx_success_cases_embedding ON success_cases 
  USING hnsw (embedding vector_cosine_ops)
  WITH (m = 16, ef_construction = 64);
```

### 6.3 データ量見積もり

#### 6.3.1 初期〜5年後のデータ量予測

| テーブル | 初期（5店舗） | 1年後（50店舗） | 3年後（200店舗） | 5年後（500店舗） |
|---------|-------------|---------------|-----------------|-----------------|
| salons | 5 | 50 | 200 | 500 |
| staffs | 50 | 500 | 2,000 | 5,000 |
| sessions | 250/月 | 3,000/月 | 12,000/月 | 30,000/月 |
| sessions累計 | 250 | 36,000 | 288,000 | 1,440,000 |
| transcripts | 7,500/月 | 90,000/月 | 360,000/月 | 900,000/月 |
| transcripts累計 | 7,500 | 1,080,000 | 8,640,000 | 43,200,000 |
| speaker_segments | 2,500/月 | 30,000/月 | 120,000/月 | 300,000/月 |
| session_analyses | 1,750/月 | 21,000/月 | 84,000/月 | 210,000/月 |
| session_reports | 250/月 | 3,000/月 | 12,000/月 | 30,000/月 |
| success_cases | 25/月 | 600/月 | 2,400/月 | 6,000/月 |

#### 6.3.2 ストレージ容量見積もり

| コンポーネント | 初期 | 1年後 | 3年後 | 5年後 |
|--------------|------|-------|-------|-------|
| PostgreSQL | 100MB | 5GB | 40GB | 200GB |
| pgvector | 10MB | 500MB | 4GB | 20GB |
| Storage（音声一時） | 1GB | 10GB | 50GB | 100GB |
| **合計** | **1.1GB** | **15.5GB** | **94GB** | **320GB** |

### 6.4 Row Level Security（RLS）ポリシー

```sql
-- RLSを有効化
ALTER TABLE salons ENABLE ROW LEVEL SECURITY;
ALTER TABLE staffs ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE transcripts ENABLE ROW LEVEL SECURITY;
ALTER TABLE speaker_segments ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE success_cases ENABLE ROW LEVEL SECURITY;

-- ユーティリティ関数: 現在ユーザーのsalon_idを取得
CREATE OR REPLACE FUNCTION get_current_user_salon_id()
RETURNS UUID AS $$
  SELECT salon_id FROM staffs WHERE auth_user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER;

-- ユーティリティ関数: 現在ユーザーのroleを取得
CREATE OR REPLACE FUNCTION get_current_user_role()
RETURNS VARCHAR AS $$
  SELECT role FROM staffs WHERE auth_user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER;

-- ユーティリティ関数: 現在ユーザーのstaff_idを取得
CREATE OR REPLACE FUNCTION get_current_user_staff_id()
RETURNS UUID AS $$
  SELECT id FROM staffs WHERE auth_user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER;

-- salons: 自店舗のみアクセス可能
CREATE POLICY "salon_access" ON salons
FOR ALL USING (id = get_current_user_salon_id());

-- staffs: 自店舗のスタッフのみアクセス可能
CREATE POLICY "staff_access" ON staffs
FOR SELECT USING (salon_id = get_current_user_salon_id());

-- staffs: manager/owner のみ作成・更新可能
CREATE POLICY "staff_manage" ON staffs
FOR INSERT WITH CHECK (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);

CREATE POLICY "staff_update" ON staffs
FOR UPDATE USING (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);

-- sessions: 自店舗のセッションのみアクセス可能
CREATE POLICY "session_salon_isolation" ON sessions
FOR ALL USING (salon_id = get_current_user_salon_id());

-- sessions: スタイリストは自分のセッションのみ
CREATE POLICY "session_own_only" ON sessions
FOR SELECT USING (
  stylist_id = get_current_user_staff_id()
  OR get_current_user_role() IN ('owner', 'manager')
);

-- transcripts: セッション経由でアクセス
CREATE POLICY "transcript_via_session" ON transcripts
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- speaker_segments: セッション経由でアクセス
CREATE POLICY "speaker_segment_via_session" ON speaker_segments
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- session_analyses: セッション経由でアクセス
CREATE POLICY "analysis_via_session" ON session_analyses
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- session_reports: セッション経由でアクセス
CREATE POLICY "report_via_session" ON session_reports
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- success_cases: 自店舗または公開されたもののみ
CREATE POLICY "success_case_access" ON success_cases
FOR SELECT USING (
  is_public = true
  OR salon_id = get_current_user_salon_id()
);

-- success_cases: 作成は自店舗のみ、manager/owner
CREATE POLICY "success_case_create" ON success_cases
FOR INSERT WITH CHECK (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);
```

---

## 7. 外部インターフェース設計

### 7.1 外部システム一覧

| システム名 | 連携方式 | 用途 | 認証方式 | SLA |
|-----------|---------|------|---------|-----|
| Anthropic Claude API | REST API | AI分析・レポート生成・ロールプレイ | API Key | 99.5% |
| OpenAI API | REST API | Embedding生成 | API Key | 99.9% |
| pyannote Server | REST API | 話者分離 | API Key (カスタム) | - |
| Apple Push Notification | APNs | プッシュ通知 | Certificate | 99.9% |
| Stripe API（将来） | REST API + Webhook | 決済処理 | API Key | 99.9% |

### 7.2 API連携仕様

#### 7.2.1 Anthropic Claude API

**基本情報**:

| 項目 | 値 |
|------|-----|
| ベースURL | https://api.anthropic.com |
| APIバージョン | 2023-06-01 |
| 使用モデル | claude-sonnet-4-5-20250929 |
| 認証方式 | x-api-key ヘッダー |
| タイムアウト | 60秒 |
| リトライ | 3回（指数バックオフ） |

**リクエスト形式**:

```typescript
// POST https://api.anthropic.com/v1/messages

interface ClaudeRequest {
  model: string;                    // "claude-sonnet-4-5-20250929"
  max_tokens: number;               // 最大4096
  messages: {
    role: 'user' | 'assistant';
    content: string;
  }[];
  system?: string;                  // システムプロンプト
  temperature?: number;             // 0-1（デフォルト: 1）
  top_p?: number;                   // 0-1
  stop_sequences?: string[];
}
```

**レスポンス形式**:

```typescript
interface ClaudeResponse {
  id: string;                       // "msg_01..."
  type: 'message';
  role: 'assistant';
  content: {
    type: 'text';
    text: string;
  }[];
  model: string;
  stop_reason: 'end_turn' | 'max_tokens' | 'stop_sequence';
  usage: {
    input_tokens: number;
    output_tokens: number;
  };
}
```

**エラーハンドリング**:

| HTTPステータス | エラー種別 | 対応 |
|--------------|-----------|------|
| 400 | bad_request | ログ記録、ユーザー通知 |
| 401 | authentication_error | アラート、API Key確認 |
| 403 | permission_error | アラート、権限確認 |
| 429 | rate_limit_error | 指数バックオフリトライ |
| 500 | api_error | リトライ（最大3回） |
| 503 | overloaded_error | リトライ（最大3回） |

**使用プロンプト例（7指標分析）**:

```typescript
const analysisPrompt = `
あなたは美容室の接客会話を分析するAIアシスタントです。
以下の会話を分析し、JSONフォーマットで結果を返してください。

## 会話データ
${JSON.stringify(transcriptWithSpeakers)}

## 分析項目
1. 感情分析（emotion_analysis）
   - ポジティブ/ネガティブの判定
   - 感情を示すキーワードの抽出
   
2. 悩みキーワード検出（concern_keywords）
   - 髪の悩みに関するキーワード（乾燥、広がり、パサつき、ダメージ、うねり、薄毛、白髪）
   - 検出されたタイミング
   
3. 提案品質（proposal_quality）
   - 商品提案があったか
   - ベネフィット（効果・メリット）を伝えているか
   - スペック（成分・機能）だけでないか
   
4. 成約判定（conversion）
   - 購入意思の表明があったか
   - 購入した商品名

## 出力形式
{
  "emotion_analysis": {
    "positive_ratio": number (0-100),
    "keywords": string[],
    "overall": "positive" | "neutral" | "negative"
  },
  "concern_keywords": {
    "detected": boolean,
    "keywords": string[],
    "detected_at": number[] // 秒
  },
  "proposal_quality": {
    "has_proposal": boolean,
    "benefit_ratio": number (0-100),
    "details": string[]
  },
  "conversion": {
    "converted": boolean,
    "product_name": string | null
  }
}
`;
```

---

#### 7.2.2 OpenAI Embedding API

**基本情報**:

| 項目 | 値 |
|------|-----|
| ベースURL | https://api.openai.com |
| エンドポイント | /v1/embeddings |
| 使用モデル | text-embedding-3-small |
| 次元数 | 1536 |
| 認証方式 | Bearer トークン |
| タイムアウト | 30秒 |

**リクエスト形式**:

```typescript
// POST https://api.openai.com/v1/embeddings

interface EmbeddingRequest {
  model: string;                    // "text-embedding-3-small"
  input: string | string[];         // テキストまたはテキスト配列
  encoding_format?: 'float' | 'base64';
}
```

**レスポンス形式**:

```typescript
interface EmbeddingResponse {
  object: 'list';
  data: {
    object: 'embedding';
    index: number;
    embedding: number[];           // 1536次元
  }[];
  model: string;
  usage: {
    prompt_tokens: number;
    total_tokens: number;
  };
}
```

**使用例**:

```typescript
async function createEmbedding(text: string): Promise<number[]> {
  const response = await fetch('https://api.openai.com/v1/embeddings', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${OPENAI_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'text-embedding-3-small',
      input: text,
    }),
  });
  
  const data: EmbeddingResponse = await response.json();
  return data.data[0].embedding;
}
```

---

#### 7.2.3 pyannote Server API

**基本情報**:

| 項目 | 値 |
|------|-----|
| ベースURL | http://{server}:{port} |
| 認証方式 | X-API-Key ヘッダー |
| タイムアウト | 300秒（5分） |
| 非同期処理 | Callback方式 |

**エンドポイント一覧**:

| メソッド | パス | 説明 |
|---------|------|------|
| POST | /diarize/{session_id} | 話者分離リクエスト |
| GET | /status/{session_id} | 処理状態確認 |
| GET | /health | ヘルスチェック |

**POST /diarize/{session_id}**:

リクエスト（multipart/form-data）:

| パラメータ | 型 | 必須 | 説明 |
|-----------|---|------|------|
| audio | File | ○ | WAVファイル |
| callback_url | string | ○ | コールバックURL |
| num_speakers | integer | × | 話者数（デフォルト: 2） |

レスポンス:

```typescript
interface DiarizeResponse {
  status: 'processing';
  session_id: string;
  estimated_time: number;  // 予想処理時間（秒）
}
```

**Callback形式**:

```typescript
// POST {callback_url}

interface DiarizationCallback {
  session_id: string;
  status: 'completed' | 'failed';
  segments?: {
    speaker: 'SPEAKER_00' | 'SPEAKER_01';
    start: number;        // 開始時間（秒）
    end: number;          // 終了時間（秒）
  }[];
  error?: string;
}
```

### 7.3 ファイルインターフェース

#### 7.3.1 音声ファイル形式

| 項目 | 仕様 |
|------|------|
| フォーマット | WAV (PCM) |
| サンプリングレート | 16000 Hz |
| ビット深度 | 16bit |
| チャンネル | モノラル |
| 最大ファイルサイズ | 10MB/チャンク |
| チャンク長 | 60秒 |

#### 7.3.2 エクスポートファイル形式

**PDF（レポート）**:

| 項目 | 仕様 |
|------|------|
| サイズ | A4 |
| 向き | 縦 |
| フォント | Noto Sans JP |
| 文字エンコーディング | UTF-8 |

**CSV（データエクスポート）**:

| 項目 | 仕様 |
|------|------|
| 文字エンコーディング | UTF-8 (BOM付き) |
| 区切り文字 | カンマ |
| 改行コード | CRLF |
| ヘッダー行 | あり |

---

## 8. セキュリティ設計

### 8.1 認証設計

#### 8.1.1 認証フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    認証フロー（JWT認証）                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────┐                   ┌────────────────┐                   │
│  │   Client   │                   │  Supabase Auth │                   │
│  │ (iPad/Web) │                   │                │                   │
│  └─────┬──────┘                   └───────┬────────┘                   │
│        │                                  │                            │
│        │ 1. Login Request                 │                            │
│        │    (email, password)             │                            │
│        │─────────────────────────────────▶│                            │
│        │                                  │                            │
│        │                                  │ 2. Verify Credentials      │
│        │                                  │────────────────────────────▶
│        │                                  │                            │
│        │                                  │ 3. User Data               │
│        │                                  │◀────────────────────────────
│        │                                  │                            │
│        │ 4. JWT Token                     │                            │
│        │    (access_token, refresh_token) │                            │
│        │◀─────────────────────────────────│                            │
│        │                                  │                            │
│  ┌─────┴──────┐                   ┌───────┴────────┐                   │
│  │   Store    │                   │                │                   │
│  │   Tokens   │                   │                │                   │
│  └─────┬──────┘                   └───────┬────────┘                   │
│        │                                  │                            │
│        │ 5. API Request                   │                            │
│        │    Authorization: Bearer {token} │                            │
│        │─────────────────────────────────▶│                            │
│        │                                  │                            │
│        │                                  │ 6. Verify JWT              │
│        │                                  │ 7. Get User & Roles        │
│        │                                  │────────────────────────────▶
│        │                                  │                            │
│        │                                  │ 8. RLS Check               │
│        │                                  │────────────────────────────▶
│        │                                  │                            │
│        │ 9. Response                      │                            │
│        │◀─────────────────────────────────│                            │
│        │                                  │                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 8.1.2 JWTトークン構成

```json
// Header
{
  "alg": "RS256",
  "typ": "JWT"
}

// Payload
{
  "sub": "user-uuid-here",
  "email": "stylist@salon.com",
  "role": "authenticated",
  "app_metadata": {
    "salon_id": "salon-uuid",
    "staff_role": "stylist"
  },
  "iat": 1701676800,
  "exp": 1701680400,  // 1時間
  "aud": "authenticated"
}
```

#### 8.1.3 トークンライフサイクル

| トークン種別 | 有効期限 | 保存場所 | 用途 |
|-------------|---------|---------|------|
| Access Token | 1時間 | メモリ（Zustand） | API認証 |
| Refresh Token | 7日 | Secure Storage | Access Token更新 |

### 8.2 認可設計

#### 8.2.1 ロール権限マトリクス

| 機能 | owner | manager | stylist | assistant |
|------|-------|---------|---------|-----------|
| セッション開始 | ○ | ○ | ○ | × |
| セッション閲覧（自分） | ○ | ○ | ○ | ○ |
| セッション閲覧（他人） | ○ | ○ | × | × |
| レポート閲覧（自分） | ○ | ○ | ○ | ○ |
| レポート閲覧（他人） | ○ | ○ | × | × |
| スタッフ管理 | ○ | ○ | × | × |
| 店舗設定 | ○ | × | × | × |
| 成功事例登録 | ○ | ○ | × | × |
| 成功事例閲覧 | ○ | ○ | ○ | ○ |
| トレーニング | ○ | ○ | ○ | ○ |
| ダッシュボード | ○ | ○ | × | × |
| 分析エクスポート | ○ | ○ | × | × |

### 8.3 データ保護設計

#### 8.3.1 暗号化設計

| 対象 | 暗号化方式 | 鍵管理 |
|------|-----------|--------|
| 通信 | TLS 1.3 | Let's Encrypt（自動更新） |
| データベース | AES-256（保存時） | Supabase管理 |
| バックアップ | AES-256 | Supabase管理 |
| API Key | 環境変数 | Supabase Secrets |
| 音声ファイル | AES-256（Storage） | Supabase管理 |

#### 8.3.2 個人情報マスキング

```sql
-- 個人情報マスキング関数
CREATE OR REPLACE FUNCTION anonymize_text(input_text TEXT)
RETURNS TEXT AS $$
BEGIN
  -- 氏名パターン（○○さん、○○様）
  input_text := regexp_replace(
    input_text, 
    '([一-龯ぁ-んァ-ヶ]{2,4})(さん|様)', 
    '○○様', 
    'g'
  );
  
  -- 電話番号
  input_text := regexp_replace(
    input_text, 
    '\d{2,4}-\d{2,4}-\d{4}', 
    '***-****-****', 
    'g'
  );
  
  -- メールアドレス
  input_text := regexp_replace(
    input_text, 
    '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}', 
    '****@****.***', 
    'g'
  );
  
  RETURN input_text;
END;
$$ LANGUAGE plpgsql;
```

### 8.4 監査ログ設計

#### 8.4.1 監査対象イベント

| イベント種別 | 記録項目 | 保持期間 |
|-------------|---------|---------|
| ログイン | ユーザーID、日時、IPアドレス、成否、User-Agent | 1年 |
| ログアウト | ユーザーID、日時 | 1年 |
| データ作成 | ユーザーID、テーブル、レコードID、日時 | 1年 |
| データ更新 | ユーザーID、テーブル、レコードID、変更前後、日時 | 1年 |
| データ削除 | ユーザーID、テーブル、レコードID、日時 | 1年 |
| 設定変更 | ユーザーID、変更項目、変更前後、日時 | 1年 |
| エラー | エラー詳細、スタックトレース、日時 | 90日 |
| API呼び出し | エンドポイント、レスポンスタイム、ステータス | 30日 |

#### 8.4.2 監査ログスキーマ

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_type VARCHAR(50) NOT NULL,
  user_id UUID REFERENCES staffs(id),
  salon_id UUID REFERENCES salons(id),
  resource_type VARCHAR(50),
  resource_id UUID,
  action VARCHAR(20),
  old_value JSONB,
  new_value JSONB,
  ip_address INET,
  user_agent TEXT,
  request_id UUID,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id, created_at DESC);
CREATE INDEX idx_audit_logs_salon ON audit_logs(salon_id, created_at DESC);
CREATE INDEX idx_audit_logs_event ON audit_logs(event_type, created_at DESC);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);

-- パーティション（月次）
-- 本番環境では月次パーティションを検討
```

### 8.5 セキュリティ対策

#### 8.5.1 OWASP Top 10対策

| リスク | 対策 |
|--------|------|
| A01: アクセス制御の不備 | RLSによる行レベルセキュリティ、ロールベースアクセス制御 |
| A02: 暗号化の失敗 | TLS 1.3、AES-256、適切な鍵管理 |
| A03: インジェクション | パラメータ化クエリ、入力バリデーション |
| A04: 安全でない設計 | 脅威モデリング、セキュアコーディングレビュー |
| A05: セキュリティ設定ミス | Supabaseセキュリティベストプラクティス適用 |
| A06: 脆弱なコンポーネント | 依存関係の定期更新、npm audit |
| A07: 認証の失敗 | Supabase Auth、JWT、レート制限 |
| A08: ソフトウェアとデータの整合性 | CI/CDパイプライン検証、署名付きビルド |
| A09: ログとモニタリングの不足 | 監査ログ、アラート設定、ダッシュボード |
| A10: SSRF | 内部ネットワークアクセス制限、URL検証 |

#### 8.5.2 入力バリデーション

```typescript
// バリデーションスキーマ（Zod）
import { z } from 'zod';

// セッション作成リクエスト
export const CreateSessionSchema = z.object({
  stylistId: z.string().uuid(),
  customerInfo: z.object({
    ageGroup: z.enum(['10s', '20s', '30s', '40s', '50s', '60s+']).optional(),
    gender: z.enum(['male', 'female', 'other']).optional(),
    visitFrequency: z.enum(['first', 'monthly', 'bimonthly', 'quarterly', 'irregular']).optional(),
    notes: z.string().max(500).optional(),
  }).optional(),
});

// スタッフ作成リクエスト
export const CreateStaffSchema = z.object({
  name: z.string().min(1).max(50),
  email: z.string().email().max(255),
  role: z.enum(['owner', 'manager', 'stylist', 'assistant']),
  position: z.string().max(50).optional(),
  joinDate: z.string().date().optional(),
});

// XSS対策: HTMLエスケープ
export function escapeHtml(text: string): string {
  const map: Record<string, string> = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;',
  };
  return text.replace(/[&<>"']/g, (m) => map[m]);
}
```

#### 8.5.3 レート制限

| エンドポイント | 制限 | ウィンドウ |
|--------------|------|-----------|
| /auth/login | 5回 | 15分 |
| /functions/* | 100回 | 1分 |
| /functions/create-session | 10回 | 1分 |
| /functions/process-audio | 60回 | 1分 |
| /functions/roleplay-chat | 30回 | 1分 |

---

（続きは Part4 に記載）
# 基本設計書 Part 4: 性能設計・運用設計・移行設計・テスト設計・付録

---

## 9. 性能設計

### 9.1 性能目標

#### 9.1.1 レスポンスタイム目標

| 処理種別 | 目標値（P95） | 最大許容値（P99） | 測定方法 |
|---------|-------------|-----------------|---------|
| 画面表示（初回） | 3秒以内 | 5秒以内 | First Contentful Paint |
| 画面表示（遷移） | 1秒以内 | 2秒以内 | Time to Interactive |
| API応答（一般） | 500ms以内 | 1秒以内 | サーバーレスポンスタイム |
| API応答（検索） | 1秒以内 | 2秒以内 | クエリ実行時間 |
| リアルタイム更新 | 1秒以内 | 2秒以内 | WebSocket遅延 |
| 文字起こし処理 | 10秒以内/1分音声 | 15秒以内 | クライアント計測 |
| 話者分離処理 | 5分以内/1時間音声 | 10分以内 | サーバーログ |
| AI分析処理 | 30秒以内/チャンク | 60秒以内 | Edge Function計測 |
| レポート生成 | 60秒以内 | 120秒以内 | Edge Function計測 |
| ベクトル検索 | 200ms以内 | 500ms以内 | pgvectorクエリ時間 |

#### 9.1.2 スループット目標

| 指標 | 初期目標 | スケール後目標 |
|------|---------|--------------|
| 同時セッション数 | 50 | 500 |
| 同時WebSocket接続 | 100 | 1,000 |
| API呼び出し | 100 req/min | 1,000 req/min |
| 話者分離処理キュー | 10タスク/min | 100タスク/min |
| AI分析処理 | 50チャンク/min | 500チャンク/min |

#### 9.1.3 リソース使用率目標

| リソース | 通常時 | ピーク時 | アラート閾値 |
|---------|-------|---------|------------|
| CPU使用率 | 40%以下 | 70%以下 | 80% |
| メモリ使用率 | 60%以下 | 80%以下 | 85% |
| DB接続数 | 50%以下 | 80%以下 | 90% |
| ストレージ使用率 | 60%以下 | 80%以下 | 85% |
| GPU使用率（pyannote） | 50%以下 | 90%以下 | 95% |

### 9.2 キャッシュ設計

#### 9.2.1 キャッシュ戦略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           キャッシュ階層設計                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Level 1: ブラウザ/アプリキャッシュ               │   │
│  │                                                                     │   │
│  │   ● 静的アセット: Service Worker (1年)                               │   │
│  │   ● API応答: SWR/TanStack Query (5分)                               │   │
│  │   ● ユーザー状態: Zustand (セッション中)                              │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Level 2: CDN/Edgeキャッシュ                     │   │
│  │                                                                     │   │
│  │   ● 静的ファイル: Vercel Edge (1年、immutable)                       │   │
│  │   ● ISR: Next.js Incremental Static Regeneration (必要に応じて)      │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Level 3: アプリケーションキャッシュ              │   │
│  │                                                                     │   │
│  │   ● セッションデータ: メモリ (アクティブセッション中)                  │   │
│  │   ● 分析結果: PostgreSQL (永続)                                      │   │
│  │   ● 成功事例: メモリ (30分TTL)                                       │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Level 4: データベースキャッシュ                  │   │
│  │                                                                     │   │
│  │   ● クエリキャッシュ: PostgreSQL (自動)                               │   │
│  │   ● コネクションプール: PgBouncer                                     │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 9.2.2 キャッシュ設定詳細

| データ種別 | キャッシュ場所 | TTL | 無効化契機 | サイズ上限 |
|-----------|--------------|-----|-----------|-----------|
| 静的アセット（JS/CSS） | Vercel Edge | 1年 | デプロイ時（hash変更） | - |
| 静的アセット（画像） | Vercel Edge | 1年 | 明示的更新時 | - |
| APIレスポンス（一覧） | SWR | 5分 | mutate呼び出し | 100件 |
| APIレスポンス（詳細） | SWR | 10分 | mutate呼び出し | - |
| ユーザー情報 | Zustand | セッション中 | ログアウト時 | - |
| セッション状態 | Zustand | セッション中 | セッション終了時 | - |
| 分析結果 | PostgreSQL | 永続 | - | - |
| 成功事例 | メモリ + SWR | 30分 | 登録・更新時 | 1000件 |

#### 9.2.3 SWR設定

```typescript
// lib/swr-config.ts

import { SWRConfiguration } from 'swr';

// グローバルSWR設定
export const swrConfig: SWRConfiguration = {
  revalidateOnFocus: false,        // フォーカス時の再検証無効
  revalidateOnReconnect: true,     // 再接続時は再検証
  refreshInterval: 0,               // 自動更新なし（リアルタイムはWebSocket）
  dedupingInterval: 5000,          // 5秒間の重複リクエスト防止
  errorRetryCount: 3,              // エラー時3回リトライ
  errorRetryInterval: 5000,        // 5秒間隔
  shouldRetryOnError: true,
};

// セッション一覧用設定
export const sessionListConfig: SWRConfiguration = {
  ...swrConfig,
  refreshInterval: 60000,          // 1分ごとに更新
  revalidateOnFocus: true,         // フォーカス時も更新
};

// リアルタイムデータ用設定（WebSocket併用）
export const realtimeConfig: SWRConfiguration = {
  ...swrConfig,
  revalidateOnFocus: true,
  refreshInterval: 0,              // WebSocketで更新
};

// 成功事例検索用設定
export const successCaseConfig: SWRConfiguration = {
  ...swrConfig,
  dedupingInterval: 30000,         // 30秒間の重複防止
  revalidateOnFocus: false,
};
```

### 9.3 スケーリング設計

#### 9.3.1 スケーリング戦略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           スケーリング戦略                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  コンポーネント         │ 方式        │ トリガー           │ 最大スケール   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  Next.js (Vercel)      │ 自動水平    │ リクエスト数       │ 無制限        │
│  Edge Functions        │ 自動水平    │ 同時実行数         │ 無制限        │
│  PostgreSQL            │ 垂直        │ 接続数/CPU         │ 64GB RAM     │
│  pyannote Server       │ 手動水平    │ キュー長           │ 10インスタンス │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    自動スケーリング（Vercel/Supabase）                 │ │
│  │                                                                       │ │
│  │     リクエスト増加                                                     │ │
│  │          │                                                            │ │
│  │          ▼                                                            │ │
│  │   ┌────────────┐    ┌────────────┐    ┌────────────┐                 │ │
│  │   │ Instance 1 │    │ Instance 2 │    │ Instance N │                 │ │
│  │   │            │    │            │ ...│            │                 │ │
│  │   │  Edge Fn   │    │  Edge Fn   │    │  Edge Fn   │                 │ │
│  │   └────────────┘    └────────────┘    └────────────┘                 │ │
│  │          │                │                │                          │ │
│  │          └────────────────┼────────────────┘                          │ │
│  │                           │                                           │ │
│  │                           ▼                                           │ │
│  │                  ┌─────────────────┐                                  │ │
│  │                  │  Connection Pool │                                  │ │
│  │                  │   (PgBouncer)   │                                  │ │
│  │                  └────────┬────────┘                                  │ │
│  │                           │                                           │ │
│  │                           ▼                                           │ │
│  │                  ┌─────────────────┐                                  │ │
│  │                  │   PostgreSQL    │                                  │ │
│  │                  │   (単一ノード)   │                                  │ │
│  │                  └─────────────────┘                                  │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    手動スケーリング（pyannote Server）                 │ │
│  │                                                                       │ │
│  │   ┌───────────────────────────────────────────────────────────────┐  │ │
│  │   │                    Load Balancer (nginx)                      │  │ │
│  │   └─────────────────────────────┬─────────────────────────────────┘  │ │
│  │                                 │                                    │ │
│  │              ┌──────────────────┼──────────────────┐                │ │
│  │              │                  │                  │                │ │
│  │              ▼                  ▼                  ▼                │ │
│  │        ┌──────────┐       ┌──────────┐       ┌──────────┐          │ │
│  │        │  GPU #1  │       │  GPU #2  │       │  GPU #N  │          │ │
│  │        │ pyannote │       │ pyannote │  ...  │ pyannote │          │ │
│  │        │RTX 4060  │       │RTX 4060  │       │RTX 4060  │          │ │
│  │        └──────────┘       └──────────┘       └──────────┘          │ │
│  │                                                                    │ │
│  │   スケールアウト条件:                                                │ │
│  │   - キュー待機タスク > 10                                           │ │
│  │   - 平均処理時間 > 目標の150%                                       │ │
│  │   - GPU使用率 > 90%（継続30分以上）                                 │ │
│  │                                                                    │ │
│  │   スケールイン条件:                                                  │ │
│  │   - キュー待機タスク = 0（継続1時間以上）                            │ │
│  │   - GPU使用率 < 30%（継続1時間以上）                                │ │
│  │                                                                    │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 9.3.2 データベーススケーリング

| フェーズ | 店舗数 | Supabaseプラン | スペック | 月額コスト |
|---------|-------|---------------|---------|-----------|
| 初期 | 5 | Pro | 8GB RAM, 50 connections | $25 |
| 成長期 | 50 | Pro (Add-on) | 16GB RAM, 100 connections | $50 |
| 拡大期 | 200 | Team | 32GB RAM, 200 connections | $599 |
| 成熟期 | 500 | Enterprise | 64GB RAM, 500 connections | Custom |

### 9.4 負荷分散設計

#### 9.4.1 負荷分散構成

| レイヤー | 負荷分散方式 | 実装 | ヘルスチェック |
|---------|------------|------|--------------|
| CDN | Vercel Edge Network | 自動（Anycast） | 自動 |
| API | Supabase | 自動 | 自動 |
| DB | PgBouncer | コネクションプール | 自動 |
| pyannote | nginx | ラウンドロビン | /health (10秒間隔) |

#### 9.4.2 pyannote負荷分散設定

```nginx
# nginx.conf

upstream pyannote_servers {
    least_conn;  # 最小接続数方式
    
    server pyannote-1:8000 weight=1;
    server pyannote-2:8000 weight=1;
    server pyannote-3:8000 weight=1 backup;  # バックアップ
}

server {
    listen 80;
    
    location / {
        proxy_pass http://pyannote_servers;
        proxy_connect_timeout 10s;
        proxy_read_timeout 300s;  # 話者分離は時間がかかる
        proxy_send_timeout 60s;
        
        # ヘルスチェック
        health_check interval=10s fails=3 passes=2;
    }
    
    location /health {
        proxy_pass http://pyannote_servers;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }
}
```

### 9.5 パフォーマンス最適化

#### 9.5.1 データベース最適化

```sql
-- クエリ最適化: 頻出クエリのインデックス

-- セッション一覧取得（スタイリスト別、日付降順）
CREATE INDEX idx_sessions_stylist_date 
ON sessions(stylist_id, started_at DESC) 
WHERE status = 'completed';

-- 分析結果取得（セッション別、チャンク順）
CREATE INDEX idx_analyses_session_chunk 
ON session_analyses(session_id, chunk_index, indicator_type);

-- 成功事例検索（悩みキーワード）
CREATE INDEX idx_success_cases_keywords 
ON success_cases USING GIN(concern_keywords);

-- パーティション（将来的な大規模データ対応）
-- sessions テーブルを月次パーティション化
-- CREATE TABLE sessions (
--   ...
-- ) PARTITION BY RANGE (started_at);

-- 統計情報の自動更新
ALTER TABLE sessions SET (autovacuum_analyze_threshold = 50);
ALTER TABLE session_analyses SET (autovacuum_analyze_threshold = 100);
```

#### 9.5.2 API最適化

```typescript
// Edge Function最適化例

// 並列処理による高速化
async function analyzeChunk(sessionId: string, chunkIndex: number) {
  const transcript = await getTranscript(sessionId, chunkIndex);
  const speakers = await getSpeakers(sessionId, chunkIndex);
  
  // 7指標を並列で分析
  const [
    talkRatio,
    questionAnalysis,
    emotionAnalysis,
    concernKeywords,
    proposalTiming,
    proposalQuality,
    conversion,
  ] = await Promise.all([
    analyzeTalkRatio(speakers),           // ローカル処理
    analyzeQuestions(transcript),          // ローカル処理
    analyzeEmotion(transcript),            // Claude API
    detectConcerns(transcript),            // ローカル + Claude
    analyzeProposalTiming(transcript),     // ローカル処理
    analyzeProposalQuality(transcript),    // Claude API
    detectConversion(transcript),          // Claude API
  ]);
  
  return calculateOverallScore({
    talkRatio,
    questionAnalysis,
    emotionAnalysis,
    concernKeywords,
    proposalTiming,
    proposalQuality,
    conversion,
  });
}

// バッチ処理による効率化
async function batchCreateEmbeddings(texts: string[]) {
  // 最大20件ずつバッチ処理
  const batchSize = 20;
  const results: number[][] = [];
  
  for (let i = 0; i < texts.length; i += batchSize) {
    const batch = texts.slice(i, i + batchSize);
    const response = await openai.embeddings.create({
      model: 'text-embedding-3-small',
      input: batch,
    });
    results.push(...response.data.map(d => d.embedding));
  }
  
  return results;
}
```

#### 9.5.3 フロントエンド最適化

```typescript
// React Native 最適化

// 1. メモ化によるレンダリング最適化
const ConversationLog = React.memo(({ messages }: Props) => {
  return (
    <FlatList
      data={messages}
      renderItem={renderMessage}
      keyExtractor={item => item.id}
      initialNumToRender={10}
      maxToRenderPerBatch={5}
      windowSize={5}
      removeClippedSubviews={true}
    />
  );
});

// 2. 遅延ロードによる初期表示高速化
const ReportDetail = React.lazy(() => import('./ReportDetail'));

// 3. 画像最適化
import { Image } from 'expo-image';

const OptimizedImage = ({ uri }: { uri: string }) => (
  <Image
    source={{ uri }}
    contentFit="cover"
    transition={200}
    cachePolicy="memory-disk"
  />
);
```

---

## 10. 運用設計

### 10.1 監視設計

#### 10.1.1 監視項目一覧

| カテゴリ | 監視項目 | 閾値（警告） | 閾値（異常） | 通知先 |
|---------|---------|------------|------------|--------|
| **可用性** | サービス稼働状態 | - | Down | Slack + Email + 電話 |
| | APIエンドポイント応答 | 3秒以上 | 10秒以上/無応答 | Slack |
| | WebSocket接続数 | 80%上限 | 95%上限 | Slack |
| **性能** | APIレスポンスタイム（P95） | 1秒以上 | 3秒以上 | Slack |
| | エラー率 | 1%以上 | 5%以上 | Slack + Email |
| | 話者分離キュー長 | 10以上 | 50以上 | Slack |
| | AI API応答時間 | 30秒以上 | 60秒以上 | Slack |
| **リソース** | DB接続数 | 80%以上 | 95%以上 | Slack |
| | DBストレージ使用率 | 80%以上 | 90%以上 | Slack + Email |
| | pyannote GPU使用率 | 90%以上 | 98%以上 | Slack |
| | pyannote メモリ使用率 | 85%以上 | 95%以上 | Slack |
| **ビジネス** | セッション異常終了率 | 3%以上/日 | 10%以上/日 | Slack |
| | レポート生成失敗率 | 1%以上 | 5%以上 | Slack |
| | AI分析エラー率 | 1%以上 | 5%以上 | Slack |

#### 10.1.2 監視ダッシュボード

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           運用監視ダッシュボード                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        サービスステータス                              │ │
│  │                                                                       │ │
│  │   🟢 iPad App     🟢 Web Dashboard    🟢 API Gateway                 │ │
│  │   🟢 PostgreSQL   🟢 Realtime         🟢 Storage                     │ │
│  │   🟢 pyannote #1  🟢 pyannote #2      🟡 pyannote #3 (高負荷)        │ │
│  │   🟢 Claude API   🟢 OpenAI API                                      │ │
│  │                                                                       │ │
│  │   最終更新: 2025-12-04 14:32:15 JST                                  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐ │
│  │   APIレスポンスタイム (P95)   │  │          エラー率                   │ │
│  │                             │  │                                     │ │
│  │   300ms │         ╭──╮     │  │   0.5% │                            │ │
│  │         │        ╱  ╲    │  │        │         ╭─╮                  │ │
│  │   200ms │       ╱    ╲   │  │   0.3% │        ╱   ╲                 │ │
│  │         │   ───╱      ╲──│  │        │   ────╱     ╲────            │ │
│  │   100ms │  ╱              │  │   0.1% │  ╱                           │ │
│  │         │ ╱               │  │        │ ╱                            │ │
│  │      0  │╱                │  │      0 │╱                             │ │
│  │         └──────────────── │  │        └──────────────────────        │ │
│  │          00:00      12:00 │  │         00:00      12:00              │ │
│  │                             │  │                                     │ │
│  │   現在: 245ms ✓            │  │   現在: 0.12% ✓                      │ │
│  └─────────────────────────────┘  └─────────────────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐ │
│  │   同時セッション数           │  │      pyannote 処理キュー            │ │
│  │                             │  │                                     │ │
│  │   現在: 45 / 100            │  │   待機中: 3 タスク                  │ │
│  │                             │  │   処理中: 2 タスク                  │ │
│  │   ████████████░░░░░░░░░    │  │                                     │ │
│  │            45%              │  │   平均処理時間: 2.5分               │ │
│  │                             │  │   GPU使用率: 65% / 72% / 89%       │ │
│  │   ピーク(今日): 78 (14:00)  │  │                                     │ │
│  └─────────────────────────────┘  └─────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        最近のアラート                                  │ │
│  │                                                                       │ │
│  │   🟡 14:25 pyannote #3 GPU使用率 92% - 高負荷状態                     │ │
│  │   🟢 14:10 pyannote #2 復旧完了                                       │ │
│  │   🔴 14:05 pyannote #2 ヘルスチェック失敗 (自動再起動)                │ │
│  │   🟢 13:00 定期メンテナンス完了                                       │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 10.1.3 アラート設定

```yaml
# alerting-rules.yaml

groups:
  - name: availability
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "サービス停止: {{ $labels.service }}"
          
      - alert: HighErrorRate
        expr: error_rate > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "エラー率上昇: {{ $value | humanizePercentage }}"

  - name: performance
    rules:
      - alert: SlowAPIResponse
        expr: api_response_time_p95 > 3000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API応答遅延: P95 {{ $value }}ms"
          
      - alert: PyannoteQueueBacklog
        expr: pyannote_queue_length > 50
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "話者分離キュー滞留: {{ $value }}タスク"

  - name: resources
    rules:
      - alert: DatabaseConnectionHigh
        expr: db_connections_used / db_connections_max > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "DB接続枯渇: {{ $value | humanizePercentage }}"
          
      - alert: GPUMemoryHigh
        expr: gpu_memory_used / gpu_memory_total > 0.95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "GPU メモリ不足: {{ $value | humanizePercentage }}"
```

### 10.2 バックアップ・リカバリ設計

#### 10.2.1 バックアップ方針

| 対象 | 方式 | 頻度 | 保持期間 | 保管場所 | RPO | RTO |
|------|------|------|---------|---------|-----|-----|
| PostgreSQL（データ） | Supabase自動 | 日次 | 7日 | Supabase | 24時間 | 1時間 |
| PostgreSQL（データ） | pg_dump | 週次 | 30日 | S3 | 7日 | 4時間 |
| PostgreSQL（WAL） | Supabase PITR | 継続的 | 7日 | Supabase | 数分 | 1時間 |
| Supabase Storage | 自動レプリケーション | リアルタイム | - | Supabase | 0 | 即時 |
| 設定ファイル | Git | 随時 | 無期限 | GitHub | 0 | 即時 |
| 環境変数 | Supabase Secrets | 変更時 | - | Supabase | 0 | 即時 |

#### 10.2.2 リカバリ手順

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           障害対応フローチャート                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐                                                            │
│  │ 障害検知     │                                                            │
│  │ (自動/手動) │                                                            │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 初動対応 (5分以内)                                                │   │
│  │    □ 障害の種類・影響範囲を特定                                      │   │
│  │    □ Slackで関係者に第一報                                          │   │
│  │    □ 重大度判定（Critical/Major/Minor）                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2. 重大度判定                                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│    ┌────┼────┬────────────┐                                                │
│    │    │    │            │                                                │
│    ▼    ▼    ▼            ▼                                                │
│  ┌────┐┌────┐┌────┐    ┌────────────────────────────────────────────────┐│
│  │Crit││Maj ││Min │    │ Critical: 全サービス停止、データ損失リスク     ││
│  └──┬─┘└──┬─┘└──┬─┘    │ Major: 主要機能停止、一部ユーザー影響         ││
│     │     │     │      │ Minor: 軽微な機能障害、回避策あり              ││
│     │     │     │      └────────────────────────────────────────────────┘│
│     │     │     │                                                         │
│     ▼     ▼     ▼                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3. 復旧作業                                                          │   │
│  │                                                                     │   │
│  │    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │   │
│  │    │ DB障害      │    │ App障害     │    │ 外部API障害  │           │   │
│  │    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘           │   │
│  │           │                  │                  │                   │   │
│  │           ▼                  ▼                  ▼                   │   │
│  │    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │   │
│  │    │ Supabase    │    │ Vercel      │    │ フォール    │           │   │
│  │    │ PITR復元    │    │ 再デプロイ   │    │ バック実行  │           │   │
│  │    │             │    │             │    │             │           │   │
│  │    │ または      │    │ または      │    │ Claude →   │           │   │
│  │    │ pg_restore  │    │ ロールバック │    │ ルールベース│           │   │
│  │    └─────────────┘    └─────────────┘    └─────────────┘           │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4. 動作確認                                                          │   │
│  │    □ 基本機能テスト（ログイン、セッション開始、分析）                 │   │
│  │    □ データ整合性確認                                                │   │
│  │    □ パフォーマンス確認                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 5. 復旧完了報告                                                      │   │
│  │    □ Slackで復旧完了を報告                                          │   │
│  │    □ 障害報告書を作成（24時間以内）                                  │   │
│  │    □ 再発防止策を検討・実施                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.3 デプロイメント設計

#### 10.3.1 CI/CDパイプライン

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CI/CD パイプライン                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         GitHub Repository                            │  │
│  │                                                                      │  │
│  │   main ─────────────────────────────────────────────────▶ Production │  │
│  │     │                                                                │  │
│  │     │ PR                                                             │  │
│  │     │                                                                │  │
│  │   develop ──────────────────────────────────────────────▶ Staging    │  │
│  │     │                                                                │  │
│  │     │ PR                                                             │  │
│  │     │                                                                │  │
│  │   feature/* ────────────────────────────────────────────▶ Preview    │  │
│  │                                                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         GitHub Actions                               │  │
│  │                                                                      │  │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │  │
│  │   │  Lint    │─▶│  Test    │─▶│  Build   │─▶│ Security │           │  │
│  │   │          │  │          │  │          │  │  Scan    │           │  │
│  │   │ ESLint   │  │ Jest     │  │ Next.js  │  │ npm audit│           │  │
│  │   │ Prettier │  │ 単体/結合 │  │ Expo     │  │ Snyk     │           │  │
│  │   └──────────┘  └──────────┘  └──────────┘  └────┬─────┘           │  │
│  │                                                   │                  │  │
│  └───────────────────────────────────────────────────┼──────────────────┘  │
│                                                      │                      │
│                         ┌────────────────────────────┘                      │
│                         │                                                   │
│                         ▼                                                   │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         Vercel Deployment                            │  │
│  │                                                                      │  │
│  │   ┌────────────────────────────────────────────────────────────────┐│  │
│  │   │  Preview Deployment (feature/*)                                ││  │
│  │   │  https://salontalk-ai-{branch}-{hash}.vercel.app              ││  │
│  │   └────────────────────────────────────────────────────────────────┘│  │
│  │                              │                                       │  │
│  │                              │ PR Merge to develop                   │  │
│  │                              ▼                                       │  │
│  │   ┌────────────────────────────────────────────────────────────────┐│  │
│  │   │  Staging Deployment (develop)                                  ││  │
│  │   │  https://staging.salontalk.app                                 ││  │
│  │   │  ● E2Eテスト実行                                               ││  │
│  │   │  ● QA検証                                                      ││  │
│  │   └────────────────────────────────────────────────────────────────┘│  │
│  │                              │                                       │  │
│  │                              │ PR Merge to main (承認後)             │  │
│  │                              ▼                                       │  │
│  │   ┌────────────────────────────────────────────────────────────────┐│  │
│  │   │  Production Deployment (main)                                  ││  │
│  │   │  https://salontalk.app                                         ││  │
│  │   │  ● Blue-Green デプロイ                                         ││  │
│  │   │  ● 自動ロールバック（エラー率 > 5%）                           ││  │
│  │   └────────────────────────────────────────────────────────────────┘│  │
│  │                                                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                       Supabase Deployment                            │  │
│  │                                                                      │  │
│  │   ┌──────────────┐              ┌──────────────┐                    │  │
│  │   │   Staging    │   検証後      │  Production  │                    │  │
│  │   │              │─────────────▶│              │                    │  │
│  │   │ supabase/    │  手動昇格     │              │                    │  │
│  │   │ staging      │              │              │                    │  │
│  │   └──────────────┘              └──────────────┘                    │  │
│  │                                                                      │  │
│  │   マイグレーション: supabase db push                                 │  │
│  │   Edge Functions: supabase functions deploy                         │  │
│  │                                                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 10.3.2 デプロイチェックリスト

| # | カテゴリ | 確認項目 | 確認方法 | 必須 |
|---|---------|---------|---------|------|
| 1 | コード品質 | ESLint警告なし | CI結果 | ○ |
| 2 | コード品質 | TypeScript型エラーなし | CI結果 | ○ |
| 3 | テスト | 単体テスト全パス | CI結果 | ○ |
| 4 | テスト | 結合テスト全パス | CI結果 | ○ |
| 5 | テスト | E2Eテスト全パス（Staging） | 手動確認 | ○ |
| 6 | セキュリティ | npm audit問題なし | CI結果 | ○ |
| 7 | セキュリティ | 機密情報がコードに含まれていない | レビュー | ○ |
| 8 | DB | マイグレーション適用済み | Supabase確認 | ○ |
| 9 | 環境変数 | 本番環境変数設定済み | Vercel/Supabase確認 | ○ |
| 10 | ドキュメント | 変更内容がドキュメント化されている | PR確認 | △ |
| 11 | ロールバック | ロールバック手順確認済み | チェック | ○ |
| 12 | 通知 | 関係者にデプロイ予定を通知 | Slack | ○ |

#### 10.3.3 ロールバック手順

```bash
# Vercel ロールバック
# 1. 前回の成功デプロイを確認
vercel ls --prod

# 2. 特定のデプロイにロールバック
vercel rollback [deployment-url]

# Supabase ロールバック
# 1. マイグレーション履歴確認
supabase migration list

# 2. 特定のマイグレーションまでロールバック
supabase db reset --version [version]

# Edge Functions ロールバック
# 1. 前回のデプロイをGitから取得
git checkout HEAD~1 -- supabase/functions/

# 2. 再デプロイ
supabase functions deploy
```

### 10.4 運用体制

#### 10.4.1 運用体制図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              運用体制                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        1次対応（24時間）                               │ │
│  │                                                                       │ │
│  │   ┌─────────────────┐    ┌─────────────────┐                         │ │
│  │   │  自動監視        │    │  オンコール担当  │                         │ │
│  │   │                 │    │  (ローテーション) │                         │ │
│  │   │ ● Supabase監視  │    │                 │                         │ │
│  │   │ ● Vercel監視    │    │ ● アラート対応   │                         │ │
│  │   │ ● カスタム監視   │    │ ● 初期判断      │                         │ │
│  │   │                 │    │ ● エスカレーション│                         │ │
│  │   └─────────────────┘    └─────────────────┘                         │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    │ エスカレーション                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        2次対応（営業時間）                              │ │
│  │                                                                       │ │
│  │   ┌─────────────────┐    ┌─────────────────┐                         │ │
│  │   │  開発チーム      │    │  インフラ担当    │                         │ │
│  │   │                 │    │                 │                         │ │
│  │   │ ● バグ修正      │    │ ● サーバー対応  │                         │ │
│  │   │ ● 機能改修      │    │ ● DB対応       │                         │ │
│  │   │ ● パフォーマンス │    │ ● ネットワーク  │                         │ │
│  │   │   改善          │    │                 │                         │ │
│  │   └─────────────────┘    └─────────────────┘                         │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    │ 重大障害                               │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        3次対応（重大障害）                              │ │
│  │                                                                       │ │
│  │   ┌─────────────────┐    ┌─────────────────┐                         │ │
│  │   │  技術責任者      │    │  外部ベンダー    │                         │ │
│  │   │                 │    │                 │                         │ │
│  │   │ ● 最終判断      │    │ ● Supabaseサポート│                        │ │
│  │   │ ● 経営報告      │    │ ● Vercelサポート │                         │ │
│  │   │ ● 対外対応      │    │ ● Anthropicサポート│                        │ │
│  │   └─────────────────┘    └─────────────────┘                         │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  連絡先:                                                                     │
│  ● Slack: #salontalk-ops                                                   │
│  ● 緊急連絡: オンコール担当携帯                                              │
│  ● メール: ops@revol.co.jp                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 11. 移行設計

### 11.1 移行方針

本システムは新規開発のため、既存システムからのデータ移行は基本的に発生しない。ただし、以下の移行作業が必要となる。

| 移行種別 | 内容 | 対象 | 方式 |
|---------|------|------|------|
| 初期データ投入 | マスタデータ | プラン、シナリオ | SQL |
| デモデータ投入 | サンプルデータ | デモ店舗、スタッフ | SQL |
| 将来POS連携 | 顧客データ | POSシステム | API連携 |

### 11.2 初期データ投入

#### 11.2.1 初期データ一覧

| データ種別 | 件数 | 投入方法 | 投入タイミング |
|-----------|------|---------|--------------|
| プランマスタ | 3件 | SQL | 初期デプロイ時 |
| 悩みキーワードマスタ | 30件 | SQL | 初期デプロイ時 |
| トレーニングシナリオ | 10件 | SQL | 初期デプロイ時 |
| デモ店舗 | 1件 | SQL | 初期デプロイ時 |
| デモスタッフ | 5件 | SQL | 初期デプロイ時 |
| サンプル成功事例 | 20件 | SQL | 初期デプロイ時 |

#### 11.2.2 初期データSQL

```sql
-- ================================================
-- 初期データ投入スクリプト
-- ================================================

-- 1. プランマスタ
INSERT INTO plans (id, name, price_monthly, features, max_sessions, max_staff) VALUES
('plan_standard', 'スタンダード', 9800, 
  '{"ai_analysis": true, "realtime_assist": true, "report": true, "training": false, "api_access": false}',
  100, 10),
('plan_professional', 'プロフェッショナル', 19800,
  '{"ai_analysis": true, "realtime_assist": true, "report": true, "training": true, "api_access": false}',
  500, 30),
('plan_enterprise', 'エンタープライズ', 49800,
  '{"ai_analysis": true, "realtime_assist": true, "report": true, "training": true, "api_access": true}',
  -1, -1);  -- -1 = 無制限

-- 2. 悩みキーワードマスタ
INSERT INTO concern_keywords (category, keyword, priority) VALUES
('乾燥', '乾燥', 1),
('乾燥', 'パサパサ', 1),
('乾燥', 'パサつき', 1),
('乾燥', '潤いがない', 2),
('広がり', '広がる', 1),
('広がり', '広がり', 1),
('広がり', 'まとまらない', 2),
('広がり', 'ボワッとする', 2),
('ダメージ', 'ダメージ', 1),
('ダメージ', '傷んでる', 1),
('ダメージ', '枝毛', 2),
('ダメージ', '切れ毛', 2),
('うねり', 'うねり', 1),
('うねり', 'くせ毛', 1),
('うねり', 'ハネる', 2),
('薄毛', '薄毛', 1),
('薄毛', 'ボリュームがない', 1),
('薄毛', 'ぺたんこ', 2),
('薄毛', '抜け毛', 2),
('白髪', '白髪', 1),
('白髪', '白髪染め', 1),
('白髪', 'グレイヘア', 2),
('頭皮', '頭皮', 1),
('頭皮', 'かゆい', 2),
('頭皮', 'フケ', 2),
('頭皮', 'べたつき', 2),
('カラー', '色落ち', 1),
('カラー', '退色', 2),
('パーマ', 'パーマがとれる', 1),
('パーマ', 'カールが弱い', 2);

-- 3. トレーニングシナリオ
INSERT INTO training_scenarios (id, name, level, description, category, initial_prompt, evaluation_criteria) VALUES
('scenario_001', '初めてのお客様対応', 'beginner', '新規のお客様への基本的なカウンセリング', 'カウンセリング',
  'あなたは30代女性のお客様です。初めてこの美容室に来ました。髪の毛が最近パサついて困っています。',
  '{"greeting": 0.2, "listening": 0.3, "question": 0.3, "proposal": 0.2}'),
('scenario_002', '悩みの深堀り', 'beginner', 'お客様の悩みを詳しく聞き出す', 'カウンセリング',
  'あなたは40代女性のお客様です。髪の広がりが気になっていますが、具体的に何が原因かわかっていません。',
  '{"listening": 0.3, "question": 0.4, "empathy": 0.3}'),
('scenario_003', '店販商品の提案（初級）', 'intermediate', 'シャンプーの提案練習', '店販提案',
  'あなたは30代女性のお客様です。乾燥が気になると話しています。商品を勧められたら興味を示してください。',
  '{"timing": 0.2, "benefit": 0.4, "closing": 0.2, "objection_handling": 0.2}'),
('scenario_004', '店販商品の提案（中級）', 'intermediate', 'トリートメントの提案練習', '店販提案',
  'あなたは40代女性のお客様です。ダメージが気になっています。商品提案に対して「高い」と言ってください。',
  '{"timing": 0.2, "benefit": 0.3, "objection_handling": 0.3, "closing": 0.2}'),
('scenario_005', '断られた時の対応', 'intermediate', '商品提案を断られた時の対応', '店販提案',
  'あなたは30代女性のお客様です。商品を勧められたら「今日はいいです」と断ってください。',
  '{"acceptance": 0.3, "alternative": 0.3, "relationship": 0.4}'),
('scenario_006', '難しいお客様対応', 'advanced', '要望の多いお客様への対応', '接客',
  'あなたは50代女性のお客様です。細かい要望が多く、「前回と違う」「イメージと違う」と言いがちです。',
  '{"patience": 0.3, "clarification": 0.3, "solution": 0.2, "satisfaction": 0.2}'),
('scenario_007', 'クレーム対応', 'advanced', 'クレームへの適切な対応', '接客',
  'あなたは40代女性のお客様です。前回のカラーが思ったより暗かったと不満を持っています。',
  '{"apology": 0.3, "listening": 0.3, "solution": 0.2, "follow_up": 0.2}'),
('scenario_008', '高単価商品の提案', 'advanced', '高価格帯商品の提案練習', '店販提案',
  'あなたは30代女性のお客様です。髪のケアに興味がありますが、5000円以上の商品には慎重です。',
  '{"value": 0.4, "benefit": 0.3, "trust": 0.3}'),
('scenario_009', '複数商品の提案', 'advanced', 'シャンプー＋トリートメントのセット提案', '店販提案',
  'あなたは40代女性のお客様です。乾燥とダメージの両方が気になっています。',
  '{"needs_analysis": 0.3, "combination": 0.3, "value": 0.2, "closing": 0.2}'),
('scenario_010', 'リピート促進', 'advanced', '次回予約の促進', '接客',
  'あなたは30代女性のお客様です。施術には満足していますが、次回予約は考えていません。',
  '{"satisfaction_confirm": 0.2, "benefit": 0.3, "urgency": 0.2, "booking": 0.3}');

-- 4. デモ店舗・スタッフ（開発・デモ用）
INSERT INTO salons (id, name, address, phone, plan, seats_count, settings) VALUES
('demo-salon-001', 'デモサロン 渋谷店', '東京都渋谷区神南1-1-1', '03-1234-5678', 'professional', 8,
  '{"notification": {"enablePush": true, "concernDetectionAlert": true}, "analysis": {"idealTalkRatio": 40}}');

-- 5. サンプル成功事例
INSERT INTO success_cases (salon_id, concern_keywords, customer_profile, successful_talk, key_tactics, sold_product, conversion_rate, is_public) VALUES
('demo-salon-001', 
  ARRAY['乾燥', 'パサつき'],
  '{"ageGroup": "30s", "gender": "female", "visitFrequency": "monthly"}',
  '「乾燥が気になるんですね。実は同じお悩みだったお客様が、このシャンプーに変えてから朝のスタイリング時間が5分短くなったとおっしゃってました。」',
  ARRAY['共感から入る', '具体的な効果を伝える', '他のお客様の声を活用'],
  '保湿シャンプー',
  0.35,
  true),
('demo-salon-001',
  ARRAY['広がり', 'まとまらない'],
  '{"ageGroup": "40s", "gender": "female", "visitFrequency": "bimonthly"}',
  '「湿気の時期は特に大変ですよね。このオイルは少量で済むので、コスパも良いんです。1本で3ヶ月くらいもちますよ。」',
  ARRAY['季節の悩みに共感', 'コストパフォーマンスを強調', '使用量の具体例'],
  'ヘアオイル',
  0.28,
  true);

-- 6. 成功事例のEmbedding生成（Edge Functionで実行）
-- create-embedding Edge Functionを呼び出して生成
```

### 11.3 段階的リリース計画

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           段階的リリース計画                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Phase 0: 開発・テスト環境                                                   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  期間: 開発期間中                                                            │
│  対象: 開発チーム                                                            │
│  環境: Staging                                                              │
│  目的: 機能検証、バグ修正                                                    │
│                                                                             │
│  Phase 1: 社内パイロット                                                     │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  期間: 2週間                                                                 │
│  対象: Revol社内スタッフ（5名）                                              │
│  環境: Production（制限付き）                                                │
│  目的: 実環境での動作確認、UXフィードバック収集                               │
│  成功基準:                                                                   │
│    ● システムエラー率 < 1%                                                  │
│    ● セッション完了率 > 95%                                                 │
│    ● ユーザー満足度 > 3.5/5                                                 │
│                                                                             │
│  Phase 2: 限定リリース                                                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  期間: 1ヶ月                                                                 │
│  対象: パイロット店舗（2店舗、20名）                                         │
│  環境: Production                                                           │
│  目的: 実店舗での検証、運用課題の洗い出し                                    │
│  成功基準:                                                                   │
│    ● 店販売上向上 > 10%                                                     │
│    ● スタッフ利用率 > 80%                                                   │
│    ● 重大障害 = 0                                                           │
│                                                                             │
│  Phase 3: 一般リリース                                                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  期間: 以降継続                                                              │
│  対象: 全顧客                                                                │
│  環境: Production                                                           │
│  目的: 本格運用開始                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 12. テスト設計

### 12.1 テスト方針

#### 12.1.1 テストピラミッド

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           テストピラミッド                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ╱╲                                             │
│                             ╱  ╲                                            │
│                            ╱ E2E╲      10%                                  │
│                           ╱ Tests╲     (主要シナリオ)                       │
│                          ╱────────╲                                         │
│                         ╱          ╲                                        │
│                        ╱ Integration╲   20%                                 │
│                       ╱    Tests     ╲  (API・DB連携)                       │
│                      ╱────────────────╲                                     │
│                     ╱                  ╲                                    │
│                    ╱    Unit Tests      ╲   70%                             │
│                   ╱                      ╲  (関数・コンポーネント)           │
│                  ╱────────────────────────╲                                 │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ テスト種別         │ ツール                      │ カバレッジ目標    │   │
│  ├────────────────────┼─────────────────────────────┼──────────────────┤   │
│  │ Unit Tests        │ Jest, React Native Testing  │ 80%以上          │   │
│  │                    │ Library                     │                  │   │
│  ├────────────────────┼─────────────────────────────┼──────────────────┤   │
│  │ Integration Tests │ Supertest, Supabase Test    │ 70%以上          │   │
│  │                    │ Helpers                     │                  │   │
│  ├────────────────────┼─────────────────────────────┼──────────────────┤   │
│  │ E2E Tests         │ Detox (iPad),               │ 主要フロー100%   │   │
│  │                    │ Playwright (Web)            │                  │   │
│  └────────────────────┴─────────────────────────────┴──────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 12.1.2 テスト種別と目的

| テスト種別 | 目的 | 実施タイミング | 担当 |
|-----------|------|--------------|------|
| 単体テスト | 関数・コンポーネント単位の動作検証 | 開発時（自動） | 開発者 |
| 結合テスト | API・DB連携の検証 | PR時（自動） | 開発者 |
| E2Eテスト | ユーザーシナリオの検証 | Staging（自動） | QA |
| 性能テスト | 負荷・応答時間の検証 | リリース前 | QA |
| セキュリティテスト | 脆弱性の検証 | リリース前 | セキュリティ担当 |
| ユーザー受入テスト | 業務要件の充足確認 | リリース前 | ステークホルダー |

### 12.2 テスト環境

| 環境 | URL | 用途 | データ |
|------|-----|------|-------|
| ローカル | localhost | 開発・単体テスト | モック/Seed |
| Staging | staging.salontalk.app | 結合・E2E・性能テスト | テストデータ |
| Production | salontalk.app | 本番 | 本番データ |

### 12.3 テストケース設計

#### 12.3.1 単体テスト例

```typescript
// __tests__/utils/scoreCalculator.test.ts

import { calculateOverallScore, calculateTalkRatioScore } from '@/utils/scoreCalculator';

describe('calculateTalkRatioScore', () => {
  it('理想的な比率（40%）の場合、100点を返す', () => {
    const result = calculateTalkRatioScore(40);
    expect(result).toBe(100);
  });

  it('許容範囲内（35-45%）の場合、100点を返す', () => {
    expect(calculateTalkRatioScore(35)).toBe(100);
    expect(calculateTalkRatioScore(45)).toBe(100);
  });

  it('やや外れた範囲（30-35%, 45-50%）の場合、80点を返す', () => {
    expect(calculateTalkRatioScore(32)).toBe(80);
    expect(calculateTalkRatioScore(48)).toBe(80);
  });

  it('大きく外れた場合、低いスコアを返す', () => {
    expect(calculateTalkRatioScore(20)).toBe(40);
    expect(calculateTalkRatioScore(70)).toBe(40);
  });
});

describe('calculateOverallScore', () => {
  it('全指標が100点の場合、100点を返す', () => {
    const indicators = {
      talkRatio: 100,
      questionAnalysis: 100,
      emotionAnalysis: 100,
      concernKeywords: 100,
      proposalTiming: 100,
      proposalQuality: 100,
      conversion: 100,
    };
    const result = calculateOverallScore(indicators);
    expect(result).toBe(100);
  });

  it('重み付けが正しく適用される', () => {
    const indicators = {
      talkRatio: 80,        // 15% -> 12
      questionAnalysis: 80, // 15% -> 12
      emotionAnalysis: 80,  // 15% -> 12
      concernKeywords: 80,  // 10% -> 8
      proposalTiming: 80,   // 15% -> 12
      proposalQuality: 80,  // 15% -> 12
      conversion: 80,       // 15% -> 12
    };
    const result = calculateOverallScore(indicators);
    expect(result).toBe(80);
  });
});
```

#### 12.3.2 結合テスト例

```typescript
// __tests__/api/createSession.test.ts

import { createClient } from '@supabase/supabase-js';
import { describe, it, expect, beforeAll, afterAll } from 'vitest';

describe('create-session API', () => {
  let supabase: SupabaseClient;
  let testUserId: string;

  beforeAll(async () => {
    supabase = createClient(
      process.env.SUPABASE_URL!,
      process.env.SUPABASE_ANON_KEY!
    );
    // テストユーザーでログイン
    const { data } = await supabase.auth.signInWithPassword({
      email: 'test@example.com',
      password: 'testpassword',
    });
    testUserId = data.user!.id;
  });

  afterAll(async () => {
    await supabase.auth.signOut();
  });

  it('正常なリクエストでセッションが作成される', async () => {
    const { data, error } = await supabase.functions.invoke('create-session', {
      body: {
        stylistId: testUserId,
        customerInfo: {
          ageGroup: '30s',
          gender: 'female',
        },
      },
    });

    expect(error).toBeNull();
    expect(data).toHaveProperty('sessionId');
    expect(data).toHaveProperty('status', 'recording');
    expect(data).toHaveProperty('realtimeChannel');
  });

  it('stylistIdがない場合、エラーを返す', async () => {
    const { data, error } = await supabase.functions.invoke('create-session', {
      body: {},
    });

    expect(error).toBeDefined();
    expect(error.message).toContain('stylistId');
  });

  it('不正なcustomerInfoの場合、エラーを返す', async () => {
    const { data, error } = await supabase.functions.invoke('create-session', {
      body: {
        stylistId: testUserId,
        customerInfo: {
          ageGroup: 'invalid',
        },
      },
    });

    expect(error).toBeDefined();
    expect(error.message).toContain('ageGroup');
  });
});
```

#### 12.3.3 E2Eテストケース

| TC-ID | シナリオ | 前提条件 | 操作手順 | 期待結果 | 優先度 |
|-------|---------|---------|---------|---------|-------|
| E2E-001 | ログイン成功 | 有効なアカウント | 1. アプリ起動<br>2. メール入力<br>3. パスワード入力<br>4. ログインタップ | ホーム画面が表示される | 高 |
| E2E-002 | ログイン失敗 | 無効なパスワード | 1. アプリ起動<br>2. メール入力<br>3. 誤ったパスワード入力<br>4. ログインタップ | エラーメッセージが表示される | 高 |
| E2E-003 | セッション開始 | ログイン済み | 1. 「セッション開始」タップ<br>2. お客様情報入力<br>3. 「開始」タップ | セッション画面が表示され、録音が開始される | 高 |
| E2E-004 | リアルタイム分析表示 | セッション中 | 1. 会話を行う（60秒以上） | スコアが更新される | 高 |
| E2E-005 | 提案通知表示 | セッション中 | 1. 「乾燥」「パサつき」を含む会話 | 提案通知カードが表示される | 高 |
| E2E-006 | セッション終了 | セッション中 | 1. 「終了」タップ<br>2. 確認ダイアログで「終了」 | レポート画面が表示される | 高 |
| E2E-007 | レポート閲覧 | レポート存在 | 1. レポート一覧表示<br>2. レポート選択 | レポート詳細が表示される | 中 |
| E2E-008 | AIロールプレイ | ログイン済み | 1. トレーニング画面<br>2. シナリオ選択<br>3. 会話を3往復<br>4. 「終了」 | 評価結果が表示される | 中 |
| E2E-009 | ダッシュボード表示 | 管理者ログイン | 1. Webでログイン<br>2. ダッシュボード確認 | KPIが正しく表示される | 中 |
| E2E-010 | スタッフ管理 | 管理者ログイン | 1. スタッフ一覧<br>2. スタッフ追加<br>3. 情報入力<br>4. 保存 | スタッフが追加される | 低 |

### 12.4 性能テスト計画

#### 12.4.1 負荷テストシナリオ

```javascript
// k6 負荷テストスクリプト
// load-test.js

import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

const errorRate = new Rate('errors');

export const options = {
  stages: [
    { duration: '2m', target: 50 },   // ウォームアップ
    { duration: '5m', target: 100 },  // 通常負荷
    { duration: '2m', target: 200 },  // ピーク負荷
    { duration: '2m', target: 100 },  // 負荷軽減
    { duration: '2m', target: 0 },    // クールダウン
  ],
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    errors: ['rate<0.01'],
  },
};

const BASE_URL = __ENV.BASE_URL || 'https://staging.salontalk.app';

export default function () {
  // ログイン
  const loginRes = http.post(`${BASE_URL}/auth/v1/token`, {
    email: 'loadtest@example.com',
    password: 'testpassword',
  });
  
  check(loginRes, {
    'ログイン成功': (r) => r.status === 200,
  }) || errorRate.add(1);

  const token = loginRes.json('access_token');

  // セッション一覧取得
  const sessionsRes = http.get(`${BASE_URL}/rest/v1/sessions`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  
  check(sessionsRes, {
    'セッション一覧取得成功': (r) => r.status === 200,
    'レスポンスタイム < 500ms': (r) => r.timings.duration < 500,
  }) || errorRate.add(1);

  sleep(1);
}
```

#### 12.4.2 性能テスト結果目標

| 指標 | 目標値 | 測定条件 |
|------|--------|---------|
| 同時ユーザー | 100 | 全機能利用 |
| スループット | 1000 req/min | 混合シナリオ |
| レスポンスタイム（P95） | 500ms以下 | API呼び出し |
| レスポンスタイム（P99） | 1000ms以下 | API呼び出し |
| エラー率 | 0.1%以下 | 全リクエスト |
| CPU使用率 | 70%以下 | ピーク時 |
| メモリ使用率 | 80%以下 | ピーク時 |

---

## 付録

### 付録A: エラーコード一覧

| コード | カテゴリ | 説明 | ユーザー向けメッセージ | 対応アクション |
|--------|---------|------|---------------------|--------------|
| AUTH_001 | 認証 | 認証トークン無効 | ログインし直してください | 再ログイン |
| AUTH_002 | 認証 | トークン期限切れ | セッションが切れました | リフレッシュ/再ログイン |
| AUTH_003 | 認証 | 権限不足 | この操作を行う権限がありません | - |
| VAL_001 | バリデーション | 必須項目未入力 | {項目名}を入力してください | 入力促進 |
| VAL_002 | バリデーション | 形式不正 | {項目名}の形式が正しくありません | 入力訂正 |
| VAL_003 | バリデーション | 値の範囲外 | {項目名}は{範囲}で入力してください | 入力訂正 |
| SES_001 | セッション | セッション未開始 | セッションが開始されていません | セッション開始 |
| SES_002 | セッション | セッション終了済み | このセッションは終了しています | - |
| SES_003 | セッション | 処理中 | 処理中です。しばらくお待ちください | 待機 |
| AI_001 | AI処理 | Claude API エラー | 分析処理に失敗しました | リトライ |
| AI_002 | AI処理 | レート制限 | しばらく待ってから再試行してください | 待機後リトライ |
| AI_003 | AI処理 | タイムアウト | 処理がタイムアウトしました | リトライ |
| DIA_001 | 話者分離 | pyannote エラー | 話者分離に失敗しました | リトライ |
| DIA_002 | 話者分離 | タイムアウト | 話者分離がタイムアウトしました | リトライ |
| DB_001 | データベース | 接続エラー | データベースに接続できません | リトライ |
| DB_002 | データベース | クエリエラー | データの取得に失敗しました | ログ確認 |
| NET_001 | ネットワーク | 接続エラー | ネットワークに接続できません | 接続確認 |
| NET_002 | ネットワーク | タイムアウト | 通信がタイムアウトしました | リトライ |
| SYS_001 | システム | 内部エラー | システムエラーが発生しました | サポート連絡 |

### 付録B: 用語集

| 用語 | 英語表記 | 定義 |
|------|---------|------|
| セッション | Session | 1回の施術における会話分析の単位。録音開始から終了まで |
| チャンク | Chunk | 60秒単位で分割された音声・テキストデータ |
| 話者分離 | Speaker Diarization | 複数話者の発話を個別に識別・分離する処理 |
| トーク比率 | Talk Ratio | スタイリストとお客様の発話時間比率（理想: 40:60） |
| 傾聴スコア | Listening Score | 7つの分析指標を重み付け合計した総合評価点（0-100） |
| 悩みキーワード | Concern Keywords | お客様の髪に関する悩みを示すキーワード群 |
| 成功事例 | Success Case | 店販成約に至った会話パターンのデータベース |
| ベクトル埋め込み | Vector Embedding | テキストを1536次元の数値ベクトルに変換したもの |
| コサイン類似度 | Cosine Similarity | 2つのベクトル間の類似度を測る指標（-1〜1） |
| RLS | Row Level Security | PostgreSQLの行単位アクセス制御機能 |
| Edge Function | Edge Function | Supabaseのサーバーレス関数実行環境 |
| Realtime | Realtime | SupabaseのWebSocketベースリアルタイム通信機能 |
| pyannote | pyannote.audio | オープンソースの話者分離ライブラリ |

### 付録C: 参考資料

| 資料名 | URL | 説明 |
|--------|-----|------|
| Supabase Documentation | https://supabase.com/docs | Supabase公式ドキュメント |
| Vercel Documentation | https://vercel.com/docs | Vercel公式ドキュメント |
| React Native | https://reactnative.dev | React Native公式ドキュメント |
| Expo | https://docs.expo.dev | Expo公式ドキュメント |
| Anthropic API | https://docs.anthropic.com | Claude API公式ドキュメント |
| OpenAI API | https://platform.openai.com/docs | OpenAI API公式ドキュメント |
| pyannote.audio | https://github.com/pyannote/pyannote-audio | pyannote GitHubリポジトリ |
| pgvector | https://github.com/pgvector/pgvector | pgvector GitHubリポジトリ |

---

## 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|---------|
| 1.0 | 2025-12-04 | Revol Corporation | 初版作成 |

---

## 承認

| 役職 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| プロジェクトマネージャー | | | |
| システムアーキテクト | | | |
| 品質保証責任者 | | | |
| セキュリティ責任者 | | | |

---

**文書終了**
