## 11. テスト仕様

### 11.1 単体テスト仕様

#### 11.1.1 トーク比率計算テスト

```typescript
// __tests__/analysis/talkRatioAnalyzer.test.ts

import { describe, it, expect } from 'vitest';
import { analyzeTalkRatio } from '@/domain/services/analysis/talkRatioAnalyzer';

describe('analyzeTalkRatio', () => {
  describe('スコア計算', () => {
    it('理想的な比率（40%）で100点を返す', () => {
      const segments = [
        { speaker: 'stylist', startTime: 0, endTime: 40 },
        { speaker: 'customer', startTime: 40, endTime: 100 },
      ];
      
      const result = analyzeTalkRatio(segments as any);
      
      expect(result.score).toBe(100);
      expect(result.value).toBe(40);
    });

    it('許容範囲（35-45%）で100点を返す', () => {
      const segments = [
        { speaker: 'stylist', startTime: 0, endTime: 45 },
        { speaker: 'customer', startTime: 45, endTime: 100 },
      ];
      
      const result = analyzeTalkRatio(segments as any);
      
      expect(result.score).toBe(100);
    });

    it('やや乖離（30-35%）で80点を返す', () => {
      const segments = [
        { speaker: 'stylist', startTime: 0, endTime: 32 },
        { speaker: 'customer', startTime: 32, endTime: 100 },
      ];
      
      const result = analyzeTalkRatio(segments as any);
      
      expect(result.score).toBe(80);
    });

    it('大きく乖離（25%未満）で40点を返す', () => {
      const segments = [
        { speaker: 'stylist', startTime: 0, endTime: 20 },
        { speaker: 'customer', startTime: 20, endTime: 100 },
      ];
      
      const result = analyzeTalkRatio(segments as any);
      
      expect(result.score).toBe(40);
    });
  });

  describe('エッジケース', () => {
    it('セグメントが空の場合、デフォルト値を返す', () => {
      const result = analyzeTalkRatio([]);
      
      expect(result.score).toBe(50);
      expect(result.value).toBe(50);
    });

    it('unknownスピーカーは無視される', () => {
      const segments = [
        { speaker: 'stylist', startTime: 0, endTime: 40 },
        { speaker: 'customer', startTime: 40, endTime: 100 },
        { speaker: 'unknown', startTime: 100, endTime: 150 },
      ];
      
      const result = analyzeTalkRatio(segments as any);
      
      expect(result.details.totalSeconds).toBe(100);
    });
  });
});
```

#### 11.1.2 質問検出テスト

```typescript
// __tests__/analysis/questionAnalyzer.test.ts

import { describe, it, expect } from 'vitest';
import { analyzeQuestions } from '@/domain/services/analysis/questionAnalyzer';

describe('analyzeQuestions', () => {
  describe('質問検出', () => {
    it('疑問符で終わる発話を質問として検出する', () => {
      const conversation = [
        { speaker: 'stylist', text: '今日はどうされますか？', startTime: 0, endTime: 5 },
      ];
      
      const result = analyzeQuestions(conversation as any);
      
      expect(result.details.totalQuestions).toBe(1);
    });

    it('「〜ですか」で終わる発話を質問として検出する', () => {
      const conversation = [
        { speaker: 'stylist', text: '前回と同じでいいですか', startTime: 0, endTime: 5 },
      ];
      
      const result = analyzeQuestions(conversation as any);
      
      expect(result.details.totalQuestions).toBe(1);
    });

    it('お客様の発話は質問としてカウントしない', () => {
      const conversation = [
        { speaker: 'customer', text: 'どうしたらいいですか？', startTime: 0, endTime: 5 },
      ];
      
      const result = analyzeQuestions(conversation as any);
      
      expect(result.details.totalQuestions).toBe(0);
    });
  });

  describe('オープン/クローズド判定', () => {
    it('「どう〜」で始まる質問はオープンクエスチョン', () => {
      const conversation = [
        { speaker: 'stylist', text: 'どうされたいですか？', startTime: 0, endTime: 5 },
      ];
      
      const result = analyzeQuestions(conversation as any);
      
      expect(result.details.openQuestions).toBe(1);
    });

    it('「〜ですか」のみはクローズドクエスチョン', () => {
      const conversation = [
        { speaker: 'stylist', text: '短くしますか？', startTime: 0, endTime: 5 },
      ];
      
      const result = analyzeQuestions(conversation as any);
      
      expect(result.details.closedQuestions).toBe(1);
    });
  });

  describe('スコア計算', () => {
    it('8-12回でオープン60%以上は100点', () => {
      const conversation = Array(10).fill(null).map((_, i) => ({
        speaker: 'stylist',
        text: i < 6 ? 'どうですか？' : 'いいですか？',
        startTime: i * 10,
        endTime: (i + 1) * 10,
      }));
      
      const result = analyzeQuestions(conversation as any);
      
      expect(result.score).toBe(100);
    });
  });
});
```

### 11.2 結合テスト仕様

```typescript
// __tests__/integration/sessionFlow.test.ts

import { describe, it, expect, beforeAll, afterAll, beforeEach } from 'vitest';
import { createClient } from '@supabase/supabase-js';

describe('セッションフロー結合テスト', () => {
  let supabase: any;
  let testUserId: string;
  let testSalonId: string;
  let testStaffId: string;

  beforeAll(async () => {
    supabase = createClient(
      process.env.SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
    
    // テストデータセットアップ
    const { data: salon } = await supabase
      .from('salons')
      .insert({ name: 'Test Salon' })
      .select()
      .single();
    testSalonId = salon.id;

    // ... スタッフ作成など
  });

  afterAll(async () => {
    // テストデータクリーンアップ
    await supabase.from('sessions').delete().eq('salon_id', testSalonId);
    await supabase.from('staffs').delete().eq('salon_id', testSalonId);
    await supabase.from('salons').delete().eq('id', testSalonId);
  });

  describe('セッション作成', () => {
    it('正常にセッションが作成される', async () => {
      const { data, error } = await supabase.functions.invoke('create-session', {
        body: {
          stylistId: testStaffId,
          customerInfo: { ageGroup: '30s' },
        },
      });

      expect(error).toBeNull();
      expect(data.data.sessionId).toBeDefined();
      expect(data.data.status).toBe('recording');
    });

    it('アクティブセッションがある場合はエラー', async () => {
      // 先にセッション作成
      await supabase.functions.invoke('create-session', {
        body: { stylistId: testStaffId },
      });

      // 2つ目のセッション作成を試行
      const { data, error } = await supabase.functions.invoke('create-session', {
        body: { stylistId: testStaffId },
      });

      expect(error).toBeDefined();
      expect(data.error.code).toBe('SES_004');
    });
  });
});
```

### 11.3 E2Eテスト仕様

```typescript
// e2e/sessionWorkflow.spec.ts

import { test, expect } from '@playwright/test';

test.describe('セッションワークフロー E2E', () => {
  test.beforeEach(async ({ page }) => {
    // ログイン
    await page.goto('/login');
    await page.fill('[data-testid="email-input"]', 'test@example.com');
    await page.fill('[data-testid="password-input"]', 'password123');
    await page.click('[data-testid="login-button"]');
    await page.waitForURL('/home');
  });

  test('セッション開始から終了までの流れ', async ({ page }) => {
    // セッション開始
    await page.click('[data-testid="start-session-button"]');
    
    // お客様情報入力モーダル
    await expect(page.locator('[data-testid="session-modal"]')).toBeVisible();
    await page.selectOption('[data-testid="age-group-select"]', '30s');
    await page.click('[data-testid="modal-start-button"]');

    // セッション画面に遷移
    await expect(page).toHaveURL(/\/session\/.+/);
    await expect(page.locator('[data-testid="recording-indicator"]')).toBeVisible();

    // 経過時間が更新される
    await expect(page.locator('[data-testid="elapsed-time"]')).toHaveText('00:01', {
      timeout: 5000,
    });

    // セッション終了
    await page.click('[data-testid="end-session-button"]');
    await page.click('[data-testid="confirm-end-button"]');

    // レポート画面に遷移
    await expect(page).toHaveURL(/\/report\/.+/);
    await expect(page.locator('[data-testid="overall-score"]')).toBeVisible();
  });
});
```

---
