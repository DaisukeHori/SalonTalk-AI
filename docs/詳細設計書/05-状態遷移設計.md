## 5. 状態遷移設計

### 5.1 セッション状態遷移

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              セッション状態遷移図                                        │
│                   DB: status = 'recording'|'processing'|'analyzing'|'completed'|'error' │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                              ┌─────────────────┐                                        │
│                              │     (初期)      │                                        │
│                              └────────┬────────┘                                        │
│                                       │ create-session                                  │
│                                       ▼                                                 │
│                              ┌─────────────────┐                                        │
│            ┌────────────────▶│   recording     │◀────────────────┐                     │
│            │                 └────────┬────────┘                 │                     │
│            │                          │ end-session              │                     │
│            │                          ▼                          │                     │
│            │                 ┌─────────────────┐                 │                     │
│            │                 │   processing    │─────────────────┤                     │
│            │                 └────────┬────────┘                 │                     │
│            │                          │ generate-report開始      │                     │
│            │                          ▼                          │                     │
│            │                 ┌─────────────────┐                 │                     │
│            │                 │   analyzing     │─────────────────┤                     │
│            │                 └────────┬────────┘                 │                     │
│            │                          │                          │                     │
│            │            ┌─────────────┼─────────────┐            │                     │
│            │            │ success     │             │ failure    │                     │
│            │            ▼             │             ▼            │                     │
│            │   ┌─────────────────┐    │    ┌─────────────────┐   │                     │
│            │   │   completed     │    │    │     error       │───┘                     │
│            │   └─────────────────┘    │    └─────────────────┘  retry                  │
│            │                          │ timeout (5min)                                  │
│            │                          ▼                                                 │
│            │                 ┌─────────────────┐                                        │
│            └─────────────────│     error       │                                        │
│              force_complete  └─────────────────┘                                        │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 状態            │ 説明                         │ 遷移条件                       │   │
│  ├─────────────────┼──────────────────────────────┼────────────────────────────────┤   │
│  │ recording       │ 録音中、リアルタイム分析中    │ create-session API成功         │   │
│  │ processing      │ 終了処理中                   │ end-session API呼び出し        │   │
│  │ analyzing       │ AI分析・レポート生成中       │ generate-report API開始        │   │
│  │ completed       │ 正常終了、レポート生成完了    │ generate-report API成功        │   │
│  │ error           │ 異常終了                     │ エラー発生 or タイムアウト      │   │
│  └─────────────────┴──────────────────────────────┴────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 話者分離状態遷移

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                            話者分離（Diarization）状態遷移図                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                              ┌─────────────────┐                                        │
│                              │                 │                                        │
│                              │    PENDING      │◀──────────────┐                       │
│                              │                 │               │                       │
│                              └────────┬────────┘               │                       │
│                                       │                        │                       │
│                                       │ trigger_diarization    │ new_chunk             │
│                                       ▼                        │                       │
│                              ┌─────────────────┐               │                       │
│                              │                 │               │                       │
│                              │   PROCESSING    │───────────────┤                       │
│                              │                 │               │                       │
│                              └────────┬────────┘               │                       │
│                                       │                        │                       │
│                         ┌─────────────┼─────────────┐          │                       │
│                         │             │             │          │                       │
│                         │ callback    │             │ callback │                       │
│                         │ success     │             │ error    │                       │
│                         ▼             │             ▼          │                       │
│                ┌─────────────────┐    │    ┌─────────────────┐ │                       │
│                │                 │    │    │                 │ │                       │
│                │   COMPLETED     │    │    │     FAILED      │─┘                       │
│                │                 │    │    │                 │  retry (max 3)          │
│                └─────────────────┘    │    └─────────────────┘                         │
│                                       │                                                 │
│                                       │ timeout (5min)                                  │
│                                       ▼                                                 │
│                              ┌─────────────────┐                                        │
│                              │                 │                                        │
│                              │     FAILED      │                                        │
│                              │                 │                                        │
│                              └─────────────────┘                                        │
│                                                                                         │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 状態            │ 説明                         │ 後続処理                       │   │
│  ├─────────────────┼──────────────────────────────┼────────────────────────────────┤   │
│  │ PENDING         │ 話者分離未実行               │ trigger_diarization待機        │   │
│  │ PROCESSING      │ pyannoteサーバーで処理中     │ callback待機                   │   │
│  │ COMPLETED       │ 話者分離完了                 │ analyze-segment実行            │   │
│  │ FAILED          │ 話者分離失敗                 │ スキップしてanalyze実行        │   │
│  └─────────────────┴──────────────────────────────┴────────────────────────────────┘   │
│                                                                                         │
│  失敗時のフォールバック:                                                                 │
│  - 話者分離なしで分析を実行                                                              │
│  - 全発話をスタイリストとして扱う                                                        │
│  - トーク比率は50:50として計算                                                          │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 ユーザー認証状態遷移

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ユーザー認証状態遷移図                                      │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│                              ┌─────────────────┐                                        │
│                              │                 │                                        │
│                              │  UNAUTHENTICATED│◀─────────────────────────────┐        │
│                              │                 │                              │        │
│                              └────────┬────────┘                              │        │
│                                       │                                       │        │
│                                       │ login_success                         │        │
│                                       ▼                                       │        │
│                              ┌─────────────────┐                              │        │
│                              │                 │                              │        │
│                  ┌──────────▶│  AUTHENTICATED  │◀─────────────┐              │        │
│                  │           │                 │              │              │        │
│                  │           └────────┬────────┘              │              │        │
│                  │                    │                       │              │        │
│                  │        ┌───────────┼───────────┐           │              │        │
│                  │        │           │           │           │              │        │
│                  │        │ token     │           │ logout    │              │        │
│                  │        │ expiring  │           │           │              │        │
│                  │        ▼           │           ▼           │              │        │
│         ┌─────────────────┐           │   ┌─────────────────┐ │              │        │
│         │                 │           │   │                 │ │              │        │
│         │   REFRESHING    │───────────┤   │   LOGGING_OUT   │─┼──────────────┘        │
│         │                 │  refresh  │   │                 │ │                       │
│         └────────┬────────┘  success  │   └─────────────────┘ │                       │
│                  │                    │                       │                       │
│                  │ refresh_failed     │                       │                       │
│                  ▼                    │                       │                       │
│         ┌─────────────────┐           │                       │                       │
│         │                 │           │                       │                       │
│         │  SESSION_EXPIRED│───────────┴───────────────────────┘                       │
│         │                 │                                                            │
│         └─────────────────┘                                                            │
│                                                                                         │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 状態              │ UI表示                     │ 許可されるアクション           │   │
│  ├───────────────────┼────────────────────────────┼────────────────────────────────┤   │
│  │ UNAUTHENTICATED   │ ログイン画面               │ ログイン、パスワードリセット    │   │
│  │ AUTHENTICATED     │ メイン画面                 │ 全機能                         │   │
│  │ REFRESHING        │ ローディング表示           │ なし（待機）                   │   │
│  │ SESSION_EXPIRED   │ 再ログイン促すダイアログ    │ 再ログインのみ                 │   │
│  │ LOGGING_OUT       │ ローディング表示           │ なし（待機）                   │   │
│  └───────────────────┴────────────────────────────┴────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 アプリケーションUI状態

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         iPadアプリ UI状態遷移図                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌───────────────────────────────────────────────────────────────────────────────┐    │
│   │                              AppNavigator                                     │    │
│   │                                                                               │    │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐│    │
│   │   │                         AuthStack                                       ││    │
│   │   │                                                                         ││    │
│   │   │   ┌──────────────┐                                                      ││    │
│   │   │   │              │                                                      ││    │
│   │   │   │ LoginScreen  │                                                      ││    │
│   │   │   │              │                                                      ││    │
│   │   │   └──────┬───────┘                                                      ││    │
│   │   │          │ login_success                                                ││    │
│   │   │          ▼                                                              ││    │
│   │   └─────────────────────────────────────────────────────────────────────────┘│    │
│   │                                                                               │    │
│   │   ┌─────────────────────────────────────────────────────────────────────────┐│    │
│   │   │                         MainStack                                       ││    │
│   │   │                                                                         ││    │
│   │   │   ┌──────────────┐         ┌──────────────┐         ┌──────────────┐   ││    │
│   │   │   │              │ start   │              │  end    │              │   ││    │
│   │   │   │  HomeScreen  │────────▶│SessionScreen │────────▶│ ReportScreen │   ││    │
│   │   │   │              │         │              │         │              │   ││    │
│   │   │   └──────┬───────┘         └──────────────┘         └──────────────┘   ││    │
│   │   │          │                                                              ││    │
│   │   │          │ reports                                                      ││    │
│   │   │          ▼                                                              ││    │
│   │   │   ┌──────────────┐         ┌──────────────┐                            ││    │
│   │   │   │              │ select  │              │                            ││    │
│   │   │   │ReportListScreen│──────▶│ ReportScreen │                            ││    │
│   │   │   │              │         │              │                            ││    │
│   │   │   └──────────────┘         └──────────────┘                            ││    │
│   │   │          │                                                              ││    │
│   │   │          │ training                                                     ││    │
│   │   │          ▼                                                              ││    │
│   │   │   ┌──────────────┐         ┌──────────────┐                            ││    │
│   │   │   │              │ select  │              │                            ││    │
│   │   │   │TrainingScreen│────────▶│RoleplayScreen│                            ││    │
│   │   │   │              │         │              │                            ││    │
│   │   │   └──────────────┘         └──────────────┘                            ││    │
│   │   │          │                                                              ││    │
│   │   │          │ settings                                                     ││    │
│   │   │          ▼                                                              ││    │
│   │   │   ┌──────────────┐                                                      ││    │
│   │   │   │              │                                                      ││    │
│   │   │   │SettingsScreen│                                                      ││    │
│   │   │   │              │                                                      ││    │
│   │   │   └──────────────┘                                                      ││    │
│   │   │                                                                         ││    │
│   │   └─────────────────────────────────────────────────────────────────────────┘│    │
│   │                                                                               │    │
│   └───────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                         │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │ SessionScreen 内部状態遷移                                                      │  │
│   │                                                                                 │  │
│   │   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐               │  │
│   │   │          │    │          │    │          │    │          │               │  │
│   │   │INITIALIZING│──▶│ RECORDING│──▶│ ENDING   │──▶│ COMPLETE │               │  │
│   │   │          │    │          │    │          │    │          │               │  │
│   │   └──────────┘    └──────────┘    └──────────┘    └──────────┘               │  │
│   │        │               │                                                      │  │
│   │        │               │ notification                                         │  │
│   │        │               ▼                                                      │  │
│   │        │         ┌──────────┐                                                 │  │
│   │        │         │          │                                                 │  │
│   │        │         │ SHOWING  │  (overlay state)                                │  │
│   │        │         │NOTIFICATION                                                │  │
│   │        │         │          │                                                 │  │
│   │        │         └──────────┘                                                 │  │
│   │        │                                                                      │  │
│   │        │ error                                                                │  │
│   │        ▼                                                                      │  │
│   │   ┌──────────┐                                                                │  │
│   │   │          │                                                                │  │
│   │   │  ERROR   │                                                                │  │
│   │   │          │                                                                │  │
│   │   └──────────┘                                                                │  │
│   │                                                                                 │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.5 状態遷移表

#### 5.5.1 セッション状態遷移表

| 現状態 | イベント | 次状態 | アクション | 備考 |
|--------|---------|--------|-----------|------|
| (none) | create-session | RECORDING | DB INSERT, Realtime接続 | 新規セッション開始 |
| RECORDING | process-audio | RECORDING | チャンク処理 | 状態維持 |
| RECORDING | end-session | PROCESSING | ステータス更新 | 終了処理開始 |
| RECORDING | error | FAILED | エラーログ | 異常終了 |
| RECORDING | network_lost | RECORDING | オフラインキュー | ネットワーク復旧待ち |
| PROCESSING | generate-report.success | COMPLETED | レポート保存 | 正常終了 |
| PROCESSING | generate-report.failure | FAILED | エラーログ | レポート生成失敗 |
| PROCESSING | timeout(5min) | FAILED | 強制終了 | タイムアウト |
| FAILED | retry | PROCESSING | 再試行 | 最大3回 |
| FAILED | force_complete | COMPLETED | 簡易レポート | 強制完了 |

#### 5.5.2 話者分離状態遷移表

| 現状態 | イベント | 次状態 | アクション | 備考 |
|--------|---------|--------|-----------|------|
| PENDING | trigger | PROCESSING | pyannote呼び出し | 処理開始 |
| PROCESSING | callback.success | COMPLETED | セグメント保存 | 分析トリガー |
| PROCESSING | callback.failure | FAILED | エラーログ | リトライ判定 |
| PROCESSING | timeout(5min) | FAILED | タイムアウト | フォールバック |
| FAILED | retry (count < 3) | PENDING | リトライ | 最大3回 |
| FAILED | retry (count >= 3) | FAILED | スキップ | フォールバック分析 |
| COMPLETED | new_chunk | PENDING | 新規処理 | 次チャンク |

---

（続きは Part 4 に記載: アルゴリズム詳細設計）
# 詳細設計書 Part 4: アルゴリズム詳細設計

---
