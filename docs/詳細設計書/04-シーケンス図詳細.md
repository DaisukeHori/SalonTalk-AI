## 4. シーケンス図詳細

### 4.1 セッションライフサイクル

#### 4.1.1 セッション開始シーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           セッション開始 詳細シーケンス                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  iPad  │ │ Zustand │ │ Speech   │ │  Edge    │ │ Supabase │ │ Realtime │           │
│  │  App   │ │  Store  │ │ Service  │ │ Function │ │    DB    │ │ Channel  │           │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│      │           │           │            │            │            │                  │
│      │ 1. タップ「セッション開始」          │            │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 2. openSessionModal()  │            │            │                  │
│      │           │◀──────────────────────│            │            │                  │
│      │           │           │            │            │            │                  │
│      │  3. モーダル表示（お客様情報入力）   │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 4. お客様情報入力 → 「開始」タップ  │            │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 5. checkMicPermission()│            │            │                  │
│      │           │──────────▶│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 6. AVAudioSession                     │                  │
│      │           │           │    .requestRecordPermission()         │                  │
│      │           │           │────────────────────────────────────────────────────────▶│
│      │           │           │            │            │            │                  │
│      │           │           │ 7. Permission Granted                 │                  │
│      │           │           │◀────────────────────────────────────────────────────────│
│      │           │           │            │            │            │                  │
│      │           │ 8. { granted: true }   │            │            │                  │
│      │           │◀──────────│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 9. setLoading(true)    │            │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 10. POST /create-session            │            │                  │
│      │           │───────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 11. Validate Request     │                  │
│      │           │           │            │──────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 12. Check Active Session │                  │
│      │           │           │            │───────────▶│            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 13. No Active Session    │                  │
│      │           │           │            │◀───────────│            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 14. INSERT sessions      │                  │
│      │           │           │            │───────────▶│            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 15. { id, started_at, ...}                 │
│      │           │           │            │◀───────────│            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 16. Response { sessionId, realtimeChannel }       │                  │
│      │           │◀──────────────────────│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 17. setSession(session)│            │            │                  │
│      │           │──────────────────────────────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │ 18. supabase.channel(realtimeChannel)             │                  │
│      │           │──────────────────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 19. Subscribe                  │
│      │           │           │            │            │────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 20. Subscribed                 │
│      │           │           │            │            │◀────────────│                  │
│      │           │           │            │            │            │                  │
│      │           │ 21. Channel Ready      │            │            │                  │
│      │           │◀──────────────────────────────────────────────────│                  │
│      │           │           │            │            │            │                  │
│      │           │ 22. initializeRecording()           │            │                  │
│      │           │──────────▶│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 23. AVAudioEngine.start()             │                  │
│      │           │           │──────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 24. SpeechAnalyzer.start()            │                  │
│      │           │           │──────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │ 25. { recording: true }│            │            │                  │
│      │           │◀──────────│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 26. setRecording(true) │            │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 27. Navigate to SessionScreen      │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │  [セッション画面表示]  │            │            │            │                  │
│      │           │           │            │            │            │                  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.1.2 リアルタイム分析シーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         リアルタイム分析 詳細シーケンス                                   │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │  iPad  │ │ Speech   │ │ process- │ │ pyannote │ │ analyze- │ │ Realtime │          │
│  │  App   │ │ Service  │ │  audio   │ │  Server  │ │ segment  │ │ Channel  │          │
│  └───┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘          │
│      │           │            │            │            │            │                 │
│      │  ════════════════ 60秒経過（チャンク生成）════════════════    │                 │
│      │           │            │            │            │            │                 │
│      │ 1. onAudioChunk(buffer, transcripts)│            │            │                 │
│      │◀──────────│            │            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 2. Convert to WAV      │            │            │            │                 │
│      │──────────▶│            │            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 3. WAV File + Transcripts           │            │            │                 │
│      │◀──────────│            │            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 4. Save to Local DB (offline backup)│            │            │                 │
│      │───────────────────────────────────▶ │            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 5. POST /process-audio (multipart)  │            │            │                 │
│      │───────────────────────▶│            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 6. Validate (session, size)          │                 │
│      │           │            │──────────────────────────────────────▶                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 7. Upload WAV to Storage             │                 │
│      │           │            │──────────────────────────────────────▶                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 8. Storage URL                       │                 │
│      │           │            │◀──────────────────────────────────────                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 9. INSERT transcripts                │                 │
│      │           │            │──────────────────────────────────────▶                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 10. POST /diarize/{session_id}       │                 │
│      │           │            │───────────▶│            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 11. { status: "processing" }         │                 │
│      │           │            │◀───────────│            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 12. Response { transcriptId, audioUrl, diarizationTriggered } │                 │
│      │◀──────────────────────│            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │ ┌─────────────────────┐ │                 │
│      │           │            │            │ │ 13. pyannote処理    │ │                 │
│      │           │            │            │ │     (GPU, 非同期)   │ │                 │
│      │           │            │            │ │                     │ │                 │
│      │           │            │            │ │ - Load Audio        │ │                 │
│      │           │            │            │ │ - Diarization       │ │                 │
│      │           │            │            │ │ - Speaker Labels    │ │                 │
│      │           │            │            │ └──────────┬──────────┘ │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │ 14. POST /diarization-callback            │
│      │           │            │◀───────────│            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 15. INSERT speaker_segments          │                 │
│      │           │            │──────────────────────────────────────▶                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 16. POST /analyze-segment            │                 │
│      │           │            │────────────────────────▶│            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 17. Get Transcripts          │
│      │           │            │            │            │──────────────────────────────▶
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 18. Get Speaker Segments     │
│      │           │            │            │            │──────────────────────────────▶
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 19. Merge & Analyze          │
│      │           │            │            │            │ ┌────────────────────────────┐
│      │           │            │            │            │ │ - Talk Ratio (local)      │
│      │           │            │            │            │ │ - Questions (local)       │
│      │           │            │            │            │ │ - Emotion (Claude API)    │
│      │           │            │            │            │ │ - Concerns (local+Claude) │
│      │           │            │            │            │ │ - Proposal (Claude API)   │
│      │           │            │            │            │ │ - Conversion (Claude API) │
│      │           │            │            │            │ └────────────────────────────┘
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 20. INSERT session_analyses  │
│      │           │            │            │            │──────────────────────────────▶
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 21. Broadcast 'analysis'     │
│      │           │            │            │            │───────────▶│                 │
│      │           │            │            │            │            │                 │
│      │ 22. onAnalysis(payload)│            │            │            │                 │
│      │◀──────────────────────────────────────────────────────────────│                 │
│      │           │            │            │            │            │                 │
│      │ 23. Update UI (scores, log)         │            │            │                 │
│      │───────────────────────▶│            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │  ════════════════ 悩みキーワード検出時 ════════════════       │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 24. POST /search-cases       │
│      │           │            │            │            │───────────▶│                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 25. Vector Search            │
│      │           │            │            │            │──────────────────────────────▶
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 26. Top 5 Cases              │
│      │           │            │            │            │◀──────────────────────────────
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 27. Broadcast 'notification' │
│      │           │            │            │            │───────────▶│                 │
│      │           │            │            │            │            │                 │
│      │ 28. onNotification(payload)         │            │            │                 │
│      │◀──────────────────────────────────────────────────────────────│                 │
│      │           │            │            │            │            │                 │
│      │ 29. Show Proposal Card │            │            │            │                 │
│      │───────────────────────▶│            │            │            │                 │
│      │           │            │            │            │            │                 │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.1.3 セッション終了・レポート生成シーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                      セッション終了・レポート生成 詳細シーケンス                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  iPad  │ │ Zustand │ │ Speech   │ │  end-    │ │ generate-│ │   Claude │           │
│  │  App   │ │  Store  │ │ Service  │ │ session  │ │  report  │ │    API   │           │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│      │           │           │            │            │            │                  │
│      │ 1. タップ「セッション終了」         │            │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │  2. 確認ダイアログ表示 │            │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 3. 「終了する」タップ  │            │            │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 4. setLoading(true)    │            │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 5. stopRecording()     │            │            │                  │
│      │           │──────────▶│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 6. AVAudioEngine.stop()               │                  │
│      │           │           │──────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 7. Process remaining buffer           │                  │
│      │           │           │──────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 8. Final transcript                   │                  │
│      │           │           │◀──────────────────────────────────────│                  │
│      │           │           │            │            │            │                  │
│      │           │ 9. Upload final chunk (if any)      │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 10. POST /end-session  │            │            │                  │
│      │           │───────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 11. UPDATE sessions      │                  │
│      │           │           │            │     SET status='processing'                │
│      │           │           │            │──────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 12. Wait for pending diarization           │
│      │           │           │            │──────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 13. POST /generate-report│                  │
│      │           │           │            │────────────▶│            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 14. GET all analyses          │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 15. GET all transcripts       │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 16. Calculate overall score   │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 17. POST /v1/messages         │
│      │           │           │            │            │───────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │            │ 18. Generate     │
│      │           │           │            │            │            │     Report       │
│      │           │           │            │            │            │     Content      │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 19. AI Response              │
│      │           │           │            │            │◀───────────│                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 20. Parse & Format           │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 21. INSERT session_reports   │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 22. UPDATE sessions          │
│      │           │           │            │            │     SET status='completed'   │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 23. Response { reportId, ... }             │
│      │           │           │            │◀───────────│            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 24. Response { success, report }    │            │                  │
│      │           │◀──────────────────────│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 25. setSession({ status: 'completed', report })  │                  │
│      │           │──────────────────────────────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │ 26. setLoading(false)  │            │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 27. Navigate to ReportScreen       │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │  [レポート画面表示]    │            │            │            │                  │
│      │           │           │            │            │            │                  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 認証シーケンス

#### 4.2.1 ログインシーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ログイン 詳細シーケンス                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                         │
│  │  iPad  │ │ Zustand │ │ Supabase │ │ Supabase │ │  Secure  │                         │
│  │  App   │ │  Store  │ │   Auth   │ │    DB    │ │ Storage  │                         │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘                         │
│      │           │           │            │            │                                │
│      │ 1. Enter email & password          │            │                                │
│      │───────────────────────────────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 2. Validate input      │            │                                │
│      │           │──────────────────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 3. signInWithPassword()│            │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 4. Verify credentials   │                                │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 5. User exists + password match       │                  │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 6. Generate JWT tokens  │                                │
│      │           │           │──────────────────────────────────────▶                   │
│      │           │           │            │            │                                │
│      │           │           │ 7. { access_token, refresh_token, user }                 │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 8. Store refresh_token │            │                                │
│      │           │──────────────────────────────────────────────────▶│                  │
│      │           │           │            │            │                                │
│      │           │ 9. Get staff info      │            │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 10. SELECT * FROM staffs WHERE auth_user_id = ?          │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 11. Staff data with salon info        │                  │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │ 12. { user, staff, session }        │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 13. setUser(user)      │            │                                │
│      │           │    setStaff(staff)     │            │                                │
│      │           │    setSession(session) │            │                                │
│      │           │──────────────────────▶│            │                                │
│      │           │           │            │            │                                │
│      │ 14. Navigate to HomeScreen         │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│                                                                                         │
│  ════════════════ エラーケース ════════════════                                         │
│                                                                                         │
│  E1. 認証失敗（パスワード誤り）                                                          │
│      │           │           │            │            │                                │
│      │           │           │ 4a. Invalid credentials │                                │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │ 5a. Error: AUTH_001    │            │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 6a. Show error message │            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  E2. スタッフ無効                                                                        │
│      │           │           │            │            │                                │
│      │           │           │ 11b. staff.is_active = false          │                  │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │ 12b. Error: AUTH_003   │            │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 13b. Show "アカウントが無効です"    │            │                                │
│      │◀──────────│           │            │            │                                │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.2 トークンリフレッシュシーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                          トークンリフレッシュ シーケンス                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐                                      │
│  │  iPad  │ │   API   │ │ Supabase │ │  Secure  │                                      │
│  │  App   │ │ Client  │ │   Auth   │ │ Storage  │                                      │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘                                      │
│      │           │           │            │                                             │
│      │ 1. API Request        │            │                                             │
│      │──────────▶│           │            │                                             │
│      │           │           │            │                                             │
│      │           │ 2. Check token expiry  │                                             │
│      │           │──────────────────────▶│                                             │
│      │           │           │            │                                             │
│      │           │ 3. Token expired (< 5 min)          │                                │
│      │           │◀──────────────────────│                                             │
│      │           │           │            │                                             │
│      │           │ 4. Get refresh_token   │                                             │
│      │           │──────────────────────────────────────▶│                              │
│      │           │           │            │                                             │
│      │           │ 5. refresh_token       │                                             │
│      │           │◀──────────────────────────────────────│                              │
│      │           │           │            │                                             │
│      │           │ 6. refreshSession()    │                                             │
│      │           │──────────▶│            │                                             │
│      │           │           │            │                                             │
│      │           │           │ 7. Validate refresh_token             │                  │
│      │           │           │──────────────────────────────────────▶                   │
│      │           │           │            │                                             │
│      │           │           │ 8. Generate new tokens  │                                │
│      │           │           │──────────────────────────────────────▶                   │
│      │           │           │            │                                             │
│      │           │ 9. { new_access_token, new_refresh_token }        │                  │
│      │           │◀──────────│            │                                             │
│      │           │           │            │                                             │
│      │           │ 10. Store new refresh_token          │                               │
│      │           │──────────────────────────────────────▶│                              │
│      │           │           │            │                                             │
│      │           │ 11. Retry original request with new token         │                  │
│      │           │──────────▶│            │                                             │
│      │           │           │            │                                             │
│      │ 12. Response          │            │                                             │
│      │◀──────────│           │            │                                             │
│      │           │           │            │                                             │
│                                                                                         │
│  ════════════════ リフレッシュ失敗ケース ════════════════                                │
│                                                                                         │
│      │           │           │            │                                             │
│      │           │           │ 7a. Refresh token invalid/expired     │                  │
│      │           │           │◀──────────────────────────────────────                   │
│      │           │           │            │                                             │
│      │           │ 8a. Error: AUTH_002    │                                             │
│      │           │◀──────────│            │                                             │
│      │           │           │            │                                             │
│      │           │ 9a. Clear stored tokens│                                             │
│      │           │──────────────────────────────────────▶│                              │
│      │           │           │            │                                             │
│      │ 10a. Redirect to LoginScreen       │                                             │
│      │◀──────────│           │            │                                             │
│      │           │           │            │                                             │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---
