## 4. シーケンス図詳細

### 4.1 セッションライフサイクル

#### 4.1.1 セッション開始シーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           セッション開始 詳細シーケンス                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  iPad  │ │ Zustand │ │ Speech   │ │  Edge    │ │ Supabase │ │ Realtime │           │
│  │  App   │ │  Store  │ │ Service  │ │ Function │ │    DB    │ │ Channel  │           │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│      │           │           │            │            │            │                  │
│      │ 1. タップ「セッション開始」          │            │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 2. openSessionModal()  │            │            │                  │
│      │           │◀──────────────────────│            │            │                  │
│      │           │           │            │            │            │                  │
│      │  3. モーダル表示（お客様情報入力）   │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 4. お客様情報入力 → 「開始」タップ  │            │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 5. checkMicPermission()│            │            │                  │
│      │           │──────────▶│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 6. AVAudioSession                     │                  │
│      │           │           │    .requestRecordPermission()         │                  │
│      │           │           │────────────────────────────────────────────────────────▶│
│      │           │           │            │            │            │                  │
│      │           │           │ 7. Permission Granted                 │                  │
│      │           │           │◀────────────────────────────────────────────────────────│
│      │           │           │            │            │            │                  │
│      │           │ 8. { granted: true }   │            │            │                  │
│      │           │◀──────────│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 9. setLoading(true)    │            │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 10. POST /create-session            │            │                  │
│      │           │───────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 11. Validate Request     │                  │
│      │           │           │            │──────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 12. Check Active Session │                  │
│      │           │           │            │───────────▶│            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 13. No Active Session    │                  │
│      │           │           │            │◀───────────│            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 14. INSERT sessions      │                  │
│      │           │           │            │───────────▶│            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 15. { id, started_at, ...}                 │
│      │           │           │            │◀───────────│            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 16. Response { sessionId, realtimeChannel }       │                  │
│      │           │◀──────────────────────│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 17. setSession(session)│            │            │                  │
│      │           │──────────────────────────────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │ 18. supabase.channel(realtimeChannel)             │                  │
│      │           │──────────────────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 19. Subscribe                  │
│      │           │           │            │            │────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 20. Subscribed                 │
│      │           │           │            │            │◀────────────│                  │
│      │           │           │            │            │            │                  │
│      │           │ 21. Channel Ready      │            │            │                  │
│      │           │◀──────────────────────────────────────────────────│                  │
│      │           │           │            │            │            │                  │
│      │           │ 22. initializeRecording()           │            │                  │
│      │           │──────────▶│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 23. AVAudioEngine.start()             │                  │
│      │           │           │──────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 24. SpeechAnalyzer.start()            │                  │
│      │           │           │──────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │ 25. { recording: true }│            │            │                  │
│      │           │◀──────────│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 26. setRecording(true) │            │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 27. Navigate to SessionScreen      │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │  [セッション画面表示]  │            │            │            │                  │
│      │           │           │            │            │            │                  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.1.2 リアルタイム分析シーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         リアルタイム分析 詳細シーケンス                                   │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │  iPad  │ │ Speech   │ │ process- │ │ pyannote │ │ analyze- │ │ Realtime │          │
│  │  App   │ │ Service  │ │  audio   │ │  Server  │ │ segment  │ │ Channel  │          │
│  └───┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘          │
│      │           │            │            │            │            │                 │
│      │  ════════════════ 60秒経過（チャンク生成）════════════════    │                 │
│      │           │            │            │            │            │                 │
│      │ 1. onAudioChunk(buffer, transcripts)│            │            │                 │
│      │◀──────────│            │            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 2. Convert to WAV      │            │            │            │                 │
│      │──────────▶│            │            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 3. WAV File + Transcripts           │            │            │                 │
│      │◀──────────│            │            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 4. Save to Local DB (offline backup)│            │            │                 │
│      │───────────────────────────────────▶ │            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 5. POST /process-audio (multipart)  │            │            │                 │
│      │───────────────────────▶│            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 6. Validate (session, size)          │                 │
│      │           │            │──────────────────────────────────────▶                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 7. Upload WAV to Storage             │                 │
│      │           │            │──────────────────────────────────────▶                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 8. Storage URL                       │                 │
│      │           │            │◀──────────────────────────────────────                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 9. INSERT transcripts                │                 │
│      │           │            │──────────────────────────────────────▶                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 10. POST /diarize/{session_id}       │                 │
│      │           │            │───────────▶│            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 11. { status: "processing" }         │                 │
│      │           │            │◀───────────│            │            │                 │
│      │           │            │            │            │            │                 │
│      │ 12. Response { transcriptId, audioUrl, diarizationTriggered } │                 │
│      │◀──────────────────────│            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │ ┌─────────────────────┐ │                 │
│      │           │            │            │ │ 13. pyannote処理    │ │                 │
│      │           │            │            │ │     (GPU, 非同期)   │ │                 │
│      │           │            │            │ │                     │ │                 │
│      │           │            │            │ │ - Load Audio        │ │                 │
│      │           │            │            │ │ - Diarization       │ │                 │
│      │           │            │            │ │ - Speaker Labels    │ │                 │
│      │           │            │            │ └──────────┬──────────┘ │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │ 14. POST /diarization-callback            │
│      │           │            │◀───────────│            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 15. INSERT speaker_segments          │                 │
│      │           │            │──────────────────────────────────────▶                 │
│      │           │            │            │            │            │                 │
│      │           │            │ 16. POST /analyze-segment            │                 │
│      │           │            │────────────────────────▶│            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 17. Get Transcripts          │
│      │           │            │            │            │──────────────────────────────▶
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 18. Get Speaker Segments     │
│      │           │            │            │            │──────────────────────────────▶
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 19. Merge & Analyze          │
│      │           │            │            │            │ ┌────────────────────────────┐
│      │           │            │            │            │ │ - Talk Ratio (local)      │
│      │           │            │            │            │ │ - Questions (local)       │
│      │           │            │            │            │ │ - Emotion (Claude API)    │
│      │           │            │            │            │ │ - Concerns (local+Claude) │
│      │           │            │            │            │ │ - Proposal (Claude API)   │
│      │           │            │            │            │ │ - Conversion (Claude API) │
│      │           │            │            │            │ └────────────────────────────┘
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 20. INSERT session_analyses  │
│      │           │            │            │            │──────────────────────────────▶
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 21. Broadcast 'analysis'     │
│      │           │            │            │            │───────────▶│                 │
│      │           │            │            │            │            │                 │
│      │ 22. onAnalysis(payload)│            │            │            │                 │
│      │◀──────────────────────────────────────────────────────────────│                 │
│      │           │            │            │            │            │                 │
│      │ 23. Update UI (scores, log)         │            │            │                 │
│      │───────────────────────▶│            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │  ════════════════ 悩みキーワード検出時 ════════════════       │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 24. POST /search-cases       │
│      │           │            │            │            │───────────▶│                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 25. Vector Search            │
│      │           │            │            │            │──────────────────────────────▶
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 26. Top 5 Cases              │
│      │           │            │            │            │◀──────────────────────────────
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 27. Broadcast 'notification' │
│      │           │            │            │            │───────────▶│                 │
│      │           │            │            │            │            │                 │
│      │ 28. onNotification(payload)         │            │            │                 │
│      │◀──────────────────────────────────────────────────────────────│                 │
│      │           │            │            │            │            │                 │
│      │ 29. Show Proposal Card │            │            │            │                 │
│      │───────────────────────▶│            │            │            │                 │
│      │           │            │            │            │            │                 │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.1.3 セッション終了・レポート生成シーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                      セッション終了・レポート生成 詳細シーケンス                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  iPad  │ │ Zustand │ │ Speech   │ │  end-    │ │ generate-│ │   Claude │           │
│  │  App   │ │  Store  │ │ Service  │ │ session  │ │  report  │ │    API   │           │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│      │           │           │            │            │            │                  │
│      │ 1. タップ「セッション終了」         │            │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │  2. 確認ダイアログ表示 │            │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 3. 「終了する」タップ  │            │            │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 4. setLoading(true)    │            │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 5. stopRecording()     │            │            │                  │
│      │           │──────────▶│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 6. AVAudioEngine.stop()               │                  │
│      │           │           │──────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 7. Process remaining buffer           │                  │
│      │           │           │──────────────────────────────────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 8. Final transcript                   │                  │
│      │           │           │◀──────────────────────────────────────│                  │
│      │           │           │            │            │            │                  │
│      │           │ 9. Upload final chunk (if any)      │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 10. POST /end-session  │            │            │                  │
│      │           │───────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 11. UPDATE sessions      │                  │
│      │           │           │            │     SET status='processing'                │
│      │           │           │            │──────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 12. Wait for pending diarization           │
│      │           │           │            │──────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 13. POST /generate-report│                  │
│      │           │           │            │────────────▶│            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 14. GET all analyses          │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 15. GET all transcripts       │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 16. Calculate overall score   │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 17. POST /v1/messages         │
│      │           │           │            │            │───────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │            │ 18. Generate     │
│      │           │           │            │            │            │     Report       │
│      │           │           │            │            │            │     Content      │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 19. AI Response              │
│      │           │           │            │            │◀───────────│                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 20. Parse & Format           │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 21. INSERT session_reports   │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 22. UPDATE sessions          │
│      │           │           │            │            │     SET status='completed'   │
│      │           │           │            │            │──────────────────────────────▶ │
│      │           │           │            │            │            │                  │
│      │           │           │            │ 23. Response { reportId, ... }             │
│      │           │           │            │◀───────────│            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 24. Response { success, report }    │            │                  │
│      │           │◀──────────────────────│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 25. setSession({ status: 'completed', report })  │                  │
│      │           │──────────────────────────────────────────────────▶                  │
│      │           │           │            │            │            │                  │
│      │           │ 26. setLoading(false)  │            │            │                  │
│      │           │──────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 27. Navigate to ReportScreen       │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │  [レポート画面表示]    │            │            │            │                  │
│      │           │           │            │            │            │                  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 認証シーケンス

#### 4.2.1 ログインシーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ログイン 詳細シーケンス                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                         │
│  │  iPad  │ │ Zustand │ │ Supabase │ │ Supabase │ │  Secure  │                         │
│  │  App   │ │  Store  │ │   Auth   │ │    DB    │ │ Storage  │                         │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘                         │
│      │           │           │            │            │                                │
│      │ 1. Enter email & password          │            │                                │
│      │───────────────────────────────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 2. Validate input      │            │                                │
│      │           │──────────────────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 3. signInWithPassword()│            │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 4. Verify credentials   │                                │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 5. User exists + password match       │                  │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 6. Generate JWT tokens  │                                │
│      │           │           │──────────────────────────────────────▶                   │
│      │           │           │            │            │                                │
│      │           │           │ 7. { access_token, refresh_token, user }                 │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 8. Store refresh_token │            │                                │
│      │           │──────────────────────────────────────────────────▶│                  │
│      │           │           │            │            │                                │
│      │           │ 9. Get staff info      │            │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 10. SELECT * FROM staffs WHERE auth_user_id = ?          │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 11. Staff data with salon info        │                  │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │ 12. { user, staff, session }        │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 13. setUser(user)      │            │                                │
│      │           │    setStaff(staff)     │            │                                │
│      │           │    setSession(session) │            │                                │
│      │           │──────────────────────▶│            │                                │
│      │           │           │            │            │                                │
│      │ 14. Navigate to HomeScreen         │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│                                                                                         │
│  ════════════════ エラーケース ════════════════                                         │
│                                                                                         │
│  E1. 認証失敗（パスワード誤り）                                                          │
│      │           │           │            │            │                                │
│      │           │           │ 4a. Invalid credentials │                                │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │ 5a. Error: AUTH_001    │            │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 6a. Show error message │            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  E2. スタッフ無効                                                                        │
│      │           │           │            │            │                                │
│      │           │           │ 11b. staff.is_active = false          │                  │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │ 12b. Error: AUTH_003   │            │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 13b. Show "アカウントが無効です"    │            │                                │
│      │◀──────────│           │            │            │                                │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.2 トークンリフレッシュシーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                          トークンリフレッシュ シーケンス                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐                                      │
│  │  iPad  │ │   API   │ │ Supabase │ │  Secure  │                                      │
│  │  App   │ │ Client  │ │   Auth   │ │ Storage  │                                      │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘                                      │
│      │           │           │            │                                             │
│      │ 1. API Request        │            │                                             │
│      │──────────▶│           │            │                                             │
│      │           │           │            │                                             │
│      │           │ 2. Check token expiry  │                                             │
│      │           │──────────────────────▶│                                             │
│      │           │           │            │                                             │
│      │           │ 3. Token expired (< 5 min)          │                                │
│      │           │◀──────────────────────│                                             │
│      │           │           │            │                                             │
│      │           │ 4. Get refresh_token   │                                             │
│      │           │──────────────────────────────────────▶│                              │
│      │           │           │            │                                             │
│      │           │ 5. refresh_token       │                                             │
│      │           │◀──────────────────────────────────────│                              │
│      │           │           │            │                                             │
│      │           │ 6. refreshSession()    │                                             │
│      │           │──────────▶│            │                                             │
│      │           │           │            │                                             │
│      │           │           │ 7. Validate refresh_token             │                  │
│      │           │           │──────────────────────────────────────▶                   │
│      │           │           │            │                                             │
│      │           │           │ 8. Generate new tokens  │                                │
│      │           │           │──────────────────────────────────────▶                   │
│      │           │           │            │                                             │
│      │           │ 9. { new_access_token, new_refresh_token }        │                  │
│      │           │◀──────────│            │                                             │
│      │           │           │            │                                             │
│      │           │ 10. Store new refresh_token          │                               │
│      │           │──────────────────────────────────────▶│                              │
│      │           │           │            │                                             │
│      │           │ 11. Retry original request with new token         │                  │
│      │           │──────────▶│            │                                             │
│      │           │           │            │                                             │
│      │ 12. Response          │            │                                             │
│      │◀──────────│           │            │                                             │
│      │           │           │            │                                             │
│                                                                                         │
│  ════════════════ リフレッシュ失敗ケース ════════════════                                │
│                                                                                         │
│      │           │           │            │                                             │
│      │           │           │ 7a. Refresh token invalid/expired     │                  │
│      │           │           │◀──────────────────────────────────────                   │
│      │           │           │            │                                             │
│      │           │ 8a. Error: AUTH_002    │                                             │
│      │           │◀──────────│            │                                             │
│      │           │           │            │                                             │
│      │           │ 9a. Clear stored tokens│                                             │
│      │           │──────────────────────────────────────▶│                              │
│      │           │           │            │                                             │
│      │ 10a. Redirect to LoginScreen       │                                             │
│      │◀──────────│           │            │                                             │
│      │           │           │            │                                             │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 4.3 初回セットアップウィザード

#### 4.3.1 店舗初回セットアップシーケンス（Web）

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           店舗初回セットアップ シーケンス                                 │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                         │
│  │  Web   │ │  Next   │ │  Edge    │ │ Supabase │ │  Stripe  │                         │
│  │ Client │ │  API    │ │ Function │ │    DB    │ │  (決済)   │                         │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘                         │
│      │           │           │            │            │                                │
│      │ 1. ログイン成功後     │            │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 2. GET /api/me/setup-status        │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 3. SELECT salons WHERE id = salon_id                    │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 4. { setup_completed: false }                           │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │ 5. { needs_setup: true, current_step: 1 }                           │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 6. Redirect to /setup │            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 1: ようこそ画面 ════════════════                                 │
│      │           │           │            │            │                                │
│      │ 7. 「始める」クリック  │            │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │ 8. Navigate to Step 2 │            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 2: 店舗情報入力 ════════════════                                 │
│      │           │           │            │            │                                │
│      │ 9. 店舗名、住所等入力 → 「次へ」クリック         │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 10. POST /api/setup/salon-info     │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 11. Validate input     │                                │
│      │           │           │──────────────────────▶│                                │
│      │           │           │            │            │                                │
│      │           │           │ 12. UPDATE salons SET name = ..., settings = ...        │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 13. UPDATE setup_progress SET current_step = 3          │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 14. { success: true }  │            │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 15. Navigate to Step 3│            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 3: プラン選択 ════════════════                                   │
│      │           │           │            │            │                                │
│      │ 16. プラン選択 → 「次へ」クリック   │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 17. POST /api/setup/select-plan    │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 18. UPDATE salons SET plan = ...                        │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ [有料プランの場合]       │                                │
│      │           │           │ 19. Create Stripe Checkout Session                      │
│      │           │           │────────────────────────────────────▶│                   │
│      │           │           │            │            │                                │
│      │           │           │ 20. { checkout_url }    │                                │
│      │           │           │◀────────────────────────────────────│                   │
│      │           │           │            │            │                                │
│      │           │ 21. { success: true, checkout_url? }                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 22. Navigate to Step 4│            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 4: スタッフ招待 ════════════════                                 │
│      │           │           │            │            │                                │
│      │ 23. メールアドレス入力 → 「招待」クリック        │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 24. POST /api/setup/invite-staff   │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 25. Generate invite token                               │
│      │           │           │──────────────────────▶│                                │
│      │           │           │            │            │                                │
│      │           │           │ 26. INSERT staff_invitations                            │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 27. Send invitation email (via Resend)                  │
│      │           │           │──────────────────────────────────▶│                     │
│      │           │           │            │            │                                │
│      │           │ 28. { success: true, invited_count: N }                             │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 29. Navigate to Step 5│            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 5: プライバシー設定 ════════════════                             │
│      │           │           │            │            │                                │
│      │ 30. 設定入力 → 「次へ」クリック     │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 31. POST /api/setup/privacy-settings                               │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 32. UPDATE salons SET settings = JSONB_SET(...)        │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 33. { success: true }  │            │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 34. Navigate to Step 6│            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 6: 完了 ════════════════                                        │
│      │           │           │            │            │                                │
│      │ 35. 「ダッシュボードへ」クリック    │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 36. POST /api/setup/complete       │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 37. UPDATE salons SET setup_completed = true            │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 38. DELETE setup_progress WHERE user_id = ...           │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 39. { success: true }  │            │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 40. Redirect to /dashboard         │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.3.2 スタッフ初回セットアップシーケンス（iPad）

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           スタッフ初回セットアップ シーケンス                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                         │
│  │  iPad  │ │ Zustand │ │  Edge    │ │ Supabase │ │  Device  │                         │
│  │  App   │ │  Store  │ │ Function │ │    DB    │ │   API    │                         │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘                         │
│      │           │           │            │            │                                │
│      │ 1. 招待リンクからログイン完了       │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 2. GET /api/me/setup-status        │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 3. SELECT staffs WHERE id = auth.uid()                  │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 4. { setup_completed: false }                           │
│      │           │           │◀───────────│            │                                │
│      │           │           │            │            │                                │
│      │           │ 5. { needs_setup: true, current_step: 1 }                           │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 6. Navigate to SetupScreen         │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 1: ようこそ画面 ════════════════                                 │
│      │           │           │            │            │                                │
│      │ 7. 「始める」タップ   │            │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │ 8. Swipe to Step 2    │            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 2: プロフィール設定 ════════════════                             │
│      │           │           │            │            │                                │
│      │ 9. プロフィール画像選択タップ       │            │                                │
│      │──────────────────────────────────────────────────▶│                              │
│      │           │           │            │            │                                │
│      │           │           │            │ 10. UIImagePickerController                │
│      │           │           │            │◀───────────│                                │
│      │           │           │            │            │                                │
│      │ 11. 画像選択完了      │            │            │                                │
│      │◀──────────────────────────────────────────────────│                              │
│      │           │           │            │            │                                │
│      │ 12. 表示名入力 → 「次へ」タップ     │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 13. POST /api/setup/profile        │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 14. Upload avatar to Storage                            │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 15. UPDATE staffs SET name = ..., avatar_url = ...      │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 16. { success: true }  │            │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 17. Swipe to Step 3   │            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 3: 権限許可 ════════════════                                     │
│      │           │           │            │            │                                │
│      │ 18. 「マイク権限を許可」タップ      │            │                                │
│      │──────────────────────────────────────────────────▶│                              │
│      │           │           │            │            │                                │
│      │           │           │            │ 19. AVAudioSession                         │
│      │           │           │            │    .requestRecordPermission()              │
│      │           │           │            │◀───────────│                                │
│      │           │           │            │            │                                │
│      │           │           │            │ 20. Show System Permission Dialog          │
│      │           │           │            │───────────▶│                                │
│      │           │           │            │            │                                │
│      │ 21. ユーザーが「許可」タップ        │            │                                │
│      │──────────────────────────────────────────────────▶│                              │
│      │           │           │            │            │                                │
│      │           │           │            │ 22. Permission Granted                     │
│      │           │           │            │◀───────────│                                │
│      │           │           │            │            │                                │
│      │ 23. ✅ マイク権限: 許可済み 表示    │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│      │ 24. 「通知を許可」タップ           │            │                                │
│      │──────────────────────────────────────────────────▶│                              │
│      │           │           │            │            │                                │
│      │           │           │            │ 25. UNUserNotificationCenter               │
│      │           │           │            │    .requestAuthorization()                 │
│      │           │           │            │◀───────────│                                │
│      │           │           │            │            │                                │
│      │ 26. ユーザーが「許可」タップ        │            │                                │
│      │──────────────────────────────────────────────────▶│                              │
│      │           │           │            │            │                                │
│      │ 27. ✅ 通知権限: 許可済み 表示     │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│      │ 28. 「次へ」タップ    │            │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │ 29. Swipe to Step 4   │            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 4: チュートリアル（スキップ可能）════════════════                 │
│      │           │           │            │            │                                │
│      │ 30. チュートリアルスライド表示      │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│      │ 31. スワイプ or 「スキップ」タップ  │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │ 32. Navigate to Step 5│            │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Step 5: 完了 ════════════════                                        │
│      │           │           │            │            │                                │
│      │ 33. 「始めましょう！」タップ        │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │           │ 34. POST /api/setup/complete       │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 35. UPDATE staffs SET setup_completed = true            │
│      │           │           │───────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 36. { success: true }  │            │                                │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 37. setSetupCompleted(true)        │            │                                │
│      │──────────▶│           │            │            │                                │
│      │           │           │            │            │                                │
│      │ 38. Navigate to HomeScreen         │            │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│      │  [ホーム画面表示 - 最初のセッション開始を促す]   │                                │
│      │           │           │            │            │                                │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 4.4 🆕 デバイス管理（2025-12-09追加）

#### 4.4.1 iPadデバイス登録・アクティベーションシーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                      iPadデバイスアクティベーション シーケンス                            │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                         │
│  │  Web   │ │  Edge   │ │ Supabase │ │  iPad    │ │  Device  │                         │
│  │ 管理者  │ │ Function│ │    DB    │ │  App    │ │  Secure  │                         │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘                         │
│      │           │           │            │            │                                │
│  ════════════════ Phase 1: デバイス登録（管理者）════════════════                        │
│      │           │           │            │            │                                │
│      │ 1. デバイス管理画面で「新規デバイス追加」クリック        │                                │
│      │───────────────────────────────────▶│            │                                │
│      │           │           │            │            │                                │
│      │ 2. デバイス名、セット面番号入力 → 「追加」クリック        │                                │
│      │───────────────────────────────────▶│            │                                │
│      │           │           │            │            │                                │
│      │           │ 3. POST /api/devices   │            │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 4. INSERT INTO devices (status='pending')               │
│      │           │           │──────────────────────▶│                                │
│      │           │           │            │            │                                │
│      │           │           │ 5. { device_id }       │                                │
│      │           │           │◀──────────────────────│                                │
│      │           │           │            │            │                                │
│      │           │ 6. generate_activation_code()      │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 7. 6桁コード生成 + INSERT device_activations            │
│      │           │           │──────────────────────▶│                                │
│      │           │           │            │            │                                │
│      │           │ 8. { activation_code: "123456", expires_at }                        │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │ 9. アクティベーションコード表示（QR含む）               │                                │
│      │◀──────────│           │            │            │                                │
│      │           │           │            │            │                                │
│  ════════════════ Phase 2: iPadアクティベーション ════════════════                      │
│      │           │           │            │            │                                │
│      │           │           │            │ 10. アプリ初回起動                          │
│      │           │           │            │────────────────────────────────────────────▶
│      │           │           │            │            │                                │
│      │           │           │            │ 11. デバイスID確認                          │
│      │           │           │            │────────────────────────────────────────────▶
│      │           │           │            │            │                                │
│      │           │           │            │ 12. 未登録（アクティベーション画面表示）     │
│      │           │           │            │◀───────────│                                │
│      │           │           │            │            │                                │
│      │           │           │            │ 13. 6桁コード入力 → 「アクティベート」タップ │
│      │           │           │            │───────────▶│                                │
│      │           │           │            │            │                                │
│      │           │ 14. POST /api/devices/activate     │                                │
│      │           │◀──────────────────────────────────│                                │
│      │           │           │            │            │                                │
│      │           │ 15. activate_device()  │            │                                │
│      │           │──────────▶│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │ 16. コード検証 + デバイス更新                            │
│      │           │           │     UPDATE devices SET status='active'                  │
│      │           │           │     UPDATE device_activations SET used_at               │
│      │           │           │──────────────────────▶│                                │
│      │           │           │            │            │                                │
│      │           │ 17. { success: true, device_id, salon_id }                          │
│      │           │◀──────────│            │            │                                │
│      │           │           │            │            │                                │
│      │           │           │            │ 18. デバイスID保存                          │
│      │           │           │            │────────────────────────────────────────────▶
│      │           │           │            │            │                                │
│      │           │           │            │ 19. [セッション開始画面表示]               │
│      │           │           │            │◀───────────│                                │
│      │           │           │            │            │                                │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.5 🆕 スタッフ声紋識別（2025-12-09追加）

#### 4.5.1 スタッフ声紋登録シーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           スタッフ声紋登録 シーケンス                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │  iPad  │ │ Zustand │ │  Audio   │ │ pyannote │ │  Edge    │ │ Supabase │           │
│  │  App   │ │  Store  │ │ Service  │ │  Server  │ │ Function │ │    DB    │           │
│  └───┬────┘ └────┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│      │           │           │            │            │            │                  │
│  ════════════════ オンボーディング Step 4: 声紋登録 ════════════════                    │
│      │           │           │            │            │            │                  │
│      │ 1. 声紋登録画面表示   │            │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 2. 「録音を開始」タップ            │            │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 3. requestMicPermission()          │            │                  │
│      │           │──────────▶│            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 4. AVAudioSession.start()           │                  │
│      │           │           │──────────────────────────────────────────────────────▶│
│      │           │           │            │            │            │                  │
│      │ 5. 「以下の文章を読み上げてください...」表示         │            │                  │
│      │    例:「本日はご来店ありがとうございます。        │            │                  │
│      │        髪のお悩みなどございましたら...」          │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │  ┌────────────────────────────────────────────┐ │            │                  │
│      │  │ 6. スタッフが文章を読み上げ（30秒以上）     │ │            │                  │
│      │  │    - 録音時間表示                          │ │            │                  │
│      │  │    - 音量レベル表示                        │ │            │                  │
│      │  └────────────────────────────────────────────┘ │            │                  │
│      │           │           │            │            │            │                  │
│      │ 7. 「録音を停止」タップ（30秒経過後アクティブ）     │            │                  │
│      │───────────────────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │ 8. AVAudioSession.stop()            │                  │
│      │           │           │──────────────────────────────────────────────────────▶│
│      │           │           │            │            │            │                  │
│      │           │           │ 9. WAV File (30秒以上)              │                  │
│      │           │           │◀──────────────────────────────────────────────────────│
│      │           │           │            │            │            │                  │
│      │ 10. 「声紋を登録中...」表示         │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 11. POST /extract-embedding (multipart)        │                  │
│      │           │───────────────────────▶│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │ ┌──────────────────────┐                  │
│      │           │           │            │ │ 12. pyannote処理     │                  │
│      │           │           │            │ │     - 音声読み込み   │                  │
│      │           │           │            │ │     - 埋め込み抽出   │                  │
│      │           │           │            │ │     - 512次元ベクトル│                  │
│      │           │           │            │ └──────────┬───────────┘                  │
│      │           │           │            │            │            │                  │
│      │           │ 13. { embedding: VECTOR(512), quality_score }  │                  │
│      │           │◀──────────────────────│            │            │                  │
│      │           │           │            │            │            │                  │
│      │           │ 14. POST /api/staffs/voice-register            │                  │
│      │           │───────────────────────────────────▶│            │                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │ 15. register_staff_voice()   │
│      │           │           │            │            │───────────▶│                  │
│      │           │           │            │            │            │                  │
│      │           │           │            │            │            │ 16. UPDATE staffs │
│      │           │           │            │            │            │     SET voice_    │
│      │           │           │            │            │            │     embedding,    │
│      │           │           │            │            │            │     voice_        │
│      │           │           │            │            │            │     registered_at │
│      │           │           │            │            │──────────────────────────────▶
│      │           │           │            │            │            │                  │
│      │           │ 17. { success: true, sample_count: 1 }         │                  │
│      │           │◀──────────────────────────────────│            │                  │
│      │           │           │            │            │            │                  │
│      │ 18. 「声紋登録が完了しました！」表示              │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│      │ 19. Navigate to Step 5 (完了)      │            │            │                  │
│      │◀──────────│           │            │            │            │                  │
│      │           │           │            │            │            │                  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.5.2 セッション中スタッフ自動識別シーケンス

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                      セッション中スタッフ自動識別 シーケンス                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │  iPad  │ │ process- │ │ pyannote │ │ identify-│ │ Supabase │ │ Realtime │          │
│  │  App   │ │  audio   │ │  Server  │ │  staff   │ │    DB    │ │ Channel  │          │
│  └───┬────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘          │
│      │           │            │            │            │            │                 │
│  ════════════════ 最初の音声チャンク処理時 ════════════════                             │
│      │           │            │            │            │            │                 │
│      │ 1. POST /process-audio (first chunk, with device_id)        │                 │
│      │──────────▶│            │            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │ 2. INSERT sessions (stylist_id = NULL)          │                 │
│      │           │───────────────────────────────────▶│            │                 │
│      │           │            │            │            │            │                 │
│      │           │ 3. POST /diarize (extract_embeddings=true)      │                 │
│      │           │───────────▶│            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │ ┌──────────────────────┐            │                 │
│      │           │            │ │ 4. pyannote処理      │            │                 │
│      │           │            │ │     - 話者分離       │            │                 │
│      │           │            │ │     - 各話者の       │            │                 │
│      │           │            │ │       埋め込み抽出   │            │                 │
│      │           │            │ └──────────┬───────────┘            │                 │
│      │           │            │            │            │            │                 │
│      │           │ 5. { speakers: [                   │            │                 │
│      │           │      { label: "SPEAKER_00", embedding: [...], duration_ms },      │
│      │           │      { label: "SPEAKER_01", embedding: [...], duration_ms }       │
│      │           │    ], segments: [...] }            │            │                 │
│      │           │◀───────────│            │            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │ 6. POST /identify-staff            │            │                 │
│      │           │───────────────────────▶│            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │ 7. match_staff_by_voice()               │
│      │           │            │            │     (各話者の埋め込みで検索)              │
│      │           │            │            │───────────▶│            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 8. SELECT staffs            │
│      │           │            │            │            │    WHERE salon_id AND       │
│      │           │            │            │            │    voice_embedding <=>      │
│      │           │            │            │            │    > threshold              │
│      │           │            │            │◀───────────│            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │ 9. スタッフ特定ロジック                   │
│      │           │            │            │    - 発話時間が長い話者 = スタッフ候補    │
│      │           │            │            │    - 声紋マッチング結果と照合            │
│      │           │            │            │    - 信頼度スコア計算                    │
│      │           │            │            │──────────────────────────────────▶       │
│      │           │            │            │            │            │                 │
│      │           │            │            │ 10. [マッチ成功: confidence >= 0.75]     │
│      │           │            │            │     UPDATE sessions SET                  │
│      │           │            │            │       stylist_id = matched_staff_id,     │
│      │           │            │            │       stylist_match_confidence           │
│      │           │            │            │───────────▶│            │                 │
│      │           │            │            │            │            │                 │
│      │           │ 11. { stylist_id, name, confidence, confidence_level }            │
│      │           │◀──────────────────────│            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │ 12. Broadcast 'staff_identified'   │            │                 │
│      │           │────────────────────────────────────────────────▶│                 │
│      │           │            │            │            │            │                 │
│      │ 13. onStaffIdentified(payload)     │            │            │                 │
│      │◀──────────────────────────────────────────────────────────────│                 │
│      │           │            │            │            │            │                 │
│      │ 14. UI更新: 「担当: 田中さん」表示  │            │            │                 │
│      │───────────────────────▶│            │            │            │                 │
│      │           │            │            │            │            │                 │
│  ════════════════ 低信頼度の場合（0.65 <= confidence < 0.75）════════════════          │
│      │           │            │            │            │            │                 │
│      │           │            │            │ 15. [低信頼度マッチ]                     │
│      │           │            │            │     stylist_id は設定するが              │
│      │           │            │            │     確認UIを表示                         │
│      │           │            │            │───────────▶│            │                 │
│      │           │            │            │            │            │                 │
│      │ 16. 確認ダイアログ: 「田中さんですか？」          │            │                 │
│      │◀──────────────────────────────────────────────────────────────│                 │
│      │           │            │            │            │            │                 │
│      │ 17. スタッフが確認/修正 → 「はい」or スタッフ選択  │            │                 │
│      │───────────────────────────────────▶│            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │ 18. POST /api/sessions/{id}/confirm-staff       │                 │
│      │           │───────────────────────────────────▶│            │                 │
│      │           │            │            │            │            │                 │
│      │           │            │            │            │ 19. UPDATE sessions         │
│      │           │            │            │            │     SET stylist_id,         │
│      │           │            │            │            │     stylist_match_          │
│      │           │            │            │            │     confidence = 1.0        │
│      │           │            │            │            │     (手動確認済み)          │
│      │           │            │            │───────────▶│            │                 │
│      │           │            │            │            │            │                 │
│  ════════════════ マッチ失敗の場合（confidence < 0.65）════════════════                │
│      │           │            │            │            │            │                 │
│      │ 20. スタッフ選択画面: 「担当スタッフを選択してください」      │                 │
│      │◀──────────────────────────────────────────────────────────────│                 │
│      │           │            │            │            │            │                 │
│      │ 21. スタッフを手動選択  │            │            │            │                 │
│      │───────────────────────────────────▶│            │            │                 │
│      │           │            │            │            │            │                 │
│      │           │ 22. POST /api/sessions/{id}/set-staff           │                 │
│      │           │           + 選択したスタッフの声紋を                               │
│      │           │             学習用データとして保存（任意）                         │
│      │           │───────────────────────────────────▶│            │                 │
│      │           │            │            │            │            │                 │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---
