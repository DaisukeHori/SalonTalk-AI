## 2. ã‚¯ãƒ©ã‚¹è¨­è¨ˆ

### 2.1 ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«æ¦‚è¦å›³                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        Bounded Context: Salon                        â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚   â”‚
â”‚  â”‚   â”‚   Salon     â”‚â—†â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Staff     â”‚                          â”‚   â”‚
â”‚  â”‚   â”‚ (Aggregate) â”‚   1:n   â”‚  (Entity)   â”‚                          â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚  â”‚         â”‚                       â”‚                                   â”‚   â”‚
â”‚  â”‚         â”‚                       â”‚ 1:n                               â”‚   â”‚
â”‚  â”‚         â”‚                       â–¼                                   â”‚   â”‚
â”‚  â”‚         â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚   â”‚
â”‚  â”‚         â”‚               â”‚  StaffRole  â”‚                             â”‚   â”‚
â”‚  â”‚         â”‚               â”‚(ValueObject)â”‚                             â”‚   â”‚
â”‚  â”‚         â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚   â”‚
â”‚  â”‚         â”‚                                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         â”‚            Bounded Context: Session                       â”‚   â”‚
â”‚  â”‚         â”‚                                                           â”‚   â”‚
â”‚  â”‚         â”‚ 1:n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Session   â”‚â—†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚                  â”‚ (Aggregate) â”‚   1:n    â”‚   1:n   â”‚   1:1   â”‚    â”‚   â”‚
â”‚  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚         â”‚         â”‚    â”‚   â”‚
â”‚  â”‚                        â”‚                  â”‚         â”‚         â”‚    â”‚   â”‚
â”‚  â”‚                        â”‚            â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â” â”Œâ”€â”€â”€â”´â”€â”€â”€â” â”Œâ”€â”€â”€â”´â”€â”€â”â”‚   â”‚
â”‚  â”‚                        â”‚            â”‚Transcriptâ”‚ â”‚Analysisâ”‚ â”‚Reportâ”‚â”‚   â”‚
â”‚  â”‚                        â”‚            â”‚ (Entity) â”‚ â”‚(Entity)â”‚ â”‚(Ent.)â”‚â”‚   â”‚
â”‚  â”‚                        â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â”‚                        â”‚                                            â”‚   â”‚
â”‚  â”‚                  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                      â”‚   â”‚
â”‚  â”‚                  â”‚  Speaker  â”‚                                      â”‚   â”‚
â”‚  â”‚                  â”‚  Segment  â”‚                                      â”‚   â”‚
â”‚  â”‚                  â”‚ (Entity)  â”‚                                      â”‚   â”‚
â”‚  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Bounded Context: Analysis                        â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚   â”‚
â”‚  â”‚   â”‚AnalysisResultâ”‚                                                  â”‚   â”‚
â”‚  â”‚   â”‚ (Aggregate) â”‚                                                   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚   â”‚
â”‚  â”‚          â”‚                                                          â”‚   â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚    â”‚           â”‚             â”‚             â”‚             â”‚         â”‚   â”‚
â”‚  â”‚    â–¼           â–¼             â–¼             â–¼             â–¼         â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚ â”‚TalkRatioâ”‚ â”‚Questionâ”‚ â”‚ Emotion  â”‚ â”‚ Concern  â”‚ â”‚Conversionâ”‚      â”‚   â”‚
â”‚  â”‚ â”‚ (VO)   â”‚ â”‚Analysisâ”‚ â”‚ Analysis â”‚ â”‚ Keywords â”‚ â”‚  (VO)    â”‚      â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ (VO)   â”‚ â”‚  (VO)    â”‚ â”‚  (VO)    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Bounded Context: SuccessCase                     â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚   â”‚
â”‚  â”‚   â”‚ SuccessCase â”‚â—†â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Embedding  â”‚                          â”‚   â”‚
â”‚  â”‚   â”‚ (Aggregate) â”‚   1:1   â”‚(ValueObject)â”‚                          â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Bounded Context: Training                        â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚   â”‚
â”‚  â”‚   â”‚  Scenario   â”‚         â”‚  Roleplay   â”‚                          â”‚   â”‚
â”‚  â”‚   â”‚ (Aggregate) â”‚         â”‚  Session    â”‚                          â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ (Aggregate) â”‚                          â”‚   â”‚
â”‚  â”‚                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚  â”‚                                  â”‚                                  â”‚   â”‚
â”‚  â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                          â”‚   â”‚
â”‚  â”‚                           â”‚  Evaluation â”‚                          â”‚   â”‚
â”‚  â”‚                           â”‚(ValueObject)â”‚                          â”‚   â”‚
â”‚  â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  å‡¡ä¾‹:                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â” Aggregate Root    â—†â”€â”€â”€â”€ é›†ç´„é–¢ä¿‚                                   â”‚
â”‚  â””â”€â”€â”€â”˜                   â”€â”€â”€â”€â–¶ å‚ç…§é–¢ä¿‚                                    â”‚
â”‚  (VO) = Value Object                                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®šç¾©

> **ğŸ“ å®Ÿè£…ã«ãŠã‘ã‚‹å‹å®šç¾©æ–¹é‡ï¼ˆ2025-12-05æ›´æ–°ï¼‰**
>
> æœ¬è¨­è¨ˆæ›¸ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®šç¾©ã¯**æ¦‚å¿µãƒ¢ãƒ‡ãƒ«**ã¨ã—ã¦è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚
> **å®Ÿè£…ã§ã¯ Supabase ç”Ÿæˆå‹ï¼ˆsnake_caseï¼‰ã‚’å˜ä¸€ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨**ã—ã¾ã™ã€‚
>
> ```typescript
> // å®Ÿè£…ã§ã®å‹ä½¿ç”¨ä¾‹
> import type { Database } from '@/types/database';
> type Salon = Database['public']['Tables']['salons']['Row'];
>
> // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯ snake_case
> const salon: Salon = {
>   id: 'uuid',
>   name: 'ã‚µãƒ­ãƒ³å',
>   seats_count: 5,        // snake_case
>   created_at: '...',     // snake_case
>   // ...
> };
> ```
>
> è©³ç´°ã¯ã€Œ12-ä»˜éŒ².md > 12.1.3 å‹å®šç¾©ã®å˜ä¸€ã‚½ãƒ¼ã‚¹åŸå‰‡ã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### 2.2.1 Salonï¼ˆåº—èˆ—ï¼‰

```typescript
// src/domain/entities/Salon.ts

import { SalonId, SalonSettings, Plan } from '../valueObjects';

/**
 * åº—èˆ—ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 * é›†ç´„ãƒ«ãƒ¼ãƒˆ
 */
export interface Salon {
  readonly id: SalonId;
  readonly name: string;
  readonly address: string | null;
  readonly phone: string | null;
  readonly plan: Plan;
  readonly seatsCount: number | null;
  readonly settings: SalonSettings;
  readonly createdAt: Date;
  readonly updatedAt: Date;
}

/**
 * åº—èˆ—ä½œæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface CreateSalonParams {
  name: string;
  address?: string;
  phone?: string;
  plan?: Plan;
  seatsCount?: number;
  settings?: Partial<SalonSettings>;
}

/**
 * åº—èˆ—æ›´æ–°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface UpdateSalonParams {
  name?: string;
  address?: string;
  phone?: string;
  plan?: Plan;
  seatsCount?: number;
  settings?: Partial<SalonSettings>;
}

/**
 * åº—èˆ—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export const SalonDomain = {
  /**
   * åº—èˆ—ã‚’ä½œæˆ
   */
  create(params: CreateSalonParams): Omit<Salon, 'id' | 'createdAt' | 'updatedAt'> {
    return {
      name: params.name,
      address: params.address ?? null,
      phone: params.phone ?? null,
      plan: params.plan ?? 'standard',
      seatsCount: params.seatsCount ?? null,
      settings: {
        notification: {
          enablePush: true,
          enableEmail: true,
          concernDetectionAlert: true,
          sessionCompleteAlert: true,
        },
        analysis: {
          idealTalkRatio: 40,
          minQuestionCount: 8,
          concernKeywords: ['ä¹¾ç‡¥', 'åºƒãŒã‚Š', 'ãƒ‘ã‚µã¤ã', 'ãƒ€ãƒ¡ãƒ¼ã‚¸', 'ã†ã­ã‚Š', 'è–„æ¯›', 'ç™½é«ª'],
        },
        display: {
          showRanking: true,
          anonymizeCustomer: false,
        },
        ...params.settings,
      },
    };
  },

  /**
   * ãƒ—ãƒ©ãƒ³ã®æ©Ÿèƒ½åˆ¶é™ã‚’ç¢ºèª
   */
  canUseFeature(salon: Salon, feature: keyof PlanFeatures): boolean {
    const planFeatures: Record<Plan, PlanFeatures> = {
      free: {
        aiAnalysis: false,
        realtimeAssist: false,
        report: true,
        training: false,
        apiAccess: false,
        maxSessions: 10,
        maxStaff: 3,
      },
      standard: {
        aiAnalysis: true,
        realtimeAssist: true,
        report: true,
        training: false,
        apiAccess: false,
        maxSessions: 100,
        maxStaff: 10,
      },
      premium: {
        aiAnalysis: true,
        realtimeAssist: true,
        report: true,
        training: true,
        apiAccess: false,
        maxSessions: 500,
        maxStaff: 30,
      },
      enterprise: {
        aiAnalysis: true,
        realtimeAssist: true,
        report: true,
        training: true,
        apiAccess: true,
        maxSessions: -1, // ç„¡åˆ¶é™
        maxStaff: -1,
      },
    };
    return planFeatures[salon.plan][feature];
  },

  /**
   * ã‚¹ã‚¿ãƒƒãƒ•ä¸Šé™ã‚’ç¢ºèª
   */
  canAddStaff(salon: Salon, currentStaffCount: number): boolean {
    const maxStaff = this.getMaxStaff(salon);
    return maxStaff === -1 || currentStaffCount < maxStaff;
  },

  /**
   * æœ€å¤§ã‚¹ã‚¿ãƒƒãƒ•æ•°ã‚’å–å¾—
   */
  getMaxStaff(salon: Salon): number {
    const limits: Record<Plan, number> = {
      free: 3,
      standard: 10,
      premium: 30,
      enterprise: -1,
    };
    return limits[salon.plan];
  },
};

interface PlanFeatures {
  aiAnalysis: boolean;
  realtimeAssist: boolean;
  report: boolean;
  training: boolean;
  apiAccess: boolean;
  maxSessions: number;
  maxStaff: number;
}
```

#### 2.2.2 Staffï¼ˆã‚¹ã‚¿ãƒƒãƒ•ï¼‰

```typescript
// src/domain/entities/Staff.ts

import { StaffId, SalonId, AuthUserId, StaffRole, StaffSettings } from '../valueObjects';

/**
 * ã‚¹ã‚¿ãƒƒãƒ•ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 * æ³¨: staffs.id = auth.users(id) æ§‹é€ ï¼ˆç›´æ¥å‚ç…§ï¼‰
 */
export interface Staff {
  readonly id: StaffId;  // = auth.users(id)
  readonly salonId: SalonId;
  readonly name: string;
  readonly email: string;
  readonly role: StaffRole;  // 'stylist' | 'manager' | 'owner' | 'admin'
  readonly avatarUrl: string | null;
  readonly isActive: boolean;
  readonly createdAt: Date;
  readonly updatedAt: Date;
}

/**
 * ã‚¹ã‚¿ãƒƒãƒ•ä½œæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 * æ³¨: id ã¯ auth.users(id) ã¨åŒã˜å€¤ã‚’ä½¿ç”¨
 */
export interface CreateStaffParams {
  id: StaffId;  // = auth.users(id)
  salonId: SalonId;
  name: string;
  email: string;
  role: StaffRole;
}

/**
 * ã‚¹ã‚¿ãƒƒãƒ•æ›´æ–°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface UpdateStaffParams {
  name?: string;
  role?: StaffRole;
  avatarUrl?: string;
  isActive?: boolean;
}

/**
 * ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export const StaffDomain = {
  /**
   * ã‚¹ã‚¿ãƒƒãƒ•ã‚’ä½œæˆ
   */
  create(params: CreateStaffParams): Omit<Staff, 'createdAt' | 'updatedAt'> {
    return {
      id: params.id,
      salonId: params.salonId,
      name: params.name,
      email: params.email.toLowerCase(),
      role: params.role,
      avatarUrl: null,
      isActive: true,
    };
  },

  /**
   * æ¨©é™ãƒã‚§ãƒƒã‚¯
   */
  hasPermission(staff: Staff, permission: Permission): boolean {
    const rolePermissions: Record<StaffRole, Permission[]> = {
      owner: [
        'session:create', 'session:read:own', 'session:read:all',
        'report:read:own', 'report:read:all', 'report:export',
        'staff:manage', 'salon:settings',
        'success-case:create', 'success-case:read',
        'training:use', 'dashboard:view', 'analytics:export',
      ],
      manager: [
        'session:create', 'session:read:own', 'session:read:all',
        'report:read:own', 'report:read:all', 'report:export',
        'staff:manage',
        'success-case:create', 'success-case:read',
        'training:use', 'dashboard:view', 'analytics:export',
      ],
      stylist: [
        'session:create', 'session:read:own',
        'report:read:own',
        'success-case:read',
        'training:use',
      ],
      admin: [
        'session:create', 'session:read:own', 'session:read:all',
        'report:read:own', 'report:read:all', 'report:export',
        'staff:manage', 'salon:settings',
        'success-case:create', 'success-case:read',
        'training:use', 'dashboard:view', 'analytics:export',
      ],
      assistant: [
        'session:read:own',
        'report:read:own',
        'success-case:read',
        'training:use',
      ],
    };
    return rolePermissions[staff.role].includes(permission);
  },

  /**
   * ä»–ã‚¹ã‚¿ãƒƒãƒ•ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã‹
   */
  canAccessOtherStaffData(staff: Staff): boolean {
    return staff.role === 'owner' || staff.role === 'manager' || staff.role === 'admin';
  },

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å¯èƒ½ã‹
   */
  canStartSession(staff: Staff): boolean {
    return staff.isActive && ['owner', 'manager', 'stylist', 'admin', 'assistant'].includes(staff.role);
  },
};

type Permission =
  | 'session:create' | 'session:read:own' | 'session:read:all'
  | 'report:read:own' | 'report:read:all' | 'report:export'
  | 'staff:manage' | 'salon:settings'
  | 'success-case:create' | 'success-case:read'
  | 'training:use' | 'dashboard:view' | 'analytics:export';
```

#### 2.2.3 Sessionï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰

```typescript
// src/domain/entities/Session.ts

import { 
  SessionId, SalonId, StaffId, SessionStatus, 
  DiarizationStatus, CustomerInfo 
} from '../valueObjects';

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 * é›†ç´„ãƒ«ãƒ¼ãƒˆ
 */
export interface Session {
  readonly id: SessionId;
  readonly salonId: SalonId;
  readonly stylistId: StaffId;
  readonly startedAt: Date;
  readonly endedAt: Date | null;
  readonly status: SessionStatus;
  readonly customerInfo: CustomerInfo | null;
  readonly diarizationStatus: DiarizationStatus;
  readonly createdAt: Date;
  readonly updatedAt: Date;
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface CreateSessionParams {
  salonId: SalonId;
  stylistId: StaffId;
  customerInfo?: CustomerInfo;
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export const SessionDomain = {
  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
   */
  create(params: CreateSessionParams): Omit<Session, 'id' | 'createdAt' | 'updatedAt'> {
    return {
      salonId: params.salonId,
      stylistId: params.stylistId,
      startedAt: new Date(),
      endedAt: null,
      status: 'recording',
      customerInfo: params.customerInfo ?? null,
      diarizationStatus: 'pending',
    };
  },

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†
   */
  end(session: Session): Partial<Session> {
    if (session.status !== 'recording') {
      throw new Error(`Cannot end session with status: ${session.status}`);
    }
    return {
      endedAt: new Date(),
      status: 'processing',
    };
  },

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†
   */
  complete(session: Session): Partial<Session> {
    if (session.status !== 'processing') {
      throw new Error(`Cannot complete session with status: ${session.status}`);
    }
    return {
      status: 'completed',
    };
  },

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤±æ•—
   */
  fail(session: Session): Partial<Session> {
    return {
      status: 'error',
    };
  },

  /**
   * è©±è€…åˆ†é›¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
   */
  updateDiarizationStatus(
    session: Session, 
    status: DiarizationStatus
  ): Partial<Session> {
    return {
      diarizationStatus: status,
    };
  },

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ï¼ˆåˆ†ï¼‰ã‚’è¨ˆç®—
   */
  getDurationMinutes(session: Session): number {
    const endTime = session.endedAt ?? new Date();
    const diffMs = endTime.getTime() - session.startedAt.getTime();
    return Math.floor(diffMs / 1000 / 60);
  },

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹
   */
  isActive(session: Session): boolean {
    return session.status === 'recording';
  },

  /**
   * Realtimeãƒãƒ£ãƒ³ãƒãƒ«åã‚’ç”Ÿæˆ
   */
  getRealtimeChannel(session: Session): string {
    return `session:${session.id}`;
  },

  /**
   * éŸ³å£°ä¿å­˜ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
   */
  getAudioPath(session: Session, chunkIndex: number): string {
    const date = session.startedAt.toISOString().split('T')[0];
    return `${session.salonId}/${date}/${session.id}/chunk_${chunkIndex.toString().padStart(4, '0')}.wav`;
  },
};
```

#### 2.2.4 Transcriptï¼ˆæ–‡å­—èµ·ã“ã—ï¼‰

```typescript
// src/domain/entities/Transcript.ts

import { TranscriptId, SessionId } from '../valueObjects';

/**
 * æ–‡å­—èµ·ã“ã—ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 */
export interface Transcript {
  readonly id: TranscriptId;
  readonly sessionId: SessionId;
  readonly chunkIndex: number;
  readonly text: string;
  readonly startTimeMs: number;  // ãƒŸãƒªç§’ï¼ˆDB: start_time_ms INTEGERï¼‰
  readonly endTimeMs: number;    // ãƒŸãƒªç§’ï¼ˆDB: end_time_ms INTEGERï¼‰
  readonly audioUrl: string | null;
  readonly confidence: number | null;
  readonly createdAt: Date;
}

/**
 * æ–‡å­—èµ·ã“ã—ä½œæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface CreateTranscriptParams {
  sessionId: SessionId;
  chunkIndex: number;
  text: string;
  startTimeMs: number;
  endTimeMs: number;
  audioUrl?: string;
  confidence?: number;
}

/**
 * æ–‡å­—èµ·ã“ã—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export const TranscriptDomain = {
  /**
   * æ–‡å­—èµ·ã“ã—ã‚’ä½œæˆ
   */
  create(params: CreateTranscriptParams): Omit<Transcript, 'id' | 'createdAt'> {
    return {
      sessionId: params.sessionId,
      chunkIndex: params.chunkIndex,
      text: params.text.trim(),
      startTimeMs: params.startTimeMs,
      endTimeMs: params.endTimeMs,
      audioUrl: params.audioUrl ?? null,
      confidence: params.confidence ?? null,
    };
  },

  /**
   * æ™‚é–“ç¯„å›²ãŒå¦¥å½“ã‹æ¤œè¨¼ï¼ˆãƒŸãƒªç§’ï¼‰
   */
  isValidTimeRange(startTimeMs: number, endTimeMs: number): boolean {
    return startTimeMs >= 0 && endTimeMs > startTimeMs;
  },

  /**
   * ç™ºè©±æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ã‚’è¨ˆç®—
   */
  getDurationMs(transcript: Transcript): number {
    return transcript.endTimeMs - transcript.startTimeMs;
  },

  /**
   * è¤‡æ•°ã®Transcriptã‚’ãƒãƒ¼ã‚¸
   */
  mergeTexts(transcripts: Transcript[]): string {
    return transcripts
      .sort((a, b) => a.chunkIndex - b.chunkIndex)
      .map(t => t.text)
      .join(' ');
  },
};
```

#### 2.2.5 SpeakerSegmentï¼ˆè©±è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼‰

```typescript
// src/domain/entities/SpeakerSegment.ts

import { SpeakerSegmentId, SessionId, Speaker } from '../valueObjects';

/**
 * è©±è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 */
export interface SpeakerSegment {
  readonly id: SpeakerSegmentId;
  readonly sessionId: SessionId;
  readonly chunkIndex: number;
  readonly speaker: Speaker;  // 'stylist' | 'customer' | 'unknown'
  readonly text: string;
  readonly startTimeMs: number;  // ãƒŸãƒªç§’ï¼ˆDB: start_time_ms INTEGERï¼‰
  readonly endTimeMs: number;    // ãƒŸãƒªç§’ï¼ˆDB: end_time_ms INTEGERï¼‰
  readonly confidence: number | null;
  readonly createdAt: Date;
}

/**
 * è©±è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä½œæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface CreateSpeakerSegmentParams {
  sessionId: SessionId;
  chunkIndex: number;
  speaker: Speaker;
  text: string;
  startTimeMs: number;
  endTimeMs: number;
  confidence?: number;
}

/**
 * è©±è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export const SpeakerSegmentDomain = {
  /**
   * è©±è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
   */
  create(params: CreateSpeakerSegmentParams): Omit<SpeakerSegment, 'id' | 'createdAt'> {
    return {
      sessionId: params.sessionId,
      chunkIndex: params.chunkIndex,
      speaker: params.speaker,
      text: params.text,
      startTimeMs: params.startTimeMs,
      endTimeMs: params.endTimeMs,
      confidence: params.confidence ?? null,
    };
  },

  /**
   * pyannoteã®çµæœã‚’Speakerã«å¤‰æ›
   * SPEAKER_00 -> stylist, SPEAKER_01 -> customer
   * ï¼ˆæœ€åˆã«è©±ã—ãŸæ–¹ã‚’ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã¨ä»®å®šï¼‰
   */
  mapPyannoteLabel(label: string, isFirstSpeaker: boolean): Speaker {
    // æœ€åˆã«ç™ºè©±ã—ãŸæ–¹ã‚’ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã¨ã™ã‚‹ï¼ˆæ–½è¡“é–‹å§‹æ™‚ã¯ç¾å®¹å¸«ãŒè©±ã—ã‹ã‘ã‚‹ï¼‰
    if (isFirstSpeaker) {
      return label === 'SPEAKER_00' ? 'stylist' : 'customer';
    }
    return label === 'SPEAKER_00' ? 'customer' : 'stylist';
  },

  /**
   * ç™ºè©±æ™‚é–“ã‚’è¨ˆç®—ï¼ˆãƒŸãƒªç§’ï¼‰
   */
  getDurationMs(segment: SpeakerSegment): number {
    return segment.endTimeMs - segment.startTimeMs;
  },

  /**
   * è©±è€…åˆ¥ã®ç™ºè©±æ™‚é–“ã‚’é›†è¨ˆï¼ˆãƒŸãƒªç§’ï¼‰
   */
  calculateTalkTimeMs(segments: SpeakerSegment[]): { stylist: number; customer: number } {
    return segments.reduce(
      (acc, segment) => {
        const duration = this.getDurationMs(segment);
        if (segment.speaker === 'stylist') {
          acc.stylist += duration;
        } else if (segment.speaker === 'customer') {
          acc.customer += duration;
        }
        return acc;
      },
      { stylist: 0, customer: 0 }
    );
  },

  /**
   * ãƒ†ã‚­ã‚¹ãƒˆã¨è©±è€…æƒ…å ±ã‚’ãƒãƒ¼ã‚¸
   */
  mergeWithTranscripts(
    segments: SpeakerSegment[],
    transcripts: Transcript[]
  ): TranscriptWithSpeaker[] {
    const result: TranscriptWithSpeaker[] = [];

    for (const segment of segments) {
      // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ™‚é–“ç¯„å›²ã«å«ã¾ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ï¼ˆãƒŸãƒªç§’ã§æ¯”è¼ƒï¼‰
      const matchingTranscripts = transcripts.filter(
        t => t.startTimeMs >= segment.startTimeMs && t.endTimeMs <= segment.endTimeMs
      );

      if (matchingTranscripts.length > 0) {
        result.push({
          speaker: segment.speaker,
          text: matchingTranscripts.map(t => t.text).join(' '),
          startTimeMs: segment.startTimeMs,
          endTimeMs: segment.endTimeMs,
        });
      } else if (segment.text) {
        result.push({
          speaker: segment.speaker,
          text: segment.text,
          startTimeMs: segment.startTimeMs,
          endTimeMs: segment.endTimeMs,
        });
      }
    }

    return result.sort((a, b) => a.startTimeMs - b.startTimeMs);
  },
};

interface TranscriptWithSpeaker {
  speaker: Speaker;
  text: string;
  startTimeMs: number;
  endTimeMs: number;
}
```

#### 2.2.6 SessionAnalysisï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æï¼‰

```typescript
// src/domain/entities/SessionAnalysis.ts

import { 
  SessionAnalysisId, SessionId, IndicatorType, 
  AnalysisDetails 
} from '../valueObjects';

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 */
export interface SessionAnalysis {
  readonly id: SessionAnalysisId;
  readonly sessionId: SessionId;
  readonly chunkIndex: number;
  readonly indicatorType: IndicatorType;
  readonly value: number;
  readonly score: number;  // 0-100
  readonly details: AnalysisDetails;
  readonly createdAt: Date;
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æä½œæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface CreateSessionAnalysisParams {
  sessionId: SessionId;
  chunkIndex: number;
  indicatorType: IndicatorType;
  value: number;
  score: number;
  details: AnalysisDetails;
}

/**
 * åˆ†æçµæœã‚’ã¾ã¨ã‚ãŸå‹
 */
export interface AnalysisResultSet {
  talkRatio: SessionAnalysis | null;
  questionAnalysis: SessionAnalysis | null;
  emotionAnalysis: SessionAnalysis | null;
  concernKeywords: SessionAnalysis | null;
  proposalTiming: SessionAnalysis | null;
  proposalQuality: SessionAnalysis | null;
  conversion: SessionAnalysis | null;
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export const SessionAnalysisDomain = {
  /**
   * åˆ†æçµæœã‚’ä½œæˆ
   */
  create(params: CreateSessionAnalysisParams): Omit<SessionAnalysis, 'id' | 'createdAt'> {
    // ã‚¹ã‚³ã‚¢ã¯0-100ã®ç¯„å›²ã«æ­£è¦åŒ–
    const normalizedScore = Math.max(0, Math.min(100, Math.round(params.score)));
    
    return {
      sessionId: params.sessionId,
      chunkIndex: params.chunkIndex,
      indicatorType: params.indicatorType,
      value: params.value,
      score: normalizedScore,
      details: params.details,
    };
  },

  /**
   * ç·åˆã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
   */
  calculateOverallScore(analyses: AnalysisResultSet): number {
    const weights: Record<IndicatorType, number> = {
      talk_ratio: 0.15,
      question_analysis: 0.15,
      emotion_analysis: 0.15,
      concern_keywords: 0.10,
      proposal_timing: 0.15,
      proposal_quality: 0.15,
      conversion: 0.15,
    };

    let totalScore = 0;
    let totalWeight = 0;

    const analysisArray = [
      { type: 'talk_ratio' as const, analysis: analyses.talkRatio },
      { type: 'question_analysis' as const, analysis: analyses.questionAnalysis },
      { type: 'emotion_analysis' as const, analysis: analyses.emotionAnalysis },
      { type: 'concern_keywords' as const, analysis: analyses.concernKeywords },
      { type: 'proposal_timing' as const, analysis: analyses.proposalTiming },
      { type: 'proposal_quality' as const, analysis: analyses.proposalQuality },
      { type: 'conversion' as const, analysis: analyses.conversion },
    ];

    for (const { type, analysis } of analysisArray) {
      if (analysis) {
        totalScore += analysis.score * weights[type];
        totalWeight += weights[type];
      }
    }

    // é‡ã¿ã®åˆè¨ˆã§æ­£è¦åŒ–
    return totalWeight > 0 ? Math.round(totalScore / totalWeight * 100) / 100 : 0;
  },

  /**
   * æŒ‡æ¨™åˆ¥ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚’ç”Ÿæˆ
   */
  toIndicatorScoreMap(analyses: SessionAnalysis[]): Record<IndicatorType, { score: number; value: number }> {
    const result: Partial<Record<IndicatorType, { score: number; value: number }>> = {};
    
    for (const analysis of analyses) {
      result[analysis.indicatorType] = {
        score: analysis.score,
        value: analysis.value,
      };
    }
    
    return result as Record<IndicatorType, { score: number; value: number }>;
  },

  /**
   * æœ€æ–°ã®ãƒãƒ£ãƒ³ã‚¯åˆ†æã‚’å–å¾—
   */
  getLatestByChunk(analyses: SessionAnalysis[]): Map<IndicatorType, SessionAnalysis> {
    const latest = new Map<IndicatorType, SessionAnalysis>();
    
    for (const analysis of analyses) {
      const existing = latest.get(analysis.indicatorType);
      if (!existing || analysis.chunkIndex > existing.chunkIndex) {
        latest.set(analysis.indicatorType, analysis);
      }
    }
    
    return latest;
  },
};
```

#### 2.2.7 SessionReportï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆï¼‰

```typescript
// src/domain/entities/SessionReport.ts

import { 
  SessionReportId, SessionId, IndicatorScores 
} from '../valueObjects';

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 */
export interface SessionReport {
  readonly id: SessionReportId;
  readonly sessionId: SessionId;
  readonly overallScore: number;
  readonly goodPoints: string[];
  readonly improvementPoints: string[];
  readonly actionItems: string[];
  readonly transcriptSummary: string | null;
  readonly aiFeedback: string | null;
  readonly indicatorScores: IndicatorScores;
  readonly createdAt: Date;
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆä½œæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface CreateSessionReportParams {
  sessionId: SessionId;
  overallScore: number;
  goodPoints: string[];
  improvementPoints: string[];
  actionItems: string[];
  transcriptSummary?: string;
  aiFeedback?: string;
  indicatorScores: IndicatorScores;
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export const SessionReportDomain = {
  /**
   * ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ
   */
  create(params: CreateSessionReportParams): Omit<SessionReport, 'id' | 'createdAt'> {
    return {
      sessionId: params.sessionId,
      overallScore: Math.max(0, Math.min(100, Math.round(params.overallScore))),
      goodPoints: params.goodPoints.slice(0, 5),  // æœ€å¤§5ã¤
      improvementPoints: params.improvementPoints.slice(0, 5),
      actionItems: params.actionItems.slice(0, 5),
      transcriptSummary: params.transcriptSummary ?? null,
      aiFeedback: params.aiFeedback ?? null,
      indicatorScores: params.indicatorScores,
    };
  },

  /**
   * ã‚¹ã‚³ã‚¢ã®ãƒ©ãƒ³ã‚¯ã‚’å–å¾—
   */
  getScoreRank(report: SessionReport): ScoreRank {
    if (report.overallScore >= 90) return 'S';
    if (report.overallScore >= 80) return 'A';
    if (report.overallScore >= 70) return 'B';
    if (report.overallScore >= 60) return 'C';
    return 'D';
  },

  /**
   * æœ€ã‚‚æ”¹å–„ãŒå¿…è¦ãªæŒ‡æ¨™ã‚’å–å¾—
   */
  getWeakestIndicator(report: SessionReport): IndicatorType | null {
    let weakest: IndicatorType | null = null;
    let lowestScore = 101;

    for (const [type, data] of Object.entries(report.indicatorScores)) {
      if (data.score < lowestScore) {
        lowestScore = data.score;
        weakest = type as IndicatorType;
      }
    }

    return weakest;
  },

  /**
   * æœ€ã‚‚å„ªã‚Œã¦ã„ã‚‹æŒ‡æ¨™ã‚’å–å¾—
   */
  getStrongestIndicator(report: SessionReport): IndicatorType | null {
    let strongest: IndicatorType | null = null;
    let highestScore = -1;

    for (const [type, data] of Object.entries(report.indicatorScores)) {
      if (data.score > highestScore) {
        highestScore = data.score;
        strongest = type as IndicatorType;
      }
    }

    return strongest;
  },
};

type ScoreRank = 'S' | 'A' | 'B' | 'C' | 'D';
type IndicatorType = 
  | 'talk_ratio' 
  | 'question_analysis' 
  | 'emotion_analysis' 
  | 'concern_keywords' 
  | 'proposal_timing' 
  | 'proposal_quality' 
  | 'conversion';
```

#### 2.2.8 SuccessCaseï¼ˆæˆåŠŸäº‹ä¾‹ï¼‰

```typescript
// src/domain/entities/SuccessCase.ts

import { 
  SuccessCaseId, SalonId, SessionId, StaffId,
  CustomerProfile, Embedding 
} from '../valueObjects';

/**
 * æˆåŠŸäº‹ä¾‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 * é›†ç´„ãƒ«ãƒ¼ãƒˆ
 */
export interface SuccessCase {
  readonly id: SuccessCaseId;
  readonly salonId: SalonId;
  readonly sessionId: SessionId | null;
  readonly stylistId: StaffId | null;
  readonly concernKeywords: string[];
  readonly customerProfile: CustomerProfile | null;
  readonly approachText: string;       // ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå†…å®¹ï¼ˆDBã«å¯¾å¿œï¼‰
  readonly successfulTalk: string | null;  // æˆåŠŸãƒˆãƒ¼ã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
  readonly keyTactics: string[] | null;    // æˆåŠŸè¦å› ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
  readonly result: string;             // çµæœï¼ˆDBã«å¯¾å¿œï¼‰
  readonly soldProduct: string | null;
  readonly conversionRate: number | null;
  readonly embedding: Embedding | null;
  readonly isActive: boolean;          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ©ã‚°
  readonly isPublic: boolean;
  readonly createdAt: Date;
  readonly updatedAt: Date;
}

/**
 * æˆåŠŸäº‹ä¾‹ä½œæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface CreateSuccessCaseParams {
  salonId: SalonId;
  sessionId?: SessionId;
  stylistId?: StaffId;
  concernKeywords: string[];
  customerProfile?: CustomerProfile;
  approachText: string;        // å¿…é ˆ
  successfulTalk?: string;     // ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«
  keyTactics?: string[];       // ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«
  result: string;              // å¿…é ˆ
  soldProduct?: string;
  conversionRate?: number;
  isActive?: boolean;
  isPublic?: boolean;
}

/**
 * æˆåŠŸäº‹ä¾‹æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
 */
export interface SearchSuccessCaseParams {
  concernKeywords?: string[];
  customerProfile?: Partial<CustomerProfile>;
  embedding?: Embedding;
  limit?: number;
  salonId?: SalonId;
  includePublic?: boolean;
}

/**
 * æˆåŠŸäº‹ä¾‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
 */
export const SuccessCaseDomain = {
  /**
   * æˆåŠŸäº‹ä¾‹ã‚’ä½œæˆ
   */
  create(params: CreateSuccessCaseParams): Omit<SuccessCase, 'id' | 'createdAt' | 'updatedAt' | 'embedding'> {
    return {
      salonId: params.salonId,
      sessionId: params.sessionId ?? null,
      stylistId: params.stylistId ?? null,
      concernKeywords: params.concernKeywords,
      customerProfile: params.customerProfile ?? null,
      approachText: params.approachText,
      successfulTalk: params.successfulTalk ?? null,
      keyTactics: params.keyTactics ?? null,
      result: params.result,
      soldProduct: params.soldProduct ?? null,
      conversionRate: params.conversionRate ?? null,
      isActive: params.isActive ?? true,
      isPublic: params.isPublic ?? false,
    };
  },

  /**
   * æ¤œç´¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆï¼ˆEmbeddingç”¨ï¼‰
   */
  generateSearchText(successCase: Omit<SuccessCase, 'id' | 'createdAt' | 'updatedAt' | 'embedding'>): string {
    const parts: string[] = [];

    // æ‚©ã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    if (successCase.concernKeywords.length > 0) {
      parts.push(`æ‚©ã¿: ${successCase.concernKeywords.join(', ')}`);
    }

    // ãŠå®¢æ§˜å±æ€§
    if (successCase.customerProfile) {
      const profile = successCase.customerProfile;
      if (profile.ageGroup) parts.push(`å¹´ä»£: ${profile.ageGroup}`);
      if (profile.gender) parts.push(`æ€§åˆ¥: ${profile.gender}`);
      if (profile.visitFrequency) parts.push(`æ¥åº—é »åº¦: ${profile.visitFrequency}`);
    }

    // ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå†…å®¹
    parts.push(`ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: ${successCase.approachText}`);

    // æˆåŠŸãƒˆãƒ¼ã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
    if (successCase.successfulTalk) {
      parts.push(`ãƒˆãƒ¼ã‚¯: ${successCase.successfulTalk}`);
    }

    // çµæœ
    parts.push(`çµæœ: ${successCase.result}`);

    // ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
    if (successCase.keyTactics && successCase.keyTactics.length > 0) {
      parts.push(`ãƒã‚¤ãƒ³ãƒˆ: ${successCase.keyTactics.join(', ')}`);
    }

    // å•†å“
    if (successCase.soldProduct) {
      parts.push(`å•†å“: ${successCase.soldProduct}`);
    }

    return parts.join('\n');
  },

  /**
   * é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ï¼‰
   */
  calculateSimilarity(embedding1: number[], embedding2: number[]): number {
    if (embedding1.length !== embedding2.length) {
      throw new Error('Embedding dimensions do not match');
    }
    
    let dotProduct = 0;
    let norm1 = 0;
    let norm2 = 0;
    
    for (let i = 0; i < embedding1.length; i++) {
      dotProduct += embedding1[i] * embedding2[i];
      norm1 += embedding1[i] * embedding1[i];
      norm2 += embedding2[i] * embedding2[i];
    }
    
    return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
  },

  /**
   * é–¾å€¤ä»¥ä¸Šã®é¡ä¼¼åº¦ã‚’æŒã¤äº‹ä¾‹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   */
  filterBySimilarity(
    cases: Array<SuccessCase & { similarity: number }>,
    threshold: number = 0.7
  ): Array<SuccessCase & { similarity: number }> {
    return cases
      .filter(c => c.similarity >= threshold)
      .sort((a, b) => b.similarity - a.similarity);
  },
};
```

### 2.3 å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå®šç¾©

```typescript
// src/domain/valueObjects/index.ts

/**
 * è­˜åˆ¥å­å‹ï¼ˆBranded Typesï¼‰
 */
export type SalonId = string & { readonly __brand: 'SalonId' };
export type StaffId = string & { readonly __brand: 'StaffId' };
export type SessionId = string & { readonly __brand: 'SessionId' };
export type TranscriptId = string & { readonly __brand: 'TranscriptId' };
export type SpeakerSegmentId = string & { readonly __brand: 'SpeakerSegmentId' };
export type SessionAnalysisId = string & { readonly __brand: 'SessionAnalysisId' };
export type SessionReportId = string & { readonly __brand: 'SessionReportId' };
export type SuccessCaseId = string & { readonly __brand: 'SuccessCaseId' };
export type AuthUserId = string & { readonly __brand: 'AuthUserId' };

/**
 * IDç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
export const createId = {
  salon: (id: string): SalonId => id as SalonId,
  staff: (id: string): StaffId => id as StaffId,
  session: (id: string): SessionId => id as SessionId,
  transcript: (id: string): TranscriptId => id as TranscriptId,
  speakerSegment: (id: string): SpeakerSegmentId => id as SpeakerSegmentId,
  sessionAnalysis: (id: string): SessionAnalysisId => id as SessionAnalysisId,
  sessionReport: (id: string): SessionReportId => id as SessionReportId,
  successCase: (id: string): SuccessCaseId => id as SuccessCaseId,
  authUser: (id: string): AuthUserId => id as AuthUserId,
};

/**
 * ãƒ—ãƒ©ãƒ³
 * âš ï¸ å®Ÿè£…ã«åˆã‚ã›ã¦ä¿®æ­£ï¼ˆ2025-12-05ï¼‰: freeè¿½åŠ ã€professionalâ†’premium
 */
export type Plan = 'free' | 'standard' | 'premium' | 'enterprise';

export const PlanDisplay: Record<Plan, string> = {
  free: 'ãƒ•ãƒªãƒ¼',
  standard: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰',
  premium: 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ',
  enterprise: 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º',
};

/**
 * ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«
 * âš ï¸ å®Ÿè£…ã«åˆã‚ã›ã¦ä¿®æ­£ï¼ˆ2025-12-05ï¼‰: assistantè¿½åŠ 
 */
export type StaffRole = 'owner' | 'manager' | 'stylist' | 'admin' | 'assistant';

export const StaffRoleDisplay: Record<StaffRole, string> = {
  owner: 'ã‚ªãƒ¼ãƒŠãƒ¼',
  manager: 'ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼',
  stylist: 'ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ',
  admin: 'ç®¡ç†è€…',
  assistant: 'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
};

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 * âš ï¸ å®Ÿè£…ã«åˆã‚ã›ã¦ä¿®æ­£ï¼ˆ2025-12-05ï¼‰: analyzingè¿½åŠ ã€failedâ†’error
 */
export type SessionStatus = 'recording' | 'processing' | 'analyzing' | 'completed' | 'error';

export const SessionStatusDisplay: Record<SessionStatus, string> = {
  recording: 'éŒ²éŸ³ä¸­',
  processing: 'å‡¦ç†ä¸­',
  analyzing: 'åˆ†æä¸­',
  completed: 'å®Œäº†',
  error: 'ã‚¨ãƒ©ãƒ¼',
};

/**
 * è©±è€…åˆ†é›¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 */
export type DiarizationStatus = 'pending' | 'processing' | 'completed' | 'failed';

/**
 * è©±è€…
 */
export type Speaker = 'stylist' | 'customer' | 'unknown';

export const SpeakerDisplay: Record<Speaker, string> = {
  stylist: 'ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ',
  customer: 'ãŠå®¢æ§˜',
  unknown: 'ä¸æ˜',
};

/**
 * åˆ†ææŒ‡æ¨™ã‚¿ã‚¤ãƒ—
 */
export type IndicatorType =
  | 'talk_ratio'
  | 'question_analysis'
  | 'emotion_analysis'
  | 'concern_keywords'
  | 'proposal_timing'
  | 'proposal_quality'
  | 'conversion';

export const IndicatorTypeDisplay: Record<IndicatorType, string> = {
  talk_ratio: 'ãƒˆãƒ¼ã‚¯æ¯”ç‡',
  question_analysis: 'è³ªå•åˆ†æ',
  emotion_analysis: 'æ„Ÿæƒ…åˆ†æ',
  concern_keywords: 'æ‚©ã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰',
  proposal_timing: 'ææ¡ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°',
  proposal_quality: 'ææ¡ˆå“è³ª',
  conversion: 'æˆç´„åˆ¤å®š',
};

/**
 * å¹´ä»£
 */
export type AgeGroup = '10s' | '20s' | '30s' | '40s' | '50s' | '60s' | '70s_plus';

export const AgeGroupDisplay: Record<AgeGroup, string> = {
  '10s': '10ä»£',
  '20s': '20ä»£',
  '30s': '30ä»£',
  '40s': '40ä»£',
  '50s': '50ä»£',
  '60s': '60ä»£',
  '70s_plus': '70ä»£ä»¥ä¸Š',
};

/**
 * æ€§åˆ¥
 */
export type Gender = 'male' | 'female' | 'other';

export const GenderDisplay: Record<Gender, string> = {
  male: 'ç”·æ€§',
  female: 'å¥³æ€§',
  other: 'ãã®ä»–',
};

/**
 * æ¥åº—é »åº¦
 */
export type VisitFrequency = 'first' | 'monthly' | 'bimonthly' | 'quarterly' | 'irregular';

export const VisitFrequencyDisplay: Record<VisitFrequency, string> = {
  first: 'åˆã‚ã¦',
  monthly: 'æœˆ1å›',
  bimonthly: '2ãƒ¶æœˆã«1å›',
  quarterly: '3ãƒ¶æœˆã«1å›',
  irregular: 'ä¸å®šæœŸ',
};

/**
 * ãŠå®¢æ§˜æƒ…å ±
 */
export interface CustomerInfo {
  ageGroup?: AgeGroup;
  gender?: Gender;
  visitFrequency?: VisitFrequency;
  notes?: string;
}

/**
 * ãŠå®¢æ§˜ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆæˆåŠŸäº‹ä¾‹ç”¨ï¼‰
 */
export interface CustomerProfile {
  ageGroup?: AgeGroup;
  gender?: Gender;
  visitFrequency?: VisitFrequency;
  hairType?: string;
  concerns?: string[];
}

/**
 * åº—èˆ—è¨­å®š
 */
export interface SalonSettings {
  notification: {
    enablePush: boolean;
    enableEmail: boolean;
    concernDetectionAlert: boolean;
    sessionCompleteAlert: boolean;
  };
  analysis: {
    idealTalkRatio: number;
    minQuestionCount: number;
    concernKeywords: string[];
  };
  display: {
    showRanking: boolean;
    anonymizeCustomer: boolean;
  };
}

/**
 * ã‚¹ã‚¿ãƒƒãƒ•è¨­å®š
 */
export interface StaffSettings {
  notificationPreferences: {
    concernAlert: boolean;
    sessionComplete: boolean;
    weeklyReport: boolean;
  };
  displayPreferences: {
    showScore: boolean;
    showRanking: boolean;
  };
}

/**
 * åˆ†æè©³ç´°
 */
export interface AnalysisDetails {
  // talk_ratio
  stylistSeconds?: number;
  customerSeconds?: number;
  totalSeconds?: number;
  ratio?: number;
  
  // question_analysis
  totalQuestions?: number;
  openQuestions?: number;
  closedQuestions?: number;
  openRatio?: number;
  questionList?: Array<{
    text: string;
    type: 'open' | 'closed';
    time: number;
  }>;
  
  // emotion_analysis
  positiveRatio?: number;
  keywords?: string[];
  overall?: 'positive' | 'neutral' | 'negative';
  
  // concern_keywords
  detected?: boolean;
  detectedKeywords?: string[];
  detectedAt?: number[];
  context?: string;
  
  // proposal_timing
  concernDetectedAt?: number;
  proposalAt?: number;
  timingMinutes?: number;
  
  // proposal_quality
  hasProposal?: boolean;
  benefitRatio?: number;
  proposalDetails?: string[];
  
  // conversion
  converted?: boolean;
  productName?: string | null;
}

/**
 * æŒ‡æ¨™ã‚¹ã‚³ã‚¢ï¼ˆãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼‰
 */
export interface IndicatorScores {
  talk_ratio?: { score: number; value: number };
  question_analysis?: { score: number; value: number };
  emotion_analysis?: { score: number; value: number };
  concern_keywords?: { score: number; value: number };
  proposal_timing?: { score: number; value: number };
  proposal_quality?: { score: number; value: number };
  conversion?: { score: number; value: number };
}

/**
 * ãƒ™ã‚¯ãƒˆãƒ«åŸ‹ã‚è¾¼ã¿
 */
export type Embedding = number[];

/**
 * Embeddingæ¬¡å…ƒæ•°
 */
export const EMBEDDING_DIMENSION = 1536;

/**
 * Embeddingãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 */
export const isValidEmbedding = (embedding: unknown): embedding is Embedding => {
  return (
    Array.isArray(embedding) &&
    embedding.length === EMBEDDING_DIMENSION &&
    embedding.every(v => typeof v === 'number' && !isNaN(v))
  );
};
```

### 2.4 ãƒªãƒã‚¸ãƒˆãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```typescript
// src/domain/repositories/index.ts

import { 
  Salon, CreateSalonParams, UpdateSalonParams,
  Staff, CreateStaffParams, UpdateStaffParams,
  Session, CreateSessionParams,
  Transcript, CreateTranscriptParams,
  SpeakerSegment, CreateSpeakerSegmentParams,
  SessionAnalysis, CreateSessionAnalysisParams,
  SessionReport, CreateSessionReportParams,
  SuccessCase, CreateSuccessCaseParams, SearchSuccessCaseParams,
} from '../entities';
import { 
  SalonId, StaffId, SessionId, AuthUserId, 
  Embedding, IndicatorType 
} from '../valueObjects';

/**
 * åº—èˆ—ãƒªãƒã‚¸ãƒˆãƒª
 */
export interface SalonRepository {
  findById(id: SalonId): Promise<Salon | null>;
  create(params: CreateSalonParams): Promise<Salon>;
  update(id: SalonId, params: UpdateSalonParams): Promise<Salon>;
  delete(id: SalonId): Promise<void>;
}

/**
 * ã‚¹ã‚¿ãƒƒãƒ•ãƒªãƒã‚¸ãƒˆãƒª
 */
export interface StaffRepository {
  findById(id: StaffId): Promise<Staff | null>;
  findByAuthUserId(authUserId: AuthUserId): Promise<Staff | null>;
  findBySalonId(salonId: SalonId): Promise<Staff[]>;
  findActiveByRole(salonId: SalonId, role: Staff['role']): Promise<Staff[]>;
  create(params: CreateStaffParams): Promise<Staff>;
  update(id: StaffId, params: UpdateStaffParams): Promise<Staff>;
  delete(id: StaffId): Promise<void>;
  countBySalonId(salonId: SalonId): Promise<number>;
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒª
 */
export interface SessionRepository {
  findById(id: SessionId): Promise<Session | null>;
  findByStylistId(stylistId: StaffId, options?: { 
    limit?: number; 
    offset?: number;
    status?: Session['status'];
  }): Promise<Session[]>;
  findBySalonId(salonId: SalonId, options?: {
    limit?: number;
    offset?: number;
    status?: Session['status'];
    startDate?: Date;
    endDate?: Date;
  }): Promise<Session[]>;
  findActiveByStylisId(stylistId: StaffId): Promise<Session | null>;
  create(params: CreateSessionParams): Promise<Session>;
  update(id: SessionId, params: Partial<Session>): Promise<Session>;
  countBySalonId(salonId: SalonId, options?: {
    startDate?: Date;
    endDate?: Date;
  }): Promise<number>;
}

/**
 * æ–‡å­—èµ·ã“ã—ãƒªãƒã‚¸ãƒˆãƒª
 */
export interface TranscriptRepository {
  findBySessionId(sessionId: SessionId): Promise<Transcript[]>;
  findBySessionIdAndChunk(sessionId: SessionId, chunkIndex: number): Promise<Transcript | null>;
  create(params: CreateTranscriptParams): Promise<Transcript>;
  createMany(params: CreateTranscriptParams[]): Promise<Transcript[]>;
}

/**
 * è©±è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒªãƒã‚¸ãƒˆãƒª
 */
export interface SpeakerSegmentRepository {
  findBySessionId(sessionId: SessionId): Promise<SpeakerSegment[]>;
  create(params: CreateSpeakerSegmentParams): Promise<SpeakerSegment>;
  createMany(params: CreateSpeakerSegmentParams[]): Promise<SpeakerSegment[]>;
  deleteBySessionId(sessionId: SessionId): Promise<void>;
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æãƒªãƒã‚¸ãƒˆãƒª
 */
export interface SessionAnalysisRepository {
  findBySessionId(sessionId: SessionId): Promise<SessionAnalysis[]>;
  findBySessionIdAndChunk(sessionId: SessionId, chunkIndex: number): Promise<SessionAnalysis[]>;
  findLatestBySessionId(sessionId: SessionId): Promise<Map<IndicatorType, SessionAnalysis>>;
  create(params: CreateSessionAnalysisParams): Promise<SessionAnalysis>;
  createMany(params: CreateSessionAnalysisParams[]): Promise<SessionAnalysis[]>;
}

/**
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒª
 */
export interface SessionReportRepository {
  findBySessionId(sessionId: SessionId): Promise<SessionReport | null>;
  findByStylistId(stylistId: StaffId, options?: {
    limit?: number;
    offset?: number;
    startDate?: Date;
    endDate?: Date;
  }): Promise<SessionReport[]>;
  create(params: CreateSessionReportParams): Promise<SessionReport>;
  getAverageScoreByStylisId(stylistId: StaffId, options?: {
    startDate?: Date;
    endDate?: Date;
  }): Promise<number>;
  getAverageScoreBySalonId(salonId: SalonId, options?: {
    startDate?: Date;
    endDate?: Date;
  }): Promise<number>;
}

/**
 * æˆåŠŸäº‹ä¾‹ãƒªãƒã‚¸ãƒˆãƒª
 */
export interface SuccessCaseRepository {
  findById(id: SuccessCaseId): Promise<SuccessCase | null>;
  findBySalonId(salonId: SalonId, options?: {
    limit?: number;
    offset?: number;
  }): Promise<SuccessCase[]>;
  findPublic(options?: {
    limit?: number;
    offset?: number;
  }): Promise<SuccessCase[]>;
  searchByEmbedding(embedding: Embedding, options: {
    salonId?: SalonId;
    includePublic?: boolean;
    limit?: number;
    threshold?: number;
  }): Promise<Array<SuccessCase & { similarity: number }>>;
  searchByKeywords(keywords: string[], options: {
    salonId?: SalonId;
    includePublic?: boolean;
    limit?: number;
  }): Promise<SuccessCase[]>;
  create(params: CreateSuccessCaseParams): Promise<SuccessCase>;
  updateEmbedding(id: SuccessCaseId, embedding: Embedding): Promise<SuccessCase>;
  delete(id: SuccessCaseId): Promise<void>;
}
```

---

ï¼ˆç¶šãã¯ Part 2 ã«è¨˜è¼‰: APIè©³ç´°ä»•æ§˜ï¼‰
# è©³ç´°è¨­è¨ˆæ›¸ Part 2: APIè©³ç´°ä»•æ§˜

---
