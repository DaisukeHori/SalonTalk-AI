## 7. 外部インターフェース設計

### 7.1 外部システム一覧

| システム名 | 連携方式 | 用途 | 認証方式 | SLA |
|-----------|---------|------|---------|-----|
| Anthropic Claude API | REST API | AI分析・レポート生成・ロールプレイ | API Key | 99.5% |
| OpenAI API | REST API | Embedding生成 | API Key | 99.9% |
| pyannote Server | REST API | 話者分離 | API Key (カスタム) | - |
| Apple Push Notification | APNs | プッシュ通知 | Certificate | 99.9% |
| Stripe API（将来） | REST API + Webhook | 決済処理 | API Key | 99.9% |

### 7.2 API連携仕様

#### 7.2.1 Anthropic Claude API

**基本情報**:

| 項目 | 値 |
|------|-----|
| ベースURL | https://api.anthropic.com |
| APIバージョン | 2023-06-01 |
| 使用モデル | claude-sonnet-4-5-20250929 |
| 認証方式 | x-api-key ヘッダー |
| タイムアウト | 60秒 |
| リトライ | 3回（指数バックオフ） |

**リクエスト形式**:

```typescript
// POST https://api.anthropic.com/v1/messages

interface ClaudeRequest {
  model: string;                    // "claude-sonnet-4-5-20250929"
  max_tokens: number;               // 最大4096
  messages: {
    role: 'user' | 'assistant';
    content: string;
  }[];
  system?: string;                  // システムプロンプト
  temperature?: number;             // 0-1（デフォルト: 1）
  top_p?: number;                   // 0-1
  stop_sequences?: string[];
}
```

**レスポンス形式**:

```typescript
interface ClaudeResponse {
  id: string;                       // "msg_01..."
  type: 'message';
  role: 'assistant';
  content: {
    type: 'text';
    text: string;
  }[];
  model: string;
  stop_reason: 'end_turn' | 'max_tokens' | 'stop_sequence';
  usage: {
    input_tokens: number;
    output_tokens: number;
  };
}
```

**エラーハンドリング**:

| HTTPステータス | エラー種別 | 対応 |
|--------------|-----------|------|
| 400 | bad_request | ログ記録、ユーザー通知 |
| 401 | authentication_error | アラート、API Key確認 |
| 403 | permission_error | アラート、権限確認 |
| 429 | rate_limit_error | 指数バックオフリトライ |
| 500 | api_error | リトライ（最大3回） |
| 503 | overloaded_error | リトライ（最大3回） |

**使用プロンプト例（7指標分析）**:

```typescript
const analysisPrompt = `
あなたは美容室の接客会話を分析するAIアシスタントです。
以下の会話を分析し、JSONフォーマットで結果を返してください。

## 会話データ
${JSON.stringify(transcriptWithSpeakers)}

## 分析項目
1. 感情分析（emotion_analysis）
   - ポジティブ/ネガティブの判定
   - 感情を示すキーワードの抽出
   
2. 悩みキーワード検出（concern_keywords）
   - 髪の悩みに関するキーワード（乾燥、広がり、パサつき、ダメージ、うねり、薄毛、白髪）
   - 検出されたタイミング
   
3. 提案品質（proposal_quality）
   - 商品提案があったか
   - ベネフィット（効果・メリット）を伝えているか
   - スペック（成分・機能）だけでないか
   
4. 成約判定（conversion）
   - 購入意思の表明があったか
   - 購入した商品名

## 出力形式
{
  "emotion_analysis": {
    "positive_ratio": number (0-100),
    "keywords": string[],
    "overall": "positive" | "neutral" | "negative"
  },
  "concern_keywords": {
    "detected": boolean,
    "keywords": string[],
    "detected_at": number[] // 秒
  },
  "proposal_quality": {
    "has_proposal": boolean,
    "benefit_ratio": number (0-100),
    "details": string[]
  },
  "conversion": {
    "converted": boolean,
    "product_name": string | null
  }
}
`;
```

---

#### 7.2.2 OpenAI Embedding API

**基本情報**:

| 項目 | 値 |
|------|-----|
| ベースURL | https://api.openai.com |
| エンドポイント | /v1/embeddings |
| 使用モデル | text-embedding-3-small |
| 次元数 | 1536 |
| 認証方式 | Bearer トークン |
| タイムアウト | 30秒 |

**リクエスト形式**:

```typescript
// POST https://api.openai.com/v1/embeddings

interface EmbeddingRequest {
  model: string;                    // "text-embedding-3-small"
  input: string | string[];         // テキストまたはテキスト配列
  encoding_format?: 'float' | 'base64';
}
```

**レスポンス形式**:

```typescript
interface EmbeddingResponse {
  object: 'list';
  data: {
    object: 'embedding';
    index: number;
    embedding: number[];           // 1536次元
  }[];
  model: string;
  usage: {
    prompt_tokens: number;
    total_tokens: number;
  };
}
```

**使用例**:

```typescript
async function createEmbedding(text: string): Promise<number[]> {
  const response = await fetch('https://api.openai.com/v1/embeddings', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${OPENAI_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'text-embedding-3-small',
      input: text,
    }),
  });
  
  const data: EmbeddingResponse = await response.json();
  return data.data[0].embedding;
}
```

---

#### 7.2.3 pyannote Server API

**基本情報**:

| 項目 | 値 |
|------|-----|
| ベースURL | http://{server}:{port} |
| 認証方式 | X-API-Key ヘッダー |
| タイムアウト | 300秒（5分） |
| 非同期処理 | Callback方式 |

**エンドポイント一覧**:

| メソッド | パス | 説明 |
|---------|------|------|
| POST | /diarize/{session_id} | 話者分離リクエスト |
| GET | /status/{session_id} | 処理状態確認 |
| GET | /health | ヘルスチェック |

**POST /diarize/{session_id}**:

リクエスト（multipart/form-data）:

| パラメータ | 型 | 必須 | 説明 |
|-----------|---|------|------|
| audio | File | ○ | WAVファイル |
| callback_url | string | ○ | コールバックURL |
| num_speakers | integer | × | 話者数（デフォルト: 2） |

レスポンス:

```typescript
interface DiarizeResponse {
  status: 'processing';
  session_id: string;
  estimated_time: number;  // 予想処理時間（秒）
}
```

**Callback形式**:

```typescript
// POST {callback_url}

interface DiarizationCallback {
  session_id: string;
  status: 'completed' | 'failed';
  segments?: {
    speaker: 'SPEAKER_00' | 'SPEAKER_01';
    start: number;        // 開始時間（秒）
    end: number;          // 終了時間（秒）
  }[];
  error?: string;
}
```

### 7.3 ファイルインターフェース

#### 7.3.1 音声ファイル形式

| 項目 | 仕様 |
|------|------|
| フォーマット | WAV (PCM) |
| サンプリングレート | 16000 Hz |
| ビット深度 | 16bit |
| チャンネル | モノラル |
| 最大ファイルサイズ | 10MB/チャンク |
| チャンク長 | 60秒 |

#### 7.3.2 エクスポートファイル形式

**PDF（レポート）**:

| 項目 | 仕様 |
|------|------|
| サイズ | A4 |
| 向き | 縦 |
| フォント | Noto Sans JP |
| 文字エンコーディング | UTF-8 |

**CSV（データエクスポート）**:

| 項目 | 仕様 |
|------|------|
| 文字エンコーディング | UTF-8 (BOM付き) |
| 区切り文字 | カンマ |
| 改行コード | CRLF |
| ヘッダー行 | あり |

---
