## 8. セキュリティ設計

### 8.1 認証設計

#### 8.1.1 認証フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    認証フロー（JWT認証）                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────┐                   ┌────────────────┐                   │
│  │   Client   │                   │  Supabase Auth │                   │
│  │ (iPad/Web) │                   │                │                   │
│  └─────┬──────┘                   └───────┬────────┘                   │
│        │                                  │                            │
│        │ 1. Login Request                 │                            │
│        │    (email, password)             │                            │
│        │─────────────────────────────────▶│                            │
│        │                                  │                            │
│        │                                  │ 2. Verify Credentials      │
│        │                                  │────────────────────────────▶
│        │                                  │                            │
│        │                                  │ 3. User Data               │
│        │                                  │◀────────────────────────────
│        │                                  │                            │
│        │ 4. JWT Token                     │                            │
│        │    (access_token, refresh_token) │                            │
│        │◀─────────────────────────────────│                            │
│        │                                  │                            │
│  ┌─────┴──────┐                   ┌───────┴────────┐                   │
│  │   Store    │                   │                │                   │
│  │   Tokens   │                   │                │                   │
│  └─────┬──────┘                   └───────┬────────┘                   │
│        │                                  │                            │
│        │ 5. API Request                   │                            │
│        │    Authorization: Bearer {token} │                            │
│        │─────────────────────────────────▶│                            │
│        │                                  │                            │
│        │                                  │ 6. Verify JWT              │
│        │                                  │ 7. Get User & Roles        │
│        │                                  │────────────────────────────▶
│        │                                  │                            │
│        │                                  │ 8. RLS Check               │
│        │                                  │────────────────────────────▶
│        │                                  │                            │
│        │ 9. Response                      │                            │
│        │◀─────────────────────────────────│                            │
│        │                                  │                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 8.1.2 JWTトークン構成

```json
// Header
{
  "alg": "RS256",
  "typ": "JWT"
}

// Payload
{
  "sub": "user-uuid-here",
  "email": "stylist@salon.com",
  "role": "authenticated",
  "app_metadata": {
    "salon_id": "salon-uuid",
    "staff_role": "stylist"
  },
  "iat": 1701676800,
  "exp": 1701680400,  // 1時間
  "aud": "authenticated"
}
```

#### 8.1.3 トークンライフサイクル

| トークン種別 | 有効期限 | 保存場所 | 用途 |
|-------------|---------|---------|------|
| Access Token | 1時間 | メモリ（Zustand） | API認証 |
| Refresh Token | 7日 | Secure Storage | Access Token更新 |

### 8.2 認可設計

#### 8.2.1 ロール権限マトリクス

| 機能 | owner | manager | stylist | assistant |
|------|-------|---------|---------|-----------|
| セッション開始 | ○ | ○ | ○ | × |
| セッション閲覧（自分） | ○ | ○ | ○ | ○ |
| セッション閲覧（他人） | ○ | ○ | × | × |
| レポート閲覧（自分） | ○ | ○ | ○ | ○ |
| レポート閲覧（他人） | ○ | ○ | × | × |
| スタッフ管理 | ○ | ○ | × | × |
| 店舗設定 | ○ | × | × | × |
| 成功事例登録 | ○ | ○ | × | × |
| 成功事例閲覧 | ○ | ○ | ○ | ○ |
| トレーニング | ○ | ○ | ○ | ○ |
| ダッシュボード | ○ | ○ | × | × |
| 分析エクスポート | ○ | ○ | × | × |

#### 8.2.2 デバイスベース認可

以下のエンドポイントはユーザーJWT認証ではなく、デバイス識別子による認可を使用します：

| エンドポイント | 認可方式 | 認可条件 | セキュリティ考慮事項 |
|---------------|---------|---------|---------------------|
| `/device-heartbeat` | device_identifier | status='active' のデバイスのみ | 下記参照 |
| `/activate-device` | activation_code | 有効期限内の未使用コード | 1回限り使用、24時間有効 |

**device-heartbeat 認可ポリシー**

```
認可フロー:
1. リクエストボディから device_identifier を取得
2. devices テーブルで device_identifier + status='active' を検索
3. 該当デバイスが存在すれば last_active_at を更新
4. 該当なしの場合は成功応答（success: false）を返す

セキュリティ考慮事項:
- device_identifier はアクティベーション時にデバイス固有値から生成
- device_identifier は推測困難な値（UUID v4 ベース）
- 無効なリクエストでもデバイス存在有無を漏洩しない（同一レスポンス形式）
- レート制限適用（60回/分）
- status='active' のデバイスのみが heartbeat 可能
- revoke されたデバイスは即座に heartbeat 不可
```

**設計根拠**:
- iPad アプリは自動ログイン状態で動作するため、常にユーザー認証情報を保持していない
- heartbeat は高頻度（1-2分間隔）で呼び出されるため、軽量な認可が必要
- デバイス管理画面でのオンライン/オフライン状態表示に使用

### 8.3 データ保護設計

#### 8.3.1 暗号化設計

| 対象 | 暗号化方式 | 鍵管理 |
|------|-----------|--------|
| 通信 | TLS 1.3 | Let's Encrypt（自動更新） |
| データベース | AES-256（保存時） | Supabase管理 |
| バックアップ | AES-256 | Supabase管理 |
| API Key | 環境変数 | Supabase Secrets |
| 音声ファイル | AES-256（Storage） | Supabase管理 |

#### 8.3.2 個人情報マスキング

```sql
-- 個人情報マスキング関数
CREATE OR REPLACE FUNCTION anonymize_text(input_text TEXT)
RETURNS TEXT AS $$
BEGIN
  -- 氏名パターン（○○さん、○○様）
  input_text := regexp_replace(
    input_text, 
    '([一-龯ぁ-んァ-ヶ]{2,4})(さん|様)', 
    '○○様', 
    'g'
  );
  
  -- 電話番号
  input_text := regexp_replace(
    input_text, 
    '\d{2,4}-\d{2,4}-\d{4}', 
    '***-****-****', 
    'g'
  );
  
  -- メールアドレス
  input_text := regexp_replace(
    input_text, 
    '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}', 
    '****@****.***', 
    'g'
  );
  
  RETURN input_text;
END;
$$ LANGUAGE plpgsql;
```

### 8.4 監査ログ設計

#### 8.4.1 監査対象イベント

| イベント種別 | 記録項目 | 保持期間 |
|-------------|---------|---------|
| ログイン | ユーザーID、日時、IPアドレス、成否、User-Agent | 1年 |
| ログアウト | ユーザーID、日時 | 1年 |
| データ作成 | ユーザーID、テーブル、レコードID、日時 | 1年 |
| データ更新 | ユーザーID、テーブル、レコードID、変更前後、日時 | 1年 |
| データ削除 | ユーザーID、テーブル、レコードID、日時 | 1年 |
| 設定変更 | ユーザーID、変更項目、変更前後、日時 | 1年 |
| エラー | エラー詳細、スタックトレース、日時 | 90日 |
| API呼び出し | エンドポイント、レスポンスタイム、ステータス | 30日 |

#### 8.4.2 監査ログスキーマ

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_type VARCHAR(50) NOT NULL,
  user_id UUID REFERENCES staffs(id),
  salon_id UUID REFERENCES salons(id),
  resource_type VARCHAR(50),
  resource_id UUID,
  action VARCHAR(20),
  old_value JSONB,
  new_value JSONB,
  ip_address INET,
  user_agent TEXT,
  request_id UUID,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id, created_at DESC);
CREATE INDEX idx_audit_logs_salon ON audit_logs(salon_id, created_at DESC);
CREATE INDEX idx_audit_logs_event ON audit_logs(event_type, created_at DESC);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);

-- パーティション（月次）
-- 本番環境では月次パーティションを検討
```

### 8.5 セキュリティ対策

#### 8.5.1 OWASP Top 10対策

| リスク | 対策 |
|--------|------|
| A01: アクセス制御の不備 | RLSによる行レベルセキュリティ、ロールベースアクセス制御 |
| A02: 暗号化の失敗 | TLS 1.3、AES-256、適切な鍵管理 |
| A03: インジェクション | パラメータ化クエリ、入力バリデーション |
| A04: 安全でない設計 | 脅威モデリング、セキュアコーディングレビュー |
| A05: セキュリティ設定ミス | Supabaseセキュリティベストプラクティス適用 |
| A06: 脆弱なコンポーネント | 依存関係の定期更新、npm audit |
| A07: 認証の失敗 | Supabase Auth、JWT、レート制限 |
| A08: ソフトウェアとデータの整合性 | CI/CDパイプライン検証、署名付きビルド |
| A09: ログとモニタリングの不足 | 監査ログ、アラート設定、ダッシュボード |
| A10: SSRF | 内部ネットワークアクセス制限、URL検証 |

#### 8.5.2 入力バリデーション

```typescript
// バリデーションスキーマ（Zod）
import { z } from 'zod';

// セッション作成リクエスト
export const CreateSessionSchema = z.object({
  stylistId: z.string().uuid(),
  customerInfo: z.object({
    ageGroup: z.enum(['10s', '20s', '30s', '40s', '50s', '60s+']).optional(),
    gender: z.enum(['male', 'female', 'other']).optional(),
    visitFrequency: z.enum(['first', 'monthly', 'bimonthly', 'quarterly', 'irregular']).optional(),
    notes: z.string().max(500).optional(),
  }).optional(),
});

// スタッフ作成リクエスト
export const CreateStaffSchema = z.object({
  name: z.string().min(1).max(50),
  email: z.string().email().max(255),
  role: z.enum(['owner', 'manager', 'stylist', 'assistant']),
  position: z.string().max(50).optional(),
  joinDate: z.string().date().optional(),
});

// XSS対策: HTMLエスケープ
export function escapeHtml(text: string): string {
  const map: Record<string, string> = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;',
  };
  return text.replace(/[&<>"']/g, (m) => map[m]);
}
```

#### 8.5.3 レート制限

| エンドポイント | 制限 | ウィンドウ |
|--------------|------|-----------|
| /auth/login | 5回 | 15分 |
| /functions/* | 100回 | 1分 |
| /functions/create-session | 10回 | 1分 |
| /functions/process-audio | 60回 | 1分 |
| /functions/roleplay-chat | 30回 | 1分 |

---

（続きは Part4 に記載）
# 基本設計書 Part 4: 性能設計・運用設計・移行設計・テスト設計・付録

---
