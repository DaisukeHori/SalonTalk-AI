## 12. テスト設計

### 12.1 テスト方針

#### 12.1.1 テストピラミッド

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           テストピラミッド                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ╱╲                                             │
│                             ╱  ╲                                            │
│                            ╱ E2E╲      10%                                  │
│                           ╱ Tests╲     (主要シナリオ)                       │
│                          ╱────────╲                                         │
│                         ╱          ╲                                        │
│                        ╱ Integration╲   20%                                 │
│                       ╱    Tests     ╲  (API・DB連携)                       │
│                      ╱────────────────╲                                     │
│                     ╱                  ╲                                    │
│                    ╱    Unit Tests      ╲   70%                             │
│                   ╱                      ╲  (関数・コンポーネント)           │
│                  ╱────────────────────────╲                                 │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ テスト種別         │ ツール                      │ カバレッジ目標    │   │
│  ├────────────────────┼─────────────────────────────┼──────────────────┤   │
│  │ Unit Tests        │ Jest, React Native Testing  │ 80%以上          │   │
│  │                    │ Library                     │                  │   │
│  ├────────────────────┼─────────────────────────────┼──────────────────┤   │
│  │ Integration Tests │ Supertest, Supabase Test    │ 70%以上          │   │
│  │                    │ Helpers                     │                  │   │
│  ├────────────────────┼─────────────────────────────┼──────────────────┤   │
│  │ E2E Tests         │ Detox (iPad),               │ 主要フロー100%   │   │
│  │                    │ Playwright (Web)            │                  │   │
│  └────────────────────┴─────────────────────────────┴──────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 12.1.2 テスト種別と目的

| テスト種別 | 目的 | 実施タイミング | 担当 |
|-----------|------|--------------|------|
| 単体テスト | 関数・コンポーネント単位の動作検証 | 開発時（自動） | 開発者 |
| 結合テスト | API・DB連携の検証 | PR時（自動） | 開発者 |
| E2Eテスト | ユーザーシナリオの検証 | Staging（自動） | QA |
| 性能テスト | 負荷・応答時間の検証 | リリース前 | QA |
| セキュリティテスト | 脆弱性の検証 | リリース前 | セキュリティ担当 |
| ユーザー受入テスト | 業務要件の充足確認 | リリース前 | ステークホルダー |

### 12.2 テスト環境

| 環境 | URL | 用途 | データ |
|------|-----|------|-------|
| ローカル | localhost | 開発・単体テスト | モック/Seed |
| Staging | staging.salontalk.app | 結合・E2E・性能テスト | テストデータ |
| Production | salontalk.app | 本番 | 本番データ |

### 12.3 テストケース設計

#### 12.3.1 単体テスト例

```typescript
// __tests__/utils/scoreCalculator.test.ts

import { calculateOverallScore, calculateTalkRatioScore } from '@/utils/scoreCalculator';

describe('calculateTalkRatioScore', () => {
  it('理想的な比率（40%）の場合、100点を返す', () => {
    const result = calculateTalkRatioScore(40);
    expect(result).toBe(100);
  });

  it('許容範囲内（35-45%）の場合、100点を返す', () => {
    expect(calculateTalkRatioScore(35)).toBe(100);
    expect(calculateTalkRatioScore(45)).toBe(100);
  });

  it('やや外れた範囲（30-35%, 45-50%）の場合、80点を返す', () => {
    expect(calculateTalkRatioScore(32)).toBe(80);
    expect(calculateTalkRatioScore(48)).toBe(80);
  });

  it('大きく外れた場合、低いスコアを返す', () => {
    expect(calculateTalkRatioScore(20)).toBe(40);
    expect(calculateTalkRatioScore(70)).toBe(40);
  });
});

describe('calculateOverallScore', () => {
  it('全指標が100点の場合、100点を返す', () => {
    const indicators = {
      talkRatio: 100,
      questionAnalysis: 100,
      emotionAnalysis: 100,
      concernKeywords: 100,
      proposalTiming: 100,
      proposalQuality: 100,
      conversion: 100,
    };
    const result = calculateOverallScore(indicators);
    expect(result).toBe(100);
  });

  it('重み付けが正しく適用される', () => {
    const indicators = {
      talkRatio: 80,        // 15% -> 12
      questionAnalysis: 80, // 15% -> 12
      emotionAnalysis: 80,  // 15% -> 12
      concernKeywords: 80,  // 10% -> 8
      proposalTiming: 80,   // 15% -> 12
      proposalQuality: 80,  // 15% -> 12
      conversion: 80,       // 15% -> 12
    };
    const result = calculateOverallScore(indicators);
    expect(result).toBe(80);
  });
});
```

#### 12.3.2 結合テスト例

```typescript
// __tests__/api/createSession.test.ts

import { createClient } from '@supabase/supabase-js';
import { describe, it, expect, beforeAll, afterAll } from 'vitest';

describe('create-session API', () => {
  let supabase: SupabaseClient;
  let testUserId: string;

  beforeAll(async () => {
    supabase = createClient(
      process.env.SUPABASE_URL!,
      process.env.SUPABASE_ANON_KEY!
    );
    // テストユーザーでログイン
    const { data } = await supabase.auth.signInWithPassword({
      email: 'test@example.com',
      password: 'testpassword',
    });
    testUserId = data.user!.id;
  });

  afterAll(async () => {
    await supabase.auth.signOut();
  });

  it('正常なリクエストでセッションが作成される', async () => {
    const { data, error } = await supabase.functions.invoke('create-session', {
      body: {
        stylistId: testUserId,
        customerInfo: {
          ageGroup: '30s',
          gender: 'female',
        },
      },
    });

    expect(error).toBeNull();
    expect(data).toHaveProperty('sessionId');
    expect(data).toHaveProperty('status', 'recording');
    expect(data).toHaveProperty('realtimeChannel');
  });

  it('stylistIdがない場合、エラーを返す', async () => {
    const { data, error } = await supabase.functions.invoke('create-session', {
      body: {},
    });

    expect(error).toBeDefined();
    expect(error.message).toContain('stylistId');
  });

  it('不正なcustomerInfoの場合、エラーを返す', async () => {
    const { data, error } = await supabase.functions.invoke('create-session', {
      body: {
        stylistId: testUserId,
        customerInfo: {
          ageGroup: 'invalid',
        },
      },
    });

    expect(error).toBeDefined();
    expect(error.message).toContain('ageGroup');
  });
});
```

#### 12.3.3 E2Eテストケース

| TC-ID | シナリオ | 前提条件 | 操作手順 | 期待結果 | 優先度 |
|-------|---------|---------|---------|---------|-------|
| E2E-001 | ログイン成功 | 有効なアカウント | 1. アプリ起動<br>2. メール入力<br>3. パスワード入力<br>4. ログインタップ | ホーム画面が表示される | 高 |
| E2E-002 | ログイン失敗 | 無効なパスワード | 1. アプリ起動<br>2. メール入力<br>3. 誤ったパスワード入力<br>4. ログインタップ | エラーメッセージが表示される | 高 |
| E2E-003 | セッション開始 | ログイン済み | 1. 「セッション開始」タップ<br>2. お客様情報入力<br>3. 「開始」タップ | セッション画面が表示され、録音が開始される | 高 |
| E2E-004 | リアルタイム分析表示 | セッション中 | 1. 会話を行う（60秒以上） | スコアが更新される | 高 |
| E2E-005 | 提案通知表示 | セッション中 | 1. 「乾燥」「パサつき」を含む会話 | 提案通知カードが表示される | 高 |
| E2E-006 | セッション終了 | セッション中 | 1. 「終了」タップ<br>2. 確認ダイアログで「終了」 | レポート画面が表示される | 高 |
| E2E-007 | レポート閲覧 | レポート存在 | 1. レポート一覧表示<br>2. レポート選択 | レポート詳細が表示される | 中 |
| E2E-008 | AIロールプレイ | ログイン済み | 1. トレーニング画面<br>2. シナリオ選択<br>3. 会話を3往復<br>4. 「終了」 | 評価結果が表示される | 中 |
| E2E-009 | ダッシュボード表示 | 管理者ログイン | 1. Webでログイン<br>2. ダッシュボード確認 | KPIが正しく表示される | 中 |
| E2E-010 | スタッフ管理 | 管理者ログイン | 1. スタッフ一覧<br>2. スタッフ追加<br>3. 情報入力<br>4. 保存 | スタッフが追加される | 低 |

### 12.4 性能テスト計画

#### 12.4.1 負荷テストシナリオ

```javascript
// k6 負荷テストスクリプト
// load-test.js

import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate } from 'k6/metrics';

const errorRate = new Rate('errors');

export const options = {
  stages: [
    { duration: '2m', target: 50 },   // ウォームアップ
    { duration: '5m', target: 100 },  // 通常負荷
    { duration: '2m', target: 200 },  // ピーク負荷
    { duration: '2m', target: 100 },  // 負荷軽減
    { duration: '2m', target: 0 },    // クールダウン
  ],
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    errors: ['rate<0.01'],
  },
};

const BASE_URL = __ENV.BASE_URL || 'https://staging.salontalk.app';

export default function () {
  // ログイン
  const loginRes = http.post(`${BASE_URL}/auth/v1/token`, {
    email: 'loadtest@example.com',
    password: 'testpassword',
  });
  
  check(loginRes, {
    'ログイン成功': (r) => r.status === 200,
  }) || errorRate.add(1);

  const token = loginRes.json('access_token');

  // セッション一覧取得
  const sessionsRes = http.get(`${BASE_URL}/rest/v1/sessions`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  
  check(sessionsRes, {
    'セッション一覧取得成功': (r) => r.status === 200,
    'レスポンスタイム < 500ms': (r) => r.timings.duration < 500,
  }) || errorRate.add(1);

  sleep(1);
}
```

#### 12.4.2 性能テスト結果目標

| 指標 | 目標値 | 測定条件 |
|------|--------|---------|
| 同時ユーザー | 100 | 全機能利用 |
| スループット | 1000 req/min | 混合シナリオ |
| レスポンスタイム（P95） | 500ms以下 | API呼び出し |
| レスポンスタイム（P99） | 1000ms以下 | API呼び出し |
| エラー率 | 0.1%以下 | 全リクエスト |
| CPU使用率 | 70%以下 | ピーク時 |
| メモリ使用率 | 80%以下 | ピーク時 |

---
