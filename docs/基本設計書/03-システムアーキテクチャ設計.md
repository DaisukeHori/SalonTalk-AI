## 3. システムアーキテクチャ設計

### 3.1 アーキテクチャ方針

#### 3.1.1 設計原則

| 原則 | 説明 | 適用方法 | メリット |
|------|------|---------|---------|
| **クラウドネイティブ** | クラウドサービスを最大限活用 | Supabase、Vercelの採用 | インフラ管理コスト削減 |
| **サーバーレス優先** | サーバー管理の最小化 | Edge Functions、マネージドDB | スケーラビリティ、コスト最適化 |
| **リアルタイム性** | 低遅延のデータ配信 | WebSocket、Realtime DB | UX向上、即時フィードバック |
| **スケーラビリティ** | 店舗数増加への対応 | 水平スケーリング設計 | ビジネス成長対応 |
| **コスト最適化** | 変動費モデルの採用 | 従量課金サービスの活用 | 初期投資抑制 |
| **セキュリティファースト** | セキュリティを設計に組み込む | RLS、暗号化、監査ログ | データ保護 |

#### 3.1.2 技術選定理由

| 技術 | 選定理由 | 代替案 | 代替案を選ばなかった理由 |
|------|---------|--------|----------------------|
| **React Native** | iOS/Web共通コードベース、TypeScript対応、Expo対応 | Swift UI | Web版も必要、開発リソース効率化 |
| **Next.js 14** | App Router、Server Components、Vercel統合 | Remix、SvelteKit | Vercelとの親和性、エコシステム |
| **Supabase** | PostgreSQL、Realtime、Auth統合、pgvector対応 | Firebase | RDB必要、ベクトル検索、コスト |
| **pgvector** | Supabase統合、追加コストなし、十分な性能 | Qdrant、Pinecone | 初期コスト、管理の簡便さ |
| **Claude Sonnet 4.5** | 日本語精度、コスト効率、分析品質 | GPT-4、Gemini | 日本語性能、API安定性 |
| **pyannote.audio** | MIT License、高精度、セルフホスト可 | AssemblyAI、Speechmatics | コスト、カスタマイズ性 |

### 3.2 コンポーネント設計

#### 3.2.1 フロントエンドコンポーネント構成

**iPadアプリケーション（React Native）**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    iPadアプリ コンポーネント構成                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  src/                                                                   │
│  ├── app/                          # Expo Router (App Directory)        │
│  │   ├── (auth)/                   # 認証が必要なルート                  │
│  │   │   ├── _layout.tsx                                               │
│  │   │   ├── home.tsx              # ホーム画面                         │
│  │   │   ├── session.tsx           # セッション画面                     │
│  │   │   ├── reports/                                                  │
│  │   │   │   ├── index.tsx         # レポート一覧                       │
│  │   │   │   └── [id].tsx          # レポート詳細                       │
│  │   │   ├── training/                                                 │
│  │   │   │   ├── index.tsx         # トレーニングメニュー                │
│  │   │   │   └── roleplay.tsx      # ロールプレイ画面                   │
│  │   │   └── settings.tsx          # 設定画面                           │
│  │   ├── login.tsx                 # ログイン画面                       │
│  │   └── _layout.tsx               # ルートレイアウト                   │
│  │                                                                      │
│  ├── components/                   # 再利用可能コンポーネント             │
│  │   ├── common/                   # 共通コンポーネント                  │
│  │   │   ├── Button.tsx                                                │
│  │   │   ├── Card.tsx                                                  │
│  │   │   ├── Header.tsx                                                │
│  │   │   ├── Loading.tsx                                               │
│  │   │   └── Modal.tsx                                                 │
│  │   ├── session/                  # セッション関連                      │
│  │   │   ├── RealtimeScoreCard.tsx # リアルタイムスコア表示              │
│  │   │   ├── ConversationLog.tsx   # 会話ログ表示                       │
│  │   │   ├── ProposalNotification.tsx # 提案通知                        │
│  │   │   ├── KeywordBadge.tsx      # キーワードバッジ                   │
│  │   │   ├── ScoreGauge.tsx        # スコアゲージ                       │
│  │   │   ├── EmotionIndicator.tsx  # 感情インジケータ                   │
│  │   │   └── TimerDisplay.tsx      # 経過時間表示                       │
│  │   ├── report/                   # レポート関連                        │
│  │   │   ├── ReportCard.tsx        # レポートカード                     │
│  │   │   ├── ScoreChart.tsx        # スコアチャート                     │
│  │   │   └── ActionItems.tsx       # アクションアイテム                 │
│  │   └── training/                 # トレーニング関連                    │
│  │       ├── ScenarioCard.tsx      # シナリオカード                     │
│  │       ├── ChatBubble.tsx        # チャットバブル                     │
│  │       └── EvaluationResult.tsx  # 評価結果                           │
│  │                                                                      │
│  ├── hooks/                        # カスタムフック                       │
│  │   ├── useAuth.ts                # 認証フック                         │
│  │   ├── useSession.ts             # セッション管理                     │
│  │   ├── useTranscript.ts          # 文字起こしフック                   │
│  │   ├── useRealtimeAnalysis.ts    # リアルタイム分析                   │
│  │   ├── useSuccessCase.ts         # 成功事例検索                       │
│  │   ├── useNotification.ts        # 通知管理                           │
│  │   └── useSpeech.ts              # 音声認識フック                     │
│  │                                                                      │
│  ├── services/                     # 外部サービス連携                    │
│  │   ├── supabase.ts               # Supabaseクライアント               │
│  │   ├── speech.ts                 # SpeechAnalyzer連携                 │
│  │   ├── audio.ts                  # 音声処理サービス                   │
│  │   ├── storage.ts                # ストレージサービス                 │
│  │   ├── notification.ts           # 通知サービス                       │
│  │   └── analytics.ts              # アナリティクス                     │
│  │                                                                      │
│  ├── stores/                       # 状態管理（Zustand）                 │
│  │   ├── sessionStore.ts           # セッション状態                     │
│  │   ├── userStore.ts              # ユーザー状態                       │
│  │   ├── analysisStore.ts          # 分析結果状態                       │
│  │   ├── notificationStore.ts      # 通知状態                           │
│  │   └── settingsStore.ts          # 設定状態                           │
│  │                                                                      │
│  ├── types/                        # 型定義                              │
│  │   ├── session.ts                                                    │
│  │   ├── analysis.ts                                                   │
│  │   ├── user.ts                                                       │
│  │   └── api.ts                                                        │
│  │                                                                      │
│  ├── utils/                        # ユーティリティ                       │
│  │   ├── format.ts                 # フォーマット関数                   │
│  │   ├── validation.ts             # バリデーション                     │
│  │   └── constants.ts              # 定数定義                           │
│  │                                                                      │
│  └── config/                       # 設定                                │
│      ├── env.ts                    # 環境変数                           │
│      └── theme.ts                  # テーマ設定                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Webダッシュボード（Next.js 14）**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Webダッシュボード コンポーネント構成                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  src/                                                                   │
│  ├── app/                          # App Router                         │
│  │   ├── (public)/                 # 公開ルート                         │
│  │   │   ├── page.tsx              # ランディングページ                  │
│  │   │   └── login/page.tsx        # ログインページ                     │
│  │   ├── (dashboard)/              # ダッシュボード（認証必須）           │
│  │   │   ├── layout.tsx            # ダッシュボードレイアウト             │
│  │   │   ├── page.tsx              # ダッシュボードトップ                │
│  │   │   ├── staff/                                                    │
│  │   │   │   ├── page.tsx          # スタッフ一覧                       │
│  │   │   │   └── [id]/page.tsx     # スタッフ詳細                       │
│  │   │   ├── reports/                                                  │
│  │   │   │   ├── page.tsx          # レポート一覧                       │
│  │   │   │   └── [id]/page.tsx     # レポート詳細                       │
│  │   │   ├── analytics/page.tsx    # 分析画面                           │
│  │   │   ├── success-cases/page.tsx # 成功事例管理                      │
│  │   │   └── settings/page.tsx     # 設定                               │
│  │   ├── api/                      # API Routes（必要に応じて）          │
│  │   │   └── webhook/              # Webhook受信                        │
│  │   ├── layout.tsx                # ルートレイアウト                   │
│  │   └── globals.css               # グローバルスタイル                 │
│  │                                                                      │
│  ├── components/                   # コンポーネント                       │
│  │   ├── layout/                   # レイアウト系                        │
│  │   │   ├── Sidebar.tsx           # サイドバー                         │
│  │   │   ├── Header.tsx            # ヘッダー                           │
│  │   │   └── Footer.tsx            # フッター                           │
│  │   ├── dashboard/                # ダッシュボード系                    │
│  │   │   ├── MetricCard.tsx        # メトリクスカード                   │
│  │   │   ├── ScoreChart.tsx        # スコアチャート                     │
│  │   │   ├── StaffRanking.tsx      # スタッフランキング                 │
│  │   │   └── RecentSessions.tsx    # 最近のセッション                   │
│  │   ├── staff/                    # スタッフ管理系                      │
│  │   │   ├── StaffTable.tsx        # スタッフテーブル                   │
│  │   │   ├── StaffCard.tsx         # スタッフカード                     │
│  │   │   └── StaffForm.tsx         # スタッフ登録フォーム               │
│  │   ├── report/                   # レポート系                          │
│  │   │   ├── ReportViewer.tsx      # レポートビューア                   │
│  │   │   └── ReportExport.tsx      # エクスポートボタン                 │
│  │   ├── analytics/                # 分析系                              │
│  │   │   ├── TrendChart.tsx        # トレンドチャート                   │
│  │   │   ├── ComparisonTable.tsx   # 比較テーブル                       │
│  │   │   └── DateRangePicker.tsx   # 期間選択                           │
│  │   └── ui/                       # 汎用UIコンポーネント                │
│  │       ├── Button.tsx                                                │
│  │       ├── Card.tsx                                                  │
│  │       ├── Table.tsx                                                 │
│  │       ├── Modal.tsx                                                 │
│  │       └── ...                   # その他shadcn/ui                   │
│  │                                                                      │
│  ├── lib/                          # ライブラリ・ユーティリティ           │
│  │   ├── supabase/                                                     │
│  │   │   ├── client.ts             # クライアントサイド                 │
│  │   │   └── server.ts             # サーバーサイド                     │
│  │   ├── utils.ts                  # ユーティリティ関数                 │
│  │   └── constants.ts              # 定数                               │
│  │                                                                      │
│  ├── hooks/                        # カスタムフック                       │
│  │   ├── useAuth.ts                                                    │
│  │   ├── useStaff.ts                                                   │
│  │   ├── useAnalytics.ts                                               │
│  │   └── useExport.ts                                                  │
│  │                                                                      │
│  └── types/                        # 型定義                              │
│      └── index.ts                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 バックエンドコンポーネント構成

**Supabase Edge Functions**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Edge Functions 構成                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  supabase/functions/                                                    │
│  │                                                                      │
│  ├── _shared/                      # 共通モジュール                       │
│  │   ├── supabase.ts               # Supabaseクライアント               │
│  │   ├── claude.ts                 # Claude APIクライアント             │
│  │   ├── openai.ts                 # OpenAI APIクライアント             │
│  │   ├── pyannote.ts               # pyannoteクライアント               │
│  │   ├── validation.ts             # バリデーション                     │
│  │   ├── errors.ts                 # エラーハンドリング                 │
│  │   └── types.ts                  # 型定義                             │
│  │                                                                      │
│  ├── create-session/               # セッション作成                       │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── end-session/                  # セッション終了                       │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── process-audio/                # 音声チャンク処理                     │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── trigger-diarization/          # 話者分離トリガー                     │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── diarization-callback/         # 話者分離コールバック                 │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── analyze-segment/              # セグメント分析                       │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── generate-report/              # レポート生成                         │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── search-cases/                 # 成功事例検索                         │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── create-embedding/             # Embedding生成                       │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── roleplay-chat/                # ロールプレイチャット                 │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  ├── evaluate-roleplay/            # ロールプレイ評価                     │
│  │   └── index.ts                                                      │
│  │                                                                      │
│  └── send-notification/            # 通知送信                             │
│      └── index.ts                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**pyannote Server（FastAPI）**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    pyannote Server 構成                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  pyannote-server/                                                       │
│  │                                                                      │
│  ├── app/                                                              │
│  │   ├── main.py                   # FastAPIアプリケーション             │
│  │   ├── api/                                                          │
│  │   │   ├── __init__.py                                               │
│  │   │   ├── routes.py             # APIルート定義                      │
│  │   │   └── deps.py               # 依存関係                           │
│  │   ├── core/                                                         │
│  │   │   ├── __init__.py                                               │
│  │   │   ├── config.py             # 設定                               │
│  │   │   └── security.py           # セキュリティ                       │
│  │   ├── services/                                                     │
│  │   │   ├── __init__.py                                               │
│  │   │   ├── diarization.py        # 話者分離サービス                   │
│  │   │   ├── storage.py            # ストレージサービス                 │
│  │   │   └── callback.py           # コールバックサービス               │
│  │   ├── models/                                                       │
│  │   │   ├── __init__.py                                               │
│  │   │   └── schemas.py            # Pydanticスキーマ                   │
│  │   └── workers/                                                      │
│  │       ├── __init__.py                                               │
│  │       └── diarization_worker.py # バックグラウンドワーカー           │
│  │                                                                      │
│  ├── tests/                        # テスト                              │
│  │   ├── __init__.py                                                   │
│  │   ├── test_api.py                                                   │
│  │   └── test_diarization.py                                           │
│  │                                                                      │
│  ├── Dockerfile                    # Dockerイメージ定義                  │
│  ├── docker-compose.yml            # 開発用compose                      │
│  ├── requirements.txt              # 依存パッケージ                      │
│  └── README.md                     # ドキュメント                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 通信設計

#### 3.3.1 通信方式一覧

| 通信種別 | プロトコル | ポート | 用途 | 認証方式 |
|---------|-----------|-------|------|---------|
| REST API | HTTPS | 443 | CRUD操作、データ取得 | JWT Bearer |
| WebSocket | WSS | 443 | リアルタイム更新 | JWT認証後接続 |
| Webhook | HTTPS | 443 | 外部サービスからの通知 | API Key + Signature |
| gRPC（将来）| HTTPS | 443 | 高性能内部通信 | mTLS |

#### 3.3.2 通信シーケンス詳細

**シーケンス1: セッション開始〜リアルタイム分析**

```
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│  iPad   │ │Supabase │ │  Edge   │ │ Storage │ │pyannote │ │ Claude  │
│   App   │ │Realtime │ │Functions│ │         │ │ Server  │ │   API   │
└────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
     │          │          │          │          │          │
     │ 1. POST /create-session                   │          │
     │─────────────────────▶                     │          │
     │          │          │                     │          │
     │          │          │ 2. INSERT sessions  │          │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │ 3. { sessionId, realtimeChannel }         │          │
     │◀─────────────────────                     │          │
     │          │          │                     │          │
     │ 4. WebSocket Connect │                     │          │
     │──────────▶          │                     │          │
     │          │          │                     │          │
     │ 5. Subscribed       │                     │          │
     │◀──────────          │                     │          │
     │          │          │                     │          │
     ║══════════║══════════║═══ 施術開始 ═══════║══════════║══════════║
     │          │          │                     │          │
     │ 6. 音声録音開始（ローカル）                │          │
     │          │          │                     │          │
     │ 7. SpeechAnalyzer 文字起こし（60秒ごと）  │          │
     │          │          │                     │          │
     │ 8. POST /process-audio (audio + transcript)          │
     │─────────────────────▶                     │          │
     │          │          │                     │          │
     │          │          │ 9. Upload WAV       │          │
     │          │          │────────────▶        │          │
     │          │          │                     │          │
     │          │          │ 10. INSERT transcripts         │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 11. POST /diarize/{session_id} │
     │          │          │──────────────────────▶         │
     │          │          │                     │          │
     │          │          │ 12. { status: "processing" }   │
     │          │          │◀──────────────────────         │
     │          │          │                     │          │
     │          │          │          ┌─────────┴─────────┐│
     │          │          │          │ pyannote処理      ││
     │          │          │          │ (GPU, 非同期)     ││
     │          │          │          └─────────┬─────────┘│
     │          │          │                     │          │
     │          │          │ 13. POST /diarization-callback │
     │          │          │◀──────────────────────         │
     │          │          │                     │          │
     │          │          │ 14. INSERT speaker_segments    │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 15. Merge transcript + speakers│
     │          │          │                     │          │
     │          │          │ 16. POST /v1/messages          │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 17. AI分析結果      │          │
     │          │          │◀──────────────────────────────────────────
     │          │          │                     │          │
     │          │          │ 18. INSERT session_analyses    │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │ 19. Broadcast (analysis)       │          │
     │          │◀─────────│                     │          │
     │          │          │                     │          │
     │ 20. onAnalysis      │                     │          │
     │◀──────────          │                     │          │
     │          │          │                     │          │
     │ 21. UI更新（スコア表示）                   │          │
     │          │          │                     │          │
     ║══════════║══════════║═══ 悩みキーワード検出時 ═══════║══════════║
     │          │          │                     │          │
     │          │          │ 22. POST /v1/embeddings (OpenAI)
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 23. Embedding vector│          │
     │          │          │◀──────────────────────────────────────────
     │          │          │                     │          │
     │          │          │ 24. pgvector cosine similarity │
     │          │          │──────────────────────────────────────────▶
     │          │          │                     │          │
     │          │          │ 25. Top 5 success cases        │
     │          │          │◀──────────────────────────────────────────
     │          │          │                     │          │
     │          │ 26. Broadcast (notification)   │          │
     │          │◀─────────│                     │          │
     │          │          │                     │          │
     │ 27. onNotification  │                     │          │
     │◀──────────          │                     │          │
     │          │          │                     │          │
     │ 28. 提案通知表示    │                     │          │
     │          │          │                     │          │
```

### 3.4 エラーハンドリング設計

#### 3.4.1 エラー分類体系

| カテゴリ | コード範囲 | HTTP Status | 説明 | リトライ |
|---------|-----------|-------------|------|---------|
| AUTH | AUTH_001-099 | 401, 403 | 認証・認可エラー | 不可 |
| VALIDATION | VAL_001-099 | 400 | 入力バリデーションエラー | 不可 |
| SESSION | SES_001-099 | 400, 404 | セッション状態エラー | 条件付き |
| AI | AI_001-099 | 500, 503 | AI API障害 | 可 |
| DIARIZATION | DIA_001-099 | 500, 503 | 話者分離障害 | 可 |
| DATABASE | DB_001-099 | 500 | データベースエラー | 可 |
| NETWORK | NET_001-099 | 503 | ネットワークエラー | 可 |
| SYSTEM | SYS_001-099 | 500 | システムエラー | 条件付き |

#### 3.4.2 エラーコード詳細

| コード | 名称 | 説明 | 対応アクション |
|--------|------|------|--------------|
| AUTH_001 | INVALID_TOKEN | JWTトークンが無効 | 再ログイン誘導 |
| AUTH_002 | TOKEN_EXPIRED | トークン期限切れ | リフレッシュトークンで更新 |
| AUTH_003 | INSUFFICIENT_PERMISSION | 権限不足 | エラーメッセージ表示 |
| VAL_001 | REQUIRED_FIELD_MISSING | 必須項目未入力 | フィールドハイライト |
| VAL_002 | INVALID_FORMAT | 形式不正 | 入力形式ガイド表示 |
| SES_001 | SESSION_NOT_FOUND | セッションが存在しない | ホームへ戻す |
| SES_002 | SESSION_ALREADY_ENDED | セッション終了済み | レポート画面へ |
| SES_003 | SESSION_IN_PROGRESS | セッション処理中 | 待機またはリトライ |
| AI_001 | CLAUDE_API_ERROR | Claude API エラー | リトライ後フォールバック |
| AI_002 | CLAUDE_RATE_LIMIT | レート制限 | 指数バックオフリトライ |
| AI_003 | CLAUDE_TIMEOUT | タイムアウト | リトライ |
| DIA_001 | PYANNOTE_ERROR | 話者分離エラー | リトライ後スキップ |
| DIA_002 | PYANNOTE_TIMEOUT | 話者分離タイムアウト | リトライ |
| DB_001 | CONNECTION_ERROR | DB接続エラー | リトライ |
| DB_002 | QUERY_ERROR | クエリエラー | ログ記録、ユーザー通知 |

#### 3.4.3 リトライ戦略

```typescript
// リトライ設定
const retryConfig = {
  // ネットワークエラー
  network: {
    maxRetries: 3,
    baseDelay: 1000,      // 1秒
    maxDelay: 30000,      // 30秒
    backoffType: 'exponential',
    jitter: true,
  },
  
  // Claude API 429
  claudeRateLimit: {
    maxRetries: 5,
    baseDelay: 5000,      // 5秒
    maxDelay: 60000,      // 60秒
    backoffType: 'exponential',
    jitter: true,
  },
  
  // Claude API 500
  claudeServerError: {
    maxRetries: 3,
    baseDelay: 2000,      // 2秒
    maxDelay: 10000,      // 10秒
    backoffType: 'fixed',
    jitter: false,
  },
  
  // DB接続エラー
  database: {
    maxRetries: 3,
    baseDelay: 1000,
    maxDelay: 10000,
    backoffType: 'exponential',
    jitter: true,
  },
  
  // pyannote
  pyannote: {
    maxRetries: 2,
    baseDelay: 5000,
    maxDelay: 30000,
    backoffType: 'exponential',
    jitter: false,
  },
};
```

#### 3.4.4 フォールバック設計

| 機能 | プライマリ | フォールバック | 条件 |
|------|-----------|---------------|------|
| 話者分離 | pyannote Server | 話者分離スキップ（全文スタイリスト扱い） | 3回リトライ失敗後 |
| AI分析 | Claude Sonnet 4.5 | ルールベース分析 | API障害時 |
| ベクトル検索 | pgvector | キーワードベース検索 | Embedding生成失敗時 |
| 文字起こし | SpeechAnalyzer | オフラインキュー蓄積 | ネットワーク障害時 |
| リアルタイム通知 | WebSocket | ポーリング（30秒間隔） | WebSocket切断時 |

---

（続きは Part2 に記載）
# 基本設計書 Part 2: 機能設計・画面設計

---
