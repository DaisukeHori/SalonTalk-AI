## 9. 性能設計

### 9.1 性能目標

#### 9.1.1 レスポンスタイム目標

| 処理種別 | 目標値（P95） | 最大許容値（P99） | 測定方法 |
|---------|-------------|-----------------|---------|
| 画面表示（初回） | 3秒以内 | 5秒以内 | First Contentful Paint |
| 画面表示（遷移） | 1秒以内 | 2秒以内 | Time to Interactive |
| API応答（一般） | 500ms以内 | 1秒以内 | サーバーレスポンスタイム |
| API応答（検索） | 1秒以内 | 2秒以内 | クエリ実行時間 |
| リアルタイム更新 | 1秒以内 | 2秒以内 | WebSocket遅延 |
| 文字起こし処理 | 10秒以内/1分音声 | 15秒以内 | クライアント計測 |
| 話者分離処理 | 5分以内/1時間音声 | 10分以内 | サーバーログ |
| AI分析処理 | 30秒以内/チャンク | 60秒以内 | Edge Function計測 |
| レポート生成 | 60秒以内 | 120秒以内 | Edge Function計測 |
| ベクトル検索 | 200ms以内 | 500ms以内 | pgvectorクエリ時間 |

#### 9.1.2 スループット目標

| 指標 | 初期目標 | スケール後目標 |
|------|---------|--------------|
| 同時セッション数 | 50 | 500 |
| 同時WebSocket接続 | 100 | 1,000 |
| API呼び出し | 100 req/min | 1,000 req/min |
| 話者分離処理キュー | 10タスク/min | 100タスク/min |
| AI分析処理 | 50チャンク/min | 500チャンク/min |

#### 9.1.3 リソース使用率目標

| リソース | 通常時 | ピーク時 | アラート閾値 |
|---------|-------|---------|------------|
| CPU使用率 | 40%以下 | 70%以下 | 80% |
| メモリ使用率 | 60%以下 | 80%以下 | 85% |
| DB接続数 | 50%以下 | 80%以下 | 90% |
| ストレージ使用率 | 60%以下 | 80%以下 | 85% |
| GPU使用率（pyannote） | 50%以下 | 90%以下 | 95% |

### 9.2 キャッシュ設計

#### 9.2.1 キャッシュ戦略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           キャッシュ階層設計                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Level 1: ブラウザ/アプリキャッシュ               │   │
│  │                                                                     │   │
│  │   ● 静的アセット: Service Worker (1年)                               │   │
│  │   ● API応答: SWR/TanStack Query (5分)                               │   │
│  │   ● ユーザー状態: Zustand (セッション中)                              │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Level 2: CDN/Edgeキャッシュ                     │   │
│  │                                                                     │   │
│  │   ● 静的ファイル: Vercel Edge (1年、immutable)                       │   │
│  │   ● ISR: Next.js Incremental Static Regeneration (必要に応じて)      │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Level 3: アプリケーションキャッシュ              │   │
│  │                                                                     │   │
│  │   ● セッションデータ: メモリ (アクティブセッション中)                  │   │
│  │   ● 分析結果: PostgreSQL (永続)                                      │   │
│  │   ● 成功事例: メモリ (30分TTL)                                       │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Level 4: データベースキャッシュ                  │   │
│  │                                                                     │   │
│  │   ● クエリキャッシュ: PostgreSQL (自動)                               │   │
│  │   ● コネクションプール: PgBouncer                                     │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 9.2.2 キャッシュ設定詳細

| データ種別 | キャッシュ場所 | TTL | 無効化契機 | サイズ上限 |
|-----------|--------------|-----|-----------|-----------|
| 静的アセット（JS/CSS） | Vercel Edge | 1年 | デプロイ時（hash変更） | - |
| 静的アセット（画像） | Vercel Edge | 1年 | 明示的更新時 | - |
| APIレスポンス（一覧） | SWR | 5分 | mutate呼び出し | 100件 |
| APIレスポンス（詳細） | SWR | 10分 | mutate呼び出し | - |
| ユーザー情報 | Zustand | セッション中 | ログアウト時 | - |
| セッション状態 | Zustand | セッション中 | セッション終了時 | - |
| 分析結果 | PostgreSQL | 永続 | - | - |
| 成功事例 | メモリ + SWR | 30分 | 登録・更新時 | 1000件 |

#### 9.2.3 SWR設定

```typescript
// lib/swr-config.ts

import { SWRConfiguration } from 'swr';

// グローバルSWR設定
export const swrConfig: SWRConfiguration = {
  revalidateOnFocus: false,        // フォーカス時の再検証無効
  revalidateOnReconnect: true,     // 再接続時は再検証
  refreshInterval: 0,               // 自動更新なし（リアルタイムはWebSocket）
  dedupingInterval: 5000,          // 5秒間の重複リクエスト防止
  errorRetryCount: 3,              // エラー時3回リトライ
  errorRetryInterval: 5000,        // 5秒間隔
  shouldRetryOnError: true,
};

// セッション一覧用設定
export const sessionListConfig: SWRConfiguration = {
  ...swrConfig,
  refreshInterval: 60000,          // 1分ごとに更新
  revalidateOnFocus: true,         // フォーカス時も更新
};

// リアルタイムデータ用設定（WebSocket併用）
export const realtimeConfig: SWRConfiguration = {
  ...swrConfig,
  revalidateOnFocus: true,
  refreshInterval: 0,              // WebSocketで更新
};

// 成功事例検索用設定
export const successCaseConfig: SWRConfiguration = {
  ...swrConfig,
  dedupingInterval: 30000,         // 30秒間の重複防止
  revalidateOnFocus: false,
};
```

### 9.3 スケーリング設計

#### 9.3.1 スケーリング戦略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           スケーリング戦略                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  コンポーネント         │ 方式        │ トリガー           │ 最大スケール   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  Next.js (Vercel)      │ 自動水平    │ リクエスト数       │ 無制限        │
│  Edge Functions        │ 自動水平    │ 同時実行数         │ 無制限        │
│  PostgreSQL            │ 垂直        │ 接続数/CPU         │ 64GB RAM     │
│  pyannote Server       │ 手動水平    │ キュー長           │ 10インスタンス │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    自動スケーリング（Vercel/Supabase）                 │ │
│  │                                                                       │ │
│  │     リクエスト増加                                                     │ │
│  │          │                                                            │ │
│  │          ▼                                                            │ │
│  │   ┌────────────┐    ┌────────────┐    ┌────────────┐                 │ │
│  │   │ Instance 1 │    │ Instance 2 │    │ Instance N │                 │ │
│  │   │            │    │            │ ...│            │                 │ │
│  │   │  Edge Fn   │    │  Edge Fn   │    │  Edge Fn   │                 │ │
│  │   └────────────┘    └────────────┘    └────────────┘                 │ │
│  │          │                │                │                          │ │
│  │          └────────────────┼────────────────┘                          │ │
│  │                           │                                           │ │
│  │                           ▼                                           │ │
│  │                  ┌─────────────────┐                                  │ │
│  │                  │  Connection Pool │                                  │ │
│  │                  │   (PgBouncer)   │                                  │ │
│  │                  └────────┬────────┘                                  │ │
│  │                           │                                           │ │
│  │                           ▼                                           │ │
│  │                  ┌─────────────────┐                                  │ │
│  │                  │   PostgreSQL    │                                  │ │
│  │                  │   (単一ノード)   │                                  │ │
│  │                  └─────────────────┘                                  │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    手動スケーリング（pyannote Server）                 │ │
│  │                                                                       │ │
│  │   ┌───────────────────────────────────────────────────────────────┐  │ │
│  │   │                    Load Balancer (nginx)                      │  │ │
│  │   └─────────────────────────────┬─────────────────────────────────┘  │ │
│  │                                 │                                    │ │
│  │              ┌──────────────────┼──────────────────┐                │ │
│  │              │                  │                  │                │ │
│  │              ▼                  ▼                  ▼                │ │
│  │        ┌──────────┐       ┌──────────┐       ┌──────────┐          │ │
│  │        │  GPU #1  │       │  GPU #2  │       │  GPU #N  │          │ │
│  │        │ pyannote │       │ pyannote │  ...  │ pyannote │          │ │
│  │        │RTX 4060  │       │RTX 4060  │       │RTX 4060  │          │ │
│  │        └──────────┘       └──────────┘       └──────────┘          │ │
│  │                                                                    │ │
│  │   スケールアウト条件:                                                │ │
│  │   - キュー待機タスク > 10                                           │ │
│  │   - 平均処理時間 > 目標の150%                                       │ │
│  │   - GPU使用率 > 90%（継続30分以上）                                 │ │
│  │                                                                    │ │
│  │   スケールイン条件:                                                  │ │
│  │   - キュー待機タスク = 0（継続1時間以上）                            │ │
│  │   - GPU使用率 < 30%（継続1時間以上）                                │ │
│  │                                                                    │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 9.3.2 データベーススケーリング

| フェーズ | 店舗数 | Supabaseプラン | スペック | 月額コスト |
|---------|-------|---------------|---------|-----------|
| 初期 | 5 | Pro | 8GB RAM, 50 connections | $25 |
| 成長期 | 50 | Pro (Add-on) | 16GB RAM, 100 connections | $50 |
| 拡大期 | 200 | Team | 32GB RAM, 200 connections | $599 |
| 成熟期 | 500 | Enterprise | 64GB RAM, 500 connections | Custom |

### 9.4 負荷分散設計

#### 9.4.1 負荷分散構成

| レイヤー | 負荷分散方式 | 実装 | ヘルスチェック |
|---------|------------|------|--------------|
| CDN | Vercel Edge Network | 自動（Anycast） | 自動 |
| API | Supabase | 自動 | 自動 |
| DB | PgBouncer | コネクションプール | 自動 |
| pyannote | nginx | ラウンドロビン | /health (10秒間隔) |

#### 9.4.2 pyannote負荷分散設定

```nginx
# nginx.conf

upstream pyannote_servers {
    least_conn;  # 最小接続数方式
    
    server pyannote-1:8000 weight=1;
    server pyannote-2:8000 weight=1;
    server pyannote-3:8000 weight=1 backup;  # バックアップ
}

server {
    listen 80;
    
    location / {
        proxy_pass http://pyannote_servers;
        proxy_connect_timeout 10s;
        proxy_read_timeout 300s;  # 話者分離は時間がかかる
        proxy_send_timeout 60s;
        
        # ヘルスチェック
        health_check interval=10s fails=3 passes=2;
    }
    
    location /health {
        proxy_pass http://pyannote_servers;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }
}
```

### 9.5 パフォーマンス最適化

#### 9.5.1 データベース最適化

```sql
-- クエリ最適化: 頻出クエリのインデックス

-- セッション一覧取得（スタイリスト別、日付降順）
CREATE INDEX idx_sessions_stylist_date 
ON sessions(stylist_id, started_at DESC) 
WHERE status = 'completed';

-- 分析結果取得（セッション別、チャンク順）
CREATE INDEX idx_analyses_session_chunk 
ON session_analyses(session_id, chunk_index, indicator_type);

-- 成功事例検索（悩みキーワード）
CREATE INDEX idx_success_cases_keywords 
ON success_cases USING GIN(concern_keywords);

-- パーティション（将来的な大規模データ対応）
-- sessions テーブルを月次パーティション化
-- CREATE TABLE sessions (
--   ...
-- ) PARTITION BY RANGE (started_at);

-- 統計情報の自動更新
ALTER TABLE sessions SET (autovacuum_analyze_threshold = 50);
ALTER TABLE session_analyses SET (autovacuum_analyze_threshold = 100);
```

#### 9.5.2 API最適化

```typescript
// Edge Function最適化例

// 並列処理による高速化
async function analyzeChunk(sessionId: string, chunkIndex: number) {
  const transcript = await getTranscript(sessionId, chunkIndex);
  const speakers = await getSpeakers(sessionId, chunkIndex);
  
  // 7指標を並列で分析
  const [
    talkRatio,
    questionAnalysis,
    emotionAnalysis,
    concernKeywords,
    proposalTiming,
    proposalQuality,
    conversion,
  ] = await Promise.all([
    analyzeTalkRatio(speakers),           // ローカル処理
    analyzeQuestions(transcript),          // ローカル処理
    analyzeEmotion(transcript),            // Claude API
    detectConcerns(transcript),            // ローカル + Claude
    analyzeProposalTiming(transcript),     // ローカル処理
    analyzeProposalQuality(transcript),    // Claude API
    detectConversion(transcript),          // Claude API
  ]);
  
  return calculateOverallScore({
    talkRatio,
    questionAnalysis,
    emotionAnalysis,
    concernKeywords,
    proposalTiming,
    proposalQuality,
    conversion,
  });
}

// バッチ処理による効率化
async function batchCreateEmbeddings(texts: string[]) {
  // 最大20件ずつバッチ処理
  const batchSize = 20;
  const results: number[][] = [];
  
  for (let i = 0; i < texts.length; i += batchSize) {
    const batch = texts.slice(i, i + batchSize);
    const response = await openai.embeddings.create({
      model: 'text-embedding-3-small',
      input: batch,
    });
    results.push(...response.data.map(d => d.embedding));
  }
  
  return results;
}
```

#### 9.5.3 フロントエンド最適化

```typescript
// React Native 最適化

// 1. メモ化によるレンダリング最適化
const ConversationLog = React.memo(({ messages }: Props) => {
  return (
    <FlatList
      data={messages}
      renderItem={renderMessage}
      keyExtractor={item => item.id}
      initialNumToRender={10}
      maxToRenderPerBatch={5}
      windowSize={5}
      removeClippedSubviews={true}
    />
  );
});

// 2. 遅延ロードによる初期表示高速化
const ReportDetail = React.lazy(() => import('./ReportDetail'));

// 3. 画像最適化
import { Image } from 'expo-image';

const OptimizedImage = ({ uri }: { uri: string }) => (
  <Image
    source={{ uri }}
    contentFit="cover"
    transition={200}
    cachePolicy="memory-disk"
  />
);
```

---
