## 4. 機能設計

### 4.1 機能階層図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           機能階層図                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  SalonTalk AI                                                               │
│  │                                                                          │
│  ├── 1. 認証・アカウント管理機能 [AUTH]                                       │
│  │   ├── 1.1 ユーザー認証 [AUTH-001]                                        │
│  │   │   ├── 1.1.1 メール/パスワードログイン                                 │
│  │   │   ├── 1.1.2 セッション管理                                           │
│  │   │   ├── 1.1.3 ログアウト                                               │
│  │   │   └── 1.1.4 パスワードリセット                                       │
│  │   ├── 1.2 ロール管理 [AUTH-002]                                          │
│  │   │   ├── 1.2.1 ロール割り当て                                           │
│  │   │   └── 1.2.2 権限チェック                                             │
│  │   ├── 1.3 店舗アカウント管理 [AUTH-003]                                   │
│  │   │   ├── 1.3.1 店舗登録                                                 │
│  │   │   ├── 1.3.2 店舗情報編集                                             │
│  │   │   └── 1.3.3 プラン管理                                               │
│  │   └── 1.4 スタッフ管理 [AUTH-004]                                        │
│  │       ├── 1.4.1 スタッフ招待                                             │
│  │       ├── 1.4.2 スタッフ情報編集                                         │
│  │       └── 1.4.3 スタッフ無効化                                           │
│  │                                                                          │
│  ├── 2. セッション管理機能 [SESSION]                                         │
│  │   ├── 2.1 セッション開始 [SESSION-001]                                    │
│  │   │   ├── 2.1.1 お客様情報入力                                           │
│  │   │   ├── 2.1.2 録音開始                                                 │
│  │   │   └── 2.1.3 Realtimeチャンネル接続                                   │
│  │   ├── 2.2 セッション監視 [SESSION-002]                                    │
│  │   │   ├── 2.2.1 録音状態監視                                             │
│  │   │   ├── 2.2.2 ネットワーク状態監視                                     │
│  │   │   └── 2.2.3 処理状態監視                                             │
│  │   ├── 2.3 セッション終了 [SESSION-003]                                    │
│  │   │   ├── 2.3.1 録音停止                                                 │
│  │   │   ├── 2.3.2 最終処理実行                                             │
│  │   │   └── 2.3.3 レポート生成トリガー                                     │
│  │   └── 2.4 セッション履歴 [SESSION-004]                                    │
│  │       ├── 2.4.1 履歴一覧表示                                             │
│  │       └── 2.4.2 履歴検索                                                 │
│  │                                                                          │
│  ├── 3. 音声処理機能 [AUDIO]                                                 │
│  │   ├── 3.1 音声取得 [AUDIO-001]                                            │
│  │   │   ├── 3.1.1 マイク入力キャプチャ                                     │
│  │   │   ├── 3.1.2 音声バッファリング                                       │
│  │   │   └── 3.1.3 チャンク分割（60秒）                                     │
│  │   ├── 3.2 文字起こし [AUDIO-002]                                          │
│  │   │   ├── 3.2.1 SpeechAnalyzer初期化                                     │
│  │   │   ├── 3.2.2 リアルタイム文字起こし                                   │
│  │   │   └── 3.2.3 タイムスタンプ付与                                       │
│  │   ├── 3.3 話者分離 [AUDIO-003]                                            │
│  │   │   ├── 3.3.1 音声ファイルアップロード                                 │
│  │   │   ├── 3.3.2 pyannote処理                                             │
│  │   │   └── 3.3.3 結果受信（Callback）                                     │
│  │   └── 3.4 テキスト結合 [AUDIO-004]                                        │
│  │       ├── 3.4.1 文字起こし＋話者分離マージ                               │
│  │       └── 3.4.2 話者ラベル付与                                           │
│  │                                                                          │
│  ├── 4. AI分析機能 [ANALYSIS]                                                │
│  │   ├── 4.1 トーク比率分析 [ANALYSIS-001]                                   │
│  │   │   ├── 4.1.1 発話時間集計                                             │
│  │   │   └── 4.1.2 比率計算                                                 │
│  │   ├── 4.2 質問分析 [ANALYSIS-002]                                         │
│  │   │   ├── 4.2.1 質問検出                                                 │
│  │   │   ├── 4.2.2 オープン/クローズド判定                                  │
│  │   │   └── 4.2.3 質問品質評価                                             │
│  │   ├── 4.3 感情分析 [ANALYSIS-003]                                         │
│  │   │   ├── 4.3.1 感情キーワード検出                                       │
│  │   │   └── 4.3.2 ポジティブ/ネガティブ判定                                │
│  │   ├── 4.4 悩みキーワード検出 [ANALYSIS-004]                               │
│  │   │   ├── 4.4.1 7カテゴリ検出                                            │
│  │   │   └── 4.4.2 検出タイミング記録                                       │
│  │   ├── 4.5 提案タイミング分析 [ANALYSIS-005]                               │
│  │   │   ├── 4.5.1 提案行為検出                                             │
│  │   │   └── 4.5.2 タイミング評価                                           │
│  │   ├── 4.6 提案品質分析 [ANALYSIS-006]                                     │
│  │   │   ├── 4.6.1 ベネフィット/スペック判定                                │
│  │   │   └── 4.6.2 品質スコア算出                                           │
│  │   ├── 4.7 成約判定 [ANALYSIS-007]                                         │
│  │   │   ├── 4.7.1 購入意思検出                                             │
│  │   │   └── 4.7.2 商品名特定                                               │
│  │   └── 4.8 総合スコアリング [ANALYSIS-008]                                 │
│  │       ├── 4.8.1 重み付け計算                                             │
│  │       └── 4.8.2 スコア正規化                                             │
│  │                                                                          │
│  ├── 5. リアルタイムアシスト機能 [ASSIST]                                    │
│  │   ├── 5.1 スコア表示 [ASSIST-001]                                         │
│  │   │   ├── 5.1.1 リアルタイムスコア更新                                   │
│  │   │   └── 5.1.2 スコアゲージ表示                                         │
│  │   ├── 5.2 提案タイミング通知 [ASSIST-002]                                 │
│  │   │   ├── 5.2.1 悩み検出トリガー                                         │
│  │   │   └── 5.2.2 通知カード表示                                           │
│  │   ├── 5.3 成功トーク提案 [ASSIST-003]                                     │
│  │   │   ├── 5.3.1 類似事例検索                                             │
│  │   │   └── 5.3.2 トーク例表示                                             │
│  │   └── 5.4 アラート表示 [ASSIST-004]                                       │
│  │       ├── 5.4.1 トーク比率警告                                           │
│  │       └── 5.4.2 質問数不足警告                                           │
│  │                                                                          │
│  ├── 6. 成功事例管理機能 [CASE]                                              │
│  │   ├── 6.1 成功事例登録 [CASE-001]                                         │
│  │   │   ├── 6.1.1 自動登録（高スコア＋成約）                               │
│  │   │   ├── 6.1.2 手動登録                                                 │
│  │   │   └── 6.1.3 Embedding生成                                            │
│  │   ├── 6.2 成功事例検索 [CASE-002]                                         │
│  │   │   ├── 6.2.1 ベクトル類似検索                                         │
│  │   │   └── 6.2.2 キーワード検索（フォールバック）                         │
│  │   ├── 6.3 成功事例閲覧 [CASE-003]                                         │
│  │   │   ├── 6.3.1 一覧表示                                                 │
│  │   │   └── 6.3.2 詳細表示                                                 │
│  │   └── 6.4 成功事例評価 [CASE-004]                                         │
│  │       └── 6.4.1 有用性評価                                               │
│  │                                                                          │
│  ├── 7. レポート機能 [REPORT]                                                │
│  │   ├── 7.1 セッションレポート生成 [REPORT-001]                             │
│  │   │   ├── 7.1.1 分析データ集約                                           │
│  │   │   ├── 7.1.2 AIレポート生成                                           │
│  │   │   └── 7.1.3 アクションアイテム生成                                   │
│  │   ├── 7.2 スタッフ分析レポート [REPORT-002]                               │
│  │   │   ├── 7.2.1 期間集計                                                 │
│  │   │   ├── 7.2.2 トレンド分析                                             │
│  │   │   └── 7.2.3 強み/弱み分析                                            │
│  │   ├── 7.3 店舗分析レポート [REPORT-003]                                   │
│  │   │   ├── 7.3.1 店舗全体集計                                             │
│  │   │   ├── 7.3.2 スタッフ比較                                             │
│  │   │   └── 7.3.3 目標達成度                                               │
│  │   └── 7.4 レポートエクスポート [REPORT-004]                               │
│  │       ├── 7.4.1 PDF出力                                                  │
│  │       └── 7.4.2 CSV出力                                                  │
│  │                                                                          │
│  ├── 8. 教育・トレーニング機能 [TRAINING]                                    │
│  │   ├── 8.1 AIロールプレイ [TRAINING-001]                                   │
│  │   │   ├── 8.1.1 お客様役AI生成                                           │
│  │   │   ├── 8.1.2 会話進行                                                 │
│  │   │   └── 8.1.3 リアルタイム評価                                         │
│  │   ├── 8.2 シナリオ管理 [TRAINING-002]                                     │
│  │   │   ├── 8.2.1 シナリオ一覧                                             │
│  │   │   └── 8.2.2 難易度選択                                               │
│  │   ├── 8.3 ベストプラクティス [TRAINING-003]                               │
│  │   │   ├── 8.3.1 成功パターン閲覧                                         │
│  │   │   └── 8.3.2 学習教材表示                                             │
│  │   └── 8.4 ゲーミフィケーション [TRAINING-004]                             │
│  │       ├── 8.4.1 バッジ管理                                               │
│  │       └── 8.4.2 ランキング表示                                           │
│  │                                                                          │
│  ├── 9. 管理機能 [ADMIN]                                                     │
│  │   ├── 9.1 ダッシュボード [ADMIN-001]                                      │
│  │   │   ├── 9.1.1 KPI表示                                                  │
│  │   │   └── 9.1.2 アラート表示                                             │
│  │   ├── 9.2 設定管理 [ADMIN-002]                                            │
│  │   │   ├── 9.2.1 店舗設定                                                 │
│  │   │   ├── 9.2.2 通知設定                                                 │
│  │   │   └── 9.2.3 分析パラメータ設定                                       │
│  │   ├── 9.3 通知管理 [ADMIN-003]                                            │
│  │   │   ├── 9.3.1 通知テンプレート                                         │
│  │   │   └── 9.3.2 通知履歴                                                 │
│  │   └── 9.4 システム監視 [ADMIN-004]                                        │
│  │       ├── 9.4.1 利用状況監視                                             │
│  │       └── 9.4.2 エラー監視                                               │
│  │                                                                          │
│  └── 10. 声紋識別機能 [VOICE]                                                │
│      ├── 10.1 声紋抽出 [VOICE-001]                                           │
│      │   ├── 10.1.1 話者音声セグメント抽出                                  │
│      │   ├── 10.1.2 埋め込みベクトル生成（512次元）                         │
│      │   └── 10.1.3 信頼度スコア算出                                        │
│      ├── 10.2 顧客声紋登録 [VOICE-002]                                       │
│      │   ├── 10.2.1 新規顧客登録                                            │
│      │   ├── 10.2.2 既存顧客マッチング                                      │
│      │   └── 10.2.3 声紋更新（平均化）                                      │
│      ├── 10.3 顧客声紋マッチング [VOICE-003]                                 │
│      │   ├── 10.3.1 コサイン類似度検索（pgvector）                          │
│      │   ├── 10.3.2 候補リスト生成                                          │
│      │   └── 10.3.3 信頼度判定（high/medium/low）                           │
│      ├── 10.4 顧客名抽出・設定 [VOICE-004]                                   │
│      │   ├── 10.4.1 会話からの名前自動抽出（Claude API）                    │
│      │   ├── 10.4.2 手動名前設定                                            │
│      │   └── 10.4.3 名前候補管理                                            │
│      ├── 10.5 顧客識別結果表示 [VOICE-005]                                   │
│      │   ├── 10.5.1 リアルタイム顧客表示                                    │
│      │   ├── 10.5.2 来店履歴表示                                            │
│      │   └── 10.5.3 識別確認UI                                              │
│      └── 10.6 顧客情報管理 [VOICE-006]                                       │
│          ├── 10.6.1 顧客一覧表示                                            │
│          ├── 10.6.2 顧客詳細編集                                            │
│          └── 10.6.3 来店履歴閲覧                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 ユースケース設計

#### 4.2.1 ユースケース一覧

| UC-ID | ユースケース名 | アクター | 優先度 | Phase |
|-------|--------------|---------|-------|-------|
| UC-001 | セッション開始 | スタイリスト | 高 | 1 |
| UC-002 | リアルタイム分析受信 | スタイリスト | 高 | 1 |
| UC-003 | 成功事例検索 | システム/スタイリスト | 高 | 2 |
| UC-004 | セッションレポート生成 | システム | 高 | 1 |
| UC-005 | AIロールプレイ | スタイリスト | 中 | 3 |
| UC-006 | スタッフ管理 | 店長/マネージャー | 中 | 1 |
| UC-007 | 店舗分析閲覧 | 店長/オーナー | 中 | 2 |
| UC-008 | 成功事例登録 | 店長/マネージャー | 中 | 2 |
| UC-009 | レポートエクスポート | 店長/オーナー | 低 | 2 |
| UC-010 | 複数店舗統合分析 | オーナー | 低 | 3 |
| UC-011 | 顧客声紋識別 | システム/スタイリスト | 高 | 2 |
| UC-012 | 顧客情報管理 | スタイリスト/店長 | 中 | 2 |

#### 4.2.2 主要ユースケース詳細

**UC-001: セッション開始**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-001 |
| ユースケース名 | セッション開始 |
| 概要 | スタイリストが施術開始時にセッションを開始し、会話分析を開始する |
| アクター | スタイリスト |
| 事前条件 | - スタイリストがログイン済みである<br>- iPadにマイク権限が許可されている<br>- ネットワーク接続が有効である |
| 事後条件 | - セッションが作成されている<br>- 録音が開始されている<br>- リアルタイム分析が開始されている |
| トリガー | スタイリストがホーム画面で「セッション開始」ボタンをタップ |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | 「セッション開始」をタップ | - |
| 2 | - | お客様情報入力画面を表示 |
| 3 | お客様情報を入力（任意） | - |
| 4 | 「開始」をタップ | - |
| 5 | - | マイク権限を確認 |
| 6 | - | create-session APIを呼び出し |
| 7 | - | セッションレコードを作成 |
| 8 | - | Realtimeチャンネルを作成 |
| 9 | - | クライアントをチャンネルに接続 |
| 10 | - | 録音を開始（AVAudioEngine） |
| 11 | - | セッション画面に遷移 |

**代替フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| A1 | ステップ5でマイク権限がない | 5a. 権限要求ダイアログを表示<br>5b. ユーザーが許可→基本フロー6へ<br>5c. ユーザーが拒否→エラー表示、終了 |
| A2 | ステップ3をスキップ | 3a. 「スキップ」をタップ<br>3b. 基本フロー4へ（customer_info: null） |

**例外フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| E1 | ステップ6でネットワークエラー | 6a. オフラインモードで録音を開始<br>6b. ローカルにデータを蓄積<br>6c. ネットワーク回復時に同期 |
| E2 | ステップ7でDB書き込みエラー | 7a. エラーログを記録<br>7b. 3回リトライ<br>7c. 失敗時はエラー表示、終了 |

---

**UC-002: リアルタイム分析受信**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-002 |
| ユースケース名 | リアルタイム分析受信 |
| 概要 | セッション中に分析結果をリアルタイムで受信し、表示する |
| アクター | スタイリスト（閲覧）、システム（処理） |
| 事前条件 | - セッションが開始されている<br>- Realtimeチャンネルに接続されている |
| 事後条件 | - 分析結果がUIに表示されている<br>- 分析結果がDBに保存されている |
| トリガー | 60秒ごとの音声チャンク処理完了 |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | - | 60秒分の音声をバッファリング |
| 2 | - | SpeechAnalyzerで文字起こし実行 |
| 3 | - | 文字起こし結果をローカルDBに一時保存 |
| 4 | - | 音声チャンク＋文字起こしをサーバーに送信 |
| 5 | - | Storageに音声ファイルを保存 |
| 6 | - | transcriptsテーブルに文字起こしを保存 |
| 7 | - | pyannoteサーバーに話者分離をリクエスト |
| 8 | - | pyannoteが非同期で処理実行 |
| 9 | - | Callback受信、speaker_segmentsに保存 |
| 10 | - | 文字起こし＋話者分離をマージ |
| 11 | - | Claude APIで7指標分析を実行 |
| 12 | - | 分析結果をsession_analysesに保存 |
| 13 | - | Realtimeチャンネルで分析結果をブロードキャスト |
| 14 | - | クライアントが分析結果を受信 |
| 15 | - | UIのスコア・会話ログを更新 |

**代替フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| A1 | ステップ8で悩みキーワード検出 | 8a. 成功事例検索をトリガー<br>8b. UC-003を実行<br>8c. 提案通知を生成 |

**例外フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| E1 | ステップ7でpyannoteエラー | 7a. 3回リトライ<br>7b. 失敗時は話者分離をスキップ<br>7c. 全テキストをスタイリスト発話として処理 |
| E2 | ステップ11でClaude APIエラー | 11a. 5回リトライ（指数バックオフ）<br>11b. 失敗時はルールベース分析にフォールバック |

---

**UC-003: 成功事例検索**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-003 |
| ユースケース名 | 成功事例検索 |
| 概要 | 悩みキーワード検出時に類似の成功事例を検索し、提案トークを表示する |
| アクター | システム（自動）、スタイリスト（手動） |
| 事前条件 | - 悩みキーワードが検出されている<br>- 成功事例DBにデータが存在する |
| 事後条件 | - 類似成功事例が取得されている<br>- 提案通知がUIに表示されている |
| トリガー | 悩みキーワード検出（自動）または「成功事例検索」ボタンタップ（手動） |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | - | 悩みキーワードとコンテキスト情報を収集 |
| 2 | - | シーン情報を構築（キーワード、お客様属性） |
| 3 | - | OpenAI Embedding APIでベクトル生成 |
| 4 | - | pgvectorでコサイン類似度検索 |
| 5 | - | 類似度0.7以上の上位5件を取得 |
| 6 | - | 成功トーク例を整形 |
| 7 | - | Realtimeチャンネルで通知をブロードキャスト |
| 8 | - | クライアントが通知を受信 |
| 9 | - | 提案通知カードを表示 |
| 10 | 通知を確認 | - |

**代替フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| A1 | ステップ5で類似事例なし | 5a. 汎用提案テンプレートを使用<br>5b. 基本フロー6へ |

**例外フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| E1 | ステップ3でEmbedding生成失敗 | 3a. キーワードベース検索にフォールバック<br>3b. concern_keywordsカラムで部分一致検索<br>3c. 基本フロー6へ |

---

**UC-004: セッションレポート生成**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-004 |
| ユースケース名 | セッションレポート生成 |
| 概要 | セッション終了時に詳細なレポートを自動生成する |
| アクター | システム（自動） |
| 事前条件 | - セッションが終了されている<br>- 分析データが保存されている |
| 事後条件 | - レポートが生成されている<br>- レポートがDBに保存されている<br>- レポート画面が表示されている |
| トリガー | スタイリストが「セッション終了」ボタンをタップ |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | 「セッション終了」をタップ | - |
| 2 | - | 終了確認ダイアログを表示 |
| 3 | 「終了」を選択 | - |
| 4 | - | 録音を停止 |
| 5 | - | 残りの音声チャンクを処理 |
| 6 | - | sessionsテーブルのstatusを「processing」に更新 |
| 7 | - | 全分析データを集約 |
| 8 | - | Claude APIでレポートテキストを生成 |
| 9 | - | 良かった点を抽出（2-3項目） |
| 10 | - | 改善ポイントを抽出（2-3項目） |
| 11 | - | アクションアイテムを生成（3項目） |
| 12 | - | session_reportsテーブルに保存 |
| 13 | - | sessionsテーブルのstatusを「completed」に更新 |
| 14 | - | レポート画面に遷移 |

**例外フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| E1 | ステップ8でClaude APIエラー | 8a. 3回リトライ<br>8b. 失敗時は簡易レポート生成<br>8c. スコアのみのレポートを表示 |

---

**UC-005: AIロールプレイ**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-005 |
| ユースケース名 | AIロールプレイ |
| 概要 | AIがお客様役となり、スタイリストの接客スキルをトレーニングする |
| アクター | スタイリスト |
| 事前条件 | - スタイリストがログイン済みである |
| 事後条件 | - トレーニングが完了している<br>- 評価結果が記録されている |
| トリガー | トレーニング画面でシナリオを選択 |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | トレーニング画面を開く | - |
| 2 | - | シナリオ一覧を表示 |
| 3 | シナリオを選択 | - |
| 4 | - | AIお客様役を初期化（Claude API） |
| 5 | - | 最初の発話を生成・表示 |
| 6 | 応答を入力（テキストまたは音声） | - |
| 7 | - | 応答を評価 |
| 8 | - | 評価スコアを表示 |
| 9 | - | 次のAI発話を生成・表示 |
| 10 | ステップ6-9を繰り返す | - |
| 11 | 「終了」をタップ | - |
| 12 | - | 総合評価を生成 |
| 13 | - | 評価結果画面を表示 |

### 4.3 機能詳細設計

#### 4.3.1 セッション管理機能

**F-SESSION-001: セッション開始**

**処理フロー**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    セッション開始 処理フロー                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [開始]                                                                  │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 1. マイク権限確認                    │                                │
│  │    AVAudioSession.requestRecordPermission()                         │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│              ┌──────┴──────┐                                            │
│              │ 権限あり？   │                                            │
│              └──────┬──────┘                                            │
│           Yes │          │ No                                           │
│               │          ▼                                              │
│               │  ┌─────────────────────────────┐                        │
│               │  │ 1a. 権限要求ダイアログ表示   │                        │
│               │  └───────────────┬─────────────┘                        │
│               │           ┌─────┴─────┐                                 │
│               │           │ 許可？    │                                 │
│               │           └─────┬─────┘                                 │
│               │        Yes │        │ No                                │
│               │            │        ▼                                   │
│               │            │  ┌─────────────────┐                       │
│               │            │  │ エラー表示      │                       │
│               │            │  │ "マイク権限が   │                       │
│               │            │  │  必要です"      │                       │
│               │            │  └────────┬────────┘                       │
│               │            │           │                                │
│               │            │           ▼                                │
│               │            │       [終了]                               │
│               ◀────────────┘                                            │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 2. お客様情報入力画面表示            │                                │
│  │    - ageGroup (選択式)              │                                │
│  │    - gender (選択式)                │                                │
│  │    - visitFrequency (選択式)        │                                │
│  │    - notes (自由入力、max 500字)    │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│              ┌──────┴──────┐                                            │
│              │ スキップ？   │                                            │
│              └──────┬──────┘                                            │
│           Yes │          │ No                                           │
│               │          ▼                                              │
│               │  ┌─────────────────────────────┐                        │
│               │  │ 2a. 入力値バリデーション     │                        │
│               │  └───────────────┬─────────────┘                        │
│               │                  │                                      │
│               ◀──────────────────┘                                      │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 3. API呼び出し: create-session      │                                │
│  │                                     │                                │
│  │    Request:                         │                                │
│  │    POST /functions/v1/create-session│                                │
│  │    {                                │                                │
│  │      stylistId: UUID,               │                                │
│  │      customerInfo: {                │                                │
│  │        ageGroup?: string,           │                                │
│  │        gender?: string,             │                                │
│  │        visitFrequency?: string,     │                                │
│  │        notes?: string               │                                │
│  │      }                              │                                │
│  │    }                                │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│              ┌──────┴──────┐                                            │
│              │ 成功？      │                                            │
│              └──────┬──────┘                                            │
│           Yes │          │ No                                           │
│               │          ▼                                              │
│               │  ┌─────────────────────────────┐                        │
│               │  │ 3a. エラーハンドリング       │                        │
│               │  │                             │                        │
│               │  │ ・ネットワークエラー         │                        │
│               │  │   → オフラインモード開始     │                        │
│               │  │ ・認証エラー                │                        │
│               │  │   → ログイン画面へ          │                        │
│               │  │ ・その他エラー              │                        │
│               │  │   → エラー表示、リトライ     │                        │
│               │  └───────────────┬─────────────┘                        │
│               │                  │                                      │
│               ◀──────────────────┘                                      │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 4. レスポンス処理                    │                                │
│  │                                     │                                │
│  │    Response:                        │                                │
│  │    {                                │                                │
│  │      sessionId: UUID,               │                                │
│  │      status: "recording",           │                                │
│  │      startedAt: ISO8601,            │                                │
│  │      realtimeChannel: string        │                                │
│  │    }                                │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 5. Realtime接続                      │                                │
│  │                                     │                                │
│  │    supabase.channel(realtimeChannel)│                                │
│  │      .on('broadcast', { event: 'analysis' }, ...)                   │
│  │      .on('broadcast', { event: 'notification' }, ...)               │
│  │      .subscribe()                   │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 6. 録音開始                          │                                │
│  │                                     │                                │
│  │    AVAudioEngine configuration:     │                                │
│  │    - sampleRate: 16000 Hz           │                                │
│  │    - channels: 1 (mono)             │                                │
│  │    - format: PCM 16bit              │                                │
│  │                                     │                                │
│  │    Buffer: 60秒ごとにチャンク化      │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────┐                                │
│  │ 7. セッション画面遷移                │                                │
│  │                                     │                                │
│  │    sessionStore.setSession({        │                                │
│  │      id: sessionId,                 │                                │
│  │      status: "recording",           │                                │
│  │      startedAt,                     │                                │
│  │      ...                            │                                │
│  │    })                               │                                │
│  │                                     │                                │
│  │    navigation.navigate("Session")   │                                │
│  └──────────────────┬──────────────────┘                                │
│                     │                                                   │
│     ▼                                                                   │
│  [終了]                                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**入力項目詳細**:

| 項目ID | 項目名 | 論理名 | データ型 | 必須 | バリデーション | 初期値 |
|--------|--------|--------|---------|------|---------------|-------|
| IN-001 | stylistId | スタイリストID | UUID | ○ | ログインユーザーのID | 自動設定 |
| IN-002 | ageGroup | 年代 | string | × | "10s"/"20s"/"30s"/"40s"/"50s"/"60s+" | null |
| IN-003 | gender | 性別 | string | × | "male"/"female"/"other" | null |
| IN-004 | visitFrequency | 来店頻度 | string | × | "first"/"monthly"/"bimonthly"/"quarterly"/"irregular" | null |
| IN-005 | notes | メモ | string | × | 最大500文字、特殊文字エスケープ | null |

**出力項目詳細**:

| 項目ID | 項目名 | 論理名 | データ型 | 説明 |
|--------|--------|--------|---------|------|
| OUT-001 | sessionId | セッションID | UUID | 作成されたセッションのID |
| OUT-002 | status | ステータス | string | "recording" |
| OUT-003 | startedAt | 開始日時 | ISO8601 | セッション開始日時 |
| OUT-004 | realtimeChannel | チャンネル名 | string | "session:{sessionId}" |

---

#### 4.3.2 AI分析機能

**F-ANALYSIS-008: 総合スコアリング**

**処理ロジック**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    総合スコアリング 計算ロジック                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  入力: 7指標の個別スコア（0-100点）                                       │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 指標              │ 重み   │ 計算方法                            │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 1. トーク比率     │  15%   │ 理想比率（40:60）からの乖離度で計算  │   │
│  │                   │        │ 35-45%: 100点                       │   │
│  │                   │        │ 30-35% or 45-50%: 80点              │   │
│  │                   │        │ 25-30% or 50-55%: 60点              │   │
│  │                   │        │ それ以外: 40点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 2. 質問分析       │  15%   │ 質問数×質問品質で計算               │   │
│  │                   │        │ 8-12回 かつ オープン60%以上: 100点  │   │
│  │                   │        │ 6-14回 かつ オープン50%以上: 80点   │   │
│  │                   │        │ 4-16回 かつ オープン40%以上: 60点   │   │
│  │                   │        │ それ以外: 40点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 3. 感情分析       │  15%   │ ポジティブキーワード比率            │   │
│  │                   │        │ 70%以上: 100点                       │   │
│  │                   │        │ 60-70%: 80点                        │   │
│  │                   │        │ 50-60%: 60点                        │   │
│  │                   │        │ それ以外: 40点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 4. 悩みキーワード │  10%   │ 検出の有無                           │   │
│  │                   │        │ 検出あり: 100点                      │   │
│  │                   │        │ 検出なし: 50点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 5. 提案タイミング │  15%   │ 悩み検出から提案までの時間          │   │
│  │                   │        │ 2-5分: 100点                        │   │
│  │                   │        │ 1-2分 or 5-7分: 80点                │   │
│  │                   │        │ 7-10分: 60点                        │   │
│  │                   │        │ 10分以上 or 提案なし: 40点          │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 6. 提案品質       │  15%   │ ベネフィット提示率                  │   │
│  │                   │        │ 70%以上: 100点                       │   │
│  │                   │        │ 50-70%: 80点                        │   │
│  │                   │        │ 30-50%: 60点                        │   │
│  │                   │        │ それ以外: 40点                       │   │
│  ├───────────────────┼────────┼─────────────────────────────────────┤   │
│  │ 7. 成約判定       │  15%   │ 成約の有無                           │   │
│  │                   │        │ 成約あり: 100点                      │   │
│  │                   │        │ 成約なし: 50点                       │   │
│  └───────────────────┴────────┴─────────────────────────────────────┘   │
│                                                                         │
│  計算式:                                                                 │
│  総合スコア = Σ(指標スコア × 重み)                                       │
│                                                                         │
│  例:                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 指標              │ スコア │ 重み  │ 加重スコア                   │   │
│  ├───────────────────┼────────┼───────┼──────────────────────────────┤   │
│  │ トーク比率        │   85   │ 0.15  │ 12.75                        │   │
│  │ 質問分析          │   80   │ 0.15  │ 12.00                        │   │
│  │ 感情分析          │   90   │ 0.15  │ 13.50                        │   │
│  │ 悩みキーワード    │  100   │ 0.10  │ 10.00                        │   │
│  │ 提案タイミング    │   85   │ 0.15  │ 12.75                        │   │
│  │ 提案品質          │   70   │ 0.15  │ 10.50                        │   │
│  │ 成約判定          │  100   │ 0.15  │ 15.00                        │   │
│  ├───────────────────┼────────┼───────┼──────────────────────────────┤   │
│  │ 合計              │   -    │ 1.00  │ 86.50                        │   │
│  └───────────────────┴────────┴───────┴──────────────────────────────┘   │
│                                                                         │
│  出力: overall_score = 87 (四捨五入)                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

#### 4.3.3 声紋識別機能

**F-VOICE-001: 声紋識別処理フロー**

**処理概要**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    声紋識別 処理フロー                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [セッション開始後60秒]                                                  │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────────┐                            │
│  │ 1. 顧客音声セグメント収集                │                            │
│  │    - 話者分離結果から customer を抽出    │                            │
│  │    - 最低10秒以上の音声を確保           │                            │
│  └──────────────────┬──────────────────────┘                            │
│                     │                                                   │
│              ┌──────┴──────┐                                            │
│              │ 10秒以上？   │                                            │
│              └──────┬──────┘                                            │
│           Yes │          │ No                                           │
│               │          ▼                                              │
│               │  ┌─────────────────────────────┐                        │
│               │  │ 1a. 追加音声を待機          │                        │
│               │  │     次の60秒チャンクまで    │                        │
│               │  └─────────────────────────────┘                        │
│               │                                                         │
│     ▼                                                                   │
│  ┌─────────────────────────────────────────┐                            │
│  │ 2. 声紋埋め込み生成                       │                            │
│  │    - pyannote/embedding モデル使用       │                            │
│  │    - 512次元ベクトル生成                 │                            │
│  └──────────────────┬──────────────────────┘                            │
│                     │                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────────┐                            │
│  │ 3. 既存顧客とのマッチング検索            │                            │
│  │    - pgvector でコサイン類似度検索       │                            │
│  │    - 閾値: 0.65以上を候補として取得      │                            │
│  │    - 上位5件を取得                       │                            │
│  └──────────────────┬──────────────────────┘                            │
│                     │                                                   │
│              ┌──────┴──────┐                                            │
│              │ マッチあり？ │                                            │
│              └──────┬──────┘                                            │
│           Yes │          │ No                                           │
│               ▼          ▼                                              │
│  ┌─────────────────┐  ┌─────────────────────────────┐                  │
│  │ 4a. リピーター   │  │ 4b. 新規顧客登録            │                  │
│  │     処理         │  │     - 新規 customer レコード │                  │
│  │                  │  │     - voice_embedding 保存   │                  │
│  │  - 顧客情報取得  │  │     - セッションと紐付け     │                  │
│  │  - 来店回数+1    │  └──────────────┬──────────────┘                  │
│  │  - 埋め込み更新  │                 │                                 │
│  │   （平均化）     │                 │                                 │
│  └────────┬────────┘                 │                                 │
│           │                          │                                 │
│           ◀──────────────────────────┘                                 │
│     │                                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────────┐                            │
│  │ 5. 識別結果をUIに表示                    │                            │
│  │    - Realtime チャンネルでブロードキャスト│                            │
│  │    - 顧客情報パネル更新                  │                            │
│  └──────────────────┬──────────────────────┘                            │
│                     │                                                   │
│     ▼                                                                   │
│  ┌─────────────────────────────────────────┐                            │
│  │ 6. 顧客名抽出（並行処理）                │                            │
│  │    - Claude API で会話から名前抽出       │                            │
│  │    - 抽出成功時は customer.name 更新     │                            │
│  └──────────────────┬──────────────────────┘                            │
│                     │                                                   │
│     ▼                                                                   │
│  [終了]                                                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**F-VOICE-002: 声紋埋め込み生成**

**API仕様**:

```
POST /api/v1/extract-embedding

Request:
{
  "session_id": "uuid",
  "audio_segments": [
    {
      "start_time_ms": 0,
      "end_time_ms": 15000,
      "speaker": "customer"
    }
  ]
}

Response:
{
  "embedding": [0.123, -0.456, ...],  // 512次元
  "duration_seconds": 15.0,
  "confidence": 0.92
}
```

**F-VOICE-003: 顧客マッチング**

**マッチング閾値と動作**:

| 類似度範囲 | 信頼度 | 動作 | UI表示 |
|-----------|--------|------|--------|
| 0.85以上 | high | 自動識別 | 「田中様（3回目）」 |
| 0.75-0.85 | medium | 確認要求 | 「田中様でよろしいですか？」 |
| 0.65-0.75 | low | 候補表示 | 「以下の候補から選択してください」 |
| 0.65未満 | - | 新規登録 | 「新規のお客様」 |

**SQL関数**:

```sql
-- 声紋マッチング検索関数
CREATE OR REPLACE FUNCTION match_customer_by_voice(
  query_embedding VECTOR(512),
  salon_id_param UUID,
  match_threshold FLOAT DEFAULT 0.65,
  match_count INT DEFAULT 5
)
RETURNS TABLE (
  customer_id UUID,
  customer_name TEXT,
  similarity FLOAT,
  total_visits INTEGER,
  last_visit_at TIMESTAMPTZ
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    c.id,
    c.name,
    1 - (c.voice_embedding <=> query_embedding) AS similarity,
    c.total_visits,
    c.last_visit_at
  FROM customers c
  WHERE c.salon_id = salon_id_param
    AND c.voice_embedding IS NOT NULL
    AND 1 - (c.voice_embedding <=> query_embedding) > match_threshold
  ORDER BY c.voice_embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```

**F-VOICE-004: 顧客名自動抽出**

**Claude APIプロンプト**:

```
あなたは美容室の会話を分析する専門家です。
以下の会話トランスクリプトから、お客様の名前を抽出してください。

## 抽出ルール
1. 美容師がお客様を呼ぶ際の名前（「○○さん」「○○様」）
2. お客様の自己紹介（「○○です」「○○といいます」）
3. 予約確認の際の名前

## 出力形式
JSON形式で以下の構造で出力してください:
{
  "names": [
    {
      "name": "田中",
      "confidence": 0.95,
      "source": "stylist_address",
      "context": "田中さん、いつもありがとうございます"
    }
  ],
  "recommended_name": "田中"
}

## 会話トランスクリプト
{transcript}
```

---

**UC-011: 顧客声紋識別**

| 項目 | 内容 |
|------|------|
| ユースケースID | UC-011 |
| ユースケース名 | 顧客声紋識別 |
| 概要 | セッション中に顧客の声紋を分析し、リピーターを自動識別する |
| アクター | システム（自動）、スタイリスト（確認） |
| 事前条件 | - セッションが開始されている<br>- 話者分離が完了している<br>- 顧客の発話が10秒以上ある |
| 事後条件 | - 顧客が識別されている<br>- 顧客情報がセッションに紐付けられている |
| トリガー | セッション開始後60秒経過 |

**基本フロー**:

| ステップ | アクター | システム |
|---------|---------|---------|
| 1 | - | 話者分離結果から顧客音声を抽出 |
| 2 | - | pyannoteで声紋埋め込みを生成 |
| 3 | - | pgvectorで類似顧客を検索 |
| 4 | - | 類似度0.85以上の顧客を自動識別 |
| 5 | - | セッションに顧客IDを紐付け |
| 6 | - | UIに顧客情報を表示 |
| 7 | 顧客情報を確認 | - |

**代替フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| A1 | ステップ4で類似度0.75-0.85 | 4a. 確認ダイアログを表示<br>4b. スタイリストが確認または修正<br>4c. 基本フロー5へ |
| A2 | ステップ4で類似度0.65-0.75 | 4a. 候補リストを表示<br>4b. スタイリストが選択<br>4c. 基本フロー5へ |
| A3 | ステップ3でマッチなし | 3a. 新規顧客として登録<br>3b. 声紋を保存<br>3c. 基本フロー6へ |

**例外フロー**:

| ID | 条件 | ステップ |
|----|------|---------|
| E1 | ステップ1で顧客音声10秒未満 | 1a. 次のチャンクまで待機<br>1b. 累積で10秒以上になったら基本フロー2へ |
| E2 | ステップ2で埋め込み生成失敗 | 2a. エラーログ記録<br>2b. 識別をスキップ<br>2c. 「顧客識別不可」と表示 |

---
