## 6. ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆ

### 6.1 è«–ç†ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

#### 6.1.1 ERå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ERå›³ï¼ˆè«–ç†ãƒ¢ãƒ‡ãƒ«ï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚                                                                 â”‚     â”‚
â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚     â”‚
â”‚    â”‚   â”‚   salons    â”‚ 1     n â”‚   staffs    â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ id (PK)     â”‚         â”‚ id (PK)     â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ name        â”‚         â”‚ salon_id(FK)â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ address     â”‚         â”‚auth_user_id â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ phone       â”‚         â”‚ name        â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ plan        â”‚         â”‚ email       â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ seats_count â”‚         â”‚ role        â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ settings    â”‚         â”‚ position    â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ created_at  â”‚         â”‚ join_date   â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ updated_at  â”‚         â”‚ is_active   â”‚                      â”‚     â”‚
â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ settings    â”‚                      â”‚     â”‚
â”‚    â”‚          â”‚                â”‚ created_at  â”‚                      â”‚     â”‚
â”‚    â”‚          â”‚                â”‚ updated_at  â”‚                      â”‚     â”‚
â”‚    â”‚          â”‚                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚     â”‚
â”‚    â”‚          â”‚                       â”‚                             â”‚     â”‚
â”‚    â”‚          â”‚ 1                   n â”‚                             â”‚     â”‚
â”‚    â”‚          â”‚                       â”‚                             â”‚     â”‚
â”‚    â”‚          â–¼                       â–¼                             â”‚     â”‚
â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚     â”‚
â”‚    â”‚   â”‚             sessions                â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ id (PK)                             â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ salon_id (FK)                       â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ stylist_id (FK)                     â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ started_at                          â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ ended_at                            â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ status                              â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ customer_info (JSONB)               â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ diarization_status                  â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ created_at                          â”‚                      â”‚     â”‚
â”‚    â”‚   â”‚ updated_at                          â”‚                      â”‚     â”‚
â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚     â”‚
â”‚    â”‚                      â”‚                                         â”‚     â”‚
â”‚    â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚     â”‚
â”‚    â”‚          â”‚           â”‚           â”‚           â”‚                â”‚     â”‚
â”‚    â”‚        1 â”‚         1 â”‚         1 â”‚         1 â”‚                â”‚     â”‚
â”‚    â”‚          â”‚           â”‚           â”‚           â”‚                â”‚     â”‚
â”‚    â”‚          â–¼           â–¼           â–¼           â–¼                â”‚     â”‚
â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚     â”‚
â”‚    â”‚   â”‚transcriptsâ”‚â”‚ speaker_  â”‚â”‚ session_  â”‚â”‚ session_  â”‚        â”‚     â”‚
â”‚    â”‚   â”‚           â”‚â”‚ segments  â”‚â”‚ analyses  â”‚â”‚ reports   â”‚        â”‚     â”‚
â”‚    â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚     â”‚
â”‚    â”‚   â”‚id (PK)    â”‚â”‚id (PK)    â”‚â”‚id (PK)    â”‚â”‚id (PK)    â”‚        â”‚     â”‚
â”‚    â”‚   â”‚session_id â”‚â”‚session_id â”‚â”‚session_id â”‚â”‚session_id â”‚        â”‚     â”‚
â”‚    â”‚   â”‚chunk_indexâ”‚â”‚speaker    â”‚â”‚chunk_indexâ”‚â”‚overall_   â”‚        â”‚     â”‚
â”‚    â”‚   â”‚text       â”‚â”‚start_time â”‚â”‚indicator  â”‚â”‚score      â”‚        â”‚     â”‚
â”‚    â”‚   â”‚start_time â”‚â”‚end_time   â”‚â”‚value      â”‚â”‚good_pointsâ”‚        â”‚     â”‚
â”‚    â”‚   â”‚end_time   â”‚â”‚text       â”‚â”‚score      â”‚â”‚improve_   â”‚        â”‚     â”‚
â”‚    â”‚   â”‚audio_url  â”‚â”‚confidence â”‚â”‚details    â”‚â”‚points     â”‚        â”‚     â”‚
â”‚    â”‚   â”‚created_at â”‚â”‚created_at â”‚â”‚created_at â”‚â”‚action_    â”‚        â”‚     â”‚
â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚items      â”‚        â”‚     â”‚
â”‚    â”‚          n           n           n       â”‚transcript â”‚        â”‚     â”‚
â”‚    â”‚                                          â”‚summary    â”‚        â”‚     â”‚
â”‚    â”‚                                          â”‚ai_feedbackâ”‚        â”‚     â”‚
â”‚    â”‚                                          â”‚created_at â”‚        â”‚     â”‚
â”‚    â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚     â”‚
â”‚    â”‚                                                 1             â”‚     â”‚
â”‚    â”‚                                                               â”‚     â”‚
â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”‚
â”‚    â”‚   â”‚                  success_cases                      â”‚     â”‚     â”‚
â”‚    â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ id (PK)                                             â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ salon_id (FK)                                       â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ session_id (FK, nullable)                           â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ stylist_id (FK, nullable)                           â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ concern_keywords (TEXT[])                           â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ customer_profile (JSONB)                            â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ successful_talk (TEXT)                              â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ key_tactics (TEXT[])                                â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ sold_product (VARCHAR)                              â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ conversion_rate (NUMERIC)                           â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ embedding (VECTOR(1536))                            â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ is_public (BOOLEAN)                                 â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ created_at                                          â”‚     â”‚     â”‚
â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚
â”‚    â”‚                                                               â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”‚
â”‚    â”‚   â”‚                    customers                       â”‚     â”‚     â”‚
â”‚    â”‚   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ id (PK)                                             â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ salon_id (FK)                                       â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ name (nullable)                                     â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ voice_embedding (VECTOR(512))                       â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ embedding_updated_at                                â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ total_visits                                        â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ first_visit_at                                      â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ last_visit_at                                       â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ metadata (JSONB)                                    â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ created_at                                          â”‚     â”‚     â”‚
â”‚    â”‚   â”‚ updated_at                                          â”‚     â”‚     â”‚
â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚
â”‚    â”‚                                                               â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â”‚  ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£:                                                           â”‚
â”‚  salon â”€1:nâ”€ staff                                                         â”‚
â”‚  salon â”€1:nâ”€ session                                                       â”‚
â”‚  salon â”€1:nâ”€ customer                                                      â”‚
â”‚  staff â”€1:nâ”€ session                                                       â”‚
â”‚  session â”€1:nâ”€ transcript                                                  â”‚
â”‚  session â”€1:nâ”€ speaker_segment                                             â”‚
â”‚  session â”€1:nâ”€ session_analysis                                            â”‚
â”‚  session â”€1:1â”€ session_report                                              â”‚
â”‚  session â”€n:1â”€ customer (nullable, å£°ç´‹è­˜åˆ¥æ™‚ã«ç´ä»˜ã‘)                       â”‚
â”‚  salon â”€1:nâ”€ success_case                                                  â”‚
â”‚  session â”€0..1:nâ”€ success_case (optional)                                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

#### 6.2.1 salonsï¼ˆåº—èˆ—ï¼‰

> âš ï¸ **å®Ÿè£…ã«åˆã‚ã›ã¦ä¿®æ­£ï¼ˆ2025-12-05ï¼‰**
> - plan: 'free', 'standard', 'premium', 'enterprise' ã«å¤‰æ›´ï¼ˆå®Ÿè£…ã¨çµ±ä¸€ï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| name | VARCHAR(100) | NOT NULL | - | åº—èˆ—å |
| address | TEXT | NULL | - | ä½æ‰€ |
| phone | VARCHAR(20) | NULL | - | é›»è©±ç•ªå· |
| plan | VARCHAR(20) | NOT NULL | 'free' | å¥‘ç´„ãƒ—ãƒ©ãƒ³ |
| seats_count | INTEGER | NULL | - | å¸­æ•° |
| settings | JSONB | NOT NULL | '{}' | åº—èˆ—è¨­å®š |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
CREATE TABLE salons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  address TEXT,
  phone VARCHAR(20),
  plan VARCHAR(20) NOT NULL DEFAULT 'free'
    CHECK (plan IN ('free', 'standard', 'premium', 'enterprise')),
  seats_count INTEGER CHECK (seats_count IS NULL OR seats_count > 0),
  settings JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_salons_plan ON salons(plan);
CREATE INDEX idx_salons_created_at ON salons(created_at);
```

**settings JSONBæ§‹é€ **:

```json
{
  "notification": {
    "enablePush": true,
    "enableEmail": true,
    "concernDetectionAlert": true,
    "sessionCompleteAlert": true
  },
  "analysis": {
    "idealTalkRatio": 40,
    "minQuestionCount": 8,
    "concernKeywords": ["ä¹¾ç‡¥", "åºƒãŒã‚Š", "ãƒ‘ã‚µã¤ã", "ãƒ€ãƒ¡ãƒ¼ã‚¸", "ã†ã­ã‚Š", "è–„æ¯›", "ç™½é«ª"]
  },
  "display": {
    "showRanking": true,
    "anonymizeCustomer": false
  }
}
```

---

#### 6.2.2a devicesï¼ˆãƒ‡ãƒã‚¤ã‚¹ï¼‰

> ğŸ†• **æ–°è¦è¿½åŠ ï¼ˆ2025-12-09ï¼‰**: iPadãƒ‡ãƒã‚¤ã‚¹ç®¡ç†ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| salon_id | UUID | NOT NULL | - | æ‰€å±åº—èˆ—ï¼ˆFKï¼‰ |
| device_name | VARCHAR(100) | NOT NULL | - | ãƒ‡ãƒã‚¤ã‚¹åï¼ˆä¾‹: "å¸­1", "å¾…åˆå®¤"ï¼‰ |
| device_identifier | VARCHAR(255) | NULL | - | ãƒ‡ãƒã‚¤ã‚¹å›ºæœ‰è­˜åˆ¥å­ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«è¨­å®šï¼‰ |
| status | device_status | NOT NULL | 'pending' | ãƒ‡ãƒã‚¤ã‚¹çŠ¶æ…‹ |
| seat_number | INTEGER | NULL | - | åº§å¸­ç•ªå· |
| last_active_at | TIMESTAMPTZ | NULL | - | æœ€çµ‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ—¥æ™‚ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | æ›´æ–°æ—¥æ™‚ |

**device_status ENUM**:
```sql
CREATE TYPE device_status AS ENUM ('pending', 'active', 'inactive', 'revoked');
```

| çŠ¶æ…‹ | èª¬æ˜ |
|------|------|
| pending | ç™»éŒ²æ¸ˆã¿ãƒ»æœªã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ |
| active | ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆæ¸ˆã¿ãƒ»ç¨¼åƒä¸­ |
| inactive | ä¸€æ™‚ç„¡åŠ¹åŒ– |
| revoked | æ°¸ä¹…ç„¡åŠ¹ï¼ˆç´›å¤±ãƒ»ç›—é›£ç­‰ï¼‰ |

**åˆ¶ç´„**:

```sql
CREATE TABLE devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  device_name VARCHAR(100) NOT NULL,
  device_identifier VARCHAR(255),
  status device_status NOT NULL DEFAULT 'pending',
  seat_number INTEGER CHECK (seat_number IS NULL OR seat_number > 0),
  last_active_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- åŒä¸€åº—èˆ—å†…ã§ãƒ‡ãƒã‚¤ã‚¹åã¯ä¸€æ„
  CONSTRAINT devices_salon_name_unique UNIQUE (salon_id, device_name),
  -- åŒä¸€åº—èˆ—å†…ã§åº§å¸­ç•ªå·ã¯ä¸€æ„
  CONSTRAINT devices_seat_number_unique UNIQUE (salon_id, seat_number),
  -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆæ¸ˆã¿ãƒ‡ãƒã‚¤ã‚¹ã®ã¿è­˜åˆ¥å­å¿…é ˆ
  CONSTRAINT devices_identifier_unique UNIQUE (device_identifier)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_devices_salon_id ON devices(salon_id);
CREATE INDEX idx_devices_status ON devices(status);
CREATE INDEX idx_devices_last_active ON devices(last_active_at DESC);
```

**ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åˆ¤å®š**:
- `last_active_at` ãŒç¾åœ¨æ™‚åˆ»ã‹ã‚‰5åˆ†ä»¥å†… â†’ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
- ãã‚Œä»¥å¤– â†’ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³
- ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã¯1-2åˆ†é–“éš”ã§é€ä¿¡

---

#### 6.2.2b device_activationsï¼ˆãƒ‡ãƒã‚¤ã‚¹ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

> ğŸ†• **æ–°è¦è¿½åŠ ï¼ˆ2025-12-09ï¼‰**: ãƒ‡ãƒã‚¤ã‚¹ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ç®¡ç†

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| device_id | UUID | NOT NULL | - | ãƒ‡ãƒã‚¤ã‚¹ï¼ˆFKï¼‰ |
| activation_code | CHAR(6) | NOT NULL | - | 6æ¡æ•°å­—ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ |
| expires_at | TIMESTAMPTZ | NOT NULL | - | ã‚³ãƒ¼ãƒ‰æœ‰åŠ¹æœŸé™ï¼ˆç”Ÿæˆã‹ã‚‰24æ™‚é–“ï¼‰ |
| used_at | TIMESTAMPTZ | NULL | - | ä½¿ç”¨æ—¥æ™‚ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
CREATE TABLE device_activations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
  activation_code CHAR(6) NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  used_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- æœªä½¿ç”¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã¯ä¸€æ„
  CONSTRAINT device_activations_code_unique
    UNIQUE (activation_code) WHERE used_at IS NULL
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_device_activations_code ON device_activations(activation_code) WHERE used_at IS NULL;
CREATE INDEX idx_device_activations_device_id ON device_activations(device_id);
CREATE INDEX idx_device_activations_expires ON device_activations(expires_at) WHERE used_at IS NULL;
```

**ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼**:
1. ç®¡ç†è€…ãŒWebãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²
2. ã‚·ã‚¹ãƒ†ãƒ ãŒ6æ¡ã®æ•°å­—ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆ24æ™‚é–“æœ‰åŠ¹ï¼‰
3. ã‚¹ã‚¿ãƒƒãƒ•ãŒiPadã‚¢ãƒ—ãƒªã§ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›
4. ãƒ‡ãƒã‚¤ã‚¹ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã•ã‚Œã€`device_identifier`ãŒè¨­å®š
5. ä»¥é™ã¯ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«`device_identifier`ã§èªè¨¼

---

#### 6.2.3 staffsï¼ˆã‚¹ã‚¿ãƒƒãƒ•ï¼‰

> âš ï¸ **å®Ÿè£…ã«åˆã‚ã›ã¦ä¿®æ­£ï¼ˆ2025-12-05ï¼‰**
> - id = auth.users(id)æ§‹é€ ã«å¤‰æ›´ï¼ˆSupabaseæ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
> - role: 'stylist', 'manager', 'owner', 'admin' ã«å¤‰æ›´
> - ä¸è¦ã‚«ãƒ©ãƒ å‰Šé™¤ï¼ˆposition, join_date, profile_image_url, settingsï¼‰
>
> ğŸ†• **å£°ç´‹è­˜åˆ¥æ©Ÿèƒ½è¿½åŠ ï¼ˆ2025-12-09ï¼‰**
> - voice_embedding, voice_registered_at, voice_sample_count, setup_completed è¿½åŠ 

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | - | ä¸»ã‚­ãƒ¼ï¼ˆ= auth.users.idï¼‰ |
| salon_id | UUID | NOT NULL | - | æ‰€å±åº—èˆ—ï¼ˆFKï¼‰ |
| name | VARCHAR(50) | NOT NULL | - | æ°å |
| email | VARCHAR(255) | NOT NULL | - | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| role | VARCHAR(20) | NOT NULL | 'stylist' | ãƒ­ãƒ¼ãƒ« |
| avatar_url | TEXT | NULL | - | ã‚¢ãƒã‚¿ãƒ¼ç”»åƒURL |
| is_active | BOOLEAN | NOT NULL | true | æœ‰åŠ¹ãƒ•ãƒ©ã‚° |
| voice_embedding | VECTOR(512) | NULL | - | å£°ç´‹åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ« |
| voice_registered_at | TIMESTAMPTZ | NULL | - | å£°ç´‹ç™»éŒ²æ—¥æ™‚ |
| voice_sample_count | INTEGER | NOT NULL | 0 | å£°ç´‹ã‚µãƒ³ãƒ—ãƒ«æ•° |
| setup_completed | BOOLEAN | NOT NULL | false | åˆæœŸè¨­å®šå®Œäº†ãƒ•ãƒ©ã‚° |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
CREATE TABLE staffs (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'stylist'
    CHECK (role IN ('stylist', 'manager', 'owner', 'admin')),
  avatar_url TEXT,
  is_active BOOLEAN NOT NULL DEFAULT true,
  voice_embedding VECTOR(512),
  voice_registered_at TIMESTAMPTZ,
  voice_sample_count INTEGER NOT NULL DEFAULT 0 CHECK (voice_sample_count >= 0),
  setup_completed BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  UNIQUE (email)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_staffs_salon_id ON staffs(salon_id);
CREATE INDEX idx_staffs_role ON staffs(role);
CREATE INDEX idx_staffs_is_active ON staffs(is_active);

-- HNSWãƒ™ã‚¯ãƒˆãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¹ã‚¿ãƒƒãƒ•å£°ç´‹é¡ä¼¼æ¤œç´¢ç”¨ï¼‰
CREATE INDEX idx_staffs_voice_embedding ON staffs
  USING hnsw (voice_embedding vector_cosine_ops)
  WITH (m = 16, ef_construction = 64);
```

**å£°ç´‹ç™»éŒ²ãƒ•ãƒ­ãƒ¼**:
1. ã‚¹ã‚¿ãƒƒãƒ•ãŒéŸ³å£°ã‚µãƒ³ãƒ—ãƒ«ã‚’éŒ²éŸ³ï¼ˆæœ€ä½5ç§’ã€æ¨å¥¨30ç§’ä»¥ä¸Šï¼‰
2. pyannoteã‚µãƒ¼ãƒãƒ¼ã§512æ¬¡å…ƒã®embeddingã‚’æŠ½å‡º
3. `register-staff-voice` Edge Functionã§ç™»éŒ²
4. è¤‡æ•°å›éŒ²éŸ³æ™‚ã¯é‡ã¿ä»˜ãå¹³å‡ã§æ›´æ–°ï¼ˆweight = min(1/(n+1), 0.2)ï¼‰

---

#### 6.2.4 sessionsï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰

> âš ï¸ **å®Ÿè£…ã«åˆã‚ã›ã¦ä¿®æ­£ï¼ˆ2025-12-05ï¼‰**
> - status: 'analyzing'è¿½åŠ ã€'failed'â†’'error'ã«å¤‰æ›´
> - total_duration_msè¿½åŠ 
>
> ğŸ†• **ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†ãƒ»ã‚¹ã‚¿ãƒƒãƒ•è‡ªå‹•è­˜åˆ¥è¿½åŠ ï¼ˆ2025-12-09ï¼‰**
> - device_id: éŒ²éŸ³ãƒ‡ãƒã‚¤ã‚¹ã®ç´ä»˜ã‘
> - stylist_id: NULLè¨±å¯ï¼ˆå£°ç´‹è­˜åˆ¥å‰ã¯æœªç¢ºå®šï¼‰
> - stylist_match_confidence: è‡ªå‹•è­˜åˆ¥ã®ä¿¡é ¼åº¦

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| salon_id | UUID | NOT NULL | - | åº—èˆ—ï¼ˆFKï¼‰ |
| stylist_id | UUID | NULL | - | ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆï¼ˆFKã€å£°ç´‹è­˜åˆ¥å¾Œã«è¨­å®šï¼‰ |
| device_id | UUID | NULL | - | éŒ²éŸ³ãƒ‡ãƒã‚¤ã‚¹ï¼ˆFKï¼‰ |
| started_at | TIMESTAMPTZ | NOT NULL | NOW() | é–‹å§‹æ—¥æ™‚ |
| ended_at | TIMESTAMPTZ | NULL | - | çµ‚äº†æ—¥æ™‚ |
| total_duration_ms | INTEGER | NULL | - | åˆè¨ˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ |
| status | VARCHAR(20) | NOT NULL | 'recording' | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
| customer_info | JSONB | NULL | - | ãŠå®¢æ§˜æƒ…å ± |
| diarization_status | VARCHAR(20) | NULL | 'pending' | è©±è€…åˆ†é›¢çŠ¶æ…‹ |
| stylist_match_confidence | REAL | NULL | - | ã‚¹ã‚¿ãƒƒãƒ•è­˜åˆ¥ä¿¡é ¼åº¦ï¼ˆ0.0-1.0ï¼‰ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  stylist_id UUID REFERENCES staffs(id) ON DELETE SET NULL,
  device_id UUID REFERENCES devices(id) ON DELETE SET NULL,
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  total_duration_ms INTEGER,
  status VARCHAR(20) NOT NULL DEFAULT 'recording'
    CHECK (status IN ('recording', 'processing', 'analyzing', 'completed', 'error')),
  customer_info JSONB,
  diarization_status VARCHAR(20) DEFAULT 'pending'
    CHECK (diarization_status IN ('pending', 'processing', 'completed', 'failed')),
  stylist_match_confidence REAL CHECK (stylist_match_confidence IS NULL OR (stylist_match_confidence >= 0 AND stylist_match_confidence <= 1)),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_sessions_salon_id ON sessions(salon_id);
CREATE INDEX idx_sessions_stylist_id ON sessions(stylist_id);
CREATE INDEX idx_sessions_device_id ON sessions(device_id);
CREATE INDEX idx_sessions_status ON sessions(status);
CREATE INDEX idx_sessions_started_at ON sessions(started_at DESC);
CREATE INDEX idx_sessions_salon_started ON sessions(salon_id, started_at DESC);
```

**ã‚¹ã‚¿ãƒƒãƒ•è‡ªå‹•è­˜åˆ¥ã®ä¿¡é ¼åº¦ãƒ¬ãƒ™ãƒ«**:

| ä¿¡é ¼åº¦ç¯„å›² | ãƒ¬ãƒ™ãƒ« | å‹•ä½œ |
|-----------|--------|------|
| >= 0.85 | high | è‡ªå‹•ç¢ºå®š |
| 0.75 - 0.85 | medium | ç¢ºèªãƒªã‚¯ã‚¨ã‚¹ãƒˆä»˜ãã§è¨­å®š |
| 0.65 - 0.75 | low | ç¢ºèªå¿…é ˆã§è¨­å®š |
| < 0.65 | none | æ‰‹å‹•é¸æŠãŒå¿…è¦ |

**customer_info JSONBæ§‹é€ **:

```json
{
  "ageGroup": "30s",
  "gender": "female",
  "visitFrequency": "monthly",
  "notes": "ã‚«ãƒ©ãƒ¼ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚ã‚Š"
}
```

---

#### 6.2.5 transcriptsï¼ˆæ–‡å­—èµ·ã“ã—ï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| session_id | UUID | NOT NULL | - | ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆFKï¼‰ |
| chunk_index | INTEGER | NOT NULL | - | ãƒãƒ£ãƒ³ã‚¯ç•ªå· |
| text | TEXT | NOT NULL | - | æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆ |
| start_time | NUMERIC(10,3) | NOT NULL | - | é–‹å§‹æ™‚é–“ï¼ˆç§’ï¼‰ |
| end_time | NUMERIC(10,3) | NOT NULL | - | çµ‚äº†æ™‚é–“ï¼ˆç§’ï¼‰ |
| audio_url | TEXT | NULL | - | éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«URL |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
CREATE TABLE transcripts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  text TEXT NOT NULL,
  start_time NUMERIC(10, 3) NOT NULL,
  end_time NUMERIC(10, 3) NOT NULL,
  audio_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (session_id, chunk_index)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_transcripts_session_id ON transcripts(session_id);
CREATE INDEX idx_transcripts_session_chunk ON transcripts(session_id, chunk_index);
```

---

#### 6.2.6 speaker_segmentsï¼ˆè©±è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| session_id | UUID | NOT NULL | - | ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆFKï¼‰ |
| speaker | VARCHAR(20) | NOT NULL | - | è©±è€…ãƒ©ãƒ™ãƒ« |
| start_time | NUMERIC(10,3) | NOT NULL | - | é–‹å§‹æ™‚é–“ï¼ˆç§’ï¼‰ |
| end_time | NUMERIC(10,3) | NOT NULL | - | çµ‚äº†æ™‚é–“ï¼ˆç§’ï¼‰ |
| text | TEXT | NULL | - | è©²å½“ãƒ†ã‚­ã‚¹ãƒˆ |
| confidence | NUMERIC(5,4) | NULL | - | ä¿¡é ¼åº¦ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
CREATE TABLE speaker_segments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  speaker VARCHAR(20) NOT NULL
    CHECK (speaker IN ('stylist', 'customer', 'unknown')),
  start_time NUMERIC(10, 3) NOT NULL,
  end_time NUMERIC(10, 3) NOT NULL,
  text TEXT,
  confidence NUMERIC(5, 4) CHECK (confidence >= 0 AND confidence <= 1),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_speaker_segments_session_id ON speaker_segments(session_id);
CREATE INDEX idx_speaker_segments_speaker ON speaker_segments(speaker);
CREATE INDEX idx_speaker_segments_time ON speaker_segments(session_id, start_time);
```

---

#### 6.2.7 session_analysesï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| session_id | UUID | NOT NULL | - | ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆFKï¼‰ |
| chunk_index | INTEGER | NOT NULL | - | ãƒãƒ£ãƒ³ã‚¯ç•ªå· |
| indicator_type | VARCHAR(30) | NOT NULL | - | æŒ‡æ¨™ç¨®åˆ¥ |
| value | NUMERIC(10,4) | NOT NULL | - | æ¸¬å®šå€¤ |
| score | INTEGER | NOT NULL | - | ã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰ |
| details | JSONB | NULL | - | è©³ç´°ãƒ‡ãƒ¼ã‚¿ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
CREATE TABLE session_analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  indicator_type VARCHAR(30) NOT NULL
    CHECK (indicator_type IN (
      'talk_ratio',
      'question_analysis',
      'emotion_analysis',
      'concern_keywords',
      'proposal_timing',
      'proposal_quality',
      'conversion'
    )),
  value NUMERIC(10, 4) NOT NULL,
  score INTEGER NOT NULL CHECK (score >= 0 AND score <= 100),
  details JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (session_id, chunk_index, indicator_type)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_session_analyses_session_id ON session_analyses(session_id);
CREATE INDEX idx_session_analyses_indicator ON session_analyses(indicator_type);
CREATE INDEX idx_session_analyses_session_chunk ON session_analyses(session_id, chunk_index);
```

**details JSONBæ§‹é€ ä¾‹**:

```json
// talk_ratio
{
  "stylistSeconds": 1800,
  "customerSeconds": 2700,
  "totalSeconds": 4500,
  "ratio": 40.0
}

// question_analysis
{
  "totalQuestions": 12,
  "openQuestions": 8,
  "closedQuestions": 4,
  "openRatio": 66.67,
  "questionList": [
    {"text": "ä»Šæ—¥ã¯ã©ã†ã•ã‚Œã¾ã™ã‹ï¼Ÿ", "type": "open", "time": 120.5}
  ]
}

// concern_keywords
{
  "detected": true,
  "keywords": ["ä¹¾ç‡¥", "åºƒãŒã‚Š"],
  "detectedAt": [180.5, 245.2],
  "context": "é«ªãŒä¹¾ç‡¥ã—ã¦ãƒ‘ã‚µãƒ‘ã‚µãªã‚“ã§ã™"
}
```

---

#### 6.2.8 session_reportsï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| session_id | UUID | NOT NULL | - | ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆFKï¼‰ |
| overall_score | INTEGER | NOT NULL | - | ç·åˆã‚¹ã‚³ã‚¢ |
| good_points | TEXT[] | NOT NULL | - | è‰¯ã‹ã£ãŸç‚¹ |
| improvement_points | TEXT[] | NOT NULL | - | æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ |
| action_items | TEXT[] | NOT NULL | - | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ  |
| transcript_summary | TEXT | NULL | - | ä¼šè©±è¦ç´„ |
| ai_feedback | TEXT | NULL | - | AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ |
| indicator_scores | JSONB | NOT NULL | - | æŒ‡æ¨™åˆ¥ã‚¹ã‚³ã‚¢ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
CREATE TABLE session_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  overall_score INTEGER NOT NULL CHECK (overall_score >= 0 AND overall_score <= 100),
  good_points TEXT[] NOT NULL DEFAULT '{}',
  improvement_points TEXT[] NOT NULL DEFAULT '{}',
  action_items TEXT[] NOT NULL DEFAULT '{}',
  transcript_summary TEXT,
  ai_feedback TEXT,
  indicator_scores JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (session_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_session_reports_session_id ON session_reports(session_id);
CREATE INDEX idx_session_reports_score ON session_reports(overall_score DESC);
```

**indicator_scores JSONBæ§‹é€ **:

```json
{
  "talk_ratio": {"score": 85, "value": 42.5},
  "question_analysis": {"score": 80, "value": 10},
  "emotion_analysis": {"score": 90, "value": 75.0},
  "concern_keywords": {"score": 100, "value": 1},
  "proposal_timing": {"score": 85, "value": 3.5},
  "proposal_quality": {"score": 70, "value": 65.0},
  "conversion": {"score": 100, "value": 1}
}
```

---

#### 6.2.9 success_casesï¼ˆæˆåŠŸäº‹ä¾‹ï¼‰

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| salon_id | UUID | NOT NULL | - | åº—èˆ—ï¼ˆFKï¼‰ |
| session_id | UUID | NULL | - | å…ƒã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆFKï¼‰ |
| stylist_id | UUID | NULL | - | ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆï¼ˆFKï¼‰ |
| concern_keywords | TEXT[] | NOT NULL | - | æ‚©ã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ |
| customer_profile | JSONB | NULL | - | ãŠå®¢æ§˜å±æ€§ |
| successful_talk | TEXT | NOT NULL | - | æˆåŠŸãƒˆãƒ¼ã‚¯ä¾‹ |
| key_tactics | TEXT[] | NOT NULL | - | ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ |
| sold_product | VARCHAR(100) | NULL | - | æˆç´„å•†å“ |
| conversion_rate | NUMERIC(5,4) | NULL | - | æˆç´„ç‡ |
| embedding | VECTOR(1536) | NULL | - | ãƒ™ã‚¯ãƒˆãƒ«åŸ‹ã‚è¾¼ã¿ |
| is_public | BOOLEAN | NOT NULL | false | å…¬é–‹ãƒ•ãƒ©ã‚° |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
-- pgvectoræ‹¡å¼µã‚’æœ‰åŠ¹åŒ–
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE success_cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
  stylist_id UUID REFERENCES staffs(id) ON DELETE SET NULL,
  concern_keywords TEXT[] NOT NULL DEFAULT '{}',
  customer_profile JSONB,
  successful_talk TEXT NOT NULL,
  key_tactics TEXT[] NOT NULL DEFAULT '{}',
  sold_product VARCHAR(100),
  conversion_rate NUMERIC(5, 4) CHECK (conversion_rate >= 0 AND conversion_rate <= 1),
  embedding VECTOR(1536),
  is_public BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_success_cases_salon_id ON success_cases(salon_id);
CREATE INDEX idx_success_cases_concern ON success_cases USING GIN(concern_keywords);
CREATE INDEX idx_success_cases_is_public ON success_cases(is_public);

-- HNSWãƒ™ã‚¯ãƒˆãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆè¿‘ä¼¼æœ€è¿‘å‚æ¢ç´¢ï¼‰
CREATE INDEX idx_success_cases_embedding ON success_cases
  USING hnsw (embedding vector_cosine_ops)
  WITH (m = 16, ef_construction = 64);
```

---

#### 6.2.10 customersï¼ˆé¡§å®¢ãƒ»å£°ç´‹è­˜åˆ¥ï¼‰

> ğŸ†• **æ–°è¦è¿½åŠ ï¼ˆ2025-12-06ï¼‰**: å£°ç´‹è­˜åˆ¥æ©Ÿèƒ½ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | ä¸»ã‚­ãƒ¼ |
| salon_id | UUID | NOT NULL | - | åº—èˆ—ï¼ˆFKï¼‰ |
| name | VARCHAR(100) | NULL | - | é¡§å®¢å |
| voice_embedding | VECTOR(512) | NULL | - | å£°ç´‹åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ« |
| embedding_updated_at | TIMESTAMPTZ | NULL | - | åŸ‹ã‚è¾¼ã¿æœ€çµ‚æ›´æ–°æ—¥æ™‚ |
| total_visits | INTEGER | NOT NULL | 1 | æ¥åº—å›æ•° |
| first_visit_at | TIMESTAMPTZ | NOT NULL | NOW() | åˆå›æ¥åº—æ—¥æ™‚ |
| last_visit_at | TIMESTAMPTZ | NOT NULL | NOW() | æœ€çµ‚æ¥åº—æ—¥æ™‚ |
| metadata | JSONB | NOT NULL | '{}' | è¿½åŠ æƒ…å ± |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | æ›´æ–°æ—¥æ™‚ |

**åˆ¶ç´„**:

```sql
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  name VARCHAR(100),
  voice_embedding VECTOR(512),
  embedding_updated_at TIMESTAMPTZ,
  total_visits INTEGER NOT NULL DEFAULT 1 CHECK (total_visits > 0),
  first_visit_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_visit_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  metadata JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_customers_salon_id ON customers(salon_id);
CREATE INDEX idx_customers_name ON customers(name) WHERE name IS NOT NULL;
CREATE INDEX idx_customers_last_visit ON customers(salon_id, last_visit_at DESC);

-- HNSWãƒ™ã‚¯ãƒˆãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå£°ç´‹é¡ä¼¼æ¤œç´¢ç”¨ï¼‰
CREATE INDEX idx_customers_voice_embedding ON customers
  USING hnsw (voice_embedding vector_cosine_ops)
  WITH (m = 16, ef_construction = 64);
```

**metadata JSONBæ§‹é€ **:

```json
{
  "age_group": "30s",
  "gender": "female",
  "preferences": ["ã‚«ãƒ©ãƒ¼å¥½ã¿", "ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯å¿—å‘"],
  "notes": "é ­çš®æ•æ„Ÿ",
  "name_candidates": [
    {"name": "ç”°ä¸­", "confidence": 0.95, "source": "stylist_address"},
    {"name": "ãŸãªã‹", "confidence": 0.7, "source": "customer_intro"}
  ]
}
```

---

#### 6.2.11 sessions.customer_idï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ã®é¡§å®¢ç´ä»˜ã‘ï¼‰

> ğŸ†• **æ–°è¦è¿½åŠ ï¼ˆ2025-12-06ï¼‰**: sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã«customer_idã‚«ãƒ©ãƒ è¿½åŠ 

```sql
-- sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã«customer_idã‚’è¿½åŠ 
ALTER TABLE sessions
  ADD COLUMN customer_id UUID REFERENCES customers(id) ON DELETE SET NULL;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_sessions_customer_id ON sessions(customer_id);
```

---

#### 6.2.12 å£°ç´‹ãƒãƒƒãƒãƒ³ã‚°é–¢æ•°

```sql
-- å£°ç´‹ãƒãƒƒãƒãƒ³ã‚°æ¤œç´¢é–¢æ•°
CREATE OR REPLACE FUNCTION match_customer_by_voice(
  query_embedding VECTOR(512),
  salon_id_param UUID,
  match_threshold FLOAT DEFAULT 0.65,
  match_count INT DEFAULT 5
)
RETURNS TABLE (
  customer_id UUID,
  customer_name TEXT,
  similarity FLOAT,
  total_visits INTEGER,
  last_visit_at TIMESTAMPTZ
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    c.id,
    c.name,
    1 - (c.voice_embedding <=> query_embedding) AS similarity,
    c.total_visits,
    c.last_visit_at
  FROM customers c
  WHERE c.salon_id = salon_id_param
    AND c.voice_embedding IS NOT NULL
    AND 1 - (c.voice_embedding <=> query_embedding) > match_threshold
  ORDER BY c.voice_embedding <=> query_embedding
  LIMIT match_count;
END;
$$;

-- å£°ç´‹åŸ‹ã‚è¾¼ã¿æ›´æ–°é–¢æ•°ï¼ˆæ¥åº—æ™‚ã®å¹³å‡åŒ–ï¼‰
CREATE OR REPLACE FUNCTION update_customer_embedding(
  customer_id_param UUID,
  new_embedding VECTOR(512)
)
RETURNS VOID
LANGUAGE plpgsql
AS $$
DECLARE
  current_visits INTEGER;
  current_embedding VECTOR(512);
BEGIN
  SELECT total_visits, voice_embedding
  INTO current_visits, current_embedding
  FROM customers
  WHERE id = customer_id_param;

  -- æ—¢å­˜åŸ‹ã‚è¾¼ã¿ãŒã‚ã‚‹å ´åˆã¯é‡ã¿ä»˜ãå¹³å‡
  IF current_embedding IS NOT NULL THEN
    UPDATE customers
    SET
      voice_embedding = (
        (current_embedding * current_visits + new_embedding) / (current_visits + 1)
      ),
      embedding_updated_at = NOW(),
      total_visits = current_visits + 1,
      last_visit_at = NOW(),
      updated_at = NOW()
    WHERE id = customer_id_param;
  ELSE
    UPDATE customers
    SET
      voice_embedding = new_embedding,
      embedding_updated_at = NOW(),
      last_visit_at = NOW(),
      updated_at = NOW()
    WHERE id = customer_id_param;
  END IF;
END;
$$;

-- ğŸ†• ã‚¹ã‚¿ãƒƒãƒ•å£°ç´‹ãƒãƒƒãƒãƒ³ã‚°æ¤œç´¢é–¢æ•°ï¼ˆ2025-12-09è¿½åŠ ï¼‰
CREATE OR REPLACE FUNCTION match_staff_by_voice(
  query_embedding VECTOR(512),
  salon_id_param UUID,
  match_threshold FLOAT DEFAULT 0.65,
  match_count INT DEFAULT 3
)
RETURNS TABLE (
  staff_id UUID,
  name TEXT,
  similarity FLOAT,
  confidence_level TEXT
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    s.id,
    s.name,
    1 - (s.voice_embedding <=> query_embedding) AS similarity,
    CASE
      WHEN 1 - (s.voice_embedding <=> query_embedding) >= 0.85 THEN 'high'
      WHEN 1 - (s.voice_embedding <=> query_embedding) >= 0.75 THEN 'medium'
      WHEN 1 - (s.voice_embedding <=> query_embedding) >= 0.65 THEN 'low'
      ELSE 'none'
    END AS confidence_level
  FROM staffs s
  WHERE s.salon_id = salon_id_param
    AND s.voice_embedding IS NOT NULL
    AND s.is_active = true
    AND 1 - (s.voice_embedding <=> query_embedding) > match_threshold
  ORDER BY s.voice_embedding <=> query_embedding
  LIMIT match_count;
END;
$$;

-- ã‚¹ã‚¿ãƒƒãƒ•å£°ç´‹ç™»éŒ²é–¢æ•°ï¼ˆé‡ã¿ä»˜ãå¹³å‡ï¼‰
CREATE OR REPLACE FUNCTION register_staff_voice(
  staff_id_param UUID,
  new_embedding VECTOR(512),
  quality_score FLOAT
)
RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
  current_count INTEGER;
  current_embedding VECTOR(512);
  weight FLOAT;
BEGIN
  SELECT voice_sample_count, voice_embedding
  INTO current_count, current_embedding
  FROM staffs
  WHERE id = staff_id_param;

  -- é‡ã¿ã‚’è¨ˆç®—ï¼ˆæœ€å¤§0.2ã€åˆå›ã¯1.0ï¼‰
  weight := LEAST(1.0 / (current_count + 1), 0.2);

  IF current_embedding IS NOT NULL AND current_count > 0 THEN
    -- é‡ã¿ä»˜ãå¹³å‡ã§æ›´æ–°
    UPDATE staffs
    SET
      voice_embedding = (current_embedding * (1 - weight) + new_embedding * weight),
      voice_registered_at = NOW(),
      voice_sample_count = current_count + 1,
      setup_completed = true,
      updated_at = NOW()
    WHERE id = staff_id_param;
  ELSE
    -- åˆå›ç™»éŒ²
    UPDATE staffs
    SET
      voice_embedding = new_embedding,
      voice_registered_at = NOW(),
      voice_sample_count = 1,
      setup_completed = true,
      updated_at = NOW()
    WHERE id = staff_id_param;
  END IF;

  RETURN jsonb_build_object(
    'success', true,
    'sample_count', COALESCE(current_count, 0) + 1,
    'weight_used', weight
  );
END;
$$;
```

### 6.3 ãƒ‡ãƒ¼ã‚¿é‡è¦‹ç©ã‚‚ã‚Š

#### 6.3.1 åˆæœŸã€œ5å¹´å¾Œã®ãƒ‡ãƒ¼ã‚¿é‡äºˆæ¸¬

| ãƒ†ãƒ¼ãƒ–ãƒ« | åˆæœŸï¼ˆ5åº—èˆ—ï¼‰ | 1å¹´å¾Œï¼ˆ50åº—èˆ—ï¼‰ | 3å¹´å¾Œï¼ˆ200åº—èˆ—ï¼‰ | 5å¹´å¾Œï¼ˆ500åº—èˆ—ï¼‰ |
|---------|-------------|---------------|-----------------|-----------------|
| salons | 5 | 50 | 200 | 500 |
| staffs | 50 | 500 | 2,000 | 5,000 |
| devices | 25 | 250 | 1,000 | 2,500 |
| device_activations | 30 | 300 | 1,200 | 3,000 |
| sessions | 250/æœˆ | 3,000/æœˆ | 12,000/æœˆ | 30,000/æœˆ |
| sessionsç´¯è¨ˆ | 250 | 36,000 | 288,000 | 1,440,000 |
| transcripts | 7,500/æœˆ | 90,000/æœˆ | 360,000/æœˆ | 900,000/æœˆ |
| transcriptsç´¯è¨ˆ | 7,500 | 1,080,000 | 8,640,000 | 43,200,000 |
| speaker_segments | 2,500/æœˆ | 30,000/æœˆ | 120,000/æœˆ | 300,000/æœˆ |
| session_analyses | 1,750/æœˆ | 21,000/æœˆ | 84,000/æœˆ | 210,000/æœˆ |
| session_reports | 250/æœˆ | 3,000/æœˆ | 12,000/æœˆ | 30,000/æœˆ |
| success_cases | 25/æœˆ | 600/æœˆ | 2,400/æœˆ | 6,000/æœˆ |

#### 6.3.2 ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡è¦‹ç©ã‚‚ã‚Š

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | åˆæœŸ | 1å¹´å¾Œ | 3å¹´å¾Œ | 5å¹´å¾Œ |
|--------------|------|-------|-------|-------|
| PostgreSQL | 100MB | 5GB | 40GB | 200GB |
| pgvector | 10MB | 500MB | 4GB | 20GB |
| Storageï¼ˆéŸ³å£°ä¸€æ™‚ï¼‰ | 1GB | 10GB | 50GB | 100GB |
| **åˆè¨ˆ** | **1.1GB** | **15.5GB** | **94GB** | **320GB** |

### 6.4 Row Level Securityï¼ˆRLSï¼‰ãƒãƒªã‚·ãƒ¼

```sql
-- RLSã‚’æœ‰åŠ¹åŒ–
ALTER TABLE salons ENABLE ROW LEVEL SECURITY;
ALTER TABLE staffs ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE transcripts ENABLE ROW LEVEL SECURITY;
ALTER TABLE speaker_segments ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE success_cases ENABLE ROW LEVEL SECURITY;

-- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°: ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®salon_idã‚’å–å¾—
CREATE OR REPLACE FUNCTION get_current_user_salon_id()
RETURNS UUID AS $$
  SELECT salon_id FROM staffs WHERE auth_user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER;

-- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°: ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®roleã‚’å–å¾—
CREATE OR REPLACE FUNCTION get_current_user_role()
RETURNS VARCHAR AS $$
  SELECT role FROM staffs WHERE auth_user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER;

-- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°: ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®staff_idã‚’å–å¾—
CREATE OR REPLACE FUNCTION get_current_user_staff_id()
RETURNS UUID AS $$
  SELECT id FROM staffs WHERE auth_user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER;

-- salons: è‡ªåº—èˆ—ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY "salon_access" ON salons
FOR ALL USING (id = get_current_user_salon_id());

-- staffs: è‡ªåº—èˆ—ã®ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY "staff_access" ON staffs
FOR SELECT USING (salon_id = get_current_user_salon_id());

-- staffs: manager/owner ã®ã¿ä½œæˆãƒ»æ›´æ–°å¯èƒ½
CREATE POLICY "staff_manage" ON staffs
FOR INSERT WITH CHECK (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);

CREATE POLICY "staff_update" ON staffs
FOR UPDATE USING (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);

-- sessions: è‡ªåº—èˆ—ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY "session_salon_isolation" ON sessions
FOR ALL USING (salon_id = get_current_user_salon_id());

-- sessions: ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆã¯è‡ªåˆ†ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿
CREATE POLICY "session_own_only" ON sessions
FOR SELECT USING (
  stylist_id = get_current_user_staff_id()
  OR get_current_user_role() IN ('owner', 'manager')
);

-- transcripts: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹
CREATE POLICY "transcript_via_session" ON transcripts
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- speaker_segments: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹
CREATE POLICY "speaker_segment_via_session" ON speaker_segments
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- session_analyses: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹
CREATE POLICY "analysis_via_session" ON session_analyses
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- session_reports: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹
CREATE POLICY "report_via_session" ON session_reports
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- success_cases: è‡ªåº—èˆ—ã¾ãŸã¯å…¬é–‹ã•ã‚ŒãŸã‚‚ã®ã®ã¿
CREATE POLICY "success_case_access" ON success_cases
FOR SELECT USING (
  is_public = true
  OR salon_id = get_current_user_salon_id()
);

-- success_cases: ä½œæˆã¯è‡ªåº—èˆ—ã®ã¿ã€manager/owner
CREATE POLICY "success_case_create" ON success_cases
FOR INSERT WITH CHECK (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);

-- customers: è‡ªåº—èˆ—ã®é¡§å®¢ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;

CREATE POLICY "customer_salon_isolation" ON customers
FOR ALL USING (salon_id = get_current_user_salon_id());

-- customers: é–²è¦§ã¯å…¨ã‚¹ã‚¿ãƒƒãƒ•å¯èƒ½
CREATE POLICY "customer_select" ON customers
FOR SELECT USING (salon_id = get_current_user_salon_id());

-- customers: ä½œæˆãƒ»æ›´æ–°ã¯å…¨ã‚¹ã‚¿ãƒƒãƒ•å¯èƒ½ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®è‡ªå‹•ç™»éŒ²ã®ãŸã‚ï¼‰
CREATE POLICY "customer_insert" ON customers
FOR INSERT WITH CHECK (salon_id = get_current_user_salon_id());

CREATE POLICY "customer_update" ON customers
FOR UPDATE USING (salon_id = get_current_user_salon_id());

-- customers: å‰Šé™¤ã¯ manager/owner ã®ã¿
CREATE POLICY "customer_delete" ON customers
FOR DELETE USING (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);
```

---
