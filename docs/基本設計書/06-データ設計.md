## 6. データ設計

### 6.1 論理データモデル

#### 6.1.1 ER図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ER図（論理モデル）                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                                                                 │     │
│    │   ┌─────────────┐         ┌─────────────┐                      │     │
│    │   │   salons    │ 1     n │   staffs    │                      │     │
│    │   │─────────────│─────────│─────────────│                      │     │
│    │   │ id (PK)     │         │ id (PK)     │                      │     │
│    │   │ name        │         │ salon_id(FK)│                      │     │
│    │   │ address     │         │auth_user_id │                      │     │
│    │   │ phone       │         │ name        │                      │     │
│    │   │ plan        │         │ email       │                      │     │
│    │   │ seats_count │         │ role        │                      │     │
│    │   │ settings    │         │ position    │                      │     │
│    │   │ created_at  │         │ join_date   │                      │     │
│    │   │ updated_at  │         │ is_active   │                      │     │
│    │   └─────────────┘         │ settings    │                      │     │
│    │          │                │ created_at  │                      │     │
│    │          │                │ updated_at  │                      │     │
│    │          │                └──────┬──────┘                      │     │
│    │          │                       │                             │     │
│    │          │ 1                   n │                             │     │
│    │          │                       │                             │     │
│    │          ▼                       ▼                             │     │
│    │   ┌─────────────────────────────────────┐                      │     │
│    │   │             sessions                │                      │     │
│    │   │─────────────────────────────────────│                      │     │
│    │   │ id (PK)                             │                      │     │
│    │   │ salon_id (FK)                       │                      │     │
│    │   │ stylist_id (FK)                     │                      │     │
│    │   │ started_at                          │                      │     │
│    │   │ ended_at                            │                      │     │
│    │   │ status                              │                      │     │
│    │   │ customer_info (JSONB)               │                      │     │
│    │   │ diarization_status                  │                      │     │
│    │   │ created_at                          │                      │     │
│    │   │ updated_at                          │                      │     │
│    │   └──────────────────┬──────────────────┘                      │     │
│    │                      │                                         │     │
│    │          ┌───────────┼───────────┬───────────┐                │     │
│    │          │           │           │           │                │     │
│    │        1 │         1 │         1 │         1 │                │     │
│    │          │           │           │           │                │     │
│    │          ▼           ▼           ▼           ▼                │     │
│    │   ┌───────────┐┌───────────┐┌───────────┐┌───────────┐        │     │
│    │   │transcripts││ speaker_  ││ session_  ││ session_  │        │     │
│    │   │           ││ segments  ││ analyses  ││ reports   │        │     │
│    │   │───────────││───────────││───────────││───────────│        │     │
│    │   │id (PK)    ││id (PK)    ││id (PK)    ││id (PK)    │        │     │
│    │   │session_id ││session_id ││session_id ││session_id │        │     │
│    │   │chunk_index││speaker    ││chunk_index││overall_   │        │     │
│    │   │text       ││start_time ││indicator  ││score      │        │     │
│    │   │start_time ││end_time   ││value      ││good_points│        │     │
│    │   │end_time   ││text       ││score      ││improve_   │        │     │
│    │   │audio_url  ││confidence ││details    ││points     │        │     │
│    │   │created_at ││created_at ││created_at ││action_    │        │     │
│    │   └───────────┘└───────────┘└───────────┘│items      │        │     │
│    │          n           n           n       │transcript │        │     │
│    │                                          │summary    │        │     │
│    │                                          │ai_feedback│        │     │
│    │                                          │created_at │        │     │
│    │                                          └───────────┘        │     │
│    │                                                 1             │     │
│    │                                                               │     │
│    │   ┌─────────────────────────────────────────────────────┐     │     │
│    │   │                  success_cases                      │     │     │
│    │   │─────────────────────────────────────────────────────│     │     │
│    │   │ id (PK)                                             │     │     │
│    │   │ salon_id (FK)                                       │     │     │
│    │   │ session_id (FK, nullable)                           │     │     │
│    │   │ stylist_id (FK, nullable)                           │     │     │
│    │   │ concern_keywords (TEXT[])                           │     │     │
│    │   │ customer_profile (JSONB)                            │     │     │
│    │   │ successful_talk (TEXT)                              │     │     │
│    │   │ key_tactics (TEXT[])                                │     │     │
│    │   │ sold_product (VARCHAR)                              │     │     │
│    │   │ conversion_rate (NUMERIC)                           │     │     │
│    │   │ embedding (VECTOR(1536))                            │     │     │
│    │   │ is_public (BOOLEAN)                                 │     │     │
│    │   │ created_at                                          │     │     │
│    │   └─────────────────────────────────────────────────────┘     │     │
│    │                                                               │     │
│    └───────────────────────────────────────────────────────────────┘     │
│                                                                             │
│  カーディナリティ:                                                           │
│  salon ─1:n─ staff                                                         │
│  salon ─1:n─ session                                                       │
│  staff ─1:n─ session                                                       │
│  session ─1:n─ transcript                                                  │
│  session ─1:n─ speaker_segment                                             │
│  session ─1:n─ session_analysis                                            │
│  session ─1:1─ session_report                                              │
│  salon ─1:n─ success_case                                                  │
│  session ─0..1:n─ success_case (optional)                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 テーブル定義

#### 6.2.1 salons（店舗）

> ⚠️ **実装に合わせて修正（2025-12-05）**
> - plan: 'free', 'standard', 'premium', 'enterprise' に変更（実装と統一）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| name | VARCHAR(100) | NOT NULL | - | 店舗名 |
| address | TEXT | NULL | - | 住所 |
| phone | VARCHAR(20) | NULL | - | 電話番号 |
| plan | VARCHAR(20) | NOT NULL | 'free' | 契約プラン |
| seats_count | INTEGER | NULL | - | 席数 |
| settings | JSONB | NOT NULL | '{}' | 店舗設定 |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | 更新日時 |

**制約**:

```sql
CREATE TABLE salons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  address TEXT,
  phone VARCHAR(20),
  plan VARCHAR(20) NOT NULL DEFAULT 'free'
    CHECK (plan IN ('free', 'standard', 'premium', 'enterprise')),
  seats_count INTEGER CHECK (seats_count IS NULL OR seats_count > 0),
  settings JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_salons_plan ON salons(plan);
CREATE INDEX idx_salons_created_at ON salons(created_at);
```

**settings JSONB構造**:

```json
{
  "notification": {
    "enablePush": true,
    "enableEmail": true,
    "concernDetectionAlert": true,
    "sessionCompleteAlert": true
  },
  "analysis": {
    "idealTalkRatio": 40,
    "minQuestionCount": 8,
    "concernKeywords": ["乾燥", "広がり", "パサつき", "ダメージ", "うねり", "薄毛", "白髪"]
  },
  "display": {
    "showRanking": true,
    "anonymizeCustomer": false
  }
}
```

---

#### 6.2.2 staffs（スタッフ）

> ⚠️ **実装に合わせて修正（2025-12-05）**
> - id = auth.users(id)構造に変更（Supabase推奨パターン）
> - role: 'stylist', 'manager', 'owner', 'admin' に変更
> - 不要カラム削除（position, join_date, profile_image_url, settings）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | - | 主キー（= auth.users.id） |
| salon_id | UUID | NOT NULL | - | 所属店舗（FK） |
| name | VARCHAR(50) | NOT NULL | - | 氏名 |
| email | VARCHAR(255) | NOT NULL | - | メールアドレス |
| role | VARCHAR(20) | NOT NULL | 'stylist' | ロール |
| avatar_url | TEXT | NULL | - | アバター画像URL |
| is_active | BOOLEAN | NOT NULL | true | 有効フラグ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | 更新日時 |

**制約**:

```sql
CREATE TABLE staffs (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'stylist'
    CHECK (role IN ('stylist', 'manager', 'owner', 'admin')),
  avatar_url TEXT,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  UNIQUE (email)
);

-- インデックス
CREATE INDEX idx_staffs_salon_id ON staffs(salon_id);
CREATE INDEX idx_staffs_role ON staffs(role);
CREATE INDEX idx_staffs_is_active ON staffs(is_active);
```

---

#### 6.2.3 sessions（セッション）

> ⚠️ **実装に合わせて修正（2025-12-05）**
> - status: 'analyzing'追加、'failed'→'error'に変更
> - total_duration_ms追加

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| salon_id | UUID | NOT NULL | - | 店舗（FK） |
| stylist_id | UUID | NOT NULL | - | スタイリスト（FK） |
| started_at | TIMESTAMPTZ | NOT NULL | NOW() | 開始日時 |
| ended_at | TIMESTAMPTZ | NULL | - | 終了日時 |
| total_duration_ms | INTEGER | NULL | - | 合計時間（ミリ秒） |
| status | VARCHAR(20) | NOT NULL | 'recording' | ステータス |
| customer_info | JSONB | NULL | - | お客様情報 |
| diarization_status | VARCHAR(20) | NULL | 'pending' | 話者分離状態 |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | 更新日時 |

**制約**:

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  stylist_id UUID NOT NULL REFERENCES staffs(id) ON DELETE CASCADE,
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  total_duration_ms INTEGER,
  status VARCHAR(20) NOT NULL DEFAULT 'recording'
    CHECK (status IN ('recording', 'processing', 'analyzing', 'completed', 'error')),
  customer_info JSONB,
  diarization_status VARCHAR(20) DEFAULT 'pending'
    CHECK (diarization_status IN ('pending', 'processing', 'completed', 'failed')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_sessions_salon_id ON sessions(salon_id);
CREATE INDEX idx_sessions_stylist_id ON sessions(stylist_id);
CREATE INDEX idx_sessions_status ON sessions(status);
CREATE INDEX idx_sessions_started_at ON sessions(started_at DESC);
CREATE INDEX idx_sessions_salon_started ON sessions(salon_id, started_at DESC);
```

**customer_info JSONB構造**:

```json
{
  "ageGroup": "30s",
  "gender": "female",
  "visitFrequency": "monthly",
  "notes": "カラーアレルギーあり"
}
```

---

#### 6.2.4 transcripts（文字起こし）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| session_id | UUID | NOT NULL | - | セッション（FK） |
| chunk_index | INTEGER | NOT NULL | - | チャンク番号 |
| text | TEXT | NOT NULL | - | 文字起こしテキスト |
| start_time | NUMERIC(10,3) | NOT NULL | - | 開始時間（秒） |
| end_time | NUMERIC(10,3) | NOT NULL | - | 終了時間（秒） |
| audio_url | TEXT | NULL | - | 音声ファイルURL |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
CREATE TABLE transcripts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  text TEXT NOT NULL,
  start_time NUMERIC(10, 3) NOT NULL,
  end_time NUMERIC(10, 3) NOT NULL,
  audio_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (session_id, chunk_index)
);

-- インデックス
CREATE INDEX idx_transcripts_session_id ON transcripts(session_id);
CREATE INDEX idx_transcripts_session_chunk ON transcripts(session_id, chunk_index);
```

---

#### 6.2.5 speaker_segments（話者セグメント）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| session_id | UUID | NOT NULL | - | セッション（FK） |
| speaker | VARCHAR(20) | NOT NULL | - | 話者ラベル |
| start_time | NUMERIC(10,3) | NOT NULL | - | 開始時間（秒） |
| end_time | NUMERIC(10,3) | NOT NULL | - | 終了時間（秒） |
| text | TEXT | NULL | - | 該当テキスト |
| confidence | NUMERIC(5,4) | NULL | - | 信頼度 |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
CREATE TABLE speaker_segments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  speaker VARCHAR(20) NOT NULL
    CHECK (speaker IN ('stylist', 'customer', 'unknown')),
  start_time NUMERIC(10, 3) NOT NULL,
  end_time NUMERIC(10, 3) NOT NULL,
  text TEXT,
  confidence NUMERIC(5, 4) CHECK (confidence >= 0 AND confidence <= 1),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_speaker_segments_session_id ON speaker_segments(session_id);
CREATE INDEX idx_speaker_segments_speaker ON speaker_segments(speaker);
CREATE INDEX idx_speaker_segments_time ON speaker_segments(session_id, start_time);
```

---

#### 6.2.6 session_analyses（セッション分析）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| session_id | UUID | NOT NULL | - | セッション（FK） |
| chunk_index | INTEGER | NOT NULL | - | チャンク番号 |
| indicator_type | VARCHAR(30) | NOT NULL | - | 指標種別 |
| value | NUMERIC(10,4) | NOT NULL | - | 測定値 |
| score | INTEGER | NOT NULL | - | スコア（0-100） |
| details | JSONB | NULL | - | 詳細データ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
CREATE TABLE session_analyses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  chunk_index INTEGER NOT NULL,
  indicator_type VARCHAR(30) NOT NULL
    CHECK (indicator_type IN (
      'talk_ratio',
      'question_analysis',
      'emotion_analysis',
      'concern_keywords',
      'proposal_timing',
      'proposal_quality',
      'conversion'
    )),
  value NUMERIC(10, 4) NOT NULL,
  score INTEGER NOT NULL CHECK (score >= 0 AND score <= 100),
  details JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (session_id, chunk_index, indicator_type)
);

-- インデックス
CREATE INDEX idx_session_analyses_session_id ON session_analyses(session_id);
CREATE INDEX idx_session_analyses_indicator ON session_analyses(indicator_type);
CREATE INDEX idx_session_analyses_session_chunk ON session_analyses(session_id, chunk_index);
```

**details JSONB構造例**:

```json
// talk_ratio
{
  "stylistSeconds": 1800,
  "customerSeconds": 2700,
  "totalSeconds": 4500,
  "ratio": 40.0
}

// question_analysis
{
  "totalQuestions": 12,
  "openQuestions": 8,
  "closedQuestions": 4,
  "openRatio": 66.67,
  "questionList": [
    {"text": "今日はどうされますか？", "type": "open", "time": 120.5}
  ]
}

// concern_keywords
{
  "detected": true,
  "keywords": ["乾燥", "広がり"],
  "detectedAt": [180.5, 245.2],
  "context": "髪が乾燥してパサパサなんです"
}
```

---

#### 6.2.7 session_reports（セッションレポート）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| session_id | UUID | NOT NULL | - | セッション（FK） |
| overall_score | INTEGER | NOT NULL | - | 総合スコア |
| good_points | TEXT[] | NOT NULL | - | 良かった点 |
| improvement_points | TEXT[] | NOT NULL | - | 改善ポイント |
| action_items | TEXT[] | NOT NULL | - | アクションアイテム |
| transcript_summary | TEXT | NULL | - | 会話要約 |
| ai_feedback | TEXT | NULL | - | AIフィードバック |
| indicator_scores | JSONB | NOT NULL | - | 指標別スコア |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
CREATE TABLE session_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  overall_score INTEGER NOT NULL CHECK (overall_score >= 0 AND overall_score <= 100),
  good_points TEXT[] NOT NULL DEFAULT '{}',
  improvement_points TEXT[] NOT NULL DEFAULT '{}',
  action_items TEXT[] NOT NULL DEFAULT '{}',
  transcript_summary TEXT,
  ai_feedback TEXT,
  indicator_scores JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE (session_id)
);

-- インデックス
CREATE INDEX idx_session_reports_session_id ON session_reports(session_id);
CREATE INDEX idx_session_reports_score ON session_reports(overall_score DESC);
```

**indicator_scores JSONB構造**:

```json
{
  "talk_ratio": {"score": 85, "value": 42.5},
  "question_analysis": {"score": 80, "value": 10},
  "emotion_analysis": {"score": 90, "value": 75.0},
  "concern_keywords": {"score": 100, "value": 1},
  "proposal_timing": {"score": 85, "value": 3.5},
  "proposal_quality": {"score": 70, "value": 65.0},
  "conversion": {"score": 100, "value": 1}
}
```

---

#### 6.2.8 success_cases（成功事例）

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| salon_id | UUID | NOT NULL | - | 店舗（FK） |
| session_id | UUID | NULL | - | 元セッション（FK） |
| stylist_id | UUID | NULL | - | スタイリスト（FK） |
| concern_keywords | TEXT[] | NOT NULL | - | 悩みキーワード |
| customer_profile | JSONB | NULL | - | お客様属性 |
| successful_talk | TEXT | NOT NULL | - | 成功トーク例 |
| key_tactics | TEXT[] | NOT NULL | - | キーポイント |
| sold_product | VARCHAR(100) | NULL | - | 成約商品 |
| conversion_rate | NUMERIC(5,4) | NULL | - | 成約率 |
| embedding | VECTOR(1536) | NULL | - | ベクトル埋め込み |
| is_public | BOOLEAN | NOT NULL | false | 公開フラグ |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |

**制約**:

```sql
-- pgvector拡張を有効化
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE success_cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  salon_id UUID NOT NULL REFERENCES salons(id) ON DELETE CASCADE,
  session_id UUID REFERENCES sessions(id) ON DELETE SET NULL,
  stylist_id UUID REFERENCES staffs(id) ON DELETE SET NULL,
  concern_keywords TEXT[] NOT NULL DEFAULT '{}',
  customer_profile JSONB,
  successful_talk TEXT NOT NULL,
  key_tactics TEXT[] NOT NULL DEFAULT '{}',
  sold_product VARCHAR(100),
  conversion_rate NUMERIC(5, 4) CHECK (conversion_rate >= 0 AND conversion_rate <= 1),
  embedding VECTOR(1536),
  is_public BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_success_cases_salon_id ON success_cases(salon_id);
CREATE INDEX idx_success_cases_concern ON success_cases USING GIN(concern_keywords);
CREATE INDEX idx_success_cases_is_public ON success_cases(is_public);

-- HNSWベクトルインデックス（近似最近傍探索）
CREATE INDEX idx_success_cases_embedding ON success_cases 
  USING hnsw (embedding vector_cosine_ops)
  WITH (m = 16, ef_construction = 64);
```

### 6.3 データ量見積もり

#### 6.3.1 初期〜5年後のデータ量予測

| テーブル | 初期（5店舗） | 1年後（50店舗） | 3年後（200店舗） | 5年後（500店舗） |
|---------|-------------|---------------|-----------------|-----------------|
| salons | 5 | 50 | 200 | 500 |
| staffs | 50 | 500 | 2,000 | 5,000 |
| sessions | 250/月 | 3,000/月 | 12,000/月 | 30,000/月 |
| sessions累計 | 250 | 36,000 | 288,000 | 1,440,000 |
| transcripts | 7,500/月 | 90,000/月 | 360,000/月 | 900,000/月 |
| transcripts累計 | 7,500 | 1,080,000 | 8,640,000 | 43,200,000 |
| speaker_segments | 2,500/月 | 30,000/月 | 120,000/月 | 300,000/月 |
| session_analyses | 1,750/月 | 21,000/月 | 84,000/月 | 210,000/月 |
| session_reports | 250/月 | 3,000/月 | 12,000/月 | 30,000/月 |
| success_cases | 25/月 | 600/月 | 2,400/月 | 6,000/月 |

#### 6.3.2 ストレージ容量見積もり

| コンポーネント | 初期 | 1年後 | 3年後 | 5年後 |
|--------------|------|-------|-------|-------|
| PostgreSQL | 100MB | 5GB | 40GB | 200GB |
| pgvector | 10MB | 500MB | 4GB | 20GB |
| Storage（音声一時） | 1GB | 10GB | 50GB | 100GB |
| **合計** | **1.1GB** | **15.5GB** | **94GB** | **320GB** |

### 6.4 Row Level Security（RLS）ポリシー

```sql
-- RLSを有効化
ALTER TABLE salons ENABLE ROW LEVEL SECURITY;
ALTER TABLE staffs ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE transcripts ENABLE ROW LEVEL SECURITY;
ALTER TABLE speaker_segments ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE session_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE success_cases ENABLE ROW LEVEL SECURITY;

-- ユーティリティ関数: 現在ユーザーのsalon_idを取得
CREATE OR REPLACE FUNCTION get_current_user_salon_id()
RETURNS UUID AS $$
  SELECT salon_id FROM staffs WHERE auth_user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER;

-- ユーティリティ関数: 現在ユーザーのroleを取得
CREATE OR REPLACE FUNCTION get_current_user_role()
RETURNS VARCHAR AS $$
  SELECT role FROM staffs WHERE auth_user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER;

-- ユーティリティ関数: 現在ユーザーのstaff_idを取得
CREATE OR REPLACE FUNCTION get_current_user_staff_id()
RETURNS UUID AS $$
  SELECT id FROM staffs WHERE auth_user_id = auth.uid()
$$ LANGUAGE sql SECURITY DEFINER;

-- salons: 自店舗のみアクセス可能
CREATE POLICY "salon_access" ON salons
FOR ALL USING (id = get_current_user_salon_id());

-- staffs: 自店舗のスタッフのみアクセス可能
CREATE POLICY "staff_access" ON staffs
FOR SELECT USING (salon_id = get_current_user_salon_id());

-- staffs: manager/owner のみ作成・更新可能
CREATE POLICY "staff_manage" ON staffs
FOR INSERT WITH CHECK (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);

CREATE POLICY "staff_update" ON staffs
FOR UPDATE USING (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);

-- sessions: 自店舗のセッションのみアクセス可能
CREATE POLICY "session_salon_isolation" ON sessions
FOR ALL USING (salon_id = get_current_user_salon_id());

-- sessions: スタイリストは自分のセッションのみ
CREATE POLICY "session_own_only" ON sessions
FOR SELECT USING (
  stylist_id = get_current_user_staff_id()
  OR get_current_user_role() IN ('owner', 'manager')
);

-- transcripts: セッション経由でアクセス
CREATE POLICY "transcript_via_session" ON transcripts
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- speaker_segments: セッション経由でアクセス
CREATE POLICY "speaker_segment_via_session" ON speaker_segments
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- session_analyses: セッション経由でアクセス
CREATE POLICY "analysis_via_session" ON session_analyses
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- session_reports: セッション経由でアクセス
CREATE POLICY "report_via_session" ON session_reports
FOR ALL USING (
  session_id IN (
    SELECT id FROM sessions WHERE salon_id = get_current_user_salon_id()
  )
);

-- success_cases: 自店舗または公開されたもののみ
CREATE POLICY "success_case_access" ON success_cases
FOR SELECT USING (
  is_public = true
  OR salon_id = get_current_user_salon_id()
);

-- success_cases: 作成は自店舗のみ、manager/owner
CREATE POLICY "success_case_create" ON success_cases
FOR INSERT WITH CHECK (
  salon_id = get_current_user_salon_id()
  AND get_current_user_role() IN ('owner', 'manager')
);
```

---
