## 2. システム概要

### 2.1 システムの目的と範囲

#### 2.1.1 システムの目的

SalonTalk AIは、美容室における接客会話をAIがリアルタイムで分析し、以下のビジネス目標を達成するためのシステムである：

| 目標 | 数値目標 | 達成期間 |
|------|---------|---------|
| 店販売上向上 | 20〜36%向上 | 導入後12ヶ月 |
| 人材育成効率化 | 育成期間50%短縮 | 導入後12ヶ月 |
| 新人離職率低下 | 30%削減 | 導入後24ヶ月 |
| スタッフ間売上格差縮小 | 3.3:1→2:1以下 | 導入後12ヶ月 |

#### 2.1.2 システムの範囲

**システム範囲図**:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          SalonTalk AI システム範囲                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      フロントエンド (システム内)                       │ │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────────┐│ │
│  │  │       iPadアプリ         │  │        Webダッシュボード             ││ │
│  │  │  ● セッション管理        │  │  ● 管理者機能                       ││ │
│  │  │  ● リアルタイム分析表示   │  │  ● 分析・レポート閲覧               ││ │
│  │  │  ● トレーニング機能      │  │  ● スタッフ管理                     ││ │
│  │  │  ● 成功事例閲覧          │  │  ● 成功事例管理                     ││ │
│  │  └─────────────────────────┘  └─────────────────────────────────────┘│ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│  ┌───────────────────────────────────┼───────────────────────────────────┐ │
│  │                      バックエンド (システム内)                         │ │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────────┐│ │
│  │  │       API層             │  │          処理層                     ││ │
│  │  │  ● 認証・認可           │  │  ● 音声処理（文字起こし結合）       ││ │
│  │  │  ● セッション管理API    │  │  ● AI分析処理                       ││ │
│  │  │  ● データ管理API        │  │  ● レポート生成処理                 ││ │
│  │  │  ● リアルタイム配信      │  │  ● 成功事例マッチング               ││ │
│  │  └─────────────────────────┘  └─────────────────────────────────────┘│ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                      │
│  ┌───────────────────────────────────┼───────────────────────────────────┐ │
│  │                      データ層 (システム内)                            │ │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────────┐│ │
│  │  │    PostgreSQL           │  │       ベクトルDB (pgvector)         ││ │
│  │  │  ● マスタデータ         │  │  ● 成功事例ベクトル                 ││ │
│  │  │  ● トランザクションデータ│  │  ● 類似度検索                       ││ │
│  │  │  ● 分析結果             │  │                                     ││ │
│  │  └─────────────────────────┘  └─────────────────────────────────────┘│ │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────────┐│ │
│  │  │    ファイルストレージ    │  │       pyannoteサーバー              ││ │
│  │  │  ● 音声チャンク（一時）  │  │  ● 話者分離処理                     ││ │
│  │  │  ● レポートファイル      │  │  ● GPUコンピューティング            ││ │
│  │  └─────────────────────────┘  └─────────────────────────────────────┘│ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│   外部システム       │  │   外部システム       │  │   外部システム       │
├─────────────────────┤  ├─────────────────────┤  ├─────────────────────┤
│ ● Anthropic Claude  │  │ ● OpenAI Embedding  │  │ ● Apple Speech      │
│   API               │  │   API               │  │   Analyzer          │
│ ● AI分析・生成      │  │ ● ベクトル生成      │  │ ● オンデバイス      │
│                     │  │                     │  │   文字起こし        │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘
```

#### 2.1.3 システム境界

**システム内（開発・運用対象）**:

| コンポーネント | 技術スタック | 責務 |
|--------------|-------------|------|
| iPadアプリケーション | React Native + Expo | 音声取得、文字起こし、UI表示 |
| Webダッシュボード | Next.js 14 + TypeScript | 管理機能、分析閲覧 |
| バックエンドAPI | Supabase Edge Functions | ビジネスロジック、API提供 |
| データベース | PostgreSQL + pgvector | データ永続化、ベクトル検索 |
| ファイルストレージ | Supabase Storage | 音声ファイル一時保存 |
| pyannoteサーバー | FastAPI + pyannote.audio | 話者分離処理 |

**システム外（連携対象）**:

| コンポーネント | 連携方式 | 責務 |
|--------------|---------|------|
| Anthropic Claude API | REST API | AI分析、レポート生成、ロールプレイ |
| OpenAI Embedding API | REST API | テキストのベクトル埋め込み生成 |
| Apple SpeechAnalyzer | ネイティブAPI | オンデバイス文字起こし |
| Apple Push Notification | APNs | プッシュ通知配信 |
| Stripe API（将来） | REST API + Webhook | 決済処理 |

### 2.2 システム構成

#### 2.2.1 論理構成（レイヤードアーキテクチャ）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          論理アーキテクチャ                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    プレゼンテーション層                                │ │
│  │                    (Presentation Layer)                               │ │
│  │                                                                       │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │    iPad UI       │  │    Web UI        │  │   通知UI          │   │ │
│  │   │    Components    │  │    Components    │  │  (Push/In-App)    │   │ │
│  │   │                  │  │                  │  │                   │   │ │
│  │   │ ・Screens        │  │ ・Pages          │  │ ・NotificationBanner│ │ │
│  │   │ ・Components     │  │ ・Components     │  │ ・Toast           │   │ │
│  │   │ ・Hooks          │  │ ・Hooks          │  │                   │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    アプリケーション層                                  │ │
│  │                    (Application Layer)                                │ │
│  │                                                                       │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   セッション      │  │    分析          │  │  教育・トレーニング │  │ │
│  │   │   管理サービス    │  │   サービス        │  │   サービス        │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │    認証          │  │   レポート        │  │    通知          │   │ │
│  │   │   サービス        │  │   サービス        │  │   サービス        │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    ドメイン層                                          │ │
│  │                    (Domain Layer)                                     │ │
│  │                                                                       │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   Session        │  │   Analysis       │  │   SuccessCase    │   │ │
│  │   │   Domain         │  │   Domain         │  │   Domain         │   │ │
│  │   │                  │  │                  │  │                  │   │ │
│  │   │ ・SessionEntity  │  │ ・AnalysisEntity │  │ ・SuccessCaseEntity│ │ │
│  │   │ ・SessionValue   │  │ ・ScoreValue     │  │ ・EmbeddingValue  │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   Staff          │  │   Salon          │  │   Training       │   │ │
│  │   │   Domain         │  │   Domain         │  │   Domain         │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    インフラストラクチャ層                               │ │
│  │                    (Infrastructure Layer)                             │ │
│  │                                                                       │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   Repository     │  │   External       │  │   Storage        │   │ │
│  │   │   (Supabase)     │  │   API Client     │  │   Service        │   │ │
│  │   │                  │  │                  │  │                  │   │ │
│  │   │ ・SessionRepo    │  │ ・ClaudeClient   │  │ ・AudioStorage   │   │ │
│  │   │ ・AnalysisRepo   │  │ ・OpenAIClient   │  │ ・ReportStorage  │   │ │
│  │   │ ・StaffRepo      │  │ ・PyannoteClient │  │                  │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │ │
│  │   │   Cache          │  │   Queue          │  │   Logger         │   │ │
│  │   │   Service        │  │   Service        │  │   Service        │   │ │
│  │   └──────────────────┘  └──────────────────┘  └──────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 物理構成（デプロイメント図）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          物理アーキテクチャ                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        エンドユーザー環境                              │ │
│  │                                                                       │ │
│  │   ┌─────────────────────────┐     ┌─────────────────────────────┐    │ │
│  │   │        iPad             │     │       Web Browser           │    │ │
│  │   │      (iOS 26+)          │     │   (Chrome/Safari/Edge)      │    │ │
│  │   │                         │     │                             │    │ │
│  │   │  ┌───────────────────┐  │     │   ┌───────────────────────┐ │    │ │
│  │   │  │  SalonTalk App    │  │     │   │   https://salon       │ │    │ │
│  │   │  │                   │  │     │   │   talk.app            │ │    │ │
│  │   │  │  ┌─────────────┐  │  │     │   │                       │ │    │ │
│  │   │  │  │SpeechAnalyzer│  │  │     │   └───────────────────────┘ │    │ │
│  │   │  │  │(オンデバイス) │  │  │     │                             │    │ │
│  │   │  │  └─────────────┘  │  │     │                             │    │ │
│  │   │  └───────────────────┘  │     │                             │    │ │
│  │   └───────────┬─────────────┘     └──────────────┬──────────────┘    │ │
│  └───────────────┼──────────────────────────────────┼────────────────────┘ │
│                  │           HTTPS / WSS            │                      │
│                  │           (TLS 1.3)              │                      │
│  ┌───────────────┼──────────────────────────────────┼────────────────────┐ │
│  │               ▼          CDN/Edge Layer          ▼                    │ │
│  │   ┌───────────────────────────────────────────────────────────────┐   │ │
│  │   │                  Vercel Edge Network                          │   │ │
│  │   │                  (Tokyo Region: hnd1)                         │   │ │
│  │   │                                                               │   │ │
│  │   │   ● 静的アセット配信（キャッシュ）                               │   │ │
│  │   │   ● SSL終端                                                   │   │ │
│  │   │   ● DDoS保護                                                  │   │ │
│  │   └───────────────────────────────────────────────────────────────┘   │ │
│  │                              │                                        │ │
│  └──────────────────────────────┼────────────────────────────────────────┘ │
│                                 │                                          │
│  ┌──────────────────────────────┼────────────────────────────────────────┐ │
│  │                              ▼          Application Layer             │ │
│  │   ┌───────────────────────────────────────────────────────────────┐   │ │
│  │   │                  Vercel Application                           │   │ │
│  │   │                  (Tokyo Region: hnd1)                         │   │ │
│  │   │                                                               │   │ │
│  │   │   ┌─────────────────────────────────────────────────────┐    │   │ │
│  │   │   │  Next.js 14 Application                             │    │   │ │
│  │   │   │                                                     │    │   │ │
│  │   │   │  ● Server Components                                │    │   │ │
│  │   │   │  ● API Routes (Optional)                            │    │   │ │
│  │   │   │  ● Static Generation                                │    │   │ │
│  │   │   └─────────────────────────────────────────────────────┘    │   │ │
│  │   │                                                               │   │ │
│  │   │   Plan: Pro                                                   │   │ │
│  │   └───────────────────────────────────────────────────────────────┘   │ │
│  │                              │                                        │ │
│  └──────────────────────────────┼────────────────────────────────────────┘ │
│                                 │                                          │
│  ┌──────────────────────────────┼────────────────────────────────────────┐ │
│  │                              ▼          Backend Layer                 │ │
│  │   ┌───────────────────────────────────────────────────────────────┐   │ │
│  │   │                  Supabase Platform                            │   │ │
│  │   │                  (Tokyo: ap-northeast-1)                      │   │ │
│  │   │                                                               │   │ │
│  │   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │   │ │
│  │   │   │    Auth     │  │  Realtime   │  │   Edge Functions    │  │   │ │
│  │   │   │             │  │             │  │                     │  │   │ │
│  │   │   │ ・JWT認証    │  │ ・WebSocket │  │ ・create-session   │  │   │ │
│  │   │   │ ・OAuth     │  │ ・Presence  │  │ ・process-audio    │  │   │ │
│  │   │   │ ・RBAC      │  │ ・Broadcast │  │ ・analyze-segment  │  │   │ │
│  │   │   └─────────────┘  └─────────────┘  │ ・generate-report  │  │   │ │
│  │   │                                     │ ・search-cases     │  │   │ │
│  │   │   ┌─────────────┐  ┌─────────────┐  │ ・roleplay-chat    │  │   │ │
│  │   │   │ PostgreSQL  │  │   Storage   │  └─────────────────────┘  │   │ │
│  │   │   │             │  │             │                           │   │ │
│  │   │   │ ・8GB RAM   │  │ ・100GB     │                           │   │ │
│  │   │   │ ・pgvector  │  │ ・音声一時  │                           │   │ │
│  │   │   │ ・RLS       │  │             │                           │   │ │
│  │   │   └─────────────┘  └─────────────┘                           │   │ │
│  │   │                                                               │   │ │
│  │   │   Plan: Pro ($25/月)                                          │   │ │
│  │   └───────────────────────────────────────────────────────────────┘   │ │
│  │                              │                                        │ │
│  └──────────────────────────────┼────────────────────────────────────────┘ │
│                                 │                                          │
│  ┌──────────────────────────────┼────────────────────────────────────────┐ │
│  │                              ▼          GPU Compute Layer             │ │
│  │   ┌───────────────────────────────────────────────────────────────┐   │ │
│  │   │                  pyannote Server                              │   │ │
│  │   │                  (VAST.ai / AWS g4dn)                         │   │ │
│  │   │                                                               │   │ │
│  │   │   ┌─────────────────────────────────────────────────────────┐│   │ │
│  │   │   │  Docker Container                                       ││   │ │
│  │   │   │                                                         ││   │ │
│  │   │   │  ● GPU: RTX 4060 (8GB VRAM) または T4                    ││   │ │
│  │   │   │  ● RAM: 16GB                                            ││   │ │
│  │   │   │  ● OS: Ubuntu 22.04                                     ││   │ │
│  │   │   │                                                         ││   │ │
│  │   │   │  ┌─────────────────────────────────────────────────┐   ││   │ │
│  │   │   │  │  FastAPI Application                            │   ││   │ │
│  │   │   │  │                                                 │   ││   │ │
│  │   │   │  │  ● POST /diarize/{session_id}                   │   ││   │ │
│  │   │   │  │  ● GET /status/{session_id}                     │   ││   │ │
│  │   │   │  │  ● GET /health                                  │   ││   │ │
│  │   │   │  │                                                 │   ││   │ │
│  │   │   │  │  pyannote.audio Pipeline                        │   ││   │ │
│  │   │   │  │  ● speaker-diarization-community-1              │   ││   │ │
│  │   │   │  │  ● CUDA acceleration                            │   ││   │ │
│  │   │   │  └─────────────────────────────────────────────────┘   ││   │ │
│  │   │   └─────────────────────────────────────────────────────────┘│   │ │
│  │   │                                                               │   │ │
│  │   │   Cost: ~$0.20/hour (オンデマンド)                             │   │ │
│  │   └───────────────────────────────────────────────────────────────┘   │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                          External APIs                                │ │
│  │                                                                       │ │
│  │   ┌─────────────────────┐  ┌─────────────────────────────────────┐   │ │
│  │   │   Anthropic API     │  │          OpenAI API                 │   │ │
│  │   │                     │  │                                     │   │ │
│  │   │ ● claude-sonnet-4-5 │  │ ● text-embedding-3-small            │   │ │
│  │   │ ● 分析・生成        │  │ ● 1536次元ベクトル                   │   │ │
│  │   │ ● $3/1M入力トークン │  │ ● $0.02/1M トークン                 │   │ │
│  │   └─────────────────────┘  └─────────────────────────────────────┘   │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 システム利用者

#### 2.3.1 利用者分類

| 利用者種別 | 説明 | 主な利用機能 | 同時利用者数（初期） |
|-----------|------|------------|-------------------|
| スタイリスト | 施術を行う美容師 | iPadアプリ全機能 | 10名/店舗 × 5店舗 = 50名 |
| 店長/マネージャー | 店舗運営責任者 | Web全機能、iPad閲覧 | 2名/店舗 × 5店舗 = 10名 |
| オーナー | 複数店舗経営者 | Web全機能（複数店舗統合） | 5名 |
| アシスタント | 補助スタッフ | iPad閲覧のみ | 5名/店舗 × 5店舗 = 25名 |
| システム管理者 | Revol社内管理 | 管理機能全般 | 2名 |

#### 2.3.2 利用パターン

**時間帯別利用パターン**:

```
利用者数
    │
100 ┤                     ╭────╮
    │                   ╭─╯    ╰─╮
 80 ┤                  ╱          ╲
    │                 ╱            ╲
 60 ┤            ╭───╯              ╲
    │           ╱                    ╲
 40 ┤          ╱                      ╲
    │        ╭╯                        ╲
 20 ┤      ╭─╯                          ╲
    │    ╭─╯                             ╰────
  0 ┼────╯─────────────────────────────────────
    9   10  11  12  13  14  15  16  17  18  19  20  時

    ━━━ スタイリスト（iPad）
    ─── 管理者（Web）
```

**ピーク時想定**:
- 同時セッション数: 50（全スタッフの50%が同時施術）
- 同時Web接続数: 20
- API呼び出し: 100 req/min

#### 2.3.3 利用シーン詳細

**シーン1: 施術中のリアルタイム分析**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    利用シーン1: 施術中のリアルタイム分析                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  スタイリスト                           システム                          │
│       │                                    │                            │
│       │ 1. セッション開始ボタンタップ        │                            │
│       │────────────────────────────────────▶│                            │
│       │                                    │ 2. セッション作成            │
│       │                                    │ 3. Realtimeチャンネル接続    │
│       │ 4. 接続完了通知                     │                            │
│       │◀────────────────────────────────────│                            │
│       │                                    │                            │
│       │ 5. 会話開始（施術中）                │                            │
│       │ ═══════════════════════════════════ │                            │
│       │                                    │                            │
│       │      │ 6. 音声チャンク（60秒ごと）   │                            │
│       │      │─────────────────────────────▶│                            │
│       │      │                              │ 7. 文字起こし保存           │
│       │      │                              │ 8. pyannote呼び出し         │
│       │      │                              │ 9. 話者分離処理             │
│       │      │                              │ 10. AI分析                  │
│       │      │ 11. スコア更新               │                            │
│       │      │◀─────────────────────────────│                            │
│       │      │                              │                            │
│       │      │ ≪悩みキーワード検出時≫        │                            │
│       │      │                              │ 12. 成功事例検索            │
│       │      │ 13. 提案通知表示              │                            │
│       │      │◀─────────────────────────────│                            │
│       │      │                              │                            │
│       │ ═══════════════════════════════════ │                            │
│       │                                    │                            │
│       │ 14. セッション終了ボタンタップ       │                            │
│       │────────────────────────────────────▶│                            │
│       │                                    │ 15. レポート生成            │
│       │ 16. レポート表示                    │                            │
│       │◀────────────────────────────────────│                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**シーン2: 管理者による分析確認**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    利用シーン2: 管理者による分析確認                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  店長/マネージャー                      システム                          │
│       │                                    │                            │
│       │ 1. Webダッシュボードアクセス        │                            │
│       │────────────────────────────────────▶│                            │
│       │                                    │ 2. 認証確認                 │
│       │ 3. ダッシュボード表示               │                            │
│       │◀────────────────────────────────────│                            │
│       │                                    │                            │
│       │    ┌──────────────────────────────┐│                            │
│       │    │ ダッシュボード                ││                            │
│       │    │ ● 今日のセッション: 12       ││                            │
│       │    │ ● 平均スコア: 78.5           ││                            │
│       │    │ ● 成約率: 23.4%              ││                            │
│       │    └──────────────────────────────┘│                            │
│       │                                    │                            │
│       │ 4. スタッフ選択                     │                            │
│       │────────────────────────────────────▶│                            │
│       │                                    │ 5. スタッフ分析データ取得   │
│       │ 6. スタッフ詳細分析表示             │                            │
│       │◀────────────────────────────────────│                            │
│       │                                    │                            │
│       │    ┌──────────────────────────────┐│                            │
│       │    │ 佐藤花子 詳細分析            ││                            │
│       │    │ ● 傾聴スコア推移グラフ       ││                            │
│       │    │ ● 成約率: 35%                ││                            │
│       │    │ ● 強み: 感情分析             ││                            │
│       │    │ ● 改善点: 質問のバリエーション││                            │
│       │    └──────────────────────────────┘│                            │
│       │                                    │                            │
│       │ 7. 期間指定（先月比較）             │                            │
│       │────────────────────────────────────▶│                            │
│       │ 8. 比較レポート表示                 │                            │
│       │◀────────────────────────────────────│                            │
│       │                                    │                            │
│       │ 9. CSVエクスポート                  │                            │
│       │────────────────────────────────────▶│                            │
│       │ 10. ファイルダウンロード            │                            │
│       │◀────────────────────────────────────│                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---
