## 10. 運用設計

### 10.1 監視設計

#### 10.1.1 監視項目一覧

| カテゴリ | 監視項目 | 閾値（警告） | 閾値（異常） | 通知先 |
|---------|---------|------------|------------|--------|
| **可用性** | サービス稼働状態 | - | Down | Slack + Email + 電話 |
| | APIエンドポイント応答 | 3秒以上 | 10秒以上/無応答 | Slack |
| | WebSocket接続数 | 80%上限 | 95%上限 | Slack |
| **性能** | APIレスポンスタイム（P95） | 1秒以上 | 3秒以上 | Slack |
| | エラー率 | 1%以上 | 5%以上 | Slack + Email |
| | 話者分離キュー長 | 10以上 | 50以上 | Slack |
| | AI API応答時間 | 30秒以上 | 60秒以上 | Slack |
| **リソース** | DB接続数 | 80%以上 | 95%以上 | Slack |
| | DBストレージ使用率 | 80%以上 | 90%以上 | Slack + Email |
| | pyannote GPU使用率 | 90%以上 | 98%以上 | Slack |
| | pyannote メモリ使用率 | 85%以上 | 95%以上 | Slack |
| **ビジネス** | セッション異常終了率 | 3%以上/日 | 10%以上/日 | Slack |
| | レポート生成失敗率 | 1%以上 | 5%以上 | Slack |
| | AI分析エラー率 | 1%以上 | 5%以上 | Slack |

#### 10.1.2 監視ダッシュボード

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           運用監視ダッシュボード                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        サービスステータス                              │ │
│  │                                                                       │ │
│  │   🟢 iPad App     🟢 Web Dashboard    🟢 API Gateway                 │ │
│  │   🟢 PostgreSQL   🟢 Realtime         🟢 Storage                     │ │
│  │   🟢 pyannote #1  🟢 pyannote #2      🟡 pyannote #3 (高負荷)        │ │
│  │   🟢 Claude API   🟢 OpenAI API                                      │ │
│  │                                                                       │ │
│  │   最終更新: 2025-12-04 14:32:15 JST                                  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐ │
│  │   APIレスポンスタイム (P95)   │  │          エラー率                   │ │
│  │                             │  │                                     │ │
│  │   300ms │         ╭──╮     │  │   0.5% │                            │ │
│  │         │        ╱  ╲    │  │        │         ╭─╮                  │ │
│  │   200ms │       ╱    ╲   │  │   0.3% │        ╱   ╲                 │ │
│  │         │   ───╱      ╲──│  │        │   ────╱     ╲────            │ │
│  │   100ms │  ╱              │  │   0.1% │  ╱                           │ │
│  │         │ ╱               │  │        │ ╱                            │ │
│  │      0  │╱                │  │      0 │╱                             │ │
│  │         └──────────────── │  │        └──────────────────────        │ │
│  │          00:00      12:00 │  │         00:00      12:00              │ │
│  │                             │  │                                     │ │
│  │   現在: 245ms ✓            │  │   現在: 0.12% ✓                      │ │
│  └─────────────────────────────┘  └─────────────────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐ │
│  │   同時セッション数           │  │      pyannote 処理キュー            │ │
│  │                             │  │                                     │ │
│  │   現在: 45 / 100            │  │   待機中: 3 タスク                  │ │
│  │                             │  │   処理中: 2 タスク                  │ │
│  │   ████████████░░░░░░░░░    │  │                                     │ │
│  │            45%              │  │   平均処理時間: 2.5分               │ │
│  │                             │  │   GPU使用率: 65% / 72% / 89%       │ │
│  │   ピーク(今日): 78 (14:00)  │  │                                     │ │
│  └─────────────────────────────┘  └─────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        最近のアラート                                  │ │
│  │                                                                       │ │
│  │   🟡 14:25 pyannote #3 GPU使用率 92% - 高負荷状態                     │ │
│  │   🟢 14:10 pyannote #2 復旧完了                                       │ │
│  │   🔴 14:05 pyannote #2 ヘルスチェック失敗 (自動再起動)                │ │
│  │   🟢 13:00 定期メンテナンス完了                                       │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 10.1.3 アラート設定

```yaml
# alerting-rules.yaml

groups:
  - name: availability
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "サービス停止: {{ $labels.service }}"
          
      - alert: HighErrorRate
        expr: error_rate > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "エラー率上昇: {{ $value | humanizePercentage }}"

  - name: performance
    rules:
      - alert: SlowAPIResponse
        expr: api_response_time_p95 > 3000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API応答遅延: P95 {{ $value }}ms"
          
      - alert: PyannoteQueueBacklog
        expr: pyannote_queue_length > 50
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "話者分離キュー滞留: {{ $value }}タスク"

  - name: resources
    rules:
      - alert: DatabaseConnectionHigh
        expr: db_connections_used / db_connections_max > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "DB接続枯渇: {{ $value | humanizePercentage }}"
          
      - alert: GPUMemoryHigh
        expr: gpu_memory_used / gpu_memory_total > 0.95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "GPU メモリ不足: {{ $value | humanizePercentage }}"
```

### 10.2 バックアップ・リカバリ設計

#### 10.2.1 バックアップ方針

| 対象 | 方式 | 頻度 | 保持期間 | 保管場所 | RPO | RTO |
|------|------|------|---------|---------|-----|-----|
| PostgreSQL（データ） | Supabase自動 | 日次 | 7日 | Supabase | 24時間 | 1時間 |
| PostgreSQL（データ） | pg_dump | 週次 | 30日 | S3 | 7日 | 4時間 |
| PostgreSQL（WAL） | Supabase PITR | 継続的 | 7日 | Supabase | 数分 | 1時間 |
| Supabase Storage | 自動レプリケーション | リアルタイム | - | Supabase | 0 | 即時 |
| 設定ファイル | Git | 随時 | 無期限 | GitHub | 0 | 即時 |
| 環境変数 | Supabase Secrets | 変更時 | - | Supabase | 0 | 即時 |

#### 10.2.2 リカバリ手順

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           障害対応フローチャート                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐                                                            │
│  │ 障害検知     │                                                            │
│  │ (自動/手動) │                                                            │
│  └──────┬──────┘                                                            │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 初動対応 (5分以内)                                                │   │
│  │    □ 障害の種類・影響範囲を特定                                      │   │
│  │    □ Slackで関係者に第一報                                          │   │
│  │    □ 重大度判定（Critical/Major/Minor）                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2. 重大度判定                                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│    ┌────┼────┬────────────┐                                                │
│    │    │    │            │                                                │
│    ▼    ▼    ▼            ▼                                                │
│  ┌────┐┌────┐┌────┐    ┌────────────────────────────────────────────────┐│
│  │Crit││Maj ││Min │    │ Critical: 全サービス停止、データ損失リスク     ││
│  └──┬─┘└──┬─┘└──┬─┘    │ Major: 主要機能停止、一部ユーザー影響         ││
│     │     │     │      │ Minor: 軽微な機能障害、回避策あり              ││
│     │     │     │      └────────────────────────────────────────────────┘│
│     │     │     │                                                         │
│     ▼     ▼     ▼                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3. 復旧作業                                                          │   │
│  │                                                                     │   │
│  │    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │   │
│  │    │ DB障害      │    │ App障害     │    │ 外部API障害  │           │   │
│  │    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘           │   │
│  │           │                  │                  │                   │   │
│  │           ▼                  ▼                  ▼                   │   │
│  │    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │   │
│  │    │ Supabase    │    │ Vercel      │    │ フォール    │           │   │
│  │    │ PITR復元    │    │ 再デプロイ   │    │ バック実行  │           │   │
│  │    │             │    │             │    │             │           │   │
│  │    │ または      │    │ または      │    │ Claude →   │           │   │
│  │    │ pg_restore  │    │ ロールバック │    │ ルールベース│           │   │
│  │    └─────────────┘    └─────────────┘    └─────────────┘           │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4. 動作確認                                                          │   │
│  │    □ 基本機能テスト（ログイン、セッション開始、分析）                 │   │
│  │    □ データ整合性確認                                                │   │
│  │    □ パフォーマンス確認                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 5. 復旧完了報告                                                      │   │
│  │    □ Slackで復旧完了を報告                                          │   │
│  │    □ 障害報告書を作成（24時間以内）                                  │   │
│  │    □ 再発防止策を検討・実施                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 10.3 デプロイメント設計

#### 10.3.1 CI/CDパイプライン

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CI/CD パイプライン                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         GitHub Repository                            │  │
│  │                                                                      │  │
│  │   main ─────────────────────────────────────────────────▶ Production │  │
│  │     │                                                                │  │
│  │     │ PR                                                             │  │
│  │     │                                                                │  │
│  │   develop ──────────────────────────────────────────────▶ Staging    │  │
│  │     │                                                                │  │
│  │     │ PR                                                             │  │
│  │     │                                                                │  │
│  │   feature/* ────────────────────────────────────────────▶ Preview    │  │
│  │                                                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         GitHub Actions                               │  │
│  │                                                                      │  │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │  │
│  │   │  Lint    │─▶│  Test    │─▶│  Build   │─▶│ Security │           │  │
│  │   │          │  │          │  │          │  │  Scan    │           │  │
│  │   │ ESLint   │  │ Jest     │  │ Next.js  │  │ npm audit│           │  │
│  │   │ Prettier │  │ 単体/結合 │  │ Expo     │  │ Snyk     │           │  │
│  │   └──────────┘  └──────────┘  └──────────┘  └────┬─────┘           │  │
│  │                                                   │                  │  │
│  └───────────────────────────────────────────────────┼──────────────────┘  │
│                                                      │                      │
│                         ┌────────────────────────────┘                      │
│                         │                                                   │
│                         ▼                                                   │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         Vercel Deployment                            │  │
│  │                                                                      │  │
│  │   ┌────────────────────────────────────────────────────────────────┐│  │
│  │   │  Preview Deployment (feature/*)                                ││  │
│  │   │  https://salontalk-ai-{branch}-{hash}.vercel.app              ││  │
│  │   └────────────────────────────────────────────────────────────────┘│  │
│  │                              │                                       │  │
│  │                              │ PR Merge to develop                   │  │
│  │                              ▼                                       │  │
│  │   ┌────────────────────────────────────────────────────────────────┐│  │
│  │   │  Staging Deployment (develop)                                  ││  │
│  │   │  https://staging.salontalk.app                                 ││  │
│  │   │  ● E2Eテスト実行                                               ││  │
│  │   │  ● QA検証                                                      ││  │
│  │   └────────────────────────────────────────────────────────────────┘│  │
│  │                              │                                       │  │
│  │                              │ PR Merge to main (承認後)             │  │
│  │                              ▼                                       │  │
│  │   ┌────────────────────────────────────────────────────────────────┐│  │
│  │   │  Production Deployment (main)                                  ││  │
│  │   │  https://salontalk.app                                         ││  │
│  │   │  ● Blue-Green デプロイ                                         ││  │
│  │   │  ● 自動ロールバック（エラー率 > 5%）                           ││  │
│  │   └────────────────────────────────────────────────────────────────┘│  │
│  │                                                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                       Supabase Deployment                            │  │
│  │                                                                      │  │
│  │   ┌──────────────┐              ┌──────────────┐                    │  │
│  │   │   Staging    │   検証後      │  Production  │                    │  │
│  │   │              │─────────────▶│              │                    │  │
│  │   │ supabase/    │  手動昇格     │              │                    │  │
│  │   │ staging      │              │              │                    │  │
│  │   └──────────────┘              └──────────────┘                    │  │
│  │                                                                      │  │
│  │   マイグレーション: supabase db push                                 │  │
│  │   Edge Functions: supabase functions deploy                         │  │
│  │                                                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 10.3.2 デプロイチェックリスト

| # | カテゴリ | 確認項目 | 確認方法 | 必須 |
|---|---------|---------|---------|------|
| 1 | コード品質 | ESLint警告なし | CI結果 | ○ |
| 2 | コード品質 | TypeScript型エラーなし | CI結果 | ○ |
| 3 | テスト | 単体テスト全パス | CI結果 | ○ |
| 4 | テスト | 結合テスト全パス | CI結果 | ○ |
| 5 | テスト | E2Eテスト全パス（Staging） | 手動確認 | ○ |
| 6 | セキュリティ | npm audit問題なし | CI結果 | ○ |
| 7 | セキュリティ | 機密情報がコードに含まれていない | レビュー | ○ |
| 8 | DB | マイグレーション適用済み | Supabase確認 | ○ |
| 9 | 環境変数 | 本番環境変数設定済み | Vercel/Supabase確認 | ○ |
| 10 | ドキュメント | 変更内容がドキュメント化されている | PR確認 | △ |
| 11 | ロールバック | ロールバック手順確認済み | チェック | ○ |
| 12 | 通知 | 関係者にデプロイ予定を通知 | Slack | ○ |

#### 10.3.3 ロールバック手順

```bash
# Vercel ロールバック
# 1. 前回の成功デプロイを確認
vercel ls --prod

# 2. 特定のデプロイにロールバック
vercel rollback [deployment-url]

# Supabase ロールバック
# 1. マイグレーション履歴確認
supabase migration list

# 2. 特定のマイグレーションまでロールバック
supabase db reset --version [version]

# Edge Functions ロールバック
# 1. 前回のデプロイをGitから取得
git checkout HEAD~1 -- supabase/functions/

# 2. 再デプロイ
supabase functions deploy
```

### 10.4 運用体制

#### 10.4.1 運用体制図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              運用体制                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        1次対応（24時間）                               │ │
│  │                                                                       │ │
│  │   ┌─────────────────┐    ┌─────────────────┐                         │ │
│  │   │  自動監視        │    │  オンコール担当  │                         │ │
│  │   │                 │    │  (ローテーション) │                         │ │
│  │   │ ● Supabase監視  │    │                 │                         │ │
│  │   │ ● Vercel監視    │    │ ● アラート対応   │                         │ │
│  │   │ ● カスタム監視   │    │ ● 初期判断      │                         │ │
│  │   │                 │    │ ● エスカレーション│                         │ │
│  │   └─────────────────┘    └─────────────────┘                         │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    │ エスカレーション                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        2次対応（営業時間）                              │ │
│  │                                                                       │ │
│  │   ┌─────────────────┐    ┌─────────────────┐                         │ │
│  │   │  開発チーム      │    │  インフラ担当    │                         │ │
│  │   │                 │    │                 │                         │ │
│  │   │ ● バグ修正      │    │ ● サーバー対応  │                         │ │
│  │   │ ● 機能改修      │    │ ● DB対応       │                         │ │
│  │   │ ● パフォーマンス │    │ ● ネットワーク  │                         │ │
│  │   │   改善          │    │                 │                         │ │
│  │   └─────────────────┘    └─────────────────┘                         │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                    │                                        │
│                                    │ 重大障害                               │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        3次対応（重大障害）                              │ │
│  │                                                                       │ │
│  │   ┌─────────────────┐    ┌─────────────────┐                         │ │
│  │   │  技術責任者      │    │  外部ベンダー    │                         │ │
│  │   │                 │    │                 │                         │ │
│  │   │ ● 最終判断      │    │ ● Supabaseサポート│                        │ │
│  │   │ ● 経営報告      │    │ ● Vercelサポート │                         │ │
│  │   │ ● 対外対応      │    │ ● Anthropicサポート│                        │ │
│  │   └─────────────────┘    └─────────────────┘                         │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  連絡先:                                                                     │
│  ● Slack: #salontalk-ops                                                   │
│  ● 緊急連絡: オンコール担当携帯                                              │
│  ● メール: ops@revol.co.jp                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---
